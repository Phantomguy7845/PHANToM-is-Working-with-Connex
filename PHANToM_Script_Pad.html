<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PHANToM Script Board — Copy on Tap</title>
  <meta name="description" content="กระดานสคริปต์/ประโยคสำเร็จรูป กดครั้งเดียวคัดลอก · เพิ่ม/แก้ไข/ลบ · ลากย้ายตำแหน่ง · นำเข้า/ส่งออก .txt · โทน PHANToM พร้อมแอนิเมชัน · เก็บข้อมูลถาวรในเบราว์เซอร์" />
  <style>
    :root{
      --bg:#060a14; --panel:#0b1220; --edge:#1b2743; --txt:#e5e7eb; --muted:#9fb3d1;
      --pri:#7c3aed; --sec:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --glow:0 0 18px rgba(123,58,237,.45), 0 0 42px rgba(59,130,246,.35);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:radial-gradient(1200px 900px at 15% -10%, rgba(59,130,246,.18), transparent),
                              radial-gradient(1000px 800px at 100% 0%, rgba(124,58,237,.12), transparent),
                              var(--bg);color:var(--txt);font-family:ui-sans-serif,system-ui,Segoe UI,Arial}
    header{position:sticky;top:0;z-index:50;backdrop-filter:blur(8px);background:rgba(10,16,32,.6);border-bottom:1px solid rgba(255,255,255,.08)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:10px}
    .tag{border:1px solid var(--edge);padding:.25rem .5rem;border-radius:999px;background:#0e1730;color:#cfe0ff;font-size:.8rem}
    .btn{cursor:pointer;border:1px solid var(--edge);background:#0e1730;color:#cfe0ff;border-radius:12px;padding:.55rem .8rem;transition:.2s;user-select:none}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--glow)}
    .btn:active{transform:translateY(0)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}

    main{max-width:1100px;margin:0 auto;padding:16px}

    .board{position:relative;min-height:62vh;border:1px solid var(--edge);background:linear-gradient(180deg,rgba(16,26,52,.6),rgba(9,14,26,.8));
           border-radius:18px;overflow:hidden;padding:14px}

    .script-btn{position:absolute;display:flex;align-items:center;gap:8px;min-width:160px;max-width:360px;
      padding:.65rem .85rem;border-radius:14px;border:1px solid var(--edge);background:
        linear-gradient(135deg, rgba(124,58,237,.22), rgba(59,130,246,.18));
      box-shadow:var(--glow);backdrop-filter:blur(2px);
      cursor:grab;user-select:none;transition:transform .08s ease;
    }
    .script-btn:active{cursor:grabbing}
    .script-label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .mini{width:22px;height:22px;display:grid;place-items:center;border:1px solid var(--edge);
      background:#0a1430;border-radius:8px;opacity:.9}
    .mini:hover{background:#1a2547}
    .selected{outline:2px solid #60a5fa; outline-offset:2px}

    .tip{font-size:.85rem;opacity:.8}

    /* Floating Add Button */
    .fab{position:fixed;right:18px;bottom:18px;z-index:60;display:flex;align-items:center;gap:10px}
    .fab .btn{border-radius:999px;padding:.9rem 1rem;font-weight:600;box-shadow:var(--glow)}
    .pulse{animation:pulse 2.2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(124,58,237,.5)}70%{box-shadow:0 0 0 16px rgba(124,58,237,0)}100%{box-shadow:0 0 0 0 rgba(124,58,237,0)}}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:80}
    .modal.show{display:flex}
    .sheet{width:min(92vw,780px);max-height:88vh;overflow:auto;background:linear-gradient(180deg,#111a33,#0b1224);
           border:1px solid var(--edge);border-radius:16px;box-shadow:0 30px 70px rgba(0,0,0,.45)}
    .sheet h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--edge)}
    .sheet .body{padding:16px}
    .sheet label{display:block;margin:.5rem 0 .25rem}
    .sheet input[type="text"], .sheet textarea{width:100%;background:#0c162b;border:1px solid #223456;color:#e5e7eb;border-radius:10px;padding:10px}
    .sheet textarea{min-height:220px;font-size:1.05rem;line-height:1.5}

    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;border:1px solid rgba(255,255,255,.12);
           padding:.5rem .75rem;border-radius:999px;z-index:100;font-size:.9rem}

    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div style="width:10px;height:10px;border-radius:999px;background:var(--ok);box-shadow:0 0 16px rgba(34,197,94,.6)"></div>
      <h1 style="margin:0;font-size:1.1rem;font-weight:800;letter-spacing:.3px">PHANToM Script Board</h1>
      <span class="tag">Copy on Tap</span>
      <div class="grow"></div>
      <button class="btn" id="btnImport">Import .txt</button>
      <a class="btn" id="btnExport" download>Export .txt</a>
      <input type="file" id="file" accept=".txt,.json" class="hidden" />
    </div>
  </header>

  <main>
    <p class="tip">กดปุ่มสคริปต์เพื่อคัดลอกทันที · ใช้ <b>ลูกศร</b> เพื่อเลือกปุ่ม · <b>Enter</b> เพื่อคัดลอก · <b>E</b> เพื่อแก้ไข · <b>Delete</b> เพื่อลบ · ลากปุ่มเพื่อจัดตำแหน่ง · ข้อมูลเก็บใน <b>เบราว์เซอร์ (localStorage)</b> ผูกกับโดเมน/พาธของ GitHub Pages</p>
    <div class="board" id="board" aria-label="script-board"></div>
  </main>

  <div class="fab">
    <button class="btn pulse" id="addBtn">＋ เพิ่มสคริปต์</button>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal" id="editModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="mTitle">
      <h3 id="mTitle">เพิ่มสคริปต์ใหม่</h3>
      <div class="body">
        <label>ชื่อปุ่ม/สั้น ๆ</label>
        <input id="mLabel" type="text" placeholder="เช่น ทักทาย, นัดดูห้อง, ยืนยันตัวตน" />
        <label>ข้อความสคริปต์</label>
        <textarea id="mText" placeholder="พิมพ์ข้อความเต็มที่จะคัดลอก"></textarea>
        <div class="row" style="margin-top:10px">
          <div class="grow"></div>
          <button class="btn" id="mCancel">ยกเลิก</button>
          <button class="btn" id="mSave">บันทึก</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div class="modal" id="confirmModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true">
      <h3>ลบสคริปต์นี้?</h3>
      <div class="body">
        <p>การลบนี้ไม่สามารถย้อนกลับได้ ต้องการลบหรือไม่</p>
        <div class="row" style="margin-top:10px">
          <div class="grow"></div>
          <button class="btn" id="cCancel">ยกเลิก</button>
          <button class="btn" id="cDelete" style="border-color:var(--err);color:#fecaca">ลบ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  'use strict';
  const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));
  const board = $('#board');

  // ทำ key แบบ namespaced ตาม path บน GitHub Pages เพื่อคงข้อมูลครบในโดเมน/พาธเดียวกัน
  const STORE_KEY_V2 = 'phantom_script_board_v2::' + location.host + location.pathname.replace(/\/$/, '');
  const STORE_KEY_V1 = 'phantom_script_board_v1'; // migrate เก่าถ้ามี

  let store = { scripts: [], seq: 1 };
  let selectedId = null; // for keyboard focus
  let pendingDeleteId = null;
  let editingId = null; // ถ้าไม่ null = โหมดแก้ไข

  function toast(msg){ const el=document.createElement('div'); el.className='toast'; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),1400); }

  async function safeCopy(text){
    try{
      if (navigator.clipboard && document.hasFocus()){
        await navigator.clipboard.writeText(String(text)); toast('คัดลอกแล้ว'); return true;
      }
      throw new Error('fallback');
    }catch{
      try{
        const ta=document.createElement('textarea'); ta.value=String(text); ta.setAttribute('readonly',''); ta.style.position='fixed'; ta.style.top='-9999px'; ta.style.opacity='0'; document.body.appendChild(ta); ta.focus(); ta.select(); const ok=document.execCommand('copy'); document.body.removeChild(ta); if(ok){ toast('คัดลอกแล้ว'); return true; } throw new Error('execFailed');
      }catch{ toast('คัดลอกอัตโนมัติไม่สำเร็จ — กด Ctrl/Cmd+C'); return false; }
    }
  }

  function save(){ localStorage.setItem(STORE_KEY_V2, JSON.stringify(store)); updateExport(); }
  function load(){
    // ลองโหลด v2 ก่อน
    try{ const j=JSON.parse(localStorage.getItem(STORE_KEY_V2)||'{}'); if(j && Array.isArray(j.scripts)){ store=Object.assign({scripts:[],seq:1}, j); return; } }catch{}
    // ถ้ายังไม่มี ลอง migrate จาก v1
    try{ const j=JSON.parse(localStorage.getItem(STORE_KEY_V1)||'{}'); if(j && Array.isArray(j.scripts)){ store=Object.assign({scripts:[],seq:1}, j); save(); return; } }catch{}
  }

  function seedIfEmpty(){ if(store.scripts.length) return; const seed=[
    {label:'ทักทาย', text:'สวัสดีค่ะ ดิฉันจาก Connex Property สะดวกคุยสักครู่ไหมคะ'},
    {label:'ยืนยันตัวตน', text:'เพื่อความสบายใจ คุณสามารถตรวจสอบตัวตนทีมงานได้จากลิงก์ยืนยันของบริษัทค่ะ'},
    {label:'ขอรายละเอียด', text:'รบกวนแจ้งงบประมาณ โซนที่สนใจ ขนาด และช่วงย้ายเข้าคร่าว ๆ ได้ไหมคะ'},
    {label:'นัดดูห้อง', text:'สะดวกนัดดูห้องวันไหนคะ พรุ่งนี้ช่วงบ่ายหรือเย็นได้ค่ะ'},
    {label:'ส่งข้อมูลเพิ่ม', text:'ดิฉันจะส่งรูปและรายละเอียดห้องเพิ่มเติมให้พิจารณาก่อนได้ค่ะ'},
    {label:'English Greet', text:'Hello, this is Connex Property. Do you have a moment to talk?'},
  ];
  // วางแบบกริดเริ่มต้น
  let x=24, y=18, w=220, h=90, col=0; seed.forEach((s,i)=>{ addScript(s.label, s.text, x, y, true); x+=w; col++; if(col%3===0){ x=24; y+=h; } }); save(); }

  function addScript(label, text, x=40, y=40, silent=false){ const id = 's'+(store.seq++); store.scripts.push({id,label,text,x,y}); render(); if(!silent) save(); }

  function updateScript(id, {label, text}){ const it=store.scripts.find(s=>s.id===id); if(!it) return; if(label!==undefined) it.label=label; if(text!==undefined) it.text=text; render(); save(); }

  function delScript(id){ store.scripts = store.scripts.filter(s=>s.id!==id); if(selectedId===id) selectedId=null; render(); save(); }

  function updateExport(){ const a=$('#btnExport'); const blob=new Blob([ JSON.stringify(store,null,2) ], {type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob); a.href=url; a.download = 'phantom_scripts_'+ new Date().toISOString().slice(0,10)+'.txt'; }

  function openEdit(item=null){ editingId = item? item.id : null; $('#mTitle').textContent = editingId? 'แก้ไขสคริปต์' : 'เพิ่มสคริปต์ใหม่'; $('#mLabel').value=item? (item.label||'') : ''; $('#mText').value=item? (item.text||'') : ''; $('#editModal').classList.add('show'); $('#mLabel').focus(); }
  function closeEdit(){ $('#editModal').classList.remove('show'); editingId=null; }
  function openConfirm(id){ pendingDeleteId=id; $('#confirmModal').classList.add('show'); }
  function closeConfirm(){ pendingDeleteId=null; $('#confirmModal').classList.remove('show'); }

  function createButtonEl(s){
    const el = document.createElement('div'); el.className='script-btn'; el.dataset.id=s.id; el.style.left=(s.x||40)+'px'; el.style.top=(s.y||40)+'px'; el.tabIndex=0;
    const lab = document.createElement('div'); lab.className='script-label'; lab.textContent=s.label||'ไม่มีชื่อ';
    const edit = document.createElement('button'); edit.className='mini'; edit.title='แก้ไข'; edit.innerHTML='✎';
    const del = document.createElement('button'); del.className='mini'; del.title='ลบ'; del.innerHTML='✕';
    el.appendChild(lab); el.appendChild(edit); el.appendChild(del);

    el.addEventListener('click', (ev)=>{ if(ev.target===edit || ev.target===del) return; select(s.id); safeCopy(s.text); });
    el.addEventListener('dblclick', ()=>{ select(s.id); safeCopy(s.text); });
    edit.addEventListener('click', ()=> openEdit(s));
    del.addEventListener('click', ()=> openConfirm(s.id));

    // Dragging
    let drag=false, ox=0, oy=0;
    el.addEventListener('pointerdown', (e)=>{
      if(e.target===del || e.target===edit) return; drag=true; el.setPointerCapture(e.pointerId); const r=el.getBoundingClientRect(); ox=e.clientX - r.left; oy=e.clientY - r.top; el.style.transition='none'; });
    el.addEventListener('pointermove', (e)=>{
      if(!drag) return; const br=board.getBoundingClientRect(); let nx=e.clientX - br.left - ox; let ny=e.clientY - br.top - oy; nx=Math.max(4, Math.min(nx, br.width- el.offsetWidth-4)); ny=Math.max(4, Math.min(ny, br.height- el.offsetHeight-4)); el.style.left=nx+'px'; el.style.top=ny+'px'; });
    el.addEventListener('pointerup', (e)=>{ if(!drag) return; drag=false; el.releasePointerCapture(e.pointerId); el.style.transition=''; const nx=parseInt(el.style.left)||0; const ny=parseInt(el.style.top)||0; const item = store.scripts.find(x=>x.id===s.id); if(item){ item.x=nx; item.y=ny; save(); } });

    return el;
  }

  function render(){ board.innerHTML=''; store.scripts.forEach(s=>{ board.appendChild(createButtonEl(s)); }); highlightSelected(); }

  function select(id){ selectedId=id; highlightSelected(); }
  function highlightSelected(){ $$('.script-btn').forEach(el=> el.classList.toggle('selected', el.dataset.id===selectedId)); }

  // Keyboard navigation + shortcuts
  document.addEventListener('keydown', (e)=>{
    const activeTag = (document.activeElement && document.activeElement.tagName) || '';
    // ไม่ intercept ตอนโหมดพิมพ์ใน modal หรือช่อง input ใด ๆ
    if(['INPUT','TEXTAREA'].includes(activeTag) || $('#editModal').classList.contains('show') || $('#confirmModal').classList.contains('show')) return;
    const list = store.scripts; if(!list.length) return;
    let idx = list.findIndex(s=>s.id===selectedId); if(idx<0) idx=0;
    if(['ArrowRight','ArrowDown'].includes(e.key)){ idx = Math.min(list.length-1, idx+1); select(list[idx].id); e.preventDefault(); }
    else if(['ArrowLeft','ArrowUp'].includes(e.key)){ idx = Math.max(0, idx-1); select(list[idx].id); e.preventDefault(); }
    else if(e.key==='Enter'){ const s=list[idx]; if(s) { safeCopy(s.text); e.preventDefault(); } }
    else if(e.key.toLowerCase()==='e'){ const s=list[idx]; if(s){ openEdit(s); e.preventDefault(); } }
    else if(e.key==='Delete' || e.key==='Backspace'){ const s=list[idx]; if(s){ openConfirm(s.id); e.preventDefault(); } }
  });

  // Import/Export
  $('#btnImport').addEventListener('click', ()=> $('#file').click());
  $('#file').addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return; const txt = await f.text();
    try{
      const j = JSON.parse(txt);
      if(!j || !Array.isArray(j.scripts)) throw 0;
      store = { scripts: j.scripts.map(x=>({id:x.id||('s'+(Math.random()*1e6|0)), label:String(x.label||'Untitled'), text:String(x.text||''), x:parseInt(x.x)||40, y:parseInt(x.y)||40})), seq: (j.seq && Number(j.seq)) || (j.scripts.length+1) };
      render(); save(); toast('นำเข้าเรียบร้อย');
    }catch{ toast('รูปแบบไฟล์ไม่ถูกต้อง ต้องเป็น JSON ที่มีฟิลด์ scripts'); }
    e.target.value='';
  });

  // Add/Edit modal events
  $('#addBtn').addEventListener('click', ()=> openEdit(null));
  $('#mCancel').addEventListener('click', closeEdit);
  $('#mSave').addEventListener('click', ()=>{
    const label = $('#mLabel').value.trim(); const text = $('#mText').value.trim(); if(!label || !text){ toast('กรอกชื่อปุ่มและข้อความก่อน'); return; }
    if(editingId){ updateScript(editingId, {label, text}); }
    else{ addScript(label, text, 40 + Math.random()* (board.clientWidth-220), 40 + Math.random()* (board.clientHeight-90)); }
    closeEdit();
  });

  // Confirm delete
  $('#cCancel').addEventListener('click', closeConfirm);
  $('#cDelete').addEventListener('click', ()=>{ if(pendingDeleteId){ delScript(pendingDeleteId); toast('ลบแล้ว'); } closeConfirm(); });

  // Autosave guard: เมื่อหน้าโดนซ่อน/ปิด ให้บันทึกอีกรอบ
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden) save(); });
  window.addEventListener('beforeunload', save);

  // init
  window.addEventListener('load', ()=>{ load(); seedIfEmpty(); render(); updateExport(); });
  </script>
</body>
</html>
