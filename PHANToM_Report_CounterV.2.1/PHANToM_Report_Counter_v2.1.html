<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PHANToM Report Counter v2</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* =======================================================
       PHANToM Report Counter ‚Äî Aurora 2025
       3-Level + Calc + UP Call Mode (Multi-project)
       ======================================================= */

    :root{
      --bg:#0b1220; --panel:#111b30; --edge:#243353; --txt:#e5e7eb; --muted:#8fa1c6;
      --pri:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --card-radius:12px; --shadow:0 8px 28px rgba(0,0,0,.25);
    }

    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--txt);
      font-family:"Prompt",system-ui,sans-serif;
      min-height:100vh; display:flex; flex-direction:column;
    }

    /* LIGHT THEME OVERRIDE */
    body.theme-light{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --edge:#cbd5f5;
      --txt:#111827;
      --muted:#6b7280;
      --pri:#2563eb;
      --ok:#16a34a;
      --warn:#d97706;
      --err:#dc2626;
    }
    body.theme-light header{
      background:linear-gradient(90deg,#e5e7eb,#d1d5db);
      border-bottom:1px solid #cbd5f5;
    }
    body.theme-light #upcallSection{
      background:linear-gradient(90deg,#e0f2fe,#e5e7ff);
      border-bottom:1px solid #cbd5f5;
    }

    /* Header */
    header{
      background:linear-gradient(90deg,#0f182a,#152238);
      padding:12px 18px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      border-bottom:1px solid #223;
    }
    header input, header select{
      background:#1a2238; border:1px solid #334; color:var(--txt);
      border-radius:8px; padding:8px 10px; font-size:.95rem;
    }

    /* Buttons */
    button{border:none;border-radius:10px;padding:8px 12px;font-size:.95rem;cursor:pointer;transition:.2s ease}
    button:hover{opacity:.92;transform:translateY(-1px)}
    .btn{background:var(--pri);color:#fff}
    .ghost{background:#1a2238;color:var(--muted);border:1px solid #334}
    .warn{background:var(--warn);color:#000}
    .danger{background:var(--err);color:#fff}
    .mini{background:#1c2a44;color:var(--txt);border:1px solid #334;width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;line-height:0;font-size:.75rem;padding:0}

    /* UP Call section */
    #upcallSection{
      padding:10px 18px 12px;
      border-bottom:1px solid #223;
      background:linear-gradient(90deg,#0a1324,#0b172a);
    }
    #upcallSection .head{
      display:flex;align-items:baseline;gap:8px;flex-wrap:wrap;margin-bottom:6px;
    }
    #upcallSection .head-title{
      font-weight:700;font-size:1rem;
    }
    #upcallSection .head-note{
      font-size:.8rem;color:var(--muted);
    }
    #upcallSection .up-row{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;
    }

    /* Projects row: ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô, ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ, ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 10+ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ */
    #upProjects{
      display:flex;
      flex-wrap:nowrap;
      gap:8px;
      overflow-x:auto;
      padding-bottom:4px;
    }

    .up-project-card{
      background:var(--panel);
      border-radius:var(--card-radius);
      border:1px solid var(--edge);
      box-shadow:var(--shadow);
      padding:8px 10px;
      flex:0 0 280px;
      font-size:.8rem;
      display:flex;
      flex-direction:column;
      gap:6px;
      cursor:pointer;
    }
    .up-project-card.collapsed{
      flex:0 0 180px;
      opacity:0.9;
    }
    .up-project-card.selected{
      border-color:var(--pri);
      box-shadow:0 0 0 2px rgba(59,130,246,.45);
    }

    .up-project-header{
      display:flex;align-items:center;gap:6px;margin-bottom:2px;flex-wrap:wrap;
    }
    .up-project-header input{
      flex:1;
      background:#1a2238;border:1px solid #334;color:var(--txt);
      border-radius:8px;padding:4px 6px;font-size:.8rem;
    }

    .up-project-summary{
      font-size:.75rem;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:2px;
      margin-bottom:3px;
    }

    /* metric list: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ö‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
    .up-metric-grid{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .up-metric-row{
      display:flex;align-items:center;justify-content:space-between;gap:6px;
      font-size:.78rem;
      border-radius:8px;
      padding:2px 4px;
      cursor:pointer;
    }
    .up-metric-row.selected{
      box-shadow:0 0 0 1px rgba(59,130,246,0.65);
    }

    /* ‡πÅ‡∏ö‡πà‡∏á group ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
    .up-metric-row.group-all{
      background:rgba(148,163,184,0.06);
      border-left:2px solid var(--pri);
    }
    .up-metric-row.group-reachable{
      background:rgba(34,197,94,0.06);
      border-left:2px solid var(--ok);
    }
    .up-metric-row.group-unreachable{
      background:rgba(239,68,68,0.06);
      border-left:2px solid var(--err);
    }

    .up-metric-row .metric-label{
      max-width:60%;
      word-break:keep-all;
    }

    /* Drag visual */
    .up-project-card.dragging,
    .up-metric-row.dragging{
      opacity:0.6;
    }
    .up-project-card.drag-over,
    .up-metric-row.drag-over{
      outline:2px dashed var(--pri);
    }

    /* Tree board (mode ‡∏õ‡∏Å‡∏ï‡∏¥) */
    #tree{padding:16px 18px;display:flex;flex-direction:column;gap:16px;flex:1}

    /* Node shells */
    .node{background:var(--panel);border:1px solid var(--edge);border-radius:var(--card-radius);box-shadow:var(--shadow);transition:.2s ease}
    .node.selected{border-color:var(--pri);box-shadow:0 0 0 2px rgba(59,130,246,.35)}
    .node .header, .node .sub-header{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    /* Main node = sheet */
    .node.main{
      background:linear-gradient(180deg,#101b33,#0a0f1f);
      border:2px solid var(--pri);
      padding:18px 20px; border-radius:16px;
    }
    .node.main .title{font-weight:800;font-size:1.05rem}
    .node.main .children{margin-top:8px}

    /* Level2 node = paragraph bar */
    .node.level2{padding:12px;border-radius:12px;margin:8px 0}
    .node.level2 .title{font-weight:700}
    .node.level2 .children{margin-top:6px}
    .node.level2.has-children .modeWrap{display:none}

    /* Level3 node = small boxes grid */
    .level3-wrap{display:flex;flex-wrap:wrap;gap:8px}
    .node.level3{
      display:inline-flex;flex-direction:column;gap:6px;
      background:#1a2238;border:1px solid var(--edge);
      border-radius:10px;padding:8px 10px;min-width:200px;max-width:520px;resize:both;overflow:auto;
    }

    /* Calc node */
    .node.calc{background:linear-gradient(180deg,#163a36,#0f2724);border:2px solid var(--ok)}
    .node.calc .formula{background:rgba(0,0,0,.25);border:1px solid #2c5;color:#9ef3c8;padding:6px 8px;border-radius:8px;font-family:ui-monospace,Consolas,monospace}

    /* SUM Section (bottom fixed) */
    .node.sum{border-top:2px dashed var(--pri);padding-top:18px;margin-top:8px}
    .node.sum .title{font-weight:800}

    /* Common bits */
    .title{min-width:120px}
    .badge{font-size:.8rem;background:#1a2238;color:var(--muted);padding:3px 8px;border-radius:6px}
    .countWrap{display:flex;align-items:center;gap:8px;flex:1}
    .modeWrap{display:flex;align-items:center;gap:8px}
    .count{background:#1a2238;border:1px solid #334;border-radius:8px;padding:6px 12px;min-width:42px;text-align:center;cursor:pointer}
    .textbox{
      width:100%;min-height:120px;resize:vertical;background:rgba(15,25,45,.95);
      border:1px solid #334;border-radius:8px;color:var(--txt);padding:10px 12px;font-size:.95rem;line-height:1.5;
    }
    .textbox:focus{border-color:var(--pri);box-shadow:0 0 0 2px rgba(59,130,246,.35)}

    .row{display:flex;align-items:center;gap:8px;margin-top:8px}
    .row input,.row select{background:#1a2238;border:1px solid #334;color:var(--txt);border-radius:8px;padding:6px 10px}

    /* Modal (‡∏™‡∏π‡∏ï‡∏£ + Preview) */
    .modal{border:none;border-radius:16px;padding:0;max-width:680px;width:calc(100% - 24px);background:#0e172e;color:var(--txt)}
    .modal::backdrop{background:rgba(0,0,0,.45)}
    .modal-card{padding:0}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--edge)}
    .modal-body{padding:12px 14px;display:flex;flex-direction:column;gap:10px}
    .modal-foot{padding:12px 14px;border-top:1px solid var(--edge);display:flex;justify-content:flex-end}
    .formula-line{display:flex;gap:8px;align-items:center}
    .formula-list{display:flex;flex-direction:column;gap:6px}
    .muted{color:var(--muted);font-size:.9rem}

    /* Toast */
    #toast{
      position:fixed;left:50%;bottom:18px;transform:translate(-50%,24px);
      background:#0f1b2d;border:1px solid var(--pri);color:#fff;padding:8px 14px;border-radius:10px;opacity:0;transition:.25s ease;z-index:50;
    }
    #toast.show{opacity:1;transform:translate(-50%,0)}

    @media (max-width:900px){
      .level3-wrap{gap:10px}
    }
  </style>
</head>
<body>

  <header>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <strong style="letter-spacing:.5px">PHANToM Report Counter</strong>
      <input id="userName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÄ‡∏ä‡πà‡∏ô Stang)" title="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" />
      <input id="reportDate" type="date" title="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" />
      <span id="lastUpdated" style="font-size:.8rem;color:var(--muted);">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -</span>
      <button id="previewReport" class="ghost" title="‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å">üëÅ ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
      <button id="copyReport" class="btn" title="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î">üìÑ Copy Report</button>
    </div>

    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input id="newMainTitle" type="text" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å (‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÉ‡∏´‡∏°‡πà)" title="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô '‡∏Ç‡∏≤‡∏¢' '‡πÄ‡∏ä‡πà‡∏≤' '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà'" />
      <button id="addMain" class="btn" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å</button>

      <button id="addCalcToRoot" class="ghost" title="‡∏™‡∏£‡πâ‡∏≤‡∏á node ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô">+ Calc (Main)</button>

      <button id="exportSettings" class="ghost" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á+‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå .txt (‡∏™‡∏≥‡∏£‡∏≠‡∏á/‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)"> ‚§í Export</button>
      <label class="ghost" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer" title="‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå .txt ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢ Export ‡πÑ‡∏ß‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ">
        ‚§ì Import
        <input id="importSettings" type="file" accept=".txt" hidden>
      </label>

      <button id="themeToggle" class="ghost" title="‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á/‡∏°‡∏∑‡∏î">üåô</button>

      <!-- ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏¢‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ -->
      <span style="flex-basis:100%;height:0;"></span>
      <button id="resetCounts" class="warn" title="‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</button>
      <button id="resetAll" class="danger" title="‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
  </header>

  <!-- UP Call Mode Section -->
  <section id="upcallSection">
    <div class="head">
      <div class="head-title">UP Call Mode</div>
      <div class="head-note">
        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£ ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: 17/144/18/33/8=220<br>
        ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏Å‡∏±‡∏™ ‚Üí ‡πÉ‡∏ä‡πâ‡∏•‡∏π‡∏Å‡∏®‡∏£ (‚Üë ‚Üì ‚Üê ‚Üí) ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏° + / ‚àí ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î‡∏Ñ‡πà‡∏≤
      </div>
    </div>
    <div class="up-row">
      <input id="upProjectName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î / ‡∏ï‡∏∂‡∏Å" title="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£" />
      <button id="upAddProject" class="btn" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô UP Call">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</button>
      <button id="upResetUpcall" class="ghost" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï UP Call ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
      <input id="upSearch" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£..." title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á" style="min-width:220px;">
    </div>
    <div id="upProjects"></div>
  </section>

  <main id="tree"></main>

  <!-- Formula Modal -->
  <dialog id="formulaModal" class="modal">
    <form method="dialog" class="modal-card" id="formulaForm">
      <header class="modal-head">
        <h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Calculate Node)</h3>
        <button id="formulaClose" class="mini" value="cancel" type="button">‚úñ</button>
      </header>
      <section class="modal-body">
        <div class="muted" style="margin-bottom:8px">
          ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ + ‡∏´‡∏£‡∏∑‡∏≠ ‚àí (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á Node ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
        </div>
        <div id="formulaList" class="formula-list"></div>
        <div class="row">
          <select id="formulaSource"></select>
          <select id="formulaSign">
            <option value="+">+</option>
            <option value="-">‚àí</option>
          </select>
          <button id="formulaAdd" type="button" class="btn">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
        <div class="muted" style="margin-top:10px">
          * ‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö: Œ£(sign √ó ‡∏Ñ‡πà‡∏≤) ‡πÇ‡∏î‡∏¢‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ node ‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á (count/text) + ‡∏•‡∏π‡∏Å‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô
        </div>
      </section>
      <footer class="modal-foot">
        <button id="formulaSave" type="button" class="btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£</button>
      </footer>
    </form>
  </dialog>

  <!-- Preview Modal -->
  <dialog id="previewModal" class="modal">
    <div class="modal-card">
      <header class="modal-head">
        <h3>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
        <button id="previewClose" class="mini" type="button">‚úñ</button>
      </header>
      <section class="modal-body">
        <pre id="previewContent" style="white-space:pre-wrap;font-size:.85rem;"></pre>
      </section>
      <footer class="modal-foot">
        <button id="previewCopy" class="btn">üìÑ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ</button>
      </footer>
    </div>
  </dialog>

  <div id="toast">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>

  <script>
    (function(){
      const $ = (s,c=document)=>c.querySelector(s);
      const $$ = (s,c=document)=>Array.from(c.querySelectorAll(s));

      // ---- DOM ----
      const treeEl = $("#tree");
      const userNameEl = $("#userName");
      const dateEl = $("#reportDate");
      const copyBtn = $("#copyReport");
      const previewBtn = $("#previewReport");
      const previewModal = $("#previewModal");
      const previewContentEl = $("#previewContent");
      const previewCloseBtn = $("#previewClose");
      const previewCopyBtn = $("#previewCopy");
      const addMainBtn = $("#addMain");
      const newMainTitleEl = $("#newMainTitle");
      const addCalcToRootBtn = $("#addCalcToRoot");
      const exportBtn = $("#exportSettings");
      const importInput = $("#importSettings");
      const resetCountsBtn = $("#resetCounts");
      const resetAllBtn = $("#resetAll");
      const themeToggleBtn = $("#themeToggle");
      const lastUpdatedEl = $("#lastUpdated");

      const formulaModal = $("#formulaModal");
      const formulaListEl = $("#formulaList");
      const formulaSourceSel = $("#formulaSource");
      const formulaSignSel = $("#formulaSign");
      const formulaAddBtn = $("#formulaAdd");
      const formulaSaveBtn = $("#formulaSave");
      const formulaCloseBtn = $("#formulaClose");

      const toastEl = $("#toast");

      // UP Call DOM
      const upProjectNameEl = $("#upProjectName");
      const upAddProjectBtn = $("#upAddProject");
      const upProjectsWrapEl = $("#upProjects");
      const upResetUpcallBtn = $("#upResetUpcall");
      const upSearchEl = $("#upSearch");

      // ---- Storage ----
      const LS_KEY = "PHANTOM_REPORT_STATE_V5";

      // ---- UP Call metrics definition ----
      const upMetrics = [
        { id:"calls",           label:"‡πÇ‡∏ó‡∏£‡∏Å‡∏µ‡πà‡∏™‡∏≤‡∏¢",              group:"all" },
        { id:"nv_to_v",         label:"‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏á",      group:"reachable" },
        { id:"v_to_nv",         label:"‡∏à‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á",      group:"reachable" },
        { id:"v_still_v",       label:"‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà",   group:"reachable" },
        { id:"nv_still_nv",     label:"‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á", group:"reachable" },
        { id:"sold",            label:"‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß",                group:"reachable" },
        { id:"wrong_number",    label:"‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏¥‡∏î",               group:"reachable" },
        { id:"owner_self",      label:"‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏≠‡∏á",          group:"reachable" },
        { id:"no_agent",        label:"‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö Agent",            group:"reachable" },
        { id:"renovate",        label:"‡∏£‡∏µ‡πÇ‡∏ô‡πÄ‡∏ß‡∏ó",                group:"reachable" },
        { id:"not_release",     label:"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Ç‡∏≤‡∏¢/‡πÄ‡∏ä‡πà‡∏≤",     group:"reachable" },
        { id:"reserved",        label:"‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏á",                 group:"reachable" },
        { id:"no_answer",       label:"‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢",               group:"unreachable" },
        { id:"phone_off",       label:"‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á",              group:"unreachable" },
        { id:"not_convenient",  label:"‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏Ñ‡∏∏‡∏¢",             group:"unreachable" }
      ];

      // ---- State ----
      let state = loadState() || defaultState();
      state.theme = state.theme || "dark";
      ensureSumSection();
      ensureUpcallState();
      let focusPath = [];
      let undoStack = [];
      let upFocus = null;          // {projectIndex, metricIndex}
      let upProjectFocus = null;   // projectIndex

      // Drag state for UP Call
      let upDragProjectIndex = null;
      let upDragMetricIndex = null;

      // temp formula
      let editingCalcObj = null;
      let editingParts = [];

      // ---- Init ----
      initHeader();
      initUpcall();
      initKeyboard();
      render();

      // =========================================================
      // Theme + Last Updated
      function applyTheme(theme){
        document.body.classList.toggle("theme-light", theme==="light");
        if(themeToggleBtn){
          themeToggleBtn.textContent = theme==="light" ? "‚òÄ" : "üåô";
          themeToggleBtn.title = theme==="light" ? "‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î" : "‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á";
        }
        state.theme = theme;
      }

      function updateLastUpdated(){
        if(!lastUpdatedEl) return;
        if(!state.lastUpdated){
          lastUpdatedEl.textContent = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -";
          return;
        }
        const dt = new Date(state.lastUpdated);
        if(isNaN(dt.getTime())){
          lastUpdatedEl.textContent = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -";
          return;
        }
        const d = dt.toLocaleDateString("th-TH",{ day:"2-digit", month:"2-digit", year:"numeric" });
        const t = dt.toLocaleTimeString("th-TH",{ hour:"2-digit", minute:"2-digit" });
        lastUpdatedEl.textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${d} ${t}`;
      }

      // =========================================================
      // Header & top actions
      function initHeader(){
        applyTheme(state.theme || "dark");
        updateLastUpdated();

        userNameEl.value = state.userName || "";
        userNameEl.addEventListener("input", ()=>{
          state.userName = userNameEl.value.trim();
          saveState();
        });

        if(!state.reportDate){
          dateEl.valueAsDate = new Date();
          state.reportDate = isoDate();
        }else{
          dateEl.value = state.reportDate;
        }
        dateEl.addEventListener("change", ()=>{
          state.reportDate = dateEl.value || isoDate();
          saveState();
        });

        if(copyBtn){
          copyBtn.addEventListener("click", ()=>{
            const t=buildReport();
            copy(t).then(()=>tip("‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß",true));
          });
        }

        if(previewBtn && previewModal && previewContentEl){
          previewBtn.addEventListener("click", ()=>{
            const t = buildReport();
            previewContentEl.textContent = t;
            previewModal.showModal();
          });
        }
        if(previewCloseBtn && previewModal){
          previewCloseBtn.addEventListener("click", ()=> previewModal.close());
        }
        if(previewCopyBtn && previewContentEl){
          previewCopyBtn.addEventListener("click", ()=>{
            const t = previewContentEl.textContent || "";
            copy(t).then(()=>tip("‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß",true));
          });
        }

        if(addMainBtn){
          addMainBtn.addEventListener("click", ()=>{
            const t = (newMainTitleEl.value||"").trim();
            if(!t){ tip("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô"); return; }
            pushUndo();
            state.mains.push({ id:uid(), title:t, kind:"main", children:[] });
            newMainTitleEl.value="";
            saveState(); render();
          });
        }

        if(addCalcToRootBtn){
          addCalcToRootBtn.addEventListener("click", ()=>{
            pushUndo();
            state.mains.push(newCalcNode("‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà (Main)"));
            saveState(); render();
            tip("‡πÄ‡∏û‡∏¥‡πà‡∏° Calculate Node ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å", true);
          });
        }

        if(exportBtn){
          exportBtn.addEventListener("click", ()=>{
            const blob = new Blob([JSON.stringify(state,null,2)],{type:"text/plain;charset=utf-8"});
            const a=document.createElement("a");
            a.href=URL.createObjectURL(blob);
            a.download="PHANToM_Report_Counter_Settings.txt";
            a.click();
            setTimeout(()=>URL.revokeObjectURL(a.href),500);
            tip("Export ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",true);
          });
        }

        if(importInput){
          importInput.addEventListener("change",(e)=>{
            const f=e.target.files && e.target.files[0]; if(!f) return;
            const r=new FileReader();
            r.onload=(ev)=>{
              try{
                const obj=JSON.parse(String(ev.target.result||"{}"));
                if(!obj || !Array.isArray(obj.mains)) throw new Error("invalid");
                pushUndo(true);
                state=obj;
                state.theme = state.theme || "dark";
                ensureSumSection();
                ensureUpcallState();
                applyTheme(state.theme);
                saveState(); render(); tip("Import ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",true);
              }catch{
                tip("‡πÑ‡∏ü‡∏•‡πå .txt ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
              }
              importInput.value="";
            };
            r.readAsText(f);
          });
        }

        if(resetCountsBtn){
          resetCountsBtn.addEventListener("click", ()=>{
            if(!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å node ‡πÅ‡∏ï‡πà‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°.")) return;
            pushUndo();
            state.mains.forEach(resetCountsOnlyNodeDeep);
            resetUpcallCounts();
            saveState(); render(); tip("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß",true);
          });
        }

        if(resetAllBtn){
          resetAllBtn.addEventListener("click", ()=>{
            if(!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞ '‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á'?\\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ.")) return;
            pushUndo();
            state = defaultState();
            state.theme = state.theme || "dark";
            ensureSumSection();
            ensureUpcallState();
            upFocus = null;
            upProjectFocus = null;
            focusPath = [];
            applyTheme(state.theme);
            saveState(); render(); tip("‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß",true);
          });
        }

        if(formulaCloseBtn){
          formulaCloseBtn.addEventListener("click", ()=> formulaModal.close());
        }
        if(formulaAddBtn){
          formulaAddBtn.addEventListener("click", ()=>{
            const id = formulaSourceSel.value; if(!id) return;
            const sign = (formulaSignSel.value==="-") ? -1 : +1;
            editingParts.push({nodeId:id, sign});
            renderFormulaLines();
          });
        }
        if(formulaSaveBtn){
          formulaSaveBtn.addEventListener("click", ()=>{
            if(!editingCalcObj) return;
            pushUndo();
            editingCalcObj.formula = editingParts.slice();
            saveState(); render(); formulaModal.close(); tip("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡πâ‡∏ß",true);
          });
        }

        if(themeToggleBtn){
          themeToggleBtn.addEventListener("click", ()=>{
            const newTheme = (state.theme==="light") ? "dark" : "light";
            applyTheme(newTheme);
            saveState();
            tip(newTheme==="light" ? "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß" : "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î‡πÅ‡∏•‡πâ‡∏ß", true);
          });
        }
      }

      // =========================================================
      // UP Call init & helpers
      function initUpcall(){
        if(upAddProjectBtn){
          upAddProjectBtn.addEventListener("click", addUpProjectFromInput);
        }
        if(upProjectNameEl){
          upProjectNameEl.addEventListener("keydown",(e)=>{
            if(e.key==="Enter"){
              e.preventDefault();
              addUpProjectFromInput();
            }
          });
        }
        if(upResetUpcallBtn){
          upResetUpcallBtn.addEventListener("click", ()=>{
            if(!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£ (UP Call) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\\n‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏•‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£.")) return;
            pushUndo();
            resetUpcallCounts();
            saveState();
            render();
            tip("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï UP Call ‡πÅ‡∏•‡πâ‡∏ß",true);
          });
        }

        if(upProjectsWrapEl){
          upProjectsWrapEl.addEventListener("click",(e)=>{
            const metricRow = e.target.closest(".up-metric-row");
            if(metricRow){
              const pi = Number(metricRow.dataset.projectIndex);
              const mi = Number(metricRow.dataset.metricIndex);
              if(!Number.isNaN(pi) && !Number.isNaN(mi)){
                upFocus = {projectIndex:pi, metricIndex:mi};
                upProjectFocus = null;
                focusPath = [];
                highlightFocus(false);
                updateUpcallHighlight(true);
              }
            }

            const metricMove = e.target.closest("button[data-role='up-move-metric']");
            if(metricMove){
              const dir = Number(metricMove.dataset.dir);
              const idx = Number(metricMove.dataset.metricIndex);
              if(!Number.isNaN(idx) && (dir===-1 || dir===1)){
                pushUndo();
                moveUpMetric(idx, dir);
                saveState();
                render();
              }
              return;
            }

            const actBtn = e.target.closest("button[data-upaction]");
            if(actBtn){
              const projIndex = Number(actBtn.dataset.projectIndex);
              const metricId = actBtn.dataset.metricId;
              const action = actBtn.dataset.upaction;
              const projects = (state.upcall && state.upcall.projects) || [];
              const proj = projects[projIndex];
              if(!proj || !metricId) return;
              if(!proj.metrics) proj.metrics={};
              const cur = Number(proj.metrics[metricId] || 0);
              pushUndo();
              if(action==="inc") proj.metrics[metricId] = cur+1;
              else if(action==="dec") proj.metrics[metricId] = Math.max(0,cur-1);
              saveState();
              render();
              return;
            }

            const inp = e.target.closest("input[data-role='up-project-name']");
            if(inp){
              const idx = Number(inp.dataset.index);
              const projects = (state.upcall && state.upcall.projects) || [];
              const proj = projects[idx];
              if(!proj) return;
              proj.name = inp.value;
              saveState();
            }
          });
        }

        if(upSearchEl){
          ensureUpcallState();
          upSearchEl.value = state.upcall.searchKeyword || "";
          upSearchEl.addEventListener("input", ()=>{
            ensureUpcallState();
            state.upcall.searchKeyword = (upSearchEl.value || "").toLowerCase();
            saveState();
            renderUpcall();
          });
        }
      }

      function addUpProjectFromInput(){
        const name = (upProjectNameEl.value||"").trim();
        if(!name){
          tip("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô");
          return;
        }
        pushUndo();
        ensureUpcallState();
        const proj = {
          id: uid(),
          name,
          metrics: createEmptyUpMetrics(),
          collapsed:false
        };
        state.upcall.projects.push(proj);
        upProjectNameEl.value="";
        saveState();
        render();
      }

      function defaultUpcall(){
        return { projects: [], order: upMetrics.map(m=>m.id), searchKeyword:"" };
      }

      function ensureUpcallState(){
        if(!state.upcall) state.upcall = defaultUpcall();
        if(!Array.isArray(state.upcall.projects)) state.upcall.projects = [];
        if(!Array.isArray(state.upcall.order) || !state.upcall.order.length){
          state.upcall.order = upMetrics.map(m=>m.id);
        }
        if(typeof state.upcall.searchKeyword!=="string") state.upcall.searchKeyword="";

        state.upcall.projects.forEach(p=>{
          if(!p.metrics) p.metrics = {};
          upMetrics.forEach(m=>{
            if(typeof p.metrics[m.id]!=="number") p.metrics[m.id]=0;
          });
          if(typeof p.collapsed!=="boolean") p.collapsed=false;
        });
      }

      function createEmptyUpMetrics(){
        const obj={};
        upMetrics.forEach(m=>{ obj[m.id]=0; });
        return obj;
      }

      function resetUpcallCounts(){
        ensureUpcallState();
        state.upcall.projects.forEach(p=>{
          if(!p.metrics) p.metrics={};
          upMetrics.forEach(m=>{ p.metrics[m.id]=0; });
        });
      }

      function moveUpProject(i,dir){
        ensureUpcallState();
        const arr = state.upcall.projects;
        const ni = i+dir;
        if(ni<0 || ni>=arr.length) return;
        const x = arr.splice(i,1)[0];
        arr.splice(ni,0,x);
      }
      function moveProjectTo(fromIndex,toIndex){
        ensureUpcallState();
        const arr = state.upcall.projects;
        if(fromIndex<0 || fromIndex>=arr.length) return;
        if(toIndex<0) toIndex=0;
        if(toIndex>=arr.length) toIndex=arr.length-1;
        if(fromIndex===toIndex) return;
        const x = arr.splice(fromIndex,1)[0];
        arr.splice(toIndex,0,x);
      }

      function moveUpMetric(idx,dir){
        ensureUpcallState();
        const order = state.upcall.order || (state.upcall.order = upMetrics.map(m=>m.id));
        const ni = idx + dir;
        if(ni<0 || ni>=order.length) return;
        const x = order.splice(idx,1)[0];
        order.splice(ni,0,x);
      }
      function moveMetricTo(fromIndex,toIndex){
        ensureUpcallState();
        const order = state.upcall.order || (state.upcall.order = upMetrics.map(m=>m.id));
        if(fromIndex<0 || fromIndex>=order.length) return;
        if(toIndex<0) toIndex=0;
        if(toIndex>=order.length) toIndex=order.length-1;
        if(fromIndex===toIndex) return;
        const x = order.splice(fromIndex,1)[0];
        order.splice(toIndex,0,x);
      }

      function reachableForProject(p){
        let s=0;
        upMetrics.forEach(m=>{
          if(m.group==="reachable"){
            s += (p.metrics && p.metrics[m.id]) || 0;
          }
        });
        return s;
      }
      function unreachableForProject(p){
        let s=0;
        upMetrics.forEach(m=>{
          if(m.group==="unreachable"){
            s += (p.metrics && p.metrics[m.id]) || 0;
          }
        });
        return s;
      }

      function renderUpcall(){
        ensureUpcallState();
        if(!upProjectsWrapEl) return;
        const allProjects = state.upcall.projects || [];

        if(upFocus){
          if(upFocus.projectIndex >= allProjects.length) upFocus = null;
          else{
            const metricLen = (state.upcall.order && state.upcall.order.length) || upMetrics.length;
            if(upFocus.metricIndex >= metricLen){
              upFocus.metricIndex = metricLen-1;
            }
          }
        }
        if(upProjectFocus!=null && upProjectFocus>=allProjects.length){
          upProjectFocus = null;
        }

        upProjectsWrapEl.innerHTML="";
        let viewIndexes = allProjects.map((_,i)=>i);
        const keyword = (state.upcall.searchKeyword || "").trim().toLowerCase();
        if(keyword){
          viewIndexes = viewIndexes.filter(i => (allProjects[i].name || "").toLowerCase().includes(keyword));
        }

        if(!viewIndexes.length){
          const msg = div("muted","‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UP Call (‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)");
          upProjectsWrapEl.appendChild(msg);
          return;
        }

        const order = state.upcall.order && state.upcall.order.length
          ? state.upcall.order
          : upMetrics.map(m=>m.id);

        viewIndexes.forEach((idx)=>{
          const p = allProjects[idx];
          const card = div("up-project-card");
          card.dataset.projectIndex = idx;
          if(p.collapsed) card.classList.add("collapsed");
          card.setAttribute("draggable","true");

          const header = div("up-project-header");
          const label = div("muted","‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£");
          const nameInput = input(p.name||"", "‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£");
          nameInput.dataset.role="up-project-name";
          nameInput.dataset.index=idx;
          nameInput.title = "‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà";

          const toggleBtn = document.createElement("button");
          toggleBtn.className="mini ghost";
          toggleBtn.textContent = p.collapsed ? "‚ñ∂" : "‚óÄ";
          toggleBtn.title = p.collapsed ? "‡∏Ç‡∏¢‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ" : "‡∏û‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ";
          toggleBtn.onclick = (e)=>{
            e.stopPropagation();
            pushUndo();
            p.collapsed = !p.collapsed;
            saveState();
            render();
          };

          const moveUpBtn = document.createElement("button");
          moveUpBtn.className="mini ghost";
          moveUpBtn.textContent="‚Üë";
          moveUpBtn.title="‡∏¢‡πâ‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏Ç‡∏∂‡πâ‡∏ô";
          moveUpBtn.onclick = (e)=>{
            e.stopPropagation();
            pushUndo();
            moveUpProject(idx,-1);
            saveState(); render();
          };

          const moveDownBtn = document.createElement("button");
          moveDownBtn.className="mini ghost";
          moveDownBtn.textContent="‚Üì";
          moveDownBtn.title="‡∏¢‡πâ‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏•‡∏á";
          moveDownBtn.onclick = (e)=>{
            e.stopPropagation();
            pushUndo();
            moveUpProject(idx,+1);
            saveState(); render();
          };

          const delBtn = document.createElement("button");
          delBtn.className="mini danger";
          delBtn.textContent="üóë";
          delBtn.title="‡∏•‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
          delBtn.onclick = (e)=>{
            e.stopPropagation();
            if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ "${p.name||""}" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\\n‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£.`)) return;
            pushUndo();
            state.upcall.projects.splice(idx,1);
            saveState();
            render();
          };

          header.append(label, nameInput, toggleBtn, moveUpBtn, moveDownBtn, delBtn);
          card.appendChild(header);

          const calls = (p.metrics && p.metrics.calls) || 0;
          const reach = reachableForProject(p);
          const unreach = unreachableForProject(p);

          const summary = div("up-project-summary");
          summary.append(
            div(null, `‡πÇ‡∏ó‡∏£‡∏Å‡∏µ‡πà‡∏™‡∏≤‡∏¢: ${calls}`),
            div(null, `‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ: ${reach}`),
            div(null, `‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${unreach}`)
          );
          card.appendChild(summary);

          const grid = div("up-metric-grid");
          if(p.collapsed){
            grid.style.display="none";
          }

          order.forEach((metricId,mi)=>{
            const m = upMetrics.find(mm=>mm.id===metricId);
            if(!m) return;

            const row = div("up-metric-row");
            if(m.group) row.classList.add("group-"+m.group);
            row.dataset.projectIndex = idx;
            row.dataset.metricIndex = mi;
            row.setAttribute("draggable","true");

            const moveBox = div("row");
            moveBox.style.marginTop = "0";

            const upBtn = document.createElement("button");
            upBtn.className = "mini";
            upBtn.textContent = "‚Üë";
            upBtn.dataset.role = "up-move-metric";
            upBtn.dataset.metricIndex = mi;
            upBtn.dataset.dir = "-1";
            upBtn.title = "‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏Ç‡∏∂‡πâ‡∏ô";

            const downBtn = document.createElement("button");
            downBtn.className = "mini";
            downBtn.textContent = "‚Üì";
            downBtn.dataset.role = "up-move-metric";
            downBtn.dataset.metricIndex = mi;
            downBtn.dataset.dir = "1";
            downBtn.title = "‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏•‡∏á";

            moveBox.append(upBtn,downBtn);

            const labelSpan = div("metric-label", m.label);
            const left = div();
            left.style.display="flex";
            left.style.alignItems="center";
            left.style.gap="4px";
            left.append(moveBox,labelSpan);

            const controls = div("countWrap");
            const decBtn = document.createElement("button");
            decBtn.className="mini";
            decBtn.textContent="‚àí";
            decBtn.dataset.upaction="dec";
            decBtn.dataset.projectIndex=idx;
            decBtn.dataset.metricId=m.id;
            decBtn.title = "‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏•‡∏á 1";

            const val = div("count", String(p.metrics && typeof p.metrics[m.id]==="number" ? p.metrics[m.id] : 0));

            const incBtn = document.createElement("button");
            incBtn.className="mini";
            incBtn.textContent="+";
            incBtn.dataset.upaction="inc";
            incBtn.dataset.projectIndex=idx;
            incBtn.dataset.metricId=m.id;
            incBtn.title = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô 1";

            controls.append(decBtn,val,incBtn);

            row.append(left,controls);
            grid.appendChild(row);

            // Drag & Drop metric (‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)
            row.addEventListener("dragstart",(ev)=>{
              upDragMetricIndex = mi;
              row.classList.add("dragging");
            });
            row.addEventListener("dragend",(ev)=>{
              upDragMetricIndex = null;
              row.classList.remove("dragging");
            });
            row.addEventListener("dragover",(ev)=>{
              ev.preventDefault();
              row.classList.add("drag-over");
            });
            row.addEventListener("dragleave",(ev)=>{
              row.classList.remove("drag-over");
            });
            row.addEventListener("drop",(ev)=>{
              ev.preventDefault();
              row.classList.remove("drag-over");
              if(upDragMetricIndex==null || upDragMetricIndex===mi) return;
              pushUndo();
              moveMetricTo(upDragMetricIndex, mi);
              upDragMetricIndex = null;
              saveState();
              render();
            });
          });

          card.appendChild(grid);
          upProjectsWrapEl.appendChild(card);

          // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å
          card.addEventListener("click",(e)=>{
            e.stopPropagation();
            upProjectFocus = idx;
            upFocus = null;
            focusPath = [];
            highlightFocus(false);
            updateUpcallHighlight(true);
          });

          // Drag & Drop project card
          card.addEventListener("dragstart",(ev)=>{
            upDragProjectIndex = idx;
            card.classList.add("dragging");
          });
          card.addEventListener("dragend",(ev)=>{
            upDragProjectIndex = null;
            card.classList.remove("dragging");
          });
          card.addEventListener("dragover",(ev)=>{
            ev.preventDefault();
            card.classList.add("drag-over");
          });
          card.addEventListener("dragleave",(ev)=>{
            card.classList.remove("drag-over");
          });
          card.addEventListener("drop",(ev)=>{
            ev.preventDefault();
            card.classList.remove("drag-over");
            if(upDragProjectIndex==null || upDragProjectIndex===idx) return;
            pushUndo();
            moveProjectTo(upDragProjectIndex, idx);
            upDragProjectIndex = null;
            saveState();
            render();
          });
        });

        updateUpcallHighlight(false);
      }

      function updateUpcallHighlight(scroll=false){
        if(!upProjectsWrapEl) return;
        const rows = $$(".up-metric-row", upProjectsWrapEl);
        rows.forEach(row=>{
          const pi = Number(row.dataset.projectIndex);
          const mi = Number(row.dataset.metricIndex);
          const sel = upFocus && upFocus.projectIndex===pi && upFocus.metricIndex===mi;
          row.classList.toggle("selected", !!sel);
          if(sel && scroll){
            row.scrollIntoView({block:"nearest", behavior:"smooth"});
          }
        });

        const cards = $$(".up-project-card", upProjectsWrapEl);
        cards.forEach(card=>{
          const pi = Number(card.dataset.projectIndex);
          const sel = (upProjectFocus!=null && upProjectFocus===pi);
          card.classList.toggle("selected", !!sel);
          if(sel && scroll){
            card.scrollIntoView({block:"nearest", behavior:"smooth"});
          }
        });
      }

      function valuesForMetric(metricId){
        const projects = state.upcall.projects || [];
        return projects.map(p => (p.metrics && p.metrics[metricId]) || 0);
      }

      function buildUpcallSectionLines(){
        ensureUpcallState();
        const projects = state.upcall.projects || [];
        if(!projects.length) return [];
        const lines = [];

        projects.forEach(p=> lines.push(p.name || "(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£)"));
        if(projects.length) lines.push("");

        const sumArr = (arr)=> arr.reduce((a,b)=>a+b,0);

        const reachableVals = projects.map(p=>reachableForProject(p));

        const order = state.upcall.order && state.upcall.order.length
          ? state.upcall.order
          : upMetrics.map(m=>m.id);

        const specs = [];
        order.forEach(mid=>{
          if(mid==="calls"){
            specs.push({type:"metric", id:"calls", label:"‡πÇ‡∏ó‡∏£‡∏Å‡∏µ‡πà‡∏™‡∏≤‡∏¢"});
            specs.push({type:"reachable", id:"reachable", label:"‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ"});
          }else{
            const m = upMetrics.find(mm=>mm.id===mid);
            if(m){
              specs.push({type:"metric", id:mid, label:m.label});
            }
          }
        });

        specs.forEach(spec=>{
          let vals;
          if(spec.type==="reachable") vals = reachableVals;
          else vals = valuesForMetric(spec.id);
          const total = sumArr(vals);
          lines.push(`${spec.label} : ${vals.join("/")}=${total}`);
        });

        return lines;
      }

      function changeUpMetric(pIndex, mIndex, delta){
        ensureUpcallState();
        const projects = state.upcall.projects || [];
        const proj = projects[pIndex];
        const order = state.upcall.order && state.upcall.order.length
          ? state.upcall.order
          : upMetrics.map(m=>m.id);
        const metricId = order[mIndex];
        const metric = upMetrics.find(m=>m.id===metricId);

        if(!proj || !metric) return;
        if(!proj.metrics) proj.metrics = {};

        const cur = Number(proj.metrics[metric.id] || 0);
        proj.metrics[metric.id] = Math.max(0, cur + delta);

        saveState();
        render();
      }

      // =========================================================
      // Keyboard (global) ‚Äî ‡πÉ‡∏ä‡πâ grid ‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡∏à‡∏≠
      function initKeyboard(){
        document.addEventListener("keydown",(e)=>{
          const tag=(document.activeElement && document.activeElement.tagName)||"";
          if(tag==="INPUT"||tag==="TEXTAREA") return;

          if(e.ctrlKey && (e.key==="z"||e.key==="Z")){
            e.preventDefault();
            undo();
            return;
          }

          if(e.key==="Tab"){
            if(toggleProjectOnTab()){
              e.preventDefault();
            }
            return;
          }

          if(e.key==="+"||e.key==="="){
            incFocused(+1);
            e.preventDefault();
            return;
          }
          if(e.key==="-"||e.key==="_"){
            incFocused(-1);
            e.preventDefault();
            return;
          }

          if(e.key==="ArrowUp"||e.key==="ArrowDown"||e.key==="ArrowLeft"||e.key==="ArrowRight"){
            e.preventDefault();
            moveFocusGrid(e.key);
            return;
          }
        }, true);
      }

      function toggleProjectOnTab(){
        ensureUpcallState();
        const projects = state.upcall.projects || [];
        let index = -1;
        if(upProjectFocus!=null && projects[upProjectFocus]){
          index = upProjectFocus;
        }else if(upFocus && projects[upFocus.projectIndex]){
          index = upFocus.projectIndex;
        }
        if(index<0) return false;
        pushUndo();
        const proj = projects[index];
        proj.collapsed = !proj.collapsed;
        saveState();
        render();
        upProjectFocus = index;
        upFocus = null;
        focusPath = [];
        return true;
      }

      // =========================================================
      // Render Tree (mode ‡∏õ‡∏Å‡∏ï‡∏¥)
      function render(){
        renderUpcall();

        treeEl.innerHTML="";
        ensureSumSection();

        state.mains.forEach((main, mi)=>{
          const mainEl = renderMain(main, mi);
          treeEl.appendChild(mainEl);
        });

        saveState();
        highlightFocus();
        updateUpcallHighlight(false);
      }

      function renderMain(main, mi){
        const node = div("node main");
        node.dataset.path = key([mi]);

        const header = div("header");
        const title  = div("title", main.kind==="sum" ? "//////////SUM//////////" : main.title);
        header.appendChild(title);

        const ops = div("row");
        if(main.kind!=="sum"){
          const subName = input("", "‡πÄ‡∏û‡∏¥‡πà‡∏° node ‡∏Ç‡∏±‡πâ‡∏ô 2 (‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤)");
          const modeSel = select([{v:"count",t:"Count"},{v:"text",t:"Text"}]);
          const addBtn  = btn("‡πÄ‡∏û‡∏¥‡πà‡∏°", ()=> {
            const t=(subName.value||"").trim(); if(!t) return tip("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô");
            pushUndo();
            main.children = main.children || [];
            main.children.push(newLevel2Node(t, modeSel.value));
            subName.value="";
            saveState(); render();
          });
          addBtn.title = "‡πÄ‡∏û‡∏¥‡πà‡∏° node ‡∏Ç‡∏±‡πâ‡∏ô 2 ‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏ô‡∏µ‡πâ";
          ops.append(subName, modeSel, addBtn);

          const addCalc = btnGhost("+ Calc", ()=>{
            pushUndo();
            main.children = main.children || [];
            main.children.push(newCalcNode("‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà"));
            saveState(); render();
          });
          addCalc.title = "‡πÄ‡∏û‡∏¥‡πà‡∏° node ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏ô‡∏µ‡πâ";
          ops.appendChild(addCalc);
        }else{
          const addCalc = btn("‡πÄ‡∏û‡∏¥‡πà‡∏° CALC (SUM)", ()=>{
            pushUndo();
            main.children = main.children || [];
            main.children.push(newCalcNode("‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏´‡∏°‡πà"));
            saveState(); render();
          });
          addCalc.title = "‡πÄ‡∏û‡∏¥‡πà‡∏° node ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô SUM";
          ops.appendChild(addCalc);
        }

        const rightOps = div("row");
        if(main.kind!=="sum"){
          const upB = btnGhost("‚Üë", ()=>{ pushUndo(); moveMain(mi,-1); });
          upB.title = "‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏ô‡∏µ‡πâ‡∏Ç‡∏∂‡πâ‡∏ô";
          const downB = btnGhost("‚Üì", ()=>{ pushUndo(); moveMain(mi,+1); });
          downB.title = "‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏ô‡∏µ‡πâ‡∏•‡∏á";
          const delB = btnDanger("‡∏•‡∏ö", ()=>{
            if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å "${main.title}" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\\n‡∏•‡∏π‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£.`)) return;
            pushUndo();
            state.mains.splice(mi,1);
            saveState(); render();
          });
          delB.title = "‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
          rightOps.append(upB, downB, delB);
        }else{
          rightOps.append(div("muted","(‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)"));
        }
        header.append(ops, rightOps);
        node.appendChild(header);

        const childrenWrap = div("children");
        (main.children||[]).forEach((child, si)=>{
          if(child.kind==="calc"){
            childrenWrap.appendChild(renderCalcNode(child, [mi, si]));
          }else{
            childrenWrap.appendChild(renderLevel2(child, [mi, si]));
          }
        });

        node.appendChild(childrenWrap);

        registerFocusable(node, [mi]);
        node.addEventListener("click",(e)=>{
          e.stopPropagation();
          upFocus = null;
          upProjectFocus = null;
          setFocusPath([mi], true);
        });

        return node;
      }

      function renderLevel2(l2, path){
        const node = div("node level2");
        node.dataset.path = key(path);
        if(l2.children && l2.children.length>0) node.classList.add("has-children");

        const head = div("sub-header");
        const title = div("title", l2.title);
        title.title = "‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠";
        title.ondblclick = ()=> renameNode(l2);

        const modeWrap = div("modeWrap");
        const modeSel = select([{v:"count",t:"Count"},{v:"text",t:"Text"}], l2.mode||"count");
        modeSel.title = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö: Count ‡∏´‡∏£‡∏∑‡∏≠ Text";
        modeSel.addEventListener("change", ()=>{
          pushUndo(); l2.mode = modeSel.value; saveState(); render();
        });
        modeWrap.append(modeSel);

        const countWrap = div("countWrap");
        if((l2.mode||"count")==="count"){
          const v = div("count", String(l2.count||0));
          v.title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç";
          v.addEventListener("click", ()=> inlineNumber(v,l2));
          countWrap.append(btnMini("‚àí", ()=>{pushUndo(); inc(l2,-1);}), v, btnMini("+", ()=>{pushUndo(); inc(l2,+1);})); 
        }else{
          const ta = textarea((l2.lines||[]).join("\n"));
          ta.placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡∏ô‡∏±‡∏ö)";
          ta.addEventListener("keydown", e=> e.stopPropagation());
          ta.addEventListener("input", ()=>{
            l2.lines = ta.value.split("\n").map(s=>s.trim()).filter(Boolean);
            saveState();
          });
          countWrap.append(ta);
        }

        if(l2.children && l2.children.length>0){
          modeWrap.style.display="none";
          countWrap.innerHTML="";
          const sum = calcCount(l2);
          countWrap.append(div("badge", "‡∏£‡∏ß‡∏°‡∏•‡∏π‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:"), div("count", String(sum)));
        }

        const leftOps = div("row");
        const upB = btnGhost("‚Üë", ()=>{ pushUndo(); moveChild(getNodeByPath([path[0]]), path, -1); });
        upB.title="‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ô‡∏µ‡πâ‡∏Ç‡∏∂‡πâ‡∏ô";
        const downB = btnGhost("‚Üì", ()=>{ pushUndo(); moveChild(getNodeByPath([path[0]]), path, +1); });
        downB.title="‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ô‡∏µ‡πâ‡∏•‡∏á";
        const delB = btnDanger("‡∏•‡∏ö", ()=>{
          if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${l2.title}" ‡πÅ‡∏•‡∏∞‡∏ó‡∏∏‡∏Å node ‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
          pushUndo();
          const parent = getNodeByPath([path[0]]);
          parent.children.splice(path[1],1);
          saveState(); render();
        });
        delB.title="‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";

        leftOps.append(upB, downB, delB);

        head.append(title, modeWrap, countWrap, leftOps);
        node.appendChild(head);

        const group = div("level3-wrap");
        const addRow = div("row");
        const subName = input("", "‡πÄ‡∏û‡∏¥‡πà‡∏° node ‡∏Ç‡∏±‡πâ‡∏ô 3");
        const subMode = select([{v:"count",t:"Count"},{v:"text",t:"Text"}]);
        const addBtn = btn("‡πÄ‡∏û‡∏¥‡πà‡∏°", ()=>{
          const t=(subName.value||"").trim(); if(!t) return tip("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô");
          pushUndo();
          l2.children = l2.children || [];
          l2.children.push(newLevel3Node(t, subMode.value));
          subName.value="";
          saveState(); render();
        });
        addBtn.title="‡πÄ‡∏û‡∏¥‡πà‡∏° node ‡∏Ç‡∏±‡πâ‡∏ô 3 ‡πÉ‡∏ï‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ô‡∏µ‡πâ";
        const addCalc = btnGhost("+ Calc", ()=>{
          pushUndo();
          l2.children = l2.children || [];
          l2.children.push(newCalcNode("‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà (‡∏¢‡πà‡∏≠‡∏¢)"));
          saveState(); render();
        });
        addCalc.title="‡πÄ‡∏û‡∏¥‡πà‡∏° node ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ô‡∏µ‡πâ";
        addRow.append(subName, subMode, addBtn, addCalc);
        node.appendChild(addRow);

        (l2.children||[]).forEach((leaf, li)=>{
          if(leaf.kind==="calc"){ group.appendChild(renderCalcNode(leaf, [...path, li])); }
          else{ group.appendChild(renderLevel3(leaf, [...path, li])); }
        });
        if((l2.children||[]).length) node.appendChild(group);

        registerFocusable(node, path);
        node.addEventListener("click",(e)=>{
          e.stopPropagation();
          upFocus = null;
          upProjectFocus = null;
          setFocusPath(path,true);
        });

        return node;
      }

      function renderLevel3(l3, path){
        const node = div("node level3");
        node.dataset.path = key(path);

        const head = div("sub-header");
        const title = div("title", l3.title);
        title.title="‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠";
        title.ondblclick = ()=> renameNode(l3);

        const modeWrap = div("modeWrap");
        const modeSel = select([{v:"count",t:"Count"},{v:"text",t:"Text"}], l3.mode||"count");
        modeSel.title = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö: Count ‡∏´‡∏£‡∏∑‡∏≠ Text";
        modeSel.addEventListener("change", ()=>{ pushUndo(); l3.mode=modeSel.value; saveState(); render(); });
        modeWrap.append(modeSel);

        const countWrap = div("countWrap");
        if((l3.mode||"count")==="count"){
          const v = div("count", String(l3.count||0));
          v.title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç";
          v.addEventListener("click", ()=> inlineNumber(v,l3));
          countWrap.append(btnMini("‚àí", ()=>{pushUndo(); inc(l3,-1);}), v, btnMini("+", ()=>{pushUndo(); inc(l3,+1);})); 
        }else{
          const ta = textarea((l3.lines||[]).join("\n"));
          ta.placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡∏ô‡∏±‡∏ö)";
          ta.addEventListener("keydown", e=> e.stopPropagation());
          ta.addEventListener("input", ()=>{
            l3.lines = ta.value.split("\n").map(s=>s.trim()).filter(Boolean);
            saveState();
          });
          countWrap.append(ta);
        }

        const ops = div("row");
        const upB = btnGhost("‚Üë", ()=>{ pushUndo(); moveChild(getNodeByPath([path[0],path[1]]), path, -1); });
        upB.title="‡∏¢‡πâ‡∏≤‡∏¢ node ‡∏ô‡∏µ‡πâ‡∏Ç‡∏∂‡πâ‡∏ô";
        const downB = btnGhost("‚Üì", ()=>{ pushUndo(); moveChild(getNodeByPath([path[0],path[1]]), path, +1); });
        downB.title="‡∏¢‡πâ‡∏≤‡∏¢ node ‡∏ô‡∏µ‡πâ‡∏•‡∏á";
        const delB = btnDanger("‡∏•‡∏ö", ()=>{
          if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${l3.title}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
          pushUndo();
          const parent = getNodeByPath([path[0],path[1]]);
          parent.children.splice(path[2],1);
          saveState(); render();
        });
        delB.title="‡∏•‡∏ö node ‡∏ô‡∏µ‡πâ";
        ops.append(upB, downB, delB);

        head.append(title, modeWrap, countWrap, ops);
        node.appendChild(head);

        registerFocusable(node, path);
        node.addEventListener("click",(e)=>{
          e.stopPropagation();
          upFocus = null;
          upProjectFocus = null;
          setFocusPath(path, true);
        });

        return node;
      }

      function renderCalcNode(calc, path){
        const node = div("node calc");
        node.dataset.path = key(path);

        const head = div("sub-header");
        const title = div("title", calc.title);
        title.title="‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠";
        title.ondblclick = ()=> renameNode(calc);

        const val = evaluateCalc(calc);
        const valueBox = div("count", String(val));

        const formBtn = btnGhost("‡∏™‡∏π‡∏ï‡∏£‚Ä¶", ()=> openFormulaEditor(calc, path));
        formBtn.title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏≠‡∏á node ‡∏ô‡∏µ‡πâ";

        const ops = div("row");
        const parentPath = path.slice(0,-1);
        const parent = getNodeByPath(parentPath);
        const upB = btnGhost("‚Üë", ()=>{ pushUndo(); moveChild(parent, path, -1); });
        upB.title="‡∏¢‡πâ‡∏≤‡∏¢ node ‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡∏Ç‡∏∂‡πâ‡∏ô";
        const downB = btnGhost("‚Üì", ()=>{ pushUndo(); moveChild(parent, path, +1); });
        downB.title="‡∏¢‡πâ‡∏≤‡∏¢ node ‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡∏•‡∏á";
        const delB = btnDanger("‡∏•‡∏ö", ()=>{
          if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${calc.title}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
          pushUndo(); parent.children.splice(path[path.length-1],1); saveState(); render();
        });
        delB.title="‡∏•‡∏ö node ‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ";

        head.append(title, div("formula", formulaText(calc)), valueBox, formBtn, ops);
        node.appendChild(head);

        registerFocusable(node, path);
        node.addEventListener("click",(e)=>{
          e.stopPropagation();
          upFocus = null;
          upProjectFocus = null;
          setFocusPath(path, true);
        });

        return node;
      }

      // =========================================================
      // Formula editor
      function openFormulaEditor(calcObj, path){
        editingCalcObj = calcObj;
        editingParts = (calcObj.formula||[]).map(x=>({nodeId:x.nodeId,sign:x.sign}));

        formulaSourceSel.innerHTML="";
        const nodes = listAllCountableNodes();
        nodes.forEach(n=>{
          const opt=document.createElement("option");
          opt.value=n.id; opt.textContent = n.title;
          formulaSourceSel.appendChild(opt);
        });

        renderFormulaLines();
        formulaModal.showModal();
      }

      function renderFormulaLines(){
        formulaListEl.innerHTML="";
        if(!editingParts.length){
          formulaListEl.appendChild(div("muted","(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÉ‡∏ô‡∏™‡∏π‡∏ï‡∏£)"));
          return;
        }
        editingParts.forEach((p,idx)=>{
          const row = div("formula-line");
          row.append(
            div(null, p.sign>0?"+":"‚àí"),
            div(null, findNodeTitleById(p.nodeId) || "(‡πÑ‡∏°‡πà‡∏û‡∏ö)"),
            btnDanger("‡∏•‡∏ö", ()=>{ editingParts.splice(idx,1); renderFormulaLines(); })
          );
          formulaListEl.appendChild(row);
        });
      }

      function listAllCountableNodes(){
        const out=[];
        state.mains.forEach(m=>{
          (m.children||[]).forEach(c=>{
            if(c.kind==="calc"){ /*skip*/ }
            else{
              out.push({id:c.id, title:`${m.kind==="sum"?"SUM":"Main"} ‚ñ∏ ${c.title}`});
              (c.children||[]).forEach(l3=>{
                if(l3.kind!=="calc") out.push({id:l3.id, title:`${m.kind==="sum"?"SUM":"Main"} ‚ñ∏ ${c.title} ‚ñ∏ ${l3.title}`});
              });
            }
          });
        });
        return out;
      }

      function evaluateCalc(calc){
        const parts = calc.formula||[];
        let sum=0;
        parts.forEach(p=>{
          const node = findNodeById(p.nodeId);
          const val = node ? calcCount(node) : 0;
          sum += (p.sign||1) * val;
        });
        return sum;
      }

      function formulaText(calc){
        const parts = calc.formula||[];
        if(!parts.length) return "‡∏™‡∏π‡∏ï‡∏£: 0";
        return "‡∏™‡∏π‡∏ï‡∏£: " + parts.map(p=>{
          const t = findNodeTitleById(p.nodeId) || "?";
          return (p.sign>0?"+":"‚àí") + t;
        }).join(" ").replace(/^\+/,"");
      }

      // =========================================================
      // Data helpers
      function defaultState(){
        return {
          userName:"",
          reportDate: isoDate(),
          mains: [],
          upcall: defaultUpcall(),
          theme:"dark",
          lastUpdated:null
        };
      }

      function ensureSumSection(){
        const idx = state.mains.findIndex(m=> m.kind==="sum");
        if(idx===-1){
          state.mains.push({ id:uid(), title:"//////////SUM//////////", kind:"sum", children:[] });
        }else if(idx !== state.mains.length-1){
          const x = state.mains.splice(idx,1)[0];
          state.mains.push(x);
        }
      }

      function newLevel2Node(title, mode){
        return { id:uid(), title, kind:"level2", mode:(mode||"count"), count:0, lines:[], children:[] };
      }
      function newLevel3Node(title, mode){
        return { id:uid(), title, kind:"level3", mode:(mode||"count"), count:0, lines:[] };
      }
      function newCalcNode(title){
        return { id:uid(), title, kind:"calc", formula:[] };
      }

      function moveMain(i,dir){
        const ni=i+dir; if(ni<0||ni>=state.mains.length-1) return;
        const x=state.mains.splice(i,1)[0]; state.mains.splice(ni,0,x);
        saveState(); render();
      }
      function moveChild(parent, path, dir){
        const idx = path[path.length-1];
        const ni  = idx+dir;
        if(ni<0 || ni>= (parent.children||[]).length) return;
        const x = parent.children.splice(idx,1)[0];
        parent.children.splice(ni,0,x);
        saveState(); render();
      }

      function inc(node,delta){
        node.count = Math.max(0,(node.count||0)+delta);
        saveState(); render();
      }
      function calcOwn(node){
        if(node.kind==="calc") return evaluateCalc(node);
        const mode = node.mode||"count";
        return (mode==="count") ? (node.count||0) : (node.lines?.length||0);
      }
      function calcCount(node){
        let base = calcOwn(node);
        if(node.children && node.children.length){
          node.children.forEach(ch=>{
            base += calcCount(ch);
          });
        }
        return base;
      }

      function resetCountsOnlyNodeDeep(node){
        if(node.kind==="calc"){/*skip values*/ }
        else{
          if(node.mode==="count") node.count=0;
          else if(node.mode==="text") node.lines=[];
        }
        (node.children||[]).forEach(resetCountsOnlyNodeDeep);
      }

      // =========================================================
      // Focus & Keyboard helpers (‡πÉ‡∏ä‡πâ grid ‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡∏à‡∏≠)
      function registerFocusable(el, path){
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö flat list ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ô error
      }

      function setFocusPath(path, scroll=false){
        focusPath = path.slice();
        upFocus = null;
        upProjectFocus = null;
        updateUpcallHighlight(false);
        highlightFocus(scroll);
      }

      function highlightFocus(scroll=false){
        $$(".node").forEach(n=> n.classList.remove("selected"));
        if(!focusPath.length) return;
        const el = $(`.node[data-path="${key(focusPath)}"]`);
        if(el){
          el.classList.add("selected");
          if(scroll) el.scrollIntoView({block:"nearest",behavior:"smooth"});
        }
      }

      function collectFocusables(){
        const items = [];

        // Tree nodes
        $$(".node", treeEl).forEach(el=>{
          const pathStr = el.dataset.path;
          if(!pathStr) return;
          const rect = el.getBoundingClientRect();
          items.push({
            kind:"node",
            path: pathStr.split(".").map(n=>parseInt(n,10)),
            el,
            cx: rect.left + rect.width/2,
            cy: rect.top + rect.height/2
          });
        });

        if(upProjectsWrapEl){
          // UP Call metric rows
          $$(".up-metric-row", upProjectsWrapEl).forEach(el=>{
            const pi = Number(el.dataset.projectIndex);
            const mi = Number(el.dataset.metricIndex);
            const rect = el.getBoundingClientRect();
            items.push({
              kind:"upMetric",
              projectIndex: pi,
              metricIndex: mi,
              el,
              cx: rect.left + rect.width/2,
              cy: rect.top + rect.height/2
            });
          });

          // Project cards
          $$(".up-project-card", upProjectsWrapEl).forEach(el=>{
            const pi = Number(el.dataset.projectIndex);
            const rect = el.getBoundingClientRect();
            items.push({
              kind:"upProject",
              projectIndex: pi,
              el,
              cx: rect.left + rect.width/2,
              cy: rect.top + rect.height/2
            });
          });
        }

        return items;
      }

      function getCurrentFocusIndex(items){
        if(focusPath.length){
          const k = key(focusPath);
          const idx = items.findIndex(it=> it.kind==="node" && key(it.path)===k);
          if(idx>=0) return idx;
        }
        if(upFocus){
          const idx = items.findIndex(it=> it.kind==="upMetric" && it.projectIndex===upFocus.projectIndex && it.metricIndex===upFocus.metricIndex);
          if(idx>=0) return idx;
        }
        if(upProjectFocus!=null){
          const idx = items.findIndex(it=> it.kind==="upProject" && it.projectIndex===upProjectFocus);
          if(idx>=0) return idx;
        }
        return 0;
      }

      function applyFocusFromItem(item, scroll){
        if(item.kind==="node"){
          setFocusPath(item.path, scroll);
        }else if(item.kind==="upMetric"){
          focusPath = [];
          upProjectFocus = null;
          upFocus = {projectIndex:item.projectIndex, metricIndex:item.metricIndex};
          highlightFocus(false);
          updateUpcallHighlight(scroll);
        }else if(item.kind==="upProject"){
          focusPath = [];
          upFocus = null;
          upProjectFocus = item.projectIndex;
          highlightFocus(false);
          updateUpcallHighlight(scroll);
        }
      }

      function moveFocusGrid(keyDir){
        const items = collectFocusables();
        if(!items.length) return;

        let curIndex = getCurrentFocusIndex(items);
        if(curIndex<0 || curIndex>=items.length) curIndex = 0;
        const current = items[curIndex];

        const curX = current.cx;
        const curY = current.cy;
        const EPS = 4;

        let bestIndex = -1;
        let bestScore = Infinity;

        for(let i=0;i<items.length;i++){
          if(i===curIndex) continue;
          const it = items[i];
          const dx = it.cx - curX;
          const dy = it.cy - curY;

          let inDir = false;
          if(keyDir==="ArrowUp" && dy < -EPS) inDir = true;
          else if(keyDir==="ArrowDown" && dy > EPS) inDir = true;
          else if(keyDir==="ArrowLeft" && dx < -EPS) inDir = true;
          else if(keyDir==="ArrowRight" && dx > EPS) inDir = true;

          if(!inDir) continue;

          const dist = Math.hypot(dx, dy);
          if(dist < bestScore){
            bestScore = dist;
            bestIndex = i;
          }
        }

        if(bestIndex===-1) return;
        applyFocusFromItem(items[bestIndex], true);
      }

      function incFocused(delta){
        const items = collectFocusables();
        if(!items.length) return;
        const idx = getCurrentFocusIndex(items);
        const cur = items[Math.max(0, idx)];
        if(cur.kind==="node"){
          const node = getNodeByPath(cur.path);
          if(!node || node.kind==="calc") return;
          if(node.mode && node.mode!=="count") return;
          pushUndo();
          inc(node, delta);
        }else if(cur.kind==="upMetric"){
          pushUndo();
          changeUpMetric(cur.projectIndex, cur.metricIndex, delta);
        }
      }

      // =========================================================
      // Inline editors & rename
      function inlineNumber(host, node){
        const old = node.count||0;
        const inp = document.createElement("input");
        inp.type="number"; inp.value=String(old);
        host.innerHTML=""; host.appendChild(inp); inp.focus(); inp.select();
        inp.addEventListener("keydown",(e)=>{ e.stopPropagation(); if(e.key==="Enter") commit(); if(e.key==="Escape") cancel(); });
        inp.addEventListener("blur",commit);
        function commit(){ pushUndo(); node.count=Math.max(0,parseInt(inp.value||"0",10)); saveState(); render(); }
        function cancel(){ render(); }
      }
      function renameNode(node){
        const nv=prompt("‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠:", node.title);
        if(!nv) return;
        pushUndo(); node.title=nv.trim(); saveState(); render();
      }

      // =========================================================
      // Report builder
      function buildReport(){
        const name = (state.userName||"PHANToM").trim();
        const d = dateEl.value ? new Date(dateEl.value): new Date();
        const header = `${name} ${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;

        const out = [header,""];

        const upLines = buildUpcallSectionLines();
        if(upLines.length){
          out.push(...upLines,"");
        }

        state.mains.forEach(m=>{
          if(m.kind==="sum") return;
          out.push(`////////// ${m.title} //////////`);
          (m.children||[]).forEach(l2=>{
            if(l2.kind==="calc"){
              out.push(`[ ${l2.title} ${evaluateCalc(l2)} ]`);
            }else{
              const total = calcCount(l2);
              out.push(`${l2.title} ${total}`);
              if((l2.mode==="text") && (!l2.children || !l2.children.length)){
                (l2.lines||[]).forEach(t=> out.push(t));
              }
              (l2.children||[]).forEach(l3=>{
                if(l3.kind==="calc"){
                  out.push(`- ${l3.title} ${evaluateCalc(l3)}`);
                }else{
                  const cnt = calcCount(l3);
                  out.push(`- ${l3.title} ${cnt}`);
                  if(l3.mode==="text"){
                    (l3.lines||[]).forEach(t=> out.push(`  ${t}`));
                  }
                }
              });
            }
            out.push("");
          });
        });

        out.push("//////////SUM//////////");
        const sumMain = state.mains.find(m=> m.kind==="sum");
        (sumMain.children||[]).forEach(calc=>{
          const v=evaluateCalc(calc);
          out.push(`${calc.title} ${v}`);
        });

        return out.join("\n");
      }

      // =========================================================
      // Undo
      function pushUndo(clearNext=false){
        if(clearNext) undoStack.length=0;
        if(undoStack.length>50) undoStack.shift();
        undoStack.push(JSON.stringify(state));
      }
      function undo(){
        if(undoStack.length===0){ tip("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤"); return; }
        const snap = undoStack.pop();
        try{
          state = JSON.parse(snap);
          state.theme = state.theme || "dark";
          ensureSumSection();
          ensureUpcallState();
          applyTheme(state.theme);
          saveState(); render();
          tip("‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß",true);
        }catch{
          tip("‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
      }

      // =========================================================
      // Lookup & helpers
      function getNodeByPath(path){
        if(!path || !path.length) return null;
        let cur = state.mains[path[0]];
        for(let i=1;i<path.length;i++){
          cur = (cur && cur.children) ? cur.children[path[i]] : null;
        }
        return cur||null;
      }
      function findNodeById(id){
        let found=null;
        state.mains.some(m=>{
          if(m.id===id){ found=m; return true; }
          (m.children||[]).some(c=>{
            if(c.id===id){ found=c; return true; }
            (c.children||[]).some(l3=>{
              if(l3.id===id){ found=l3; return true; }
              return false;
            });
            return !!found;
          });
          return !!found;
        });
        return found;
      }
      function findNodeTitleById(id){
        const n=findNodeById(id); return n?n.title:null;
      }

      // =========================================================
      // Small DOM makers
      function div(cls, txt){ const x=document.createElement("div"); if(cls) x.className=cls; if(txt!=null) x.textContent=txt; return x; }
      function input(val="", placeholder=""){ const x=document.createElement("input"); x.type="text"; x.value=val; x.placeholder=placeholder; return x; }
      function textarea(val=""){ const x=document.createElement("textarea"); x.className="textbox"; x.value=val; return x; }
      function select(opts, val){
        const s=document.createElement("select");
        opts.forEach(o=>{ const op=document.createElement("option"); op.value=o.v; op.textContent=o.t; s.appendChild(op); });
        if(val!=null) s.value=val;
        return s;
      }
      function btn(t,fn){ const b=document.createElement("button"); b.className="btn"; b.textContent=t; b.onclick=(e)=>{ e.stopPropagation(); fn&&fn(); }; return b; }
      function btnGhost(t,fn){ const b=document.createElement("button"); b.className="ghost"; b.textContent=t; b.onclick=(e)=>{ e.stopPropagation(); fn&&fn(); }; return b; }
      function btnDanger(t,fn){ const b=document.createElement("button"); b.className="danger"; b.textContent=t; b.onclick=(e)=>{ e.stopPropagation(); fn&&fn(); }; return b; }
      function btnMini(t,fn){ const b=document.createElement("button"); b.className="mini"; b.textContent=t; b.onclick=(e)=>{ e.stopPropagation(); fn&&fn(); }; return b; }

      // =========================================================
      // Persist & misc
      function saveState(){
        state.lastUpdated = new Date().toISOString();
        localStorage.setItem(LS_KEY, JSON.stringify(state));
        updateLastUpdated();
      }
      function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"null"); }catch{ return null; } }
      function isoDate(){ const d=new Date(); return d.toISOString().split("T")[0]; }
      function pad2(n){ return String(n).padStart(2,"0"); }
      function key(path){ return path.join("."); }
      function tip(t, ok=false){
        if(!toastEl) return;
        toastEl.textContent=t;
        toastEl.style.borderColor=ok?"var(--ok)":"var(--pri)";
        toastEl.classList.add("show");
        setTimeout(()=>toastEl.classList.remove("show"),1300);
      }
      async function copy(text){
        try{
          await navigator.clipboard.writeText(text);
        }catch{
          const ta=document.createElement("textarea");
          ta.value=text; document.body.appendChild(ta); ta.select();
          document.execCommand("copy"); ta.remove();
        }
      }
      function uid(){ return Math.random().toString(36).slice(2,9); }
    })();
  </script>
</body>
</html>
