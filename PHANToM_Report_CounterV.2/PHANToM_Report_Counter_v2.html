<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PHANToM Report Counter v2</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* =======================================================
       PHANToM Report Counter ‚Äî Aurora 2025
       3-Level + Calc + UP Call Mode (Multi-project)
       ======================================================= */

    :root{
      --bg:#0b1220; --panel:#111b30; --edge:#243353; --txt:#e5e7eb; --muted:#8fa1c6;
      --pri:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --card-radius:12px; --shadow:0 8px 28px rgba(0,0,0,.25);
    }

    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--txt);
      font-family:"Prompt",system-ui,sans-serif;
      min-height:100vh; display:flex; flex-direction:column;
    }

    /* Header */
    header{
      background:linear-gradient(90deg,#0f182a,#152238);
      padding:12px 18px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      border-bottom:1px solid #223;
    }
    header input, header select{
      background:#1a2238; border:1px solid #334; color:var(--txt);
      border-radius:8px; padding:8px 10px; font-size:.95rem;
    }

    /* Buttons */
    button{border:none;border-radius:10px;padding:8px 12px;font-size:.95rem;cursor:pointer;transition:.2s ease}
    button:hover{opacity:.92;transform:translateY(-1px)}
    .btn{background:var(--pri);color:#fff}
    .ghost{background:#1a2238;color:var(--muted);border:1px solid #334}
    .warn{background:var(--warn);color:#000}
    .danger{background:var(--err);color:#fff}
    .mini{background:#1c2a44;color:var(--txt);border:1px solid #334;width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;line-height:0}

    /* UP Call section */
    #upcallSection{
      padding:10px 18px 12px;
      border-bottom:1px solid #223;
      background:linear-gradient(90deg,#0a1324,#0b172a);
    }
    #upcallSection .head{
      display:flex;align-items:baseline;gap:8px;flex-wrap:wrap;margin-bottom:6px;
    }
    #upcallSection .head-title{
      font-weight:700;font-size:1rem;
    }
    #upcallSection .head-note{
      font-size:.8rem;color:var(--muted);
    }
    #upcallSection .up-row{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;
    }
    #upProjects{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:10px;
    }
    .up-project-card{
      background:var(--panel);
      border-radius:var(--card-radius);
      border:1px solid var(--edge);
      box-shadow:var(--shadow);
      padding:8px 10px;
    }
    .up-project-header{
      display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap;
    }
    .up-project-header input{
      flex:1;
      background:#1a2238;border:1px solid #334;color:var(--txt);
      border-radius:8px;padding:6px 8px;font-size:.9rem;
    }

    .up-metric-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:4px;
    }
    .up-metric-row{
      display:flex;align-items:center;justify-content:space-between;gap:6px;
      font-size:.8rem;
      border-radius:8px;
      padding:2px 4px;
      cursor:pointer;
    }
    .up-metric-row.selected{
      background:rgba(59,130,246,0.12);
      box-shadow:0 0 0 1px rgba(59,130,246,0.4);
    }
    .up-metric-row .metric-label{
      max-width:60%;
    }
    @media (min-width:900px){
      .up-metric-grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }

    /* Tree board (mode ‡∏õ‡∏Å‡∏ï‡∏¥) */
    #tree{padding:16px 18px;display:flex;flex-direction:column;gap:16px;flex:1}

    /* Node shells */
    .node{background:var(--panel);border:1px solid var(--edge);border-radius:var(--card-radius);box-shadow:var(--shadow);transition:.2s ease}
    .node.selected{border-color:var(--pri);box-shadow:0 0 0 2px rgba(59,130,246,.35)}
    .node .header, .node .sub-header{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    /* Main node = sheet */
    .node.main{
      background:linear-gradient(180deg,#101b33,#0a0f1f);
      border:2px solid var(--pri);
      padding:18px 20px; border-radius:16px;
    }
    .node.main .title{font-weight:800;font-size:1.05rem}
    .node.main .children{margin-top:8px}

    /* Level2 node = paragraph bar */
    .node.level2{padding:12px;border-radius:12px;margin:8px 0}
    .node.level2 .title{font-weight:700}
    .node.level2 .children{margin-top:6px}
    .node.level2.has-children .modeWrap{display:none}

    /* Level3 node = small boxes grid */
    .level3-wrap{display:flex;flex-wrap:wrap;gap:8px}
    .node.level3{
      display:inline-flex;flex-direction:column;gap:6px;
      background:#1a2238;border:1px solid var(--edge);
      border-radius:10px;padding:8px 10px;min-width:200px;max-width:520px;resize:both;overflow:auto;
    }

    /* Calc node */
    .node.calc{background:linear-gradient(180deg,#163a36,#0f2724);border:2px solid var(--ok)}
    .node.calc .formula{background:rgba(0,0,0,.25);border:1px solid #2c5;color:#9ef3c8;padding:6px 8px;border-radius:8px;font-family:ui-monospace,Consolas,monospace}

    /* SUM Section (bottom fixed) */
    .node.sum{border-top:2px dashed var(--pri);padding-top:18px;margin-top:8px}
    .node.sum .title{font-weight:800}

    /* Common bits */
    .title{min-width:120px}
    .badge{font-size:.8rem;background:#1a2238;color:var(--muted);padding:3px 8px;border-radius:6px}
    .countWrap{display:flex;align-items:center;gap:8px;flex:1}
    .modeWrap{display:flex;align-items:center;gap:8px}
    .count{background:#1a2238;border:1px solid #334;border-radius:8px;padding:6px 12px;min-width:42px;text-align:center;cursor:pointer}
    .textbox{
      width:100%;min-height:120px;resize:vertical;background:rgba(15,25,45,.95);
      border:1px solid #334;border-radius:8px;color:var(--txt);padding:10px 12px;font-size:.95rem;line-height:1.5;
    }
    .textbox:focus{border-color:var(--pri);box-shadow:0 0 0 2px rgba(59,130,246,.35)}

    .row{display:flex;align-items:center;gap:8px;margin-top:8px}
    .row input,.row select{background:#1a2238;border:1px solid #334;color:var(--txt);border-radius:8px;padding:6px 10px}

    /* Formula modal */
    .modal{border:none;border-radius:16px;padding:0;max-width:680px;width:calc(100% - 24px);background:#0e172e;color:var(--txt)}
    .modal::backdrop{background:rgba(0,0,0,.45)}
    .modal-card{padding:0}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--edge)}
    .modal-body{padding:12px 14px;display:flex;flex-direction:column;gap:10px}
    .modal-foot{padding:12px 14px;border-top:1px solid var(--edge);display:flex;justify-content:flex-end}
    .formula-line{display:flex;gap:8px;align-items:center}
    .formula-list{display:flex;flex-direction:column;gap:6px}
    .muted{color:var(--muted);font-size:.9rem}

    /* Toast */
    #toast{
      position:fixed;left:50%;bottom:18px;transform:translate(-50%,24px);
      background:#0f1b2d;border:1px solid var(--pri);color:#fff;padding:8px 14px;border-radius:10px;opacity:0;transition:.25s ease
    }
    #toast.show{opacity:1;transform:translate(-50%,0)}

    @media (max-width:900px){
      .level3-wrap{gap:10px}
    }
  </style>
</head>
<body>

  <header>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <strong style="letter-spacing:.5px">PHANToM Report Counter</strong>
      <input id="userName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÄ‡∏ä‡πà‡∏ô Stang)" />
      <input id="reportDate" type="date" />
      <button id="copyReport" class="btn">üìÑ Copy Report</button>
    </div>

    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input id="newMainTitle" type="text" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å (‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÉ‡∏´‡∏°‡πà)" />
      <button id="addMain" class="btn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å</button>

      <button id="addCalcToRoot" class="ghost" title="‡πÄ‡∏û‡∏¥‡πà‡∏° Calculate Node ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å">+ Calc (Main)</button>

      <button id="exportSettings" class="ghost" title="Export ‡πÄ‡∏õ‡πá‡∏ô .txt">‚§ì Export</button>
      <label class="ghost" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
        ‚§í Import
        <input id="importSettings" type="file" accept=".txt" hidden>
      </label>

      <button id="resetCounts" class="warn">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</button>
      <button id="resetAll" class="danger">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
  </header>

  <!-- UP Call Mode Section -->
  <section id="upcallSection">
    <div class="head">
      <div class="head-title">UP Call Mode</div>
      <div class="head-note">
        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£ ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: 17/144/18/33/8=220<br>
        ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏Å‡∏±‡∏™ ‚Üí ‡πÉ‡∏ä‡πâ‡∏•‡∏π‡∏Å‡∏®‡∏£ (‚Üë ‚Üì ‚Üê ‚Üí) ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏° + / ‚àí ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥
      </div>
    </div>
    <div class="up-row">
      <input id="upProjectName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î / ‡∏ï‡∏∂‡∏Å" />
      <button id="upAddProject" class="btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</button>
      <button id="upResetUpcall" class="ghost">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï UP Call ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>
    <div id="upProjects"></div>
  </section>

  <main id="tree"></main>

  <!-- Formula Modal -->
  <dialog id="formulaModal" class="modal">
    <form method="dialog" class="modal-card" id="formulaForm">
      <header class="modal-head">
        <h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Calculate Node)</h3>
        <button id="formulaClose" class="mini" value="cancel" type="button">‚úñ</button>
      </header>
      <section class="modal-body">
        <div class="muted" style="margin-bottom:8px">
          ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ + ‡∏´‡∏£‡∏∑‡∏≠ ‚àí (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á Node ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
        </div>
        <div id="formulaList" class="formula-list"></div>
        <div class="row">
          <select id="formulaSource"></select>
          <select id="formulaSign">
            <option value="+">+</option>
            <option value="-">‚àí</option>
          </select>
          <button id="formulaAdd" type="button" class="btn">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
        <div class="muted" style="margin-top:10px">
          * ‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö: Œ£(sign √ó ‡∏Ñ‡πà‡∏≤) ‡πÇ‡∏î‡∏¢‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ node ‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á (count/text) + ‡∏•‡∏π‡∏Å‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô
        </div>
      </section>
      <footer class="modal-foot">
        <button id="formulaSave" type="button" class="btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£</button>
      </footer>
    </form>
  </dialog>

  <div id="toast">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>

  <script>
    (function(){
      const $ = (s,c=document)=>c.querySelector(s);
      const $$ = (s,c=document)=>Array.from(c.querySelectorAll(s));

      // ---- DOM ----
      const treeEl = $("#tree");
      const userNameEl = $("#userName");
      const dateEl = $("#reportDate");
      const copyBtn = $("#copyReport");
      const addMainBtn = $("#addMain");
      const newMainTitleEl = $("#newMainTitle");
      const addCalcToRootBtn = $("#addCalcToRoot");
      const exportBtn = $("#exportSettings");
      const importInput = $("#importSettings");
      const resetCountsBtn = $("#resetCounts");
      const resetAllBtn = $("#resetAll");

      const formulaModal = $("#formulaModal");
      const formulaListEl = $("#formulaList");
      const formulaSourceSel = $("#formulaSource");
      const formulaSignSel = $("#formulaSign");
      const formulaAddBtn = $("#formulaAdd");
      const formulaSaveBtn = $("#formulaSave");
      const formulaCloseBtn = $("#formulaClose");

      const toastEl = $("#toast");

      // UP Call DOM
      const upProjectNameEl = $("#upProjectName");
      const upAddProjectBtn = $("#upAddProject");
      const upProjectsWrapEl = $("#upProjects");
      const upResetUpcallBtn = $("#upResetUpcall");

      // ---- Storage ----
      const LS_KEY = "PHANTOM_REPORT_STATE_V5";

      // ---- UP Call metrics definition ----
      const upMetrics = [
        { id:"calls",           label:"‡πÇ‡∏ó‡∏£‡∏Å‡∏µ‡πà‡∏™‡∏≤‡∏¢",              group:"all" },
        { id:"nv_to_v",         label:"‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏á",      group:"reachable" },
        { id:"v_to_nv",         label:"‡∏à‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á",      group:"reachable" },
        { id:"v_still_v",       label:"‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà",   group:"reachable" },
        { id:"nv_still_nv",     label:"‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á", group:"reachable" },
        { id:"sold",            label:"‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß",                group:"reachable" },
        { id:"wrong_number",    label:"‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏¥‡∏î",               group:"reachable" },
        { id:"owner_self",      label:"‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏≠‡∏á",          group:"reachable" },
        { id:"no_agent",        label:"‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö Agent",            group:"reachable" },
        { id:"renovate",        label:"‡∏£‡∏µ‡πÇ‡∏ô‡πÄ‡∏ß‡∏ó",                group:"reachable" },
        { id:"not_release",     label:"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Ç‡∏≤‡∏¢/‡πÄ‡∏ä‡πà‡∏≤",     group:"reachable" },
        { id:"reserved",        label:"‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏á",                 group:"reachable" },
        { id:"no_answer",       label:"‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢",               group:"unreachable" },
        { id:"phone_off",       label:"‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á",              group:"unreachable" },
        { id:"not_convenient",  label:"‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏Ñ‡∏∏‡∏¢",             group:"unreachable" }
      ];

      // ---- State ----
      let state = loadState() || defaultState();
      ensureSumSection();
      ensureUpcallState();
      let focusPath = [];
      let flatFocus = [];
      let undoStack = [];
      let upFocus = null;

      // temp formula
      let editingCalcObj = null;
      let editingParts = [];

      // ---- Init ----
      initHeader();
      initUpcall();
      initKeyboard();
      render();

      // =========================================================
      // Header & top actions
      function initHeader(){
        userNameEl.value = state.userName || "";
        userNameEl.addEventListener("input", ()=>{
          state.userName = userNameEl.value.trim();
          saveState();
        });

        if(!state.reportDate){
          dateEl.valueAsDate = new Date();
          state.reportDate = isoDate();
        }else{
          dateEl.value = state.reportDate;
        }
        dateEl.addEventListener("change", ()=>{
          state.reportDate = dateEl.value || isoDate();
          saveState();
        });

        copyBtn.addEventListener("click", ()=>{
          const t=buildReport();
          copy(t).then(()=>tip("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß",true));
        });

        addMainBtn.addEventListener("click", ()=>{
          const t = (newMainTitleEl.value||"").trim();
          if(!t){ tip("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô"); return; }
          pushUndo();
          state.mains.push({ id:uid(), title:t, kind:"main", children:[] });
          newMainTitleEl.value="";
          saveState(); render();
        });

        addCalcToRootBtn.addEventListener("click", ()=>{
          pushUndo();
          state.mains.push(newCalcNode("‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà (Main)"));
          saveState(); render();
          tip("‡πÄ‡∏û‡∏¥‡πà‡∏° Calculate Node ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å", true);
        });

        exportBtn.addEventListener("click", ()=>{
          const blob = new Blob([JSON.stringify(state,null,2)],{type:"text/plain;charset=utf-8"});
          const a=document.createElement("a");
          a.href=URL.createObjectURL(blob); a.download="PHANToM_Report_Counter_Settings.txt"; a.click();
          setTimeout(()=>URL.revokeObjectURL(a.href),500);
          tip("Export ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",true);
        });

        importInput.addEventListener("change",(e)=>{
          const f=e.target.files && e.target.files[0]; if(!f) return;
          const r=new FileReader();
          r.onload=(ev)=>{
            try{
              const obj=JSON.parse(String(ev.target.result||"{}"));
              if(!obj || !Array.isArray(obj.mains)) throw new Error("invalid");
              pushUndo(true);
              state=obj;
              ensureSumSection();
              ensureUpcallState();
              saveState(); render(); tip("Import ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",true);
            }catch{
              tip("‡πÑ‡∏ü‡∏•‡πå .txt ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            }
            importInput.value="";
          };
          r.readAsText(f);
        });

        resetCountsBtn.addEventListener("click", ()=>{
          if(!confirm("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÅ‡∏ï‡πà‡∏Ñ‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á)?")) return;
          pushUndo();
          state.mains.forEach(resetCountsOnlyNodeDeep);
          resetUpcallCounts();
          saveState(); render(); tip("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß",true);
        });

        resetAllBtn.addEventListener("click", ()=>{
          if(!confirm("‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á?")) return;
          pushUndo();
          state = defaultState();
          ensureSumSection();
          ensureUpcallState();
          upFocus = null;
          saveState(); render(); tip("‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß",true);
        });

        formulaCloseBtn.addEventListener("click", ()=> formulaModal.close());
        formulaAddBtn.addEventListener("click", ()=>{
          const id = formulaSourceSel.value; if(!id) return;
          const sign = (formulaSignSel.value==="-") ? -1 : +1;
          editingParts.push({nodeId:id, sign});
          renderFormulaLines();
        });
        formulaSaveBtn.addEventListener("click", ()=>{
          if(!editingCalcObj) return;
          pushUndo();
          editingCalcObj.formula = editingParts.slice();
          saveState(); render(); formulaModal.close(); tip("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡πâ‡∏ß",true);
        });
      }

      // =========================================================
      // UP Call init & helpers
      function initUpcall(){
        if(upAddProjectBtn){
          upAddProjectBtn.addEventListener("click", addUpProjectFromInput);
        }
        if(upProjectNameEl){
          upProjectNameEl.addEventListener("keydown",(e)=>{
            if(e.key==="Enter"){
              e.preventDefault();
              addUpProjectFromInput();
            }
          });
        }
        if(upResetUpcallBtn){
          upResetUpcallBtn.addEventListener("click", ()=>{
            if(!confirm("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£ (UP Call) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ?")) return;
            pushUndo();
            resetUpcallCounts();
            saveState();
            render();
            tip("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï UP Call ‡πÅ‡∏•‡πâ‡∏ß",true);
          });
        }

        if(upProjectsWrapEl){
          upProjectsWrapEl.addEventListener("click",(e)=>{
            const metricRow = e.target.closest(".up-metric-row");
            if(metricRow){
              const pi = Number(metricRow.dataset.projectIndex);
              const mi = Number(metricRow.dataset.metricIndex);
              if(!Number.isNaN(pi) && !Number.isNaN(mi)){
                upFocus = {projectIndex:pi, metricIndex:mi};
                focusPath = [];
                highlightFocus(false);
                updateUpcallHighlight(true);
              }
            }

            const metricMove = e.target.closest("button[data-role='up-move-metric']");
            if(metricMove){
              const dir = Number(metricMove.dataset.dir);
              const idx = Number(metricMove.dataset.metricIndex);
              if(!Number.isNaN(idx) && (dir===-1 || dir===1)){
                pushUndo();
                moveUpMetric(idx, dir);
                saveState();
                render();
              }
              return;
            }

            const btn = e.target.closest("button[data-upaction]");
            if(btn){
              const projIndex = Number(btn.dataset.projectIndex);
              const metricId = btn.dataset.metricId;
              const action = btn.dataset.upaction;
              const projects = (state.upcall && state.upcall.projects) || [];
              const proj = projects[projIndex];
              if(!proj) return;
              if(!proj.metrics) proj.metrics={};
              const cur = Number(proj.metrics[metricId] || 0);
              pushUndo();
              if(action==="inc") proj.metrics[metricId] = cur+1;
              else if(action==="dec") proj.metrics[metricId] = Math.max(0,cur-1);
              saveState();
              render();
              return;
            }

            const delBtn = e.target.closest("button[data-role='up-del-project']");
            if(delBtn){
              const idx = Number(delBtn.dataset.index);
              if(Number.isNaN(idx)) return;
              if(!confirm(`‡∏•‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ "${state.upcall.projects[idx]?.name||""}" ?`)) return;
              pushUndo();
              state.upcall.projects.splice(idx,1);
              saveState();
              render();
              return;
            }

            const moveBtn = e.target.closest("button[data-role='up-move-project']");
            if(moveBtn){
              const idx = Number(moveBtn.dataset.index);
              const dir = Number(moveBtn.dataset.dir);
              pushUndo();
              moveUpProject(idx, dir);
              saveState();
              render();
              return;
            }
          });

          upProjectsWrapEl.addEventListener("input",(e)=>{
            const inp = e.target.closest("input[data-role='up-project-name']");
            if(inp){
              const idx = Number(inp.dataset.index);
              const projects = (state.upcall && state.upcall.projects) || [];
              const proj = projects[idx];
              if(!proj) return;
              proj.name = inp.value;
              saveState();
            }
          });
        }
      }

      function addUpProjectFromInput(){
        const name = (upProjectNameEl.value||"").trim();
        if(!name){
          tip("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô");
          return;
        }
        pushUndo();
        ensureUpcallState();
        state.upcall.projects.push({
          id: uid(),
          name,
          metrics: createEmptyUpMetrics()
        });
        upProjectNameEl.value="";
        saveState();
        render();
      }

      function defaultUpcall(){
        return { projects: [], order: upMetrics.map(m=>m.id) };
      }

      function ensureUpcallState(){
        if(!state.upcall) state.upcall = defaultUpcall();
        if(!Array.isArray(state.upcall.projects)) state.upcall.projects = [];

        if(!Array.isArray(state.upcall.order) || !state.upcall.order.length){
          state.upcall.order = upMetrics.map(m=>m.id);
        }

        state.upcall.projects.forEach(p=>{
          if(!p.metrics) p.metrics = {};
          upMetrics.forEach(m=>{
            if(typeof p.metrics[m.id]!=="number") p.metrics[m.id]=0;
          });
        });
      }

      function createEmptyUpMetrics(){
        const obj={};
        upMetrics.forEach(m=>{ obj[m.id]=0; });
        return obj;
      }

      function resetUpcallCounts(){
        ensureUpcallState();
        state.upcall.projects.forEach(p=>{
          if(!p.metrics) p.metrics={};
          upMetrics.forEach(m=>{ p.metrics[m.id]=0; });
        });
      }

      function moveUpProject(i,dir){
        ensureUpcallState();
        const arr = state.upcall.projects;
        const ni = i+dir;
        if(ni<0 || ni>=arr.length) return;
        const x = arr.splice(i,1)[0];
        arr.splice(ni,0,x);
      }

      function moveUpMetric(idx,dir){
        ensureUpcallState();
        const order = state.upcall.order || (state.upcall.order = upMetrics.map(m=>m.id));
        const ni = idx + dir;
        if(ni<0 || ni>=order.length) return;
        const x = order.splice(idx,1)[0];
        order.splice(ni,0,x);
      }

      function renderUpcall(){
        ensureUpcallState();
        if(!upProjectsWrapEl) return;
        const projects = state.upcall.projects || [];

        if(upFocus){
          if(upFocus.projectIndex >= projects.length) upFocus = null;
          else{
            const metricLen = state.upcall.order.length || upMetrics.length;
            if(upFocus.metricIndex >= metricLen){
              upFocus.metricIndex = metricLen-1;
            }
          }
        }

        upProjectsWrapEl.innerHTML="";
        if(!projects.length){
          const msg = div("muted","‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UP Call ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô");
          upProjectsWrapEl.appendChild(msg);
          return;
        }

        const order = state.upcall.order && state.upcall.order.length
          ? state.upcall.order
          : upMetrics.map(m=>m.id);

        projects.forEach((p,idx)=>{
          const card = div("up-project-card");
          const header = div("up-project-header");
          const label = div("muted","‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£");
          const nameInput = input(p.name||"", "‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£");
          nameInput.dataset.role="up-project-name";
          nameInput.dataset.index=idx;

          const moveUpBtn = btnGhost("‚Üë", ()=>{
            pushUndo();
            moveUpProject(idx,-1);
            saveState(); render();
          });
          moveUpBtn.dataset.role="up-move-project";
          moveUpBtn.dataset.index=idx;
          moveUpBtn.dataset.dir=-1;

          const moveDownBtn = btnGhost("‚Üì", ()=>{
            pushUndo();
            moveUpProject(idx,+1);
            saveState(); render();
          });
          moveDownBtn.dataset.role="up-move-project";
          moveDownBtn.dataset.index=idx;
          moveDownBtn.dataset.dir=1;

          const delBtn = btnDanger("‡∏•‡∏ö", ()=>{});
          delBtn.dataset.role="up-del-project";
          delBtn.dataset.index=idx;

          header.append(label, nameInput, moveUpBtn, moveDownBtn, delBtn);
          card.appendChild(header);

          const grid = div("up-metric-grid");

          order.forEach((metricId,mi)=>{
            const m = upMetrics.find(mm=>mm.id===metricId);
            if(!m) return;

            const row = div("up-metric-row");
            row.dataset.projectIndex = idx;
            row.dataset.metricIndex = mi;

            const moveBox = div("row");
            moveBox.style.marginTop = "0";

            const upBtn = document.createElement("button");
            upBtn.className = "mini";
            upBtn.textContent = "‚Üë";
            upBtn.dataset.role = "up-move-metric";
            upBtn.dataset.metricIndex = mi;
            upBtn.dataset.dir = "-1";

            const downBtn = document.createElement("button");
            downBtn.className = "mini";
            downBtn.textContent = "‚Üì";
            downBtn.dataset.role = "up-move-metric";
            downBtn.dataset.metricIndex = mi;
            downBtn.dataset.dir = "1";

            moveBox.append(upBtn,downBtn);

            const labelSpan = div("metric-label", m.label);
            const left = div();
            left.style.display="flex";
            left.style.alignItems="center";
            left.style.gap="4px";
            left.append(moveBox,labelSpan);

            const controls = div("countWrap");
            const decBtn = document.createElement("button");
            decBtn.className="mini";
            decBtn.textContent="‚àí";
            decBtn.dataset.upaction="dec";
            decBtn.dataset.projectIndex=idx;
            decBtn.dataset.metricId=m.id;

            const val = div("count", String(p.metrics && typeof p.metrics[m.id]==="number" ? p.metrics[m.id] : 0));

            const incBtn = document.createElement("button");
            incBtn.className="mini";
            incBtn.textContent="+";
            incBtn.dataset.upaction="inc";
            incBtn.dataset.projectIndex=idx;
            incBtn.dataset.metricId=m.id;

            controls.append(decBtn,val,incBtn);

            row.append(left,controls);
            grid.appendChild(row);
          });

          card.appendChild(grid);
          upProjectsWrapEl.appendChild(card);
        });

        updateUpcallHighlight(false);
      }

      function updateUpcallHighlight(scroll=false){
        if(!upProjectsWrapEl) return;
        const rows = $$(".up-metric-row", upProjectsWrapEl);
        rows.forEach(row=>{
          const pi = Number(row.dataset.projectIndex);
          const mi = Number(row.dataset.metricIndex);
          const sel = upFocus && upFocus.projectIndex===pi && upFocus.metricIndex===mi;
          row.classList.toggle("selected", !!sel);
          if(sel && scroll){
            row.scrollIntoView({block:"nearest", behavior:"smooth"});
          }
        });
      }

      function valuesForMetric(metricId){
        const projects = state.upcall.projects || [];
        return projects.map(p => (p.metrics && p.metrics[metricId]) || 0);
      }

      function buildUpcallSectionLines(){
        ensureUpcallState();
        const projects = state.upcall.projects || [];
        if(!projects.length) return [];
        const lines = [];

        projects.forEach(p=> lines.push(p.name || "(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£)"));
        if(projects.length) lines.push("");

        const sumArr = (arr)=> arr.reduce((a,b)=>a+b,0);

        const reachableVals = projects.map(p=>{
          let s=0;
          upMetrics.forEach(m=>{
            if(m.group==="reachable"){
              s += (p.metrics && p.metrics[m.id]) || 0;
            }
          });
          return s;
        });

        const order = state.upcall.order && state.upcall.order.length
          ? state.upcall.order
          : upMetrics.map(m=>m.id);

        const specs = [];
        order.forEach(mid=>{
          if(mid==="calls"){
            specs.push({type:"metric", id:"calls", label:"‡πÇ‡∏ó‡∏£‡∏Å‡∏µ‡πà‡∏™‡∏≤‡∏¢"});
            specs.push({type:"reachable", id:"reachable", label:"‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ"});
          }else{
            const m = upMetrics.find(mm=>mm.id===mid);
            if(m){
              specs.push({type:"metric", id:mid, label:m.label});
            }
          }
        });

        specs.forEach(spec=>{
          let vals;
          if(spec.type==="reachable") vals = reachableVals;
          else vals = valuesForMetric(spec.id);
          const total = sumArr(vals);
          lines.push(`${spec.label} : ${vals.join("/")}=${total}`);
        });

        return lines;
      }

      // =========================================================
      // Keyboard (global)
      function initKeyboard(){
        document.addEventListener("keydown",(e)=>{
          const tag=(document.activeElement && document.activeElement.tagName)||"";
          if(tag==="INPUT"||tag==="TEXTAREA") return;

          if(e.ctrlKey && (e.key==="z"||e.key==="Z")){ e.preventDefault(); undo(); return; }

          if(upFocus && ["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","+","=","-","_"].includes(e.key)){
            e.preventDefault();
            handleUpcallKey(e.key);
            return;
          }

          if(e.key==="+"||e.key==="="){ incFocused(+1); e.preventDefault(); return; }
          if(e.key==="-"||e.key==="_"){ incFocused(-1); e.preventDefault(); return; }

          if(e.key==="ArrowDown"){ moveFocusFlat(+1); e.preventDefault(); return; }
          if(e.key==="ArrowUp"){ moveFocusFlat(-1); e.preventDefault(); return; }
          if(e.key==="ArrowRight"){
            const n = getNodeByPath(focusPath);
            if(n && n.children && n.children.length>0){ setFocusPath([...focusPath,0], true); }
            e.preventDefault(); return;
          }
          if(e.key==="ArrowLeft"){
            if(focusPath.length>1){ setFocusPath(focusPath.slice(0,-1), true); }
            e.preventDefault(); return;
          }
        }, true);
      }

      function handleUpcallKey(key){
        ensureUpcallState();
        const projects = state.upcall.projects || [];
        if(!upFocus || !projects.length) return;
        const COLS = 2;
        let {projectIndex, metricIndex} = upFocus;
        const metricLen = state.upcall.order.length || upMetrics.length;

        if(key==="ArrowRight"){
          metricIndex = Math.min(metricLen-1, metricIndex+1);
        }else if(key==="ArrowLeft"){
          metricIndex = Math.max(0, metricIndex-1);
        }else if(key==="ArrowDown"){
          metricIndex = Math.min(metricLen-1, metricIndex+COLS);
        }else if(key==="ArrowUp"){
          metricIndex = Math.max(0, metricIndex-COLS);
        }else if(key==="+" || key==="="){
          changeUpMetric(projectIndex, metricIndex, +1);
        }else if(key==="-" || key==="_"){
          changeUpMetric(projectIndex, metricIndex, -1);
        }

        upFocus = {projectIndex, metricIndex};
        updateUpcallHighlight(true);
      }

      function changeUpMetric(pIndex, mIndex, delta){
        ensureUpcallState();
        const projects = state.upcall.projects || [];
        const proj = projects[pIndex];
        const order = state.upcall.order && state.upcall.order.length
          ? state.upcall.order
          : upMetrics.map(m=>m.id);
        const metricId = order[mIndex];
        const metric = upMetrics.find(m=>m.id===metricId);

        if(!proj || !metric) return;
        if(!proj.metrics) proj.metrics={};

        const cur = Number(proj.metrics[metric.id] || 0);
        proj.metrics[metric.id] = Math.max(0, cur+delta);

        saveState();
        render();
      }

      // =========================================================
      // Render Tree (mode ‡∏õ‡∏Å‡∏ï‡∏¥)
      function render(){
        renderUpcall();

        treeEl.innerHTML="";
        flatFocus=[];
        ensureSumSection();

        state.mains.forEach((main, mi)=>{
          const mainEl = renderMain(main, mi);
          treeEl.appendChild(mainEl);
        });

        saveState();
        highlightFocus();
      }

      function renderMain(main, mi){
        const node = div("node main");
        node.dataset.path = key([mi]);

        const header = div("header");
        const title  = div("title", main.kind==="sum" ? "//////////SUM//////////" : main.title);
        header.appendChild(title);

        const ops = div("row");
        if(main.kind!=="sum"){
          const subName = input("", "‡πÄ‡∏û‡∏¥‡πà‡∏° node ‡∏Ç‡∏±‡πâ‡∏ô 2 (‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤)");
          const modeSel = select([{v:"count",t:"Count"},{v:"text",t:"Text"}]);
          const addBtn  = btn("‡πÄ‡∏û‡∏¥‡πà‡∏°", ()=> {
            const t=(subName.value||"").trim(); if(!t) return tip("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô");
            pushUndo();
            main.children = main.children || [];
            main.children.push(newLevel2Node(t, modeSel.value));
            subName.value="";
            saveState(); render();
          });
          ops.append(subName, modeSel, addBtn);

          const addCalc = btnGhost("+ Calc", ()=>{
            pushUndo();
            main.children = main.children || [];
            main.children.push(newCalcNode("‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà"));
            saveState(); render();
          });
          ops.appendChild(addCalc);
        }else{
          const addCalc = btn("‡πÄ‡∏û‡∏¥‡πà‡∏° CALC (SUM)", ()=>{
            pushUndo();
            main.children = main.children || [];
            main.children.push(newCalcNode("‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏´‡∏°‡πà"));
            saveState(); render();
          });
          ops.appendChild(addCalc);
        }

        const rightOps = div("row");
        if(main.kind!=="sum"){
          rightOps.append(
            btnGhost("‚Üë", ()=>{ pushUndo(); moveMain(mi,-1); }),
            btnGhost("‚Üì", ()=>{ pushUndo(); moveMain(mi,+1); }),
            btnDanger("‡∏•‡∏ö", ()=>{
              if(!confirm(`‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å "${main.title}" ?`)) return;
              pushUndo();
              state.mains.splice(mi,1);
              saveState(); render();
            })
          );
        }else{
          rightOps.append(div("muted","(‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)"));
        }
        header.append(ops, rightOps);
        node.appendChild(header);

        const childrenWrap = div("children");
        (main.children||[]).forEach((child, si)=>{
          if(child.kind==="calc"){
            childrenWrap.appendChild(renderCalcNode(child, [mi, si]));
          }else{
            childrenWrap.appendChild(renderLevel2(child, [mi, si]));
          }
        });

        node.appendChild(childrenWrap);

        registerFocusable(node, [mi]);
        node.addEventListener("click",(e)=>{
          e.stopPropagation();
          upFocus = null;
          updateUpcallHighlight(false);
          setFocusPath([mi], true);
        });

        return node;
      }

      function renderLevel2(l2, path){
        const node = div("node level2");
        node.dataset.path = key(path);
        if(l2.children && l2.children.length>0) node.classList.add("has-children");

        const head = div("sub-header");
        const title = div("title", l2.title);
        title.title = "‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠"; title.ondblclick = ()=> renameNode(l2);

        const modeWrap = div("modeWrap");
        const modeSel = select([{v:"count",t:"Count"},{v:"text",t:"Text"}], l2.mode||"count");
        modeSel.addEventListener("change", ()=>{
          pushUndo(); l2.mode = modeSel.value; saveState(); render();
        });
        modeWrap.append(modeSel);

        const countWrap = div("countWrap");
        if((l2.mode||"count")==="count"){
          const v = div("count", String(l2.count||0));
          v.title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç"; v.addEventListener("click", ()=> inlineNumber(v,l2));
          countWrap.append(btnMini("‚àí", ()=>{pushUndo(); inc(l2,-1);}), v, btnMini("+", ()=>{pushUndo(); inc(l2,+1);}));
        }else{
          const ta = textarea((l2.lines||[]).join("\n"));
          ta.placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡∏ô‡∏±‡∏ö)";
          ta.addEventListener("keydown", e=> e.stopPropagation());
          ta.addEventListener("input", ()=>{
            l2.lines = ta.value.split("\n").map(s=>s.trim()).filter(Boolean);
            saveState();
          });
          countWrap.append(ta);
        }

        if(l2.children && l2.children.length>0){
          modeWrap.style.display="none";
          countWrap.innerHTML="";
          const sum = calcCount(l2);
          countWrap.append(div("badge", "‡∏£‡∏ß‡∏°‡∏•‡∏π‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:"), div("count", String(sum)));
        }

        const leftOps = div("row");
        leftOps.append(
          btnGhost("‚Üë", ()=>{ pushUndo(); moveChild(getNodeByPath([path[0]]), path, -1); }),
          btnGhost("‚Üì", ()=>{ pushUndo(); moveChild(getNodeByPath([path[0]]), path, +1); }),
          btnDanger("‡∏•‡∏ö", ()=>{
            if(!confirm(`‡∏•‡∏ö "${l2.title}" ?`)) return;
            pushUndo();
            const parent = getNodeByPath([path[0]]);
            parent.children.splice(path[1],1);
            saveState(); render();
          })
        );

        head.append(title, modeWrap, countWrap, leftOps);
        node.appendChild(head);

        const group = div("level3-wrap");
        const addRow = div("row");
        const subName = input("", "‡πÄ‡∏û‡∏¥‡πà‡∏° node ‡∏Ç‡∏±‡πâ‡∏ô 3");
        const subMode = select([{v:"count",t:"Count"},{v:"text",t:"Text"}]);
        const addBtn = btn("‡πÄ‡∏û‡∏¥‡πà‡∏°", ()=>{
          const t=(subName.value||"").trim(); if(!t) return tip("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô");
          pushUndo();
          l2.children = l2.children || [];
          l2.children.push(newLevel3Node(t, subMode.value));
          subName.value="";
          saveState(); render();
        });
        const addCalc = btnGhost("+ Calc", ()=>{
          pushUndo();
          l2.children = l2.children || [];
          l2.children.push(newCalcNode("‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà (‡∏¢‡πà‡∏≠‡∏¢)"));
          saveState(); render();
        });
        addRow.append(subName, subMode, addBtn, addCalc);
        node.appendChild(addRow);

        (l2.children||[]).forEach((leaf, li)=>{
          if(leaf.kind==="calc"){ group.appendChild(renderCalcNode(leaf, [...path, li])); }
          else{ group.appendChild(renderLevel3(leaf, [...path, li])); }
        });
        if((l2.children||[]).length) node.appendChild(group);

        registerFocusable(node, path);
        node.addEventListener("click",(e)=>{
          e.stopPropagation();
          upFocus = null;
          updateUpcallHighlight(false);
          setFocusPath(path,true);
        });

        return node;
      }

      function renderLevel3(l3, path){
        const node = div("node level3");
        node.dataset.path = key(path);

        const head = div("sub-header");
        const title = div("title", l3.title);
        title.title="‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠"; title.ondblclick = ()=> renameNode(l3);

        const modeWrap = div("modeWrap");
        const modeSel = select([{v:"count",t:"Count"},{v:"text",t:"Text"}], l3.mode||"count");
        modeSel.addEventListener("change", ()=>{ pushUndo(); l3.mode=modeSel.value; saveState(); render(); });
        modeWrap.append(modeSel);

        const countWrap = div("countWrap");
        if((l3.mode||"count")==="count"){
          const v = div("count", String(l3.count||0));
          v.title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç"; v.addEventListener("click", ()=> inlineNumber(v,l3));
          countWrap.append(btnMini("‚àí", ()=>{pushUndo(); inc(l3,-1);}), v, btnMini("+", ()=>{pushUndo(); inc(l3,+1);}));
        }else{
          const ta = textarea((l3.lines||[]).join("\n"));
          ta.placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡∏ô‡∏±‡∏ö)";
          ta.addEventListener("keydown", e=> e.stopPropagation());
          ta.addEventListener("input", ()=>{
            l3.lines = ta.value.split("\n").map(s=>s.trim()).filter(Boolean);
            saveState();
          });
          countWrap.append(ta);
        }

        const ops = div("row");
        ops.append(
          btnGhost("‚Üë", ()=>{ pushUndo(); moveChild(getNodeByPath([path[0],path[1]]), path, -1); }),
          btnGhost("‚Üì", ()=>{ pushUndo(); moveChild(getNodeByPath([path[0],path[1]]), path, +1); }),
          btnDanger("‡∏•‡∏ö", ()=>{
            if(!confirm(`‡∏•‡∏ö "${l3.title}" ?`)) return;
            pushUndo();
            const parent = getNodeByPath([path[0],path[1]]);
            parent.children.splice(path[2],1);
            saveState(); render();
          })
        );

        head.append(title, modeWrap, countWrap, ops);
        node.appendChild(head);

        registerFocusable(node, path);
        node.addEventListener("click",(e)=>{
          e.stopPropagation();
          upFocus = null;
          updateUpcallHighlight(false);
          setFocusPath(path, true);
        });

        return node;
      }

      function renderCalcNode(calc, path){
        const node = div("node calc");
        node.dataset.path = key(path);

        const head = div("sub-header");
        const title = div("title", calc.title);
        title.title="‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠"; title.ondblclick = ()=> renameNode(calc);

        const val = evaluateCalc(calc);
        const valueBox = div("count", String(val));

        const formBtn = btnGhost("‡∏™‡∏π‡∏ï‡∏£‚Ä¶", ()=> openFormulaEditor(calc, path));

        const ops = div("row");
        const parentPath = path.slice(0,-1);
        const parent = getNodeByPath(parentPath);
        ops.append(
          btnGhost("‚Üë", ()=>{ pushUndo(); moveChild(parent, path, -1); }),
          btnGhost("‚Üì", ()=>{ pushUndo(); moveChild(parent, path, +1); }),
          btnDanger("‡∏•‡∏ö", ()=>{
            if(!confirm(`‡∏•‡∏ö "${calc.title}" ?`)) return;
            pushUndo(); parent.children.splice(path[path.length-1],1); saveState(); render();
          })
        );

        head.append(title, div("formula", formulaText(calc)), valueBox, formBtn, ops);
        node.appendChild(head);

        registerFocusable(node, path);
        node.addEventListener("click",(e)=>{
          e.stopPropagation();
          upFocus = null;
          updateUpcallHighlight(false);
          setFocusPath(path, true);
        });

        return node;
      }

      // =========================================================
      // Formula editor
      function openFormulaEditor(calcObj, path){
        editingCalcObj = calcObj;
        editingParts = (calcObj.formula||[]).map(x=>({nodeId:x.nodeId,sign:x.sign}));

        formulaSourceSel.innerHTML="";
        const nodes = listAllCountableNodes();
        nodes.forEach(n=>{
          const opt=document.createElement("option");
          opt.value=n.id; opt.textContent = n.title;
          formulaSourceSel.appendChild(opt);
        });

        renderFormulaLines();
        formulaModal.showModal();
      }

      function renderFormulaLines(){
        formulaListEl.innerHTML="";
        if(!editingParts.length){
          formulaListEl.appendChild(div("muted","(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÉ‡∏ô‡∏™‡∏π‡∏ï‡∏£)"));
          return;
        }
        editingParts.forEach((p,idx)=>{
          const row = div("formula-line");
          row.append(
            div(null, p.sign>0?"+":"‚àí"),
            div(null, findNodeTitleById(p.nodeId) || "(‡πÑ‡∏°‡πà‡∏û‡∏ö)"),
            btnDanger("‡∏•‡∏ö", ()=>{ editingParts.splice(idx,1); renderFormulaLines(); })
          );
          formulaListEl.appendChild(row);
        });
      }

      function listAllCountableNodes(){
        const out=[];
        state.mains.forEach(m=>{
          (m.children||[]).forEach(c=>{
            if(c.kind==="calc"){ /*skip*/ }
            else{
              out.push({id:c.id, title:`${m.kind==="sum"?"SUM":"Main"} ‚ñ∏ ${c.title}`});
              (c.children||[]).forEach(l3=>{
                if(l3.kind!=="calc") out.push({id:l3.id, title:`${m.kind==="sum"?"SUM":"Main"} ‚ñ∏ ${c.title} ‚ñ∏ ${l3.title}`});
              });
            }
          });
        });
        return out;
      }

      function evaluateCalc(calc){
        const parts = calc.formula||[];
        let sum=0;
        parts.forEach(p=>{
          const node = findNodeById(p.nodeId);
          const val = node ? calcCount(node) : 0;
          sum += (p.sign||1) * val;
        });
        return sum;
      }

      function formulaText(calc){
        const parts = calc.formula||[];
        if(!parts.length) return "‡∏™‡∏π‡∏ï‡∏£: 0";
        return "‡∏™‡∏π‡∏ï‡∏£: " + parts.map(p=>{
          const t = findNodeTitleById(p.nodeId) || "?";
          return (p.sign>0?"+":"‚àí") + t;
        }).join(" ").replace(/^\+/,"");
      }

      // =========================================================
      // Data helpers
      function defaultState(){
        return {
          userName:"",
          reportDate: isoDate(),
          mains: [],
          upcall: defaultUpcall()
        };
      }

      function ensureSumSection(){
        const idx = state.mains.findIndex(m=> m.kind==="sum");
        if(idx===-1){
          state.mains.push({ id:uid(), title:"//////////SUM//////////", kind:"sum", children:[] });
        }else if(idx !== state.mains.length-1){
          const x = state.mains.splice(idx,1)[0];
          state.mains.push(x);
        }
      }

      function newLevel2Node(title, mode){
        return { id:uid(), title, kind:"level2", mode:(mode||"count"), count:0, lines:[], children:[] };
      }
      function newLevel3Node(title, mode){
        return { id:uid(), title, kind:"level3", mode:(mode||"count"), count:0, lines:[] };
      }
      function newCalcNode(title){
        return { id:uid(), title, kind:"calc", formula:[] };
      }

      function moveMain(i,dir){
        const ni=i+dir; if(ni<0||ni>=state.mains.length-1) return;
        const x=state.mains.splice(i,1)[0]; state.mains.splice(ni,0,x);
      }
      function moveChild(parent, path, dir){
        const idx = path[path.length-1];
        const ni  = idx+dir;
        if(ni<0 || ni>= (parent.children||[]).length) return;
        const x = parent.children.splice(idx,1)[0];
        parent.children.splice(ni,0,x);
        saveState(); render();
      }

      function inc(node,delta){
        node.count = Math.max(0,(node.count||0)+delta);
        saveState(); render();
      }
      function calcOwn(node){
        if(node.kind==="calc") return evaluateCalc(node);
        const mode = node.mode||"count";
        return (mode==="count") ? (node.count||0) : (node.lines?.length||0);
      }
      function calcCount(node){
        let base = calcOwn(node);
        if(node.children && node.children.length){
          node.children.forEach(ch=>{
            base += calcCount(ch);
          });
        }
        return base;
      }

      function resetCountsOnlyNodeDeep(node){
        if(node.kind==="calc"){/*skip values*/ }
        else{
          if(node.mode==="count") node.count=0;
          else if(node.mode==="text") node.lines=[];
        }
        (node.children||[]).forEach(resetCountsOnlyNodeDeep);
      }

      // =========================================================
      // Focus & Keyboard helpers (node ‡∏õ‡∏Å‡∏ï‡∏¥)
      function registerFocusable(el, path){ flatFocus.push({path:path.slice(), el}); }
      function setFocusPath(path, scroll=false){
        focusPath = path.slice();
        upFocus = null;
        updateUpcallHighlight(false);
        highlightFocus(scroll);
      }
      function highlightFocus(scroll=false){
        $$(".node").forEach(n=> n.classList.remove("selected"));
        if(!focusPath.length) return;
        const el = $(`.node[data-path="${key(focusPath)}"]`);
        if(el){
          el.classList.add("selected");
          if(scroll) el.scrollIntoView({block:"nearest",behavior:"smooth"});
        }
      }
      function moveFocusFlat(delta){
        if(flatFocus.length===0) return;
        let idx=0;
        if(focusPath.length){
          const k=key(focusPath);
          idx = flatFocus.findIndex(x=> key(x.path)===k);
          if(idx<0) idx=0;
        }
        let ni = Math.max(0, Math.min(flatFocus.length-1, idx+delta));
        setFocusPath(flatFocus[ni].path, true);
      }
      function incFocused(delta){
        if(!focusPath.length) return;
        const node = getNodeByPath(focusPath);
        if(!node || node.kind==="calc") return;
        if(node.mode && node.mode!=="count") return;
        pushUndo();
        inc(node, delta);
      }

      // =========================================================
      // Inline editors & rename
      function inlineNumber(host, node){
        const old = node.count||0;
        const inp = document.createElement("input");
        inp.type="number"; inp.value=String(old);
        host.innerHTML=""; host.appendChild(inp); inp.focus(); inp.select();
        inp.addEventListener("keydown",(e)=>{ e.stopPropagation(); if(e.key==="Enter") commit(); if(e.key==="Escape") cancel(); });
        inp.addEventListener("blur",commit);
        function commit(){ pushUndo(); node.count=Math.max(0,parseInt(inp.value||"0",10)); saveState(); render(); }
        function cancel(){ render(); }
      }
      function renameNode(node){
        const nv=prompt("‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠:", node.title);
        if(!nv) return;
        pushUndo(); node.title=nv.trim(); saveState(); render();
      }

      // =========================================================
      // Report builder
      function buildReport(){
        const name = (state.userName||"PHANToM").trim();
        const d = dateEl.value ? new Date(dateEl.value): new Date();
        const header = `${name} ${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;

        const out = [header,""];

        const upLines = buildUpcallSectionLines();
        if(upLines.length){
          out.push(...upLines,"");
        }

        state.mains.forEach(m=>{
          if(m.kind==="sum") return;
          out.push(`////////// ${m.title} //////////`);
          (m.children||[]).forEach(l2=>{
            if(l2.kind==="calc"){
              out.push(`[ ${l2.title} ${evaluateCalc(l2)} ]`);
            }else{
              const total = calcCount(l2);
              out.push(`${l2.title} ${total}`);
              if((l2.mode==="text") && (!l2.children || !l2.children.length)){
                (l2.lines||[]).forEach(t=> out.push(t));
              }
              (l2.children||[]).forEach(l3=>{
                if(l3.kind==="calc"){
                  out.push(`- ${l3.title} ${evaluateCalc(l3)}`);
                }else{
                  const cnt = calcCount(l3);
                  out.push(`- ${l3.title} ${cnt}`);
                  if(l3.mode==="text"){
                    (l3.lines||[]).forEach(t=> out.push(`  ${t}`));
                  }
                }
              });
            }
            out.push("");
          });
        });

        out.push("//////////SUM//////////");
        const sumMain = state.mains.find(m=> m.kind==="sum");
        (sumMain.children||[]).forEach(calc=>{
          const v=evaluateCalc(calc);
          out.push(`${calc.title} ${v}`);
        });

        return out.join("\n");
      }

      // =========================================================
      // Undo
      function pushUndo(clearNext=false){
        if(clearNext) undoStack.length=0;
        if(undoStack.length>50) undoStack.shift();
        undoStack.push(JSON.stringify(state));
      }
      function undo(){
        if(undoStack.length===0){ tip("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤"); return; }
        const snap = undoStack.pop();
        try{
          state = JSON.parse(snap);
          ensureSumSection();
          ensureUpcallState();
          saveState(); render();
          tip("‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß",true);
        }catch{
          tip("‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
      }

      // =========================================================
      // Lookup & helpers
      function getNodeByPath(path){
        if(!path || !path.length) return null;
        let cur = state.mains[path[0]];
        for(let i=1;i<path.length;i++){
          cur = (cur && cur.children) ? cur.children[path[i]] : null;
        }
        return cur||null;
      }
      function findNodeById(id){
        let found=null;
        state.mains.some(m=>{
          if(m.id===id){ found=m; return true; }
          (m.children||[]).some(c=>{
            if(c.id===id){ found=c; return true; }
            (c.children||[]).some(l3=>{
              if(l3.id===id){ found=l3; return true; }
              return false;
            });
            return !!found;
          });
          return !!found;
        });
        return found;
      }
      function findNodeTitleById(id){
        const n=findNodeById(id); return n?n.title:null;
      }

      // =========================================================
      // Small DOM makers
      function div(cls, txt){ const x=document.createElement("div"); if(cls) x.className=cls; if(txt!=null) x.textContent=txt; return x; }
      function input(val="", placeholder=""){ const x=document.createElement("input"); x.type="text"; x.value=val; x.placeholder=placeholder; return x; }
      function textarea(val=""){ const x=document.createElement("textarea"); x.className="textbox"; x.value=val; return x; }
      function select(opts, val){
        const s=document.createElement("select");
        opts.forEach(o=>{ const op=document.createElement("option"); op.value=o.v; op.textContent=o.t; s.appendChild(op); });
        if(val!=null) s.value=val;
        return s;
      }
      function btn(t,fn){ const b=document.createElement("button"); b.className="btn"; b.textContent=t; b.onclick=(e)=>{ e.stopPropagation(); fn&&fn(); }; return b; }
      function btnGhost(t,fn){ const b=document.createElement("button"); b.className="ghost"; b.textContent=t; b.onclick=(e)=>{ e.stopPropagation(); fn&&fn(); }; return b; }
      function btnDanger(t,fn){ const b=document.createElement("button"); b.className="danger"; b.textContent=t; b.onclick=(e)=>{ e.stopPropagation(); fn&&fn(); }; return b; }
      function btnMini(t,fn){ const b=document.createElement("button"); b.className="mini"; b.textContent=t; b.onclick=(e)=>{ e.stopPropagation(); fn&&fn(); }; return b; }

      // =========================================================
      // Persist & misc
      function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
      function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"null"); }catch{ return null; } }
      function isoDate(){ const d=new Date(); return d.toISOString().split("T")[0]; }
      function pad2(n){ return String(n).padStart(2,"0"); }
      function key(path){ return path.join("."); }
      function tip(t, ok=false){
        if(!toastEl) return;
        toastEl.textContent=t;
        toastEl.style.borderColor=ok?"var(--ok)":"var(--pri)";
        toastEl.classList.add("show");
        setTimeout(()=>toastEl.classList.remove("show"),1300);
      }
      async function copy(text){
        try{
          await navigator.clipboard.writeText(text);
        }catch{
          const ta=document.createElement("textarea");
          ta.value=text; document.body.appendChild(ta); ta.select();
          document.execCommand("copy"); ta.remove();
        }
      }
      function uid(){ return Math.random().toString(36).slice(2,9); }
    })();
  </script>
</body>
</html>
