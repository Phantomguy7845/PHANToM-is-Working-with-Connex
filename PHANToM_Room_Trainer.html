<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PHANToM Room Trainer ‚Äî Aurora TF Edition</title>
<style>
:root{
  --bg:#0b1220;--panel:#0f1830;--edge:#243353;--txt:#e5e7eb;--muted:#94a3b8;
  --pri:#4f9eff;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--a1:#7dd3fc;
}
*{box-sizing:border-box} body{
  margin:0;min-height:100vh;background:radial-gradient(1000px 700px at 15% 15%,#101b3a,#070c18 60%);
  color:var(--txt);font-family:"Prompt",system-ui,Segoe UI,Roboto,sans-serif;
  display:flex;flex-direction:column;gap:16px;padding:16px
}
header{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 12px;border:1px solid var(--edge);border-radius:12px;
  background:rgba(255,255,255,.03)
}
h1{font-size:1.2rem;margin:0}
.btns{display:flex;gap:8px;flex-wrap:wrap}
button{
  border:none;border-radius:10px;padding:9px 14px;font-weight:700;cursor:pointer;
  transition:transform .15s ease, filter .2s ease;
}
button:hover{transform:translateY(-1px);filter:brightness(1.05)}
.ok{background:var(--ok);color:#001b0c}
.ghost{background:transparent;border:1px solid var(--edge);color:var(--txt)}
.secondary{background:var(--pri);color:white}
.warn{background:var(--warn);color:black}
.card{
  background:rgba(255,255,255,.03);border:1px solid var(--edge);border-radius:16px;
  padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)
}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.item{position:relative;border:1px solid var(--edge);border-radius:12px;background:#0e1a3a;padding:8px}
.thumb{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px}
.bar{display:flex;justify-content:space-between;align-items:center;font-size:.85rem;color:var(--muted);margin-top:6px}
.del{position:absolute;top:8px;left:8px;width:26px;height:26px;border-radius:999px;border:1px solid var(--edge);background:rgba(239,68,68,.85);color:#fff;font-weight:800;display:flex;align-items:center;justify-content:center;font-size:.8rem}
.section{margin-bottom:14px}
.note{color:var(--muted);font-size:.9rem}
</style>
</head>
<body>
<header>
  <h1>PHANToM Room Trainer</h1>
  <div class="btns">
    <a href="PHANToM_Image_Sorter.html" class="ghost" style="text-decoration:none;display:inline-block">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Sorter</a>
    <button id="addClass" class="secondary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà</button>
    <button id="train" class="ok">‡πÄ‡∏ó‡∏£‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏•</button>
    <button id="export" class="warn">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•</button>
  </div>
</header>

<section class="card">
  <div class="note">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î (‡πÄ‡∏ä‡πà‡∏ô living, bedroom, kitchen, bathroom, balcony, corridor ‡∏Ø‡∏•‡∏Ø) ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î ‚Äú‡πÄ‡∏ó‡∏£‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏•‚Äù ‡πÅ‡∏•‡∏∞ ‚Äú‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Sorter (AI Sort: Custom)</div>
</section>

<section id="classes" class="card"></section>

<section class="card">
  <div id="progress" class="note">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ó‡∏£‡∏ô</div>
</section>

<div id="toast" class="card" style="position:fixed;right:14px;bottom:14px;padding:10px 14px;opacity:0;transform:translateY(10px);transition:.25s;background:#0d1b36">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
<script>
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const toastEl=$("#toast"), clsWrap=$("#classes"), progress=$("#progress");
let classData={}; let model=null;

function toast(t,ok=false){toastEl.textContent=t;toastEl.style.background=ok?"#153a1f":"#0d1b36";toastEl.style.opacity=1;toastEl.style.transform="translateY(0)";setTimeout(()=>{toastEl.style.opacity=0;toastEl.style.transform="translateY(10px)";},1500);}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà
$("#addClass").onclick=()=>{
  const name=prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î (‡πÄ‡∏ä‡πà‡∏ô living, kitchen, bedroom)");
  if(!name) return;
  if(classData[name]) return toast("‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
  classData[name]=[];
  render();
};

// ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î
function pickImgs(k){
  const inp=document.createElement("input");
  inp.type="file"; inp.accept="image/*"; inp.multiple=true;
  inp.onchange=e=>{
    Array.from(e.target.files).forEach(f=>{
      const r=new FileReader();
      r.onload=v=>{ classData[k].push(v.target.result); render(); };
      r.readAsDataURL(f);
    });
  };
  inp.click();
}

// ‡∏•‡∏ö‡∏£‡∏π‡∏õ
function removeImage(k, idx){
  classData[k].splice(idx,1);
  render();
}

// ‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î
function removeClass(k){
  if(confirm(`‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î ${k}?`)){
    delete classData[k];
    render();
  }
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î
function render(){
  clsWrap.innerHTML="";
  Object.keys(classData).forEach(k=>{
    const box=document.createElement("div"); box.className="section";
    box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">${k}</h3>
        <div class="btns">
          <button class="ghost add">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ</button>
          <button class="warn del-class">‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î</button>
        </div>
      </div>
      <div class="grid"></div>`;
    const grid=box.querySelector(".grid");
    box.querySelector(".add").onclick=()=>pickImgs(k);
    box.querySelector(".del-class").onclick=()=>removeClass(k);
    classData[k].forEach((src,i)=>{
      const item=document.createElement("div"); item.className="item";
      const img=document.createElement("img"); img.src=src; img.className="thumb";
      const del=document.createElement("button"); del.className="del"; del.textContent="üóë";
      del.onclick=()=>removeImage(k,i);
      const bar=document.createElement("div"); bar.className="bar";
      bar.innerHTML=`<span>#${i+1}</span><span class="note">${k}</span>`;
      item.append(img,del,bar); grid.append(item);
    });
    clsWrap.append(box);
  });
}

// ‡πÄ‡∏ó‡∏£‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏•
$("#train").onclick=async()=>{
  if(Object.keys(classData).length<2){return toast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏´‡∏°‡∏ß‡∏î");}
  progress.textContent="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶";

  const {xs, ys, labels}=await buildDataset();
  model=createModel(labels.length);
  model.compile({optimizer:'adam',loss:'categoricalCrossentropy',metrics:['accuracy']});
  progress.textContent="‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ó‡∏£‡∏ô...";
  await model.fit(xs, ys, {
    epochs:12, batchSize:8, shuffle:true,
    callbacks:{
      onEpochEnd:(ep,logs)=>{
        const acc=(logs.acc||logs.accuracy||0)*100;
        progress.textContent=`Epoch ${ep+1}/12 ‚Äî Loss ${logs.loss.toFixed(4)} Acc ${acc.toFixed(1)}%`;
      }
    }
  });
  xs.dispose(); ys.dispose();
  progress.textContent="‚úÖ ‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å";
  toast("‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô",true);
};

// ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•
$("#export").onclick=async()=>{
  if(!model) return toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÄ‡∏ó‡∏£‡∏ô");
  await model.save('downloads://PHANToM_Room_Model');
  toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÅ‡∏•‡πâ‡∏ß",true);
};

// Dataset helpers
async function buildDataset(){
  let dataX=[], dataY=[], labels=Object.keys(classData);
  for(let i=0;i<labels.length;i++){
    const name=labels[i];
    for(let imgData of classData[name]){
      const tensor=await imgToTensor(imgData,128);
      dataX.push(tensor);
      dataY.push(i);
    }
  }
  const xs=tf.concat(dataX);
  const ys=tf.oneHot(tf.tensor1d(dataY,'int32'),labels.length);
  dataX.forEach(t=>t.dispose());
  return {xs,ys,labels};
}

function imgToTensor(data,size=128){
  return new Promise(res=>{
    const im=new Image(); im.src=data;
    im.onload=()=>{
      const t=tf.tidy(()=>tf.image.resizeBilinear(tf.browser.fromPixels(im),[size,size])
        .toFloat().div(255).expandDims(0));
      res(t);
    };
  });
}

function createModel(classes){
  const m=tf.sequential();
  m.add(tf.layers.conv2d({inputShape:[128,128,3],filters:16,kernelSize:3,activation:'relu'}));
  m.add(tf.layers.maxPooling2d({poolSize:2}));
  m.add(tf.layers.conv2d({filters:32,kernelSize:3,activation:'relu'}));
  m.add(tf.layers.maxPooling2d({poolSize:2}));
  m.add(tf.layers.flatten());
  m.add(tf.layers.dense({units:96,activation:'relu'}));
  m.add(tf.layers.dropout({rate:0.2}));
  m.add(tf.layers.dense({units:classes,activation:'softmax'}));
  return m;
}
</script>
</body>
</html>
