<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PHANToM Room Trainer — TensorFlow Aurora Edition</title>
<style>
:root{
  --bg:#0b1220; --panel:#0f1830; --edge:#243353; --txt:#e5e7eb;
  --muted:#9cb1d9; --pri:#6b8bff; --a1:#8bf5ff; --ok:#22c55e;
  --warn:#f59e0b; --err:#ef4444;
}
*{box-sizing:border-box;font-family:'Prompt',system-ui,sans-serif}
body{
  margin:0;min-height:100vh;background:radial-gradient(1000px 700px at 15% 15%,#101b3a,#070c18 60%);
  color:var(--txt);display:flex;flex-direction:column;align-items:center;padding:20px;
}
h1{font-size:1.6rem;margin-bottom:8px;text-shadow:0 0 10px rgba(139,245,255,.3);}
p{color:var(--muted);margin:0 0 18px;text-align:center;max-width:600px}
.card{
  background:rgba(255,255,255,.04);border:1px solid var(--edge);
  border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);
  padding:20px;max-width:900px;width:100%;
}
button{
  border:none;border-radius:10px;padding:10px 14px;margin:4px;
  cursor:pointer;font-weight:600;color:#fff;background:var(--pri);
  transition:.3s;
}
button:hover{filter:brightness(1.15)}
button.warn{background:var(--warn);color:#000}
button.ok{background:var(--ok)}
button.secondary{background:#132044}
.note{color:var(--muted);font-size:.9rem;margin-top:6px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:10px}
.item{border:1px solid var(--edge);border-radius:10px;padding:6px;text-align:center;background:#0d1733}
.thumb{width:100%;border-radius:6px;aspect-ratio:1/1;object-fit:cover}
.toast{position:fixed;right:14px;bottom:14px;background:#0d1b36;border:1px solid var(--edge);
  padding:10px 12px;border-radius:12px;opacity:0;transform:translateY(10px);
  pointer-events:none;transition:.25s}
.toast.show{opacity:1;transform:translateY(0)}
</style>
</head>
<body>
<h1>PHANToM Room Trainer</h1>
<p>เทรนโมเดลจำแนกรูปภาพห้อง (Living, Bedroom, Bathroom, Kitchen ฯลฯ) ด้วย TensorFlow.js<br>
สามารถส่งออกโมเดลและนำไปใช้กับ PHANToM Image Sorter ได้ทันที</p>

<div class="card">
  <div style="margin-bottom:10px">
    <button id="addClass" class="secondary">เพิ่มหมวดใหม่</button>
    <button id="train" class="ok">เทรนโมเดล</button>
    <button id="export" class="warn">ส่งออกโมเดล</button>
  </div>
  <div id="classes"></div>
  <div id="progress" class="note">สถานะ: รอเริ่มเทรน</div>
</div>

<div id="toast" class="toast">พร้อมทำงาน</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script>
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const toastEl=$("#toast"), clsWrap=$("#classes"), progress=$("#progress");
let classData={}; let model=null;

function toast(t,ok=false){toastEl.textContent=t;toastEl.style.background=ok?"#153a1f":"#0d1b36";toastEl.classList.add("show");setTimeout(()=>toastEl.classList.remove("show"),1500);}

// เพิ่มหมวดใหม่
$("#addClass").onclick=()=>{
  const name=prompt("ชื่อหมวด (เช่น living, kitchen, bedroom)");
  if(!name) return;
  if(classData[name]) return toast("มีหมวดนี้แล้ว");
  classData[name]=[];
  render();
};

// แสดงภาพแต่ละหมวด
function render(){
  clsWrap.innerHTML="";
  Object.keys(classData).forEach(k=>{
    const box=document.createElement("div");
    box.innerHTML=`<h3>${k}</h3><div class="grid"></div><button class="secondary">เพิ่มรูป</button>`;
    const grid=box.querySelector(".grid");
    const btn=box.querySelector("button");
    btn.onclick=()=>pickImgs(k);
    classData[k].forEach(src=>{
      const im=document.createElement("img"); im.src=src; im.className="thumb";
      grid.append(im);
    });
    clsWrap.append(box);
  });
}

// เลือกภาพเข้าแต่ละหมวด
function pickImgs(k){
  const inp=document.createElement("input");
  inp.type="file"; inp.accept="image/*"; inp.multiple=true;
  inp.onchange=e=>{
    Array.from(e.target.files).forEach(f=>{
      const r=new FileReader();
      r.onload=v=>{ classData[k].push(v.target.result); render(); };
      r.readAsDataURL(f);
    });
  };
  inp.click();
}

// สร้างและเทรนโมเดล
$("#train").onclick=async()=>{
  if(Object.keys(classData).length<2){return toast("เพิ่มหมวดอย่างน้อย 2 หมวด");}
  progress.textContent="กำลังเตรียมข้อมูล…";

  const {xs, ys, labels}=await buildDataset();
  model=createModel(labels.length);
  model.compile({optimizer:'adam',loss:'categoricalCrossentropy',metrics:['accuracy']});
  progress.textContent="เริ่มเทรน...";
  await model.fit(xs, ys, {
    epochs:10,
    batchSize:8,
    shuffle:true,
    callbacks:{
      onEpochEnd:(ep,logs)=>progress.textContent=`Epoch ${ep+1}/10 — Loss ${logs.loss.toFixed(4)} Acc ${(logs.acc*100).toFixed(1)}%`
    }
  });
  xs.dispose(); ys.dispose();
  progress.textContent="✅ เทรนเสร็จสิ้น พร้อมส่งออก";
  toast("เทรนเสร็จสิ้น",true);
};

// สร้าง dataset จากภาพ
async function buildDataset(){
  let dataX=[], dataY=[], labels=Object.keys(classData);
  for(let i=0;i<labels.length;i++){
    const name=labels[i];
    for(let imgData of classData[name]){
      const tensor=await imgToTensor(imgData);
      dataX.push(tensor);
      dataY.push(i);
    }
  }
  const xs=tf.concat(dataX);
  const ys=tf.oneHot(tf.tensor1d(dataY,'int32'),labels.length);
  dataX.forEach(t=>t.dispose());
  return {xs,ys,labels};
}

// แปลงรูปเป็น tensor
function imgToTensor(data){
  return new Promise(res=>{
    const im=new Image();
    im.src=data;
    im.onload=()=>{
      const t=tf.tidy(()=>tf.image.resizeBilinear(tf.browser.fromPixels(im),[128,128])
        .toFloat().div(255).expandDims(0));
      res(t);
    };
  });
}

// สร้างโมเดล
function createModel(classes){
  const m=tf.sequential();
  m.add(tf.layers.conv2d({inputShape:[128,128,3],filters:16,kernelSize:3,activation:'relu'}));
  m.add(tf.layers.maxPooling2d({poolSize:2}));
  m.add(tf.layers.flatten());
  m.add(tf.layers.dense({units:64,activation:'relu'}));
  m.add(tf.layers.dense({units:classes,activation:'softmax'}));
  return m;
}

// ส่งออกโมเดล
$("#export").onclick=async()=>{
  if(!model) return toast("ยังไม่มีโมเดลเทรน");
  await model.save('downloads://PHANToM_Room_Model');
  toast("บันทึกโมเดลแล้ว",true);
};
</script>
</body>
</html>
