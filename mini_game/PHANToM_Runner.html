<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>PHANToM Runner</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root{
      --bg1: #1d2337;
      --bg2: #020617;

      /* Poison obstacles (themeable) */
      --obs-a: #111827;
      --obs-b: #0b1020;
      --obs-c: #2e1065;
      --obs-d: #0b1020;
      --obs-border: rgba(148,163,184,0.16);
      --obs-shadow: rgba(0,0,0,0.35);

      /* Wood ground/platform */
      --wood-1: #8b5a2b;
      --wood-2: #7a4f25;
      --wood-3: #6a4320;
      --wood-line: rgba(0,0,0,0.12);
    }

    body {
      background: #020617;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 22px;
      padding-bottom: 18px;
      overscroll-behavior: none;
    }

    body.fullscreen-game{ padding-top: 12px; }

    h1 {
      margin-bottom: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      user-select: none;
    }

    #gameContainer {
      position: relative;
      width: 800px;
      max-width: 95vw;
      height: 260px;
      border: 2px solid #4b5563;
      overflow: hidden;
      border-radius: 16px;
      background: radial-gradient(circle at top, var(--bg1) 0, var(--bg2) 55%, var(--bg2) 100%);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.9);
      touch-action: none;
    }

    /* =========================
       IN-GAME TOP BAR (NEW LAYOUT)
       ========================= */
    #inGameTopBar{
      position:absolute;
      top:10px;
      left:10px;
      right:10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      z-index: 30;
      pointer-events:none;
    }

    .ig-pill{
      pointer-events:auto;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.35);
      color:#e5e7eb;
      font-size:12px;
      box-shadow:0 8px 18px rgba(0,0,0,0.18);
      backdrop-filter: blur(2px);
      user-select:none;
      display:flex;
      gap:10px;
      align-items:center;
      line-height: 1.1;
    }

    .ig-btn{
      pointer-events:auto;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.55);
      color: #e5e7eb;
      font-size:12px;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,0.22);
      user-select:none;
      display:flex;
      align-items:center;
      gap:6px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .ig-btn:hover{ border-color: rgba(99,102,241,0.65); }
    .ig-btn:active{ transform: translateY(1px) scale(0.99); }

    .ig-left{
      pointer-events:none;
      display:flex;
      flex-direction:column;
      gap: 8px;
      min-width: 240px;
    }
    .ig-left .ig-pill{ pointer-events:auto; }

    .ig-energy{
      pointer-events:auto;
      padding:8px 10px;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,0.30);
      background: rgba(2,6,23,0.38);
      box-shadow:0 8px 18px rgba(0,0,0,0.18);
      backdrop-filter: blur(2px);
    }
    .ig-energy-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 6px;
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color:#9ca3af;
    }
    .ig-energy-top b{
      color:#e5e7eb;
      letter-spacing: 0.02em;
      text-transform:none;
      font-size: 11px;
    }
    #energyBarWrapper {
      height: 10px;
      border-radius: 999px;
      background: rgba(2,6,23,0.85);
      border: 1px solid rgba(148,163,184,0.35);
      overflow: hidden;
      box-shadow: 0 0 8px rgba(15,23,42,0.6);
    }
    #energyBar {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #22c55e, #facc15, #fb923c);
      box-shadow: 0 0 12px rgba(250,204,21,0.7);
      transition: width 0.15s ease;
    }

    .ig-center{
      pointer-events:auto;
      flex: 1;
      display:flex;
      justify-content:center;
      padding-top: 2px;
    }
    .ig-coins{
      max-width: 420px;
      width: fit-content;
      justify-content:center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 14px;
      background: rgba(2,6,23,0.42);
    }
    .ig-coins b{ color:#facc15; }
    .ig-coins .muted{ color:#9ca3af; font-size: 11px; }
    .ig-coins .sep{ opacity:0.45; }

    .ig-right{
      pointer-events:none;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 8px;
      min-width: 240px;
    }
    .ig-right-top{
      pointer-events:auto;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .ig-scorebox{
      pointer-events:auto;
      border-radius: 14px;
      background: rgba(2,6,23,0.35);
      padding: 8px 10px;
      display:flex;
      flex-direction:column;
      gap: 6px;
      align-items:flex-end;
    }
    #score{ font-size: 12px; color:#e5e7eb; }
    #bestScore{ font-size: 12px; color:#9ca3af; }

    /* ========================= */

    #ground {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 200%;
      height: 40px;
      background: repeating-linear-gradient(
        -45deg,
        var(--wood-1) 0,
        var(--wood-1) 12px,
        var(--wood-2) 12px,
        var(--wood-2) 24px
      );
      animation: groundMove 1s linear infinite;
      opacity: 0.95;
      z-index: 1;
      box-shadow: inset 0 2px 0 rgba(255,255,255,0.05);
    }

    @keyframes groundMove {
      from { transform: translateX(0); }
      to   { transform: translateX(-50%); }
    }

    /* ==== player ==== */
    #player {
      position: absolute;
      bottom: 40px;
      left: 80px;
      width: 60px;
      height: 60px;
      transform-origin: center bottom;
      transition: transform 0.08s ease, width 0.12s ease, height 0.12s ease;
      z-index: 5;
    }

    #player img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
      user-select: none;
      background: transparent;
      filter: drop-shadow(0 0 16px rgba(56,189,248,0.8));
    }

    #player.duck { transform: translateY(-8px) scaleY(0.48); }
    #player.duck img { filter: drop-shadow(0 0 14px rgba(56,189,248,0.9)); }

    #player.invincible img {
      filter:
        drop-shadow(0 0 26px rgba(250,204,21,1))
        drop-shadow(0 0 70px rgba(250,204,21,0.7));
    }

    #player.giant { width: 130px; height: 130px; }
    #player.giant img {
      filter:
        drop-shadow(0 0 26px rgba(59,130,246,1))
        drop-shadow(0 0 70px rgba(59,130,246,0.7));
    }

    #player.double-jump img { animation: djumpSpin 0.2s linear; }
    @keyframes djumpSpin { from{transform:rotate(0)} to{transform:rotate(360deg)} }

    /* ‚úÖ Hurt i-frame blink (slow) */
    #player.hurt-blink{
      animation: hurtBlink 0.60s linear infinite;
    }
    @keyframes hurtBlink{
      0%, 100% { opacity: 1; }
      50% { opacity: 0.25; }
    }

    /* Boost beam */
    #boostBeam {
      position: absolute;
      width: 140px;
      height: 35px;
      left: -9999px;
      bottom: 40px;
      background: linear-gradient(90deg, rgba(34,197,94,0), rgba(34,197,94,0.9), rgba(56,189,248,0));
      filter: blur(8px);
      opacity: 0;
      transition: opacity 0.12s ease;
      pointer-events: none;
      z-index: 4;
      mix-blend-mode: screen;
    }

    /* Obstacles (emoji) */
    .obstacle {
      position: absolute;
      bottom: 40px;
      border-radius: 10px;
      z-index: 3;

      display:flex;
      align-items:center;
      justify-content:center;
      line-height: 1;
      user-select:none;

      background: linear-gradient(135deg, var(--obs-a), var(--obs-b), var(--obs-c), var(--obs-d));
      border: 1px solid var(--obs-border);
      box-shadow:
        0 14px 22px var(--obs-shadow),
        inset 0 1px 0 rgba(255,255,255,0.05);
    }

    /* ceiling stalactites (duck to avoid) */
    .obstacle.ceiling{
      border-radius: 14px;
      overflow: visible;
    }
    .obstacle.ceiling::before{
      content:"";
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top:-220px;
      width: 6px;
      height: 220px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(148,163,184,0.04), rgba(148,163,184,0.16), rgba(148,163,184,0.05));
      box-shadow: 0 10px 26px rgba(0,0,0,0.18);
      pointer-events:none;
    }

    /* platform wood */
    .platform {
      position: absolute;
      height: 10px;
      background:
        repeating-linear-gradient(
          90deg,
          var(--wood-1) 0 14px,
          var(--wood-2) 14px 28px
        );
      border-radius: 8px;
      box-shadow: 0 10px 18px rgba(0,0,0,0.28);
      border: 1px solid rgba(0,0,0,0.18);
      z-index: 2;
    }
    .platform::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      background: repeating-linear-gradient(180deg, transparent 0 6px, var(--wood-line) 6px 7px);
      opacity:0.55;
      pointer-events:none;
    }

    /* hole */
    .hole {
      position: absolute;
      bottom: 0;
      height: 40px;
      background: linear-gradient(to top, #000000 0%, #020617 55%);
      border-radius: 6px 6px 0 0;
      box-shadow:
        inset 0 0 24px rgba(0,0,0,0.9),
        0 -2px 0 rgba(148,163,184,0.6);
      z-index: 1;
      overflow: hidden;
    }
    .hole::before {
      content: "";
      position: absolute;
      left: 0; right: 0; bottom: 0;
      height: 14px;
      background: repeating-linear-gradient(-45deg, transparent 0 10px, #b91c1c 10px 20px);
      box-shadow: 0 -2px 8px rgba(248,113,113,0.8);
    }
    .hole::after {
      content: "";
      position: absolute;
      left: 50%;
      bottom: 2px;
      width: 60%;
      height: 10px;
      transform: translateX(-50%);
      background: radial-gradient(circle, rgba(248,113,113,0.7), transparent);
      opacity: 0.9;
    }

    /* collectibles */
    .collectible {
      position: absolute;
      z-index: 4;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      line-height: 1;
      user-select: none;
      pointer-events: none;
      will-change: transform, opacity;
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.10);
    }

    .collectible.coin {
      background: radial-gradient(circle at 30% 30%, #fff7d6, #fde047, #f59e0b);
      box-shadow: 0 0 18px rgba(250, 204, 21, 0.38), inset 0 1px 0 rgba(255,255,255,0.14);
    }

    .collectible.energy {
      background: radial-gradient(circle at 30% 20%, #99FFCC, #00FFFF, #FFFFCC);
      box-shadow: 0 0 18px rgba(248, 113, 113, 0.38), inset 0 1px 0 rgba(255,255,255,0.14);
      font-size: 18px;
      transform: scale(1);
    }
    .collectible.energy.small  { transform: scale(0.75); }
    .collectible.energy.medium { transform: scale(1.25); }

    /* ‚úÖ Big heart: GOLD + 2x size */
    .collectible.energy.large  {
      transform: scale(2.2);
      background: radial-gradient(circle at 30% 20%, #fff7d6, #fde047, #f59e0b);
      box-shadow:
        0 0 26px rgba(250,204,21,0.65),
        0 0 60px rgba(250,204,21,0.28),
        inset 0 1px 0 rgba(255,255,255,0.18);
      border-color: rgba(250,204,21,0.30);
      font-size: 18px;
    }

    .collectible.magnet {
      background: radial-gradient(circle at 30% 20%, #e0f2fe, #7dd3fc, #0284c7);
      box-shadow: 0 0 18px rgba(56, 189, 248, 0.38), inset 0 1px 0 rgba(255,255,255,0.14);
    }
    .collectible.boost {
      background: linear-gradient(90deg, #bbf7d0, #22c55e);
      box-shadow: 0 0 18px rgba(34, 197, 94, 0.38), inset 0 1px 0 rgba(255,255,255,0.14);
    }
    .collectible.giant {
      background: radial-gradient(circle at 30% 20%, #e0e7ff, #a5b4fc, #4f46e5);
      box-shadow: 0 0 18px rgba(129, 140, 248, 0.38), inset 0 1px 0 rgba(255,255,255,0.14);
    }

    /* ‚úÖ Jelly (trail): smaller 25% */
    .collectible.jelly{
      transform: scale(0.75);
      background: radial-gradient(circle at 30% 20%, #f5d0fe, #c084fc, #7c3aed);
      box-shadow: 0 0 18px rgba(192,132,252,0.40), inset 0 1px 0 rgba(255,255,255,0.14);
      border-color: rgba(216,180,254,0.30);
      font-size: 18px;
    }

    /* UI under game */
    #touchControls {
      margin-top: 14px;
      width: 800px;
      max-width: 95vw;
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .ctrl-btn {
      flex: 1;
      padding: 12px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: radial-gradient(circle at 20% 0, #1f2937, #020617);
      color: #e5e7eb;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.04em;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(15,23,42,0.9);
      text-transform: uppercase;
      user-select:none;
      touch-action: none;
      -webkit-tap-highlight-color: transparent;
    }
    .ctrl-btn span {
      font-size: 11px;
      display: block;
      opacity: 0.7;
      margin-top: 2px;
    }
    .ctrl-btn:hover { border-color: #38bdf8; box-shadow: 0 0 14px rgba(56,189,248,0.7); }
    .ctrl-btn:active { transform: translateY(1px) scale(0.98); }

    #miniActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top: 10px;
    }
    .mini-btn{
      padding:8px 14px;
      border-radius:999px;
      border:1px solid #4b5563;
      background: radial-gradient(circle at 20% 0, #1f2937, #020617);
      color:#e5e7eb;
      font-size:13px;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(15,23,42,0.9);
      user-select:none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .mini-btn:hover{ border-color: rgba(99,102,241,0.65); }
    .mini-btn:active{ transform: translateY(1px) scale(0.98); }

    #cheatTimer {
      margin-top: 4px;
      font-size: 14px;
      min-height: 20px;
      color: #facc15;
      text-shadow: 0 0 8px rgba(250, 204, 21, 0.35);
      user-select:none;
    }

    #mission {
      margin-top: 6px;
      font-size: 12px;
      color: #9ca3af;
      max-width: 800px;
      text-align: center;
      padding: 0 12px;
      user-select:none;
    }

    #message {
      margin-top: 6px;
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
      max-width: 800px;
      padding: 0 12px;
      user-select:none;
      min-height: 18px;
    }

    #itemGuide {
      margin-top: 10px;
      font-size: 12px;
      color: #e5e7eb;
      max-width: 800px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(148,163,184,0.45);
    }
    #itemGuide strong { color: #facc15; }
    #itemGuide ul { margin: 6px 0 0; padding-left: 18px; }
    #itemGuide li { margin-bottom: 4px; }

    @keyframes hitShake {
      0%   { transform: translate(0, 0); }
      20%  { transform: translate(-4px, 2px); }
      40%  { transform: translate(4px, -2px); }
      60%  { transform: translate(-3px, 1px); }
      80%  { transform: translate(3px, -1px); }
      100% { transform: translate(0, 0); }
    }
    #gameContainer.shake { animation: hitShake 0.25s ease; }

    #hitFlash {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle, rgba(248,250,252,0.25), transparent 60%);
      mix-blend-mode: screen;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.12s ease;
      z-index: 999;
    }
    body.hit-blink #hitFlash { opacity: 1; }

    /* Start overlay */
    #startOverlay{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
      z-index: 50;
      background: rgba(2,6,23,0.65);
      backdrop-filter: blur(3px);
    }
    #startOverlay.hidden{ display:none; }

    #startOverlay .title{
      font-weight: 900;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #e5e7eb;
      opacity: 0.95;
      text-shadow: 0 12px 28px rgba(0,0,0,0.35);
    }
    #startGameBtn{
      padding: 12px 18px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      cursor:pointer;
      font-weight: 900;
      letter-spacing: 0.04em;
      background: linear-gradient(90deg, rgba(34,197,94,0.95), rgba(45,212,191,0.95));
      color: #022c22;
      box-shadow: 0 18px 44px rgba(34,197,94,0.22);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    #startGameBtn:hover{ filter: brightness(1.03); transform: translateY(-1px); }
    #startGameBtn:active{ transform: translateY(1px); }

    #countdownText{
      font-size: 54px;
      font-weight: 950;
      letter-spacing: 0.08em;
      color: #facc15;
      text-shadow: 0 0 16px rgba(250,204,21,0.28);
      min-height: 62px;
    }
    #startHintMini{
      font-size: 12px;
      color:#9ca3af;
      text-align:center;
      padding: 0 14px;
      line-height: 1.4;
    }

    /* Pause overlay */
    #pauseOverlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:10px;
      z-index: 60;
      background: rgba(2,6,23,0.55);
      backdrop-filter: blur(2px);
    }
    #pauseOverlay.show{ display:flex; }
    #pauseOverlay .pTitle{
      font-weight: 900;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color:#e5e7eb;
      opacity: 0.95;
    }
    #resumeBtnOverlay{
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.35);
      cursor:pointer;
      font-weight: 900;
      background: rgba(2,6,23,0.65);
      color:#e5e7eb;
      box-shadow: 0 14px 34px rgba(0,0,0,0.28);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    #resumeBtnOverlay:hover{ border-color: rgba(99,102,241,0.65); }
    #resumeBtnOverlay:active{ transform: translateY(1px); }

    /* Game Over modal */
    #gameOverModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 1200;
      background: rgba(2,6,23,0.72);
      backdrop-filter: blur(4px);
    }
    #gameOverModal.show { display: flex; }

    .modal-card {
      width: min(520px, 96vw);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.92);
      box-shadow: 0 24px 60px rgba(0,0,0,0.55);
      padding: 16px 16px 14px;
    }
    .modal-title {
      font-weight: 900;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #facc15;
      text-shadow: 0 0 18px rgba(250,204,21,0.25);
      margin-bottom: 8px;
      font-size: 18px;
    }
    .modal-stats {
      color: #e5e7eb;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 12px;
    }
    .modal-stats b { color: #facc15; }
    .modal-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    .modal-btn {
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.35);
      cursor: pointer;
      font-weight: 900;
      letter-spacing: 0.03em;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
      transition: transform 0.08s ease, filter 0.12s ease, opacity 0.12s ease;
      user-select:none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .modal-btn:hover { filter: brightness(1.05); transform: translateY(-1px); }
    .modal-btn:active { transform: translateY(1px); }

    #reviveFreeBtn{
      background: linear-gradient(90deg, rgba(34,197,94,0.95), rgba(250,204,21,0.95));
      color: #02120b;
      border-color: rgba(250,204,21,0.55);
    }
    #revivePaidBtn{
      background: linear-gradient(90deg, rgba(56,189,248,0.95), rgba(34,197,94,0.95));
      color: #02121a;
      border-color: rgba(56,189,248,0.55);
    }
    #restartBtn {
      background: linear-gradient(90deg, #22c55e, #2dd4bf);
      color: #022c22;
      border-color: rgba(34,197,94,0.55);
    }
    .modal-note {
      margin-top: 10px;
      font-size: 12px;
      color: #9ca3af;
      text-align: center;
      user-select:none;
    }

    /* Shop modal */
    #shopModal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 1300;
      background: rgba(2,6,23,0.78);
      backdrop-filter: blur(4px);
    }
    #shopModal.show{ display:flex; }

    .shop-card{
      width: min(760px, 96vw);
      max-height: 86vh;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.95);
      box-shadow: 0 28px 70px rgba(0,0,0,0.6);
      padding: 14px 14px 12px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .shop-body{
      overflow:auto;
      padding-right: 4px;
      margin-top: 6px;
      -webkit-overflow-scrolling: touch;
    }

    .shop-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      margin-bottom: 4px;
      flex: 0 0 auto;
    }
    .shop-title{
      font-weight: 950;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color:#facc15;
      text-shadow: 0 0 18px rgba(250,204,21,0.20);
    }
    .shop-sub{
      font-size: 12px;
      color:#9ca3af;
      margin-top: 4px;
      line-height:1.4;
    }
    .shop-close{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.55);
      color:#e5e7eb;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .shop-close:hover{ border-color: rgba(99,102,241,0.65); }
    .shop-close:active{ transform: translateY(1px); }

    .shop-balance{
      margin-top: 6px;
      font-size: 12px;
      color:#e5e7eb;
    }
    .shop-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-top: 8px;
      padding-bottom: 6px;
    }
    .shop-section-title{
      grid-column: 1 / -1;
      margin-top: 6px;
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
      opacity: 0.95;
    }
    .shop-section-note{
      grid-column: 1 / -1;
      margin-top: -6px;
      font-size: 12px;
      color:#9ca3af;
      line-height:1.35;
    }

    .shop-item{
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.25);
      background: rgba(2,6,23,0.35);
      padding: 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,0.22);
      overflow:hidden;
    }
    .shop-item h3{
      font-size: 14px;
      color:#e5e7eb;
      margin-bottom: 6px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .shop-item p{
      font-size: 12px;
      color:#9ca3af;
      line-height:1.4;
      margin-bottom: 10px;
    }
    .shop-row{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
    }
    .price{
      font-size: 12px;
      color:#facc15;
      font-weight: 800;
    }
    .shop-action{
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.65);
      color:#e5e7eb;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .shop-action:hover{ filter: brightness(1.06); }
    .shop-action:active{ transform: translateY(1px); }
    .shop-action[disabled]{
      opacity: 0.45;
      cursor:not-allowed;
    }
    .swatch{
      width: 26px;
      height: 26px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06), 0 10px 20px rgba(0,0,0,0.25);
      flex: 0 0 auto;
    }

    /* Sound modal */
    #soundModal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 1350;
      background: rgba(2,6,23,0.78);
      backdrop-filter: blur(4px);
    }
    #soundModal.show{ display:flex; }
    .sound-card{
      width: min(640px, 96vw);
      max-height: 86vh;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.95);
      box-shadow: 0 28px 70px rgba(0,0,0,0.6);
      padding: 14px 14px 12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .sound-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }
    .sound-title{
      font-weight: 950;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color:#facc15;
      text-shadow: 0 0 18px rgba(250,204,21,0.20);
    }
    .sound-sub{
      font-size: 12px;
      color:#9ca3af;
      margin-top: 4px;
      line-height:1.4;
    }
    .sound-close{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.55);
      color:#e5e7eb;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .sound-close:hover{ border-color: rgba(99,102,241,0.65); }
    .sound-close:active{ transform: translateY(1px); }

    .sound-body{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .s-row{
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.25);
      background: rgba(2,6,23,0.35);
      padding: 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,0.18);
    }
    .s-row h3{
      font-size: 13px;
      color:#e5e7eb;
      margin-bottom: 8px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .s-line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .toggle input{ transform: scale(1.1); }
    .range-wrap{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 1;
      min-width: 240px;
    }
    .range-wrap input[type="range"]{
      width: 100%;
      accent-color: #facc15;
    }
    .pct{
      width: 56px;
      text-align:right;
      font-size: 12px;
      color:#e5e7eb;
      font-weight: 800;
    }
    .s-note{
      margin-top: 8px;
      font-size: 12px;
      color:#9ca3af;
      line-height: 1.4;
    }

    /* Bottom hint */
    #hint {
      margin-top: 12px;
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
      max-width: 900px;
      padding: 0 12px;
      line-height: 1.5;
    }

    @media (max-width: 600px) {
      #gameContainer { height: 230px; }
      #player { left: 40px; }
      #touchControls { margin-top: 12px; gap: 8px; }
      .ctrl-btn { padding: 10px 8px; font-size: 13px; }
      .shop-grid{ grid-template-columns: 1fr; }
      .range-wrap{ min-width: 200px; }
      .ig-left{ min-width: 200px; }
      .ig-right{ min-width: 200px; }
      .ig-coins{ font-size: 11px; }
    }
  </style>
</head>

<body>
  <h1>PHANToM Runner</h1>

  <div id="gameContainer">
    <div id="ground"></div>
    <div id="boostBeam"></div>

    <div id="inGameTopBar">
      <div class="ig-left">
        <div class="ig-pill">
          <span>‚è∏ P</span>
          <span id="statusPill">READY</span>
        </div>

        <div class="ig-energy">
          <div class="ig-energy-top">
            <span>Energy</span>
            <b id="energyText">100 / 100</b>
          </div>
          <div id="energyBarWrapper"><div id="energyBar"></div></div>
        </div>
      </div>

      <div class="ig-center">
        <div class="ig-pill ig-coins" id="igCoinsPill" title="‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ / ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°">
          <span>ü§ë</span>
          <span class="muted">‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</span>
          <b id="runCoins">0</b>
          <span class="sep">‚Ä¢</span>
          <span class="muted">‡∏™‡∏∞‡∏™‡∏°</span>
          <b id="walletCoins">0</b>
        </div>
      </div>

      <div class="ig-right">
        <div class="ig-right-top">
          <button id="audioQuickBtn" class="ig-btn" title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á">üîä</button>
          <button id="pauseBtn" class="ig-btn">Pause</button>
        </div>

        <div class="ig-pill ig-scorebox" title="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ / ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
          <div id="score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</div>
          <div id="bestScore">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: 0</div>
        </div>
      </div>
    </div>

    <div id="player">
      <img src="phantom-runner.png" alt="PHANToM" />
    </div>

    <div id="startOverlay">
      <div class="title" id="startTitle">PHANToM RUNNER</div>
      <div id="countdownText"></div>
      <button id="startGameBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
      <div id="startHintMini">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ ‡∏Å‡∏î Space ‡∏Å‡πá‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ</div>
    </div>

    <div id="pauseOverlay">
      <div class="pTitle">PAUSED</div>
      <button id="resumeBtnOverlay">Resume</button>
      <div style="font-size:12px;color:#9ca3af;">‡∏Å‡∏î P ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Resume (‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥)</div>
    </div>
  </div>

  <div id="touchControls">
    <button id="btnJump" class="ctrl-btn">‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î <span>JUMP / SPACE</span></button>
    <button id="btnDuck" class="ctrl-btn">‡∏´‡∏°‡∏≠‡∏ö <span>DUCK / ‚Üì</span></button>
  </div>

  <div id="miniActions">
    <button id="fullscreenBtn" class="mini-btn">‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠</button>
    <button id="soundBtn" class="mini-btn">‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
    <button id="shopBtn" class="mini-btn">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    <button id="restartOutsideBtn" class="mini-btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
  </div>

  <div id="cheatTimer"></div>
  <div id="mission"></div>
  <div id="message">‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‚Äù ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Å‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</div>

  <div id="itemGuide">
    <strong>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°:</strong>
    <ul>
      <li>ü§ë <b>‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç (Coin)</b> : +‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô / ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</li>
      <li>‚ù§Ô∏è <b>‡∏´‡∏±‡∏ß‡πÉ‡∏à (Energy)</b> : ‡πÄ‡∏û‡∏¥‡πà‡∏° Energy (‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î) + ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</li>
      <li>üç¨ <b>‡πÄ‡∏à‡∏•‡∏•‡∏µ‡πà (Jelly)</b> : ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏Å‡∏¥‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 2 ‡πÄ‡∏ó‡πà‡∏≤ ‡πÅ‡∏•‡∏∞‡∏î‡∏£‡∏≠‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏ï‡πà‡∏Ç‡∏∂‡πâ‡∏ô-‡∏•‡∏á (‡∏î‡∏π‡∏î‡∏î‡πâ‡∏ß‡∏¢ Magnet ‡πÑ‡∏î‡πâ)</li>
      <li>üß≤ <b>Magnet</b> : ‡∏î‡∏π‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç/‡∏´‡∏±‡∏ß‡πÉ‡∏à/‡πÄ‡∏à‡∏•‡∏•‡∏µ‡πà ‡∏£‡∏≠‡∏ö ‡πÜ ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</li>
      <li>‚ö° <b>Boost</b> : ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏≠‡∏°‡∏ï‡∏∞‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡∏î‡∏£‡∏≠‡∏õ‡∏´‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ)</li>
      <li>üåÄ <b>Giant</b> : ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏£‡πà‡∏≤‡∏á ‡∏ä‡∏ô‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡∏û‡∏∑‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏á‡πÑ‡∏î‡πâ (‡∏î‡∏£‡∏≠‡∏õ‡∏´‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ)</li>
    </ul>
  </div>

  <div id="hint">
    Space / ‚Üë = ‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î (2 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞) ‚Ä¢ ‚Üì = ‡∏´‡∏°‡∏≠‡∏ö ‚Ä¢ ‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏•‡∏≠‡∏¢/‡∏ö‡∏±‡∏ô‡πÑ‡∏î ‚Ä¢ ‡∏´‡∏•‡∏∏‡∏°‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å (‡∏ï‡∏Å‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ) ‚Ä¢
    ‡∏Å‡∏î P = Pause/Resume (Resume ‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥) ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡πÅ‡∏ö‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç (‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -15% ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç -50% ‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)
    ‚Ä¢ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏∞ ‚Äú‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‚Äù ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
  </div>

  <div id="hitFlash"></div>

  <div id="gameOverModal" aria-modal="true" role="dialog">
    <div class="modal-card">
      <div class="modal-title">Game Over</div>
      <div id="modalStats" class="modal-stats"></div>

      <div class="modal-actions">
        <button id="reviveFreeBtn" class="modal-btn" style="display:none;">‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏ü‡∏£‡∏µ (Passive)</button>
        <button id="revivePaidBtn" class="modal-btn" style="display:none;">‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏î‡πâ‡∏ß‡∏¢ 50 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</button>
        <button id="restartBtn" class="modal-btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</button>
      </div>

      <div class="modal-note">‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ</div>
    </div>
  </div>

  <div id="shopModal" aria-modal="true" role="dialog">
    <div class="shop-card">
      <div class="shop-header">
        <div>
          <div class="shop-title">SHOP</div>
          <div class="shop-sub">‡∏ã‡∏∑‡πâ‡∏≠ ‚Äú‡∏ò‡∏µ‡∏°‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á/‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‚Äù + ‚Äú‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡πà‡∏ô‚Äù + ‚ÄúPassive (‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á)‚Äù ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏° (localStorage)</div>
          <div class="shop-balance">‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°: <b id="shopWalletCoins">0</b></div>
          <div class="shop-sub" id="shopPassiveInfo" style="margin-top:6px;"></div>
        </div>
        <button id="shopCloseBtn" class="shop-close">‡∏õ‡∏¥‡∏î</button>
      </div>

      <div class="shop-body">
        <div class="shop-grid" id="shopGrid"></div>
      </div>
    </div>
  </div>

  <div id="soundModal" aria-modal="true" role="dialog">
    <div class="sound-card">
      <div class="sound-header">
        <div>
          <div class="sound-title">SOUND</div>
          <div class="sound-sub">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å BGM / SFX ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä (localStorage)</div>
        </div>
        <button id="soundCloseBtn" class="sound-close">‡∏õ‡∏¥‡∏î</button>
      </div>

      <div class="sound-body">
        <div class="s-row">
          <h3>Master</h3>
          <div class="s-line">
            <label class="toggle">
              <input type="checkbox" id="audioMasterToggle">
              <span>‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
            </label>
            <button id="audioTestBtn" class="shop-action" style="border-radius:12px;">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
          </div>
          <div class="s-note">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ö‡∏≤‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ï‡πâ‡∏≠‡∏á ‚Äú‡πÅ‡∏ï‡∏∞/‡∏Ñ‡∏•‡∏¥‡∏Å‚Äù ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ</div>
        </div>

        <div class="s-row">
          <h3>BGM</h3>
          <div class="s-line">
            <label class="toggle">
              <input type="checkbox" id="bgmToggle">
              <span>‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á BGM</span>
            </label>
            <div class="range-wrap">
              <input type="range" id="bgmVolRange" min="0" max="100" value="65">
              <div class="pct" id="bgmPct">65%</div>
            </div>
          </div>
        </div>

        <div class="s-row">
          <h3>SFX</h3>
          <div class="s-line">
            <label class="toggle">
              <input type="checkbox" id="sfxToggle">
              <span>‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á SFX</span>
            </label>
            <div class="range-wrap">
              <input type="range" id="sfxVolRange" min="0" max="100" value="80">
              <div class="pct" id="sfxPct">80%</div>
            </div>
          </div>
        </div>

        <div class="s-note">Tip: ‡∏õ‡∏∏‡πà‡∏° ‚Äúüîä/üîá‚Äù ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡πÉ‡∏ô‡πÄ‡∏Å‡∏° = ‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß</div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const CFG_GRAVITY = 0.98;
      const CFG_JUMP_STRENGTH = 14.5;
      const CFG_MAX_JUMPS = 2;

      const CFG_MAX_ENERGY = 100;
      const CFG_ENERGY_DECAY_PER_SEC = 4;
      const CFG_DAMAGE_GROUND = 17;
      const CFG_DAMAGE_AIR = 28;

      const CFG_START_SPEED = 6;
      const CFG_MAX_SPEED = 20;

      const CFG_BOOST_MULTIPLIER = 1.6;

      const CFG_HIT_SLOW_FACTOR = 0.75;
      const CFG_HIT_SLOW_DURATION = 650;

      // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡∏ã‡πâ‡∏≥ 2.5 ‡∏ß‡∏¥ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏î‡∏ô‡∏ä‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô "‡πÇ‡∏î‡∏ô‡∏ä‡∏ô")
      const CFG_HIT_IFRAMES = 350; // ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏ä‡πà‡∏ô revive
      const CFG_HIT_IFRAMES_ON_HIT = 2500;

      const CFG_HOLE_CHANCE = 0.18;
      const CFG_TRAP_Y = -60;

      const CFG_CHEAT_INVINCIBLE_DURATION = 10000;
      const CFG_MAGNET_DURATION = 3500;

      /* ‚úÖ ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏Å‡πâ‡πÄ‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° */
      const CFG_BOOST_DURATION = 5150;
      const CFG_GIANT_DURATION = 3800;

      const CFG_MAGNET_RADIUS = 350;

      /* ‚úÖ ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏Å‡πâ‡πÄ‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° */
      const CFG_HEART_SMALL_GAIN = 3;
      const CFG_HEART_MEDIUM_GAIN = 8;
      const CFG_HEART_LARGE_GAIN = 36;

      const CFG_SPEED_UP_ON_BIG_HEART = 1.2;

      const CFG_MISSION_COIN_TARGET = 20;
      const CFG_MISSION_DJ_TARGET = 10;
      const CFG_MISSION_OBS_TARGET = 30;

      const CFG_COIN_BASE_INTERVAL = 1900;
      const CFG_COIN_MIN_INTERVAL  = 450;

      const CFG_HEART_BASE_INTERVAL = 2500;
      const CFG_HEART_MIN_INTERVAL  = 1450;

      /* ‚úÖ Magnet spawn interval */
      const CFG_MAGNET_BASE_INTERVAL = 4500;
      const CFG_MAGNET_MIN_INTERVAL  = 2900;

      // ‚úÖ Jelly trail (drops a lot)
      const CFG_JELLY_TRAIL_BASE_INTERVAL = 1550;
      const CFG_JELLY_TRAIL_MIN_INTERVAL  = 700;

      const CFG_BIG_HEART_EVERY_MS = 40000;

      const CFG_CHEAT_WINDOW = 1000;

      const CFG_REVIVE_COST = 50;
      const CFG_REVIVE_ENERGY = 55;
      const CFG_REVIVE_INVINCIBLE_MS = 1200;
      const CFG_POST_REVIVE_SCORE_MULT = 0.85;
      const CFG_POST_REVIVE_COIN_MULT  = 0.50;
      const CFG_COUNTDOWN_SECONDS = 3;

      /* ‚úÖ ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏Å‡πâ‡πÄ‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° */
      const CFG_BG_MIN_MS = 25500;
      const CFG_BG_MAX_MS = 37500;

      /* ===== Shop: Power Items + Passive ===== */
      const CFG_SHOP_START_ENERGY_MAX = 150;
      const CFG_SHOP_START_BOOST_MS   = 5000;
      const CFG_PASSIVE_BOX_BASE_PRICE = 150;
      const CFG_PASSIVE_DUPLICATE_DISCOUNT = 0.85;

      const LS_BEST = "phantom_runner_best";
      const LS_WALLET = "phantom_runner_wallet_coins";

      const LS_BACKDROPS_UNLOCK = "phantom_runner_backdrops_unlocked";
      const LS_BACKDROP_SELECTED = "phantom_runner_backdrop_selected";
      const LS_OBS_UNLOCK = "phantom_runner_obstacles_unlocked";
      const LS_OBS_SELECTED = "phantom_runner_obstacles_selected";

      const LS_AUDIO_MASTER = "phantom_runner_audio_master";
      const LS_AUDIO_BGM_ON = "phantom_runner_audio_bgm_on";
      const LS_AUDIO_SFX_ON = "phantom_runner_audio_sfx_on";
      const LS_AUDIO_BGM_VOL = "phantom_runner_audio_bgm_vol";
      const LS_AUDIO_SFX_VOL = "phantom_runner_audio_sfx_vol";

      const LS_POWER_INV = "phantom_runner_power_inventory";
      const LS_PASSIVE_CURRENT = "phantom_runner_passive_current";
      const LS_PASSIVE_DISCOUNT_STEPS = "phantom_runner_passive_discount_steps";

      const gameContainer = document.getElementById("gameContainer");
      const player = document.getElementById("player");
      const scoreEl = document.getElementById("score");
      const bestScoreEl = document.getElementById("bestScore");
      const messageEl = document.getElementById("message");
      const cheatTimerEl = document.getElementById("cheatTimer");
      const btnJump = document.getElementById("btnJump");
      const btnDuck = document.getElementById("btnDuck");
      const energyBar = document.getElementById("energyBar");
      const energyText = document.getElementById("energyText");

      const walletCoinsEl = document.getElementById("walletCoins");
      const runCoinsEl = document.getElementById("runCoins");

      const missionEl = document.getElementById("mission");
      const boostBeam = document.getElementById("boostBeam");

      const fullscreenBtn = document.getElementById("fullscreenBtn");
      const restartOutsideBtn = document.getElementById("restartOutsideBtn");

      const pauseBtn = document.getElementById("pauseBtn");
      const pauseOverlay = document.getElementById("pauseOverlay");
      const resumeBtnOverlay = document.getElementById("resumeBtnOverlay");
      const statusPill = document.getElementById("statusPill");

      const startOverlay = document.getElementById("startOverlay");
      const startGameBtn = document.getElementById("startGameBtn");
      const countdownText = document.getElementById("countdownText");
      const startTitle = document.getElementById("startTitle");
      const startHintMini = document.getElementById("startHintMini");

      const gameOverModal = document.getElementById("gameOverModal");
      const modalStats = document.getElementById("modalStats");
      const reviveFreeBtn = document.getElementById("reviveFreeBtn");
      const revivePaidBtn = document.getElementById("revivePaidBtn");
      const restartBtn = document.getElementById("restartBtn");

      const shopBtn = document.getElementById("shopBtn");
      const shopModal = document.getElementById("shopModal");
      const shopCloseBtn = document.getElementById("shopCloseBtn");
      const shopGrid = document.getElementById("shopGrid");
      const shopWalletCoins = document.getElementById("shopWalletCoins");
      const shopPassiveInfo = document.getElementById("shopPassiveInfo");

      const audioQuickBtn = document.getElementById("audioQuickBtn");
      const soundBtn = document.getElementById("soundBtn");
      const soundModal = document.getElementById("soundModal");
      const soundCloseBtn = document.getElementById("soundCloseBtn");
      const audioMasterToggle = document.getElementById("audioMasterToggle");
      const bgmToggle = document.getElementById("bgmToggle");
      const sfxToggle = document.getElementById("sfxToggle");
      const bgmVolRange = document.getElementById("bgmVolRange");
      const sfxVolRange = document.getElementById("sfxVolRange");
      const bgmPct = document.getElementById("bgmPct");
      const sfxPct = document.getElementById("sfxPct");
      const audioTestBtn = document.getElementById("audioTestBtn");

      function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
      function randomBetween(min, max) { return Math.random() * (max - min) + min; }
      function randInt(min, maxIncl){ return Math.floor(randomBetween(min, maxIncl + 1)); }

      const Sounds = {
        bgm: new Audio("bgm_main.mp3"),
        countdown: new Audio("sfx_countdown.mp3"),
        jump: new Audio("sfx_jump.mp3"),
        coin: new Audio("sfx_coin.mp3"),
        powerup: new Audio("sfx_powerup.mp3"),
        hit: new Audio("sfx_hit.mp3"),
        gameover: new Audio("sfx_gameover.mp3"),
        revive: new Audio("sfx_revive.mp3"),
        click: new Audio("sfx_click.mp3"),
      };

      const BASE_VOL = {
        bgm: 0.22,
        countdown: 0.35,
        jump: 0.35,
        coin: 0.35,
        powerup: 0.40,
        hit: 0.45,
        gameover: 0.50,
        revive: 0.45,
        click: 0.35,
      };

      Sounds.bgm.loop = true;

      let audioUnlocked = false;

      function loadBool(key, def){
        try{
          const v = localStorage.getItem(key);
          if (v === null || v === undefined) return def;
          return v === "1" || v === "true";
        }catch(_){ return def; }
      }
      function loadNum(key, def){
        try{
          const v = parseFloat(localStorage.getItem(key));
          return Number.isFinite(v) ? v : def;
        }catch(_){ return def; }
      }
      function saveBool(key, v){ try{ localStorage.setItem(key, v ? "1" : "0"); }catch(_){ } }
      function saveNum(key, v){ try{ localStorage.setItem(key, String(v)); }catch(_){ } }

      function loadJSON(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          if (!raw) return fallback;
          const obj = JSON.parse(raw);
          return (obj && typeof obj === "object") ? obj : fallback;
        }catch(_){ return fallback; }
      }
      function saveJSON(key, obj){
        try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(_){}
      }

      let audioEnabled = loadBool(LS_AUDIO_MASTER, true);
      let bgmEnabled = loadBool(LS_AUDIO_BGM_ON, true);
      let sfxEnabled = loadBool(LS_AUDIO_SFX_ON, true);
      let bgmVolume = clamp(loadNum(LS_AUDIO_BGM_VOL, 0.65), 0, 1);
      let sfxVolume = clamp(loadNum(LS_AUDIO_SFX_VOL, 0.80), 0, 1);

      function unlockAudioOnce(){
        if (audioUnlocked) return;
        audioUnlocked = true;
        try{
          const prev = Sounds.click.volume;
          Sounds.click.volume = 0;
          const p = Sounds.click.play();
          if (p && p.catch) p.catch(()=>{});
          setTimeout(()=>{ try{ Sounds.click.pause(); Sounds.click.currentTime = 0; Sounds.click.volume = prev; }catch(_){ } }, 80);
        }catch(_){}
      }
      document.addEventListener("pointerdown", unlockAudioOnce, { once:true });

      function applyAudioVolumes(){
        Sounds.bgm.volume = BASE_VOL.bgm * bgmVolume;

        const s = sfxVolume;
        Sounds.countdown.volume = BASE_VOL.countdown * s;
        Sounds.jump.volume      = BASE_VOL.jump * s;
        Sounds.coin.volume      = BASE_VOL.coin * s;
        Sounds.powerup.volume   = BASE_VOL.powerup * s;
        Sounds.hit.volume       = BASE_VOL.hit * s;
        Sounds.gameover.volume  = BASE_VOL.gameover * s;
        Sounds.revive.volume    = BASE_VOL.revive * s;
        Sounds.click.volume     = BASE_VOL.click * s;
      }

      function updateAudioQuickBtn(){
        audioQuickBtn.textContent = audioEnabled ? "üîä" : "üîá";
      }

      function playSFX(a){
        if (!audioEnabled || !sfxEnabled) return;
        if (!a) return;
        try{
          a.currentTime = 0;
          const p = a.play();
          if (p && typeof p.catch === "function") p.catch(()=>{});
        }catch(_){}
      }

      function bgmPlay(){
        if (!audioEnabled || !bgmEnabled) return;
        try{
          const p = Sounds.bgm.play();
          if (p && p.catch) p.catch(()=>{});
        }catch(_){}
      }
      function bgmPause(){
        try{ Sounds.bgm.pause(); }catch(_){}
      }

      function applyAudioSettings(){
        applyAudioVolumes();
        updateAudioQuickBtn();

        audioMasterToggle.checked = !!audioEnabled;
        bgmToggle.checked = !!bgmEnabled;
        sfxToggle.checked = !!sfxEnabled;

        bgmVolRange.value = String(Math.round(bgmVolume * 100));
        sfxVolRange.value = String(Math.round(sfxVolume * 100));
        bgmPct.textContent = Math.round(bgmVolume * 100) + "%";
        sfxPct.textContent = Math.round(sfxVolume * 100) + "%";

        if (!audioEnabled || !bgmEnabled) bgmPause();
        else {
          if (isRunning && !gameOver && !isPaused && !countdownTimer) bgmPlay();
        }
      }

      const Backdrops = [
        { id:"toxic",  name:"Toxic Lab (Default)", desc:"‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏° ‡πÜ ‡πÇ‡∏ó‡∏ô‡∏û‡∏¥‡∏©", price:0,   css:{ "--bg1":"#1d2337", "--bg2":"#020617" } },
        { id:"nebula", name:"Purple Nebula",       desc:"‡∏°‡πà‡∏ß‡∏á‡∏•‡∏∂‡∏Å ‡πÜ ‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏•", price:120, css:{ "--bg1":"#20102e", "--bg2":"#050312" } },
        { id:"neon",   name:"Neon City",           desc:"‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô/‡∏ô‡∏µ‡∏≠‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏° ‡πÜ",  price:150, css:{ "--bg1":"#0b1b2e", "--bg2":"#020617" } },
        { id:"dusk",   name:"Midnight Dusk",       desc:"‡πÄ‡∏Ç‡πâ‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô",      price:180, css:{ "--bg1":"#0a1224", "--bg2":"#020617" } },
        { id:"sunset", name:"Sunset Ember",        desc:"‡∏™‡πâ‡∏°/‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ï‡∏Å", price:220, css:{ "--bg1":"#2a0f10", "--bg2":"#07040a" } },
        { id:"arctic", name:"Arctic Cyan",         desc:"‡∏ü‡πâ‡∏≤/‡πÑ‡∏ã‡πÅ‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô ‡πÜ",      price:240, css:{ "--bg1":"#061a2b", "--bg2":"#020617" } },
      ];

      const ObstacleThemes = [
        { id:"poison", name:"Poison Slate (Default)", desc:"‡πÇ‡∏ó‡∏ô‡∏û‡∏¥‡∏©‡∏°‡∏∑‡∏î ‡πÜ", price:0,
          css:{ "--obs-a":"#111827","--obs-b":"#0b1020","--obs-c":"#2e1065","--obs-d":"#0b1020","--obs-border":"rgba(148,163,184,0.16)","--obs-shadow":"rgba(0,0,0,0.35)" } },
        { id:"ember", name:"Ember Core", desc:"‡πÅ‡∏î‡∏á/‡∏™‡πâ‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏î ‡πÜ", price:140,
          css:{ "--obs-a":"#2b0a0a","--obs-b":"#3b0a0a","--obs-c":"#7f1d1d","--obs-d":"#1f0a0a","--obs-border":"rgba(248,113,113,0.18)","--obs-shadow":"rgba(0,0,0,0.38)" } },
        { id:"cyber", name:"Cyber Neon", desc:"‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô/‡∏°‡πà‡∏ß‡∏á‡∏ô‡∏µ‡∏≠‡∏≠‡∏ô", price:170,
          css:{ "--obs-a":"#0a1020","--obs-b":"#0b2a3a","--obs-c":"#5b21b6","--obs-d":"#0b1020","--obs-border":"rgba(56,189,248,0.18)","--obs-shadow":"rgba(0,0,0,0.36)" } },
        { id:"forest", name:"Deep Forest", desc:"‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°/‡∏î‡∏≥", price:190,
          css:{ "--obs-a":"#07110b","--obs-b":"#0a1a12","--obs-c":"#14532d","--obs-d":"#07110b","--obs-border":"rgba(34,197,94,0.16)","--obs-shadow":"rgba(0,0,0,0.36)" } },
        { id:"ice", name:"Frost Byte", desc:"‡∏ü‡πâ‡∏≤‡πÄ‡∏¢‡πá‡∏ô/‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô", price:210,
          css:{ "--obs-a":"#07141f","--obs-b":"#0b2a3a","--obs-c":"#1d4ed8","--obs-d":"#07141f","--obs-border":"rgba(147,197,253,0.18)","--obs-shadow":"rgba(0,0,0,0.34)" } },
      ];

      const PowerItems = [
        { id:"energy150", icon:"üîã", name:"Start Energy 150", price:60, desc:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏î‡πâ‡∏ß‡∏¢ Energy 150 (‡πÄ‡∏û‡∏¥‡πà‡∏° Max ‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô 150) ‚Ä¢ ‡πÉ‡∏ä‡πâ 1 ‡∏ä‡∏¥‡πâ‡∏ô/‡πÄ‡∏Å‡∏° ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" },
        { id:"startBoost", icon:"‚ö°", name:"Start Boost 5s",  price:80, desc:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏ï‡∏¥‡∏î Boost ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ ‡πÉ‡∏ä‡πâ 1 ‡∏ä‡∏¥‡πâ‡∏ô/‡πÄ‡∏Å‡∏° ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" },
      ];

      const PassivePool = [
        { id:"none",       icon:"‚≠ï", name:"None",         desc:"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Passive" },
        { id:"coin2x",     icon:"ü§ë", name:"Coin x2",      desc:"‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ x2 (‡∏£‡∏ß‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°‡∏î‡πâ‡∏ß‡∏¢)" },
        { id:"energySaver",icon:"üî∞", name:"Energy Saver", desc:"‡πÉ‡∏ä‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á 15% (‡∏ó‡∏±‡πâ‡∏á‡∏•‡∏î‡πÄ‡∏≠‡∏á + ‡πÇ‡∏î‡∏ô‡∏ä‡∏ô)" },
        { id:"freeRevive", icon:"üß¨", name:"Free Revive",  desc:"‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏ü‡∏£‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡πÄ‡∏Å‡∏° (‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç) ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å (‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô)" },
        { id:"holeShield", icon:"üõ°Ô∏è", name:"Hole Shield",  desc:"‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏Å‡∏´‡∏•‡∏∏‡∏°‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ" },
      ];

      function getPassiveObj(id){
        return PassivePool.find(p=>p.id===id) || PassivePool[0];
      }
      function getPassiveName(id){
        const p = getPassiveObj(id);
        return (p.icon ? (p.icon + " ") : "") + p.name;
      }
      function getPassiveDesc(id){
        const p = getPassiveObj(id);
        return p.desc || "";
      }
      function getPassiveBoxPrice(discountSteps){
        const factor = Math.pow(CFG_PASSIVE_DUPLICATE_DISCOUNT, discountSteps);
        return Math.max(1, Math.ceil(CFG_PASSIVE_BOX_BASE_PRICE * factor));
      }

      function loadUnlockedObj(key, defaultId){
        try{
          const raw = localStorage.getItem(key);
          let obj = raw ? JSON.parse(raw) : {};
          if (!obj || typeof obj !== "object") obj = {};
          obj[defaultId] = true;
          return obj;
        }catch(_){
          const o = {}; o[defaultId] = true; return o;
        }
      }
      function saveUnlockedObj(key, obj){
        try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(_){}
      }
      function loadSelectedId(key, fallback){
        return localStorage.getItem(key) || fallback;
      }
      function saveSelectedId(key, id){
        try{ localStorage.setItem(key, id); }catch(_){}
      }

      let unlockedBackdrops = loadUnlockedObj(LS_BACKDROPS_UNLOCK, "toxic");
      let selectedBackdrop = loadSelectedId(LS_BACKDROP_SELECTED, "toxic");
      if (!unlockedBackdrops[selectedBackdrop]) selectedBackdrop = "toxic";

      let unlockedObsThemes = loadUnlockedObj(LS_OBS_UNLOCK, "poison");
      let selectedObsTheme = loadSelectedId(LS_OBS_SELECTED, "poison");
      if (!unlockedObsThemes[selectedObsTheme]) selectedObsTheme = "poison";

      function applyThemeVars(cssObj){
        for (const k in cssObj){
          document.documentElement.style.setProperty(k, cssObj[k]);
        }
      }
      function applyBackdrop(id){
        const b = Backdrops.find(x=>x.id===id) || Backdrops[0];
        applyThemeVars(b.css);
        selectedBackdrop = b.id;
        saveSelectedId(LS_BACKDROP_SELECTED, selectedBackdrop);
      }
      function applyObstacleTheme(id){
        const t = ObstacleThemes.find(x=>x.id===id) || ObstacleThemes[0];
        applyThemeVars(t.css);
        selectedObsTheme = t.id;
        saveSelectedId(LS_OBS_SELECTED, selectedObsTheme);
      }
      applyBackdrop(selectedBackdrop);
      applyObstacleTheme(selectedObsTheme);

      function swatchBackdrop(b){
        const c1 = b.css["--bg1"] || "#111827";
        const c2 = b.css["--bg2"] || "#020617";
        return `background: linear-gradient(180deg, ${c1}, ${c2});`;
      }
      function swatchObstacle(t){
        const a = t.css["--obs-a"], b = t.css["--obs-b"], c = t.css["--obs-c"], d = t.css["--obs-d"];
        return `background: linear-gradient(135deg, ${a}, ${b}, ${c}, ${d});`;
      }

      /* ===== Power inventory + Passive persistent ===== */
      let powerInv = loadJSON(LS_POWER_INV, { energy150: 0, startBoost: 0 });
      powerInv.energy150 = Math.max(0, parseInt(powerInv.energy150 || 0, 10));
      powerInv.startBoost = Math.max(0, parseInt(powerInv.startBoost || 0, 10));
      function savePowerInv(){
        saveJSON(LS_POWER_INV, powerInv);
      }

      let currentPassiveId = localStorage.getItem(LS_PASSIVE_CURRENT) || "none";
      if (!PassivePool.some(p=>p.id===currentPassiveId)) currentPassiveId = "none";

      let passiveDiscountSteps = parseInt(localStorage.getItem(LS_PASSIVE_DISCOUNT_STEPS) || "0", 10);
      if (!Number.isFinite(passiveDiscountSteps) || passiveDiscountSteps < 0) passiveDiscountSteps = 0;

      function savePassiveState(){
        try{ localStorage.setItem(LS_PASSIVE_CURRENT, currentPassiveId); }catch(_){}
        try{ localStorage.setItem(LS_PASSIVE_DISCOUNT_STEPS, String(passiveDiscountSteps)); }catch(_){}
      }

      const groundY = 40;

      let playerY = groundY;
      let prevPlayerY = groundY;
      let jumpVelocity = 0;
      let jumpsLeft = CFG_MAX_JUMPS;

      let isDucking = false;

      let maxEnergyRun = CFG_MAX_ENERGY;
      let energy = CFG_MAX_ENERGY;

      let score = 0;
      let bestScore = Number(localStorage.getItem(LS_BEST) || 0);

      let runCoins = 0;
      let walletCoins = Number(localStorage.getItem(LS_WALLET) || 0);

      let coinsCollected = 0;
      let totalDoubleJumps = 0;
      let obstaclesPassed = 0;

      let obstacles = [];
      let collectibles = [];
      let platforms = [];
      let holes = [];

      let speed = CFG_START_SPEED;

      let gameOver = false;
      let frameId = null;
      let lastTime = null;

      let isRunning = false;
      let isPaused = false;

      let countdownTimer = null;
      let countdownLeft = 0;
      let countdownMode = "start";

      let timeSinceLastObstacle = 0;
      let nextSpawnIn = 900;

      let timeSinceLastCoin = 0;
      let timeSinceLastHeart = 0;
      let timeSinceLastMagnet = 0;
      let timeSinceLastJelly = 0;
      let timeSinceLastBigHeart = 0;

      let timeSinceLastPlatform = 0;
      let nextPlatformIn = 2000 + Math.random() * (4500 - 2000);

      let timeSinceLastBG = 0;
      let nextBGIn = randomBetween(CFG_BG_MIN_MS, CFG_BG_MAX_MS);

      let invincible = false;
      let invincibleTimer = 0;

      let magnetActive = false;
      let magnetTimer = 0;

      let boostActive = false;
      let boostTimer = 0;

      let giantActive = false;
      let giantTimer = 0;

      let hitSlowTimer = 0;
      let hitIFramesTimer = 0;

      let cheatEvents = [];

      let revivedThisRun = false;
      let postReviveActive = false;
      let postScoreAcc = 0;
      let postScoreCredited = 0;
      let postCoinAcc = 0;
      let postCoinCredited = 0;

      let runPassiveId = "none";
      let runCoinMult = 1;
      let runEnergyMult = 1;
      let runFreeReviveAvailable = false;
      let freeReviveUsedThisRun = false;
      let runHoleShield = false;

      let plannedUseEnergy150 = false;
      let plannedUseStartBoost = false;

      let obstacleWaveLeft = 0;
      let obstacleRestLeft = 0;

      function saveWallet(){ try{ localStorage.setItem(LS_WALLET, String(walletCoins)); }catch(_){ } }

      function updateCoinsUI(){
        walletCoinsEl.textContent = String(walletCoins);
        runCoinsEl.textContent = String(runCoins);
        if (shopModal.classList.contains("show")) shopWalletCoins.textContent = String(walletCoins);
      }

      function updateEnergyUI() {
        const ratio = clamp(energy / maxEnergyRun, 0, 1);
        energyBar.style.width = (ratio * 100) + "%";
        energyText.textContent = Math.round(energy) + " / " + maxEnergyRun;
      }

      function updateMissionUI() {
        missionEl.textContent =
          "Mission: ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç " + coinsCollected + "/" + CFG_MISSION_COIN_TARGET +
          " ‚Ä¢ Double Jump " + totalDoubleJumps + "/" + CFG_MISSION_DJ_TARGET +
          " ‚Ä¢ ‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ " + obstaclesPassed + "/" + CFG_MISSION_OBS_TARGET;
      }

      function setStatus(text){ statusPill.textContent = text; }

      function showStartOverlay(){
        startOverlay.classList.remove("hidden");
        countdownText.textContent = "";
        setStatus("READY");
      }
      function hideStartOverlay(){ startOverlay.classList.add("hidden"); }

      function showPauseOverlay(){
        pauseOverlay.classList.add("show");
        setStatus("PAUSED");
      }
      function hidePauseOverlay(){ pauseOverlay.classList.remove("show"); }

      function hideGameOverModal(){ gameOverModal.classList.remove("show"); }

      function showGameOverModal(){
        const canFree = runFreeReviveAvailable && !freeReviveUsedThisRun;
        const canPaid = (!revivedThisRun && walletCoins >= CFG_REVIVE_COST);

        reviveFreeBtn.style.display = canFree ? "block" : "none";
        revivePaidBtn.style.display = canPaid ? "block" : "none";

        if (canFree){
          reviveFreeBtn.textContent = "‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏ü‡∏£‡∏µ (Passive) ‚Ä¢ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡πÄ‡∏Å‡∏°";
        }

        if (canPaid){
          revivePaidBtn.textContent = "‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏î‡πâ‡∏ß‡∏¢ " + CFG_REVIVE_COST + " ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: " + walletCoins + ")";
        }

        const passiveLine = (runPassiveId && runPassiveId !== "none")
          ? ("<br/>Passive: <b>" + getPassiveName(runPassiveId) + "</b>")
          : "";

        modalStats.innerHTML =
          "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <b>" + score + "</b><br/>" +
          "‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: <b>" + runCoins + "</b><br/>" +
          "‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b>" + walletCoins + "</b><br/>" +
          "Energy ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>" + Math.round(energy) + " / " + maxEnergyRun + "</b><br/>" +
          passiveLine +
          (postReviveActive ? "<br/><br/><b>‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û (‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç):</b> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -15% / ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç -50% (‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)" : "");

        gameOverModal.classList.add("show");
      }

      function cancelCountdown(){
        if (!countdownTimer) return;
        clearInterval(countdownTimer);
        countdownTimer = null;
        countdownLeft = 0;
        countdownText.textContent = "";
        startGameBtn.disabled = false;
        startGameBtn.style.display = "";
        startTitle.textContent = "PHANToM RUNNER";
        startHintMini.textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ ‡∏Å‡∏î Space ‡∏Å‡πá‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ";
        setStatus("READY");
      }
      function closeAllModals(){
        shopModal.classList.remove("show");
        soundModal.classList.remove("show");
      }

      function clearArrays() {
        obstacles.forEach(o => o && o.remove());
        obstacles = [];
        collectibles.forEach(c => c && c.remove());
        collectibles = [];
        platforms.forEach(p => p && p.remove());
        platforms = [];
        holes.forEach(h => h && h.remove());
        holes = [];
      }

      function resetPowerupsAndVFX(){
        invincible = false; invincibleTimer = 0;
        magnetActive = false; magnetTimer = 0;
        boostActive = false; boostTimer = 0;
        giantActive = false; giantTimer = 0;
        hitSlowTimer = 0;
        hitIFramesTimer = 0;

        player.classList.remove("invincible","giant","hurt-blink");
        cheatTimerEl.textContent = "";

        if (boostBeam) {
          boostBeam.style.opacity = 0;
          boostBeam.style.left = "-9999px";
        }
      }

      function addScore(base){
        if (!postReviveActive){
          score += base;
          return;
        }
        postScoreAcc += base * CFG_POST_REVIVE_SCORE_MULT;
        const newCred = Math.ceil(postScoreAcc);
        const gain = newCred - postScoreCredited;
        postScoreCredited = newCred;
        if (gain > 0) score += gain;
      }

      function addCoins(base){
        const adjustedBase = base * runCoinMult;

        if (!postReviveActive){
          runCoins += adjustedBase;
          walletCoins += adjustedBase;
          saveWallet();
          return;
        }
        postCoinAcc += adjustedBase * CFG_POST_REVIVE_COIN_MULT;
        const newCred = Math.ceil(postCoinAcc);
        const gain = newCred - postCoinCredited;
        postCoinCredited = newCred;
        if (gain > 0){
          runCoins += gain;
          walletCoins += gain;
          saveWallet();
        }
      }

      function setupRunModifiersForNextStart(){
        runPassiveId = currentPassiveId;

        runCoinMult = (runPassiveId === "coin2x") ? 2 : 1;
        runEnergyMult = (runPassiveId === "energySaver") ? 0.85 : 1;

        runFreeReviveAvailable = (runPassiveId === "freeRevive");
        freeReviveUsedThisRun = false;

        runHoleShield = (runPassiveId === "holeShield");

        plannedUseEnergy150 = (powerInv.energy150 > 0);
        plannedUseStartBoost = (powerInv.startBoost > 0);
      }

      function applyConsumablesOnBeginRun(){
        let usedAny = false;

        if (plannedUseEnergy150 && powerInv.energy150 > 0){
          powerInv.energy150 -= 1;
          maxEnergyRun = CFG_SHOP_START_ENERGY_MAX;
          energy = maxEnergyRun;
          usedAny = true;
        } else {
          maxEnergyRun = CFG_MAX_ENERGY;
          energy = maxEnergyRun;
        }

        if (plannedUseStartBoost && powerInv.startBoost > 0){
          powerInv.startBoost -= 1;
          usedAny = true;
        }

        if (usedAny) savePowerInv();

        updateEnergyUI();
        updateCoinsUI();

        if (plannedUseStartBoost){
          activateBoost(CFG_SHOP_START_BOOST_MS, true);
        }
      }

      function prepareNewRun(){
        cancelCountdown();
        closeAllModals();
        clearArrays();
        hideGameOverModal();
        hidePauseOverlay();

        score = 0;
        runCoins = 0;
        coinsCollected = 0;
        totalDoubleJumps = 0;
        obstaclesPassed = 0;
        speed = CFG_START_SPEED;

        playerY = groundY;
        prevPlayerY = groundY;
        jumpVelocity = 0;
        jumpsLeft = CFG_MAX_JUMPS;

        isDucking = false;
        player.classList.remove("duck", "invincible", "giant", "double-jump", "hurt-blink");
        player.style.bottom = playerY + "px";

        resetPowerupsAndVFX();

        maxEnergyRun = CFG_MAX_ENERGY;
        energy = maxEnergyRun;

        timeSinceLastObstacle = 0;
        nextSpawnIn = 900 + Math.random() * 700;

        timeSinceLastCoin = 0;
        timeSinceLastHeart = 0;
        timeSinceLastMagnet = 0;
        timeSinceLastJelly = 0;

        timeSinceLastBigHeart = 0;

        timeSinceLastPlatform = 0;
        nextPlatformIn = 2000 + Math.random() * (4500 - 2000);

        timeSinceLastBG = 0;
        nextBGIn = randomBetween(CFG_BG_MIN_MS, CFG_BG_MAX_MS);

        obstacleWaveLeft = 0;
        obstacleRestLeft = 900;

        revivedThisRun = false;
        postReviveActive = false;
        postScoreAcc = 0; postScoreCredited = 0;
        postCoinAcc = 0;  postCoinCredited = 0;

        runPassiveId = "none";
        runCoinMult = 1;
        runEnergyMult = 1;
        runFreeReviveAvailable = false;
        freeReviveUsedThisRun = false;
        runHoleShield = false;

        plannedUseEnergy150 = false;
        plannedUseStartBoost = false;

        gameOver = false;
        isRunning = false;
        isPaused = false;

        if (frameId) cancelAnimationFrame(frameId);
        frameId = null;
        lastTime = null;

        scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
        bestScoreEl.textContent = "‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: " + bestScore;
        updateCoinsUI();
        updateEnergyUI();
        updateMissionUI();

        messageEl.textContent = "‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‚Äù ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Å‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°";

        bgmPause();
        showStartOverlay();
      }

      function startCountdown(isResume){
        if (countdownTimer) return;
        if (gameOver) return;

        closeAllModals();
        hidePauseOverlay();

        unlockAudioOnce();
        playSFX(Sounds.click);

        countdownMode = isResume ? "resume" : "start";

        if (!isResume){
          setupRunModifiersForNextStart();
        }

        startOverlay.classList.remove("hidden");
        startGameBtn.disabled = true;
        setStatus("COUNTDOWN");

        if (isResume){
          startTitle.textContent = "RESUME";
          startHintMini.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°...";
          startGameBtn.style.display = "none";
        } else {
          startTitle.textContent = "PHANToM RUNNER";
          const passiveText = (runPassiveId && runPassiveId !== "none") ? (" ‚Ä¢ Passive: " + getPassiveName(runPassiveId)) : "";
          const powerText = (plannedUseEnergy150 || plannedUseStartBoost) ? " ‚Ä¢ ‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πà‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" : "";
          startHintMini.textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ ‡∏Å‡∏î Space ‡∏Å‡πá‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ" + passiveText + powerText;
          startGameBtn.style.display = "";
        }

        countdownLeft = CFG_COUNTDOWN_SECONDS;
        countdownText.textContent = String(countdownLeft);

        playSFX(Sounds.countdown);

        countdownTimer = setInterval(() => {
          countdownLeft -= 1;
          if (countdownLeft > 0){
            countdownText.textContent = String(countdownLeft);
            playSFX(Sounds.countdown);
            return;
          }

          countdownText.textContent = "GO!";
          playSFX(Sounds.countdown);

          clearInterval(countdownTimer);
          countdownTimer = null;

          setTimeout(() => {
            countdownText.textContent = "";
            startGameBtn.disabled = false;
            startGameBtn.style.display = "";
            hideStartOverlay();

            if (countdownMode === "resume") resumeAfterCountdown();
            else beginRun();
          }, 350);
        }, 1000);
      }

      function beginRun(){
        if (isRunning || gameOver) return;
        isRunning = true;
        isPaused = false;
        setStatus("RUN");

        applyConsumablesOnBeginRun();

        let msg = postReviveActive
          ? "‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û (‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç): ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -15% / ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç -50% (‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)"
          : "‡∏´‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏∏‡∏°‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!";

        if (runPassiveId && runPassiveId !== "none"){
          msg += " ‚Ä¢ Passive: " + getPassiveName(runPassiveId);
        }
        if (runHoleShield){
          msg += " ‚Ä¢ (‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏´‡∏•‡∏∏‡∏°)";
        }
        if (plannedUseEnergy150){
          msg += " ‚Ä¢ Start Energy 150";
        }
        if (plannedUseStartBoost){
          msg += " ‚Ä¢ Start Boost 5s";
        }

        messageEl.textContent = msg;

        spawnObstacle();
        lastTime = null;

        bgmPlay();
        frameId = requestAnimationFrame(gameLoop);
      }

      function pauseGame(silent){
        if (!isRunning || gameOver) return;
        if (isPaused) return;
        isPaused = true;

        if (!silent){
          unlockAudioOnce();
          playSFX(Sounds.click);
        }
        showPauseOverlay();

        bgmPause();
        if (frameId) cancelAnimationFrame(frameId);
        frameId = null;
        lastTime = null;
      }

      function resumeGame(){
        if (!isRunning || gameOver) return;
        if (!isPaused) return;
        startCountdown(true);
      }

      function resumeAfterCountdown(){
        if (!isRunning || gameOver) return;
        isPaused = false;

        unlockAudioOnce();
        playSFX(Sounds.click);
        hidePauseOverlay();
        setStatus("RUN");

        bgmPlay();
        lastTime = null;
        frameId = requestAnimationFrame(gameLoop);
      }

      document.addEventListener("visibilitychange", () => {
        if (document.hidden && isRunning && !gameOver && !isPaused) pauseGame(true);
      });

      function spawnHole() {
        const h = document.createElement("div");
        h.classList.add("hole");
        const width = randomBetween(80, 160);
        h.style.width = width + "px";
        h.style.left = gameContainer.offsetWidth + "px";
        h.style.bottom = "0px";
        gameContainer.appendChild(h);
        holes.push(h);
      }

      function setObstacleEmoji(obs, emoji, heightPx){
        obs.textContent = emoji;
        const fs = Math.max(18, Math.min(38, Math.round(heightPx * 0.55)));
        obs.style.fontSize = fs + "px";
      }

      const EMOJI_GROUND = { tree:"ü™µ", bush:"ü™¥", rock:"ü™®", spike:"üî∫", crate:"üì¶", barrel:"üõ¢Ô∏è", sign:"üöß", laser:"üíÄ", low:"üß±" };
      const EMOJI_AIR = { bird:"üê¶", drone:"üõ∏", fireball:"üî•" };
      const EMOJI_STAL = { stal1:"üîª", stal2:"ü™®", stal3:"üßä" };

      function spawnObstacle() {
        const roll = Math.random();

        if (roll < 0.18) {
          const obs = document.createElement("div");
          obs.classList.add("obstacle", "ceiling");

          const types = ["stal1","stal2","stal3"];
          const kind = types[Math.floor(Math.random() * types.length)];
          obs.classList.add(kind);

          const width  = randomBetween(34, 52);

          const top = 0;
          const height = randomBetween(92, 104);

          obs.style.width = width + "px";
          obs.style.height = height + "px";
          obs.style.top = top + "px";
          obs.style.left = gameContainer.offsetWidth + "px";

          setObstacleEmoji(obs, EMOJI_STAL[kind], height);

          gameContainer.appendChild(obs);
          obstacles.push(obs);
          return;
        }

        const isAir = roll < 0.50;

        if (!isAir && Math.random() < CFG_HOLE_CHANCE && !runHoleShield) {
          spawnHole();
          return;
        }

        const obs = document.createElement("div");
        obs.classList.add("obstacle");

        if (isAir) {
          const airTypes = ["bird", "drone", "fireball"];
          const kind = airTypes[Math.floor(Math.random() * airTypes.length)];
          obs.classList.add("air", kind);

          const height = randomBetween(24, 32);
          const width = randomBetween(34, 40);
          obs.style.width = width + "px";
          obs.style.height = height + "px";
          obs.style.bottom = randomBetween(95, 125) + "px";
          obs.style.left = gameContainer.offsetWidth + "px";

          setObstacleEmoji(obs, EMOJI_AIR[kind], height);
        } else {
          obs.classList.add("ground");

          const groundTypes = ["tree", "bush", "rock", "spike", "crate", "barrel", "sign", "laser", "low"];
          const kind = groundTypes[Math.floor(Math.random() * groundTypes.length)];
          obs.classList.add(kind);

          let height, width;
          if (kind === "low") {
            height = randomBetween(28, 52);
            width  = randomBetween(28, 48);
            obs.style.borderRadius = "14px";
          } else {
            height = randomBetween(45, 80);
            width  = randomBetween(22, 40);
          }

          obs.style.width = width + "px";
          obs.style.height = height + "px";
          obs.style.bottom = groundY + "px";
          obs.style.left = gameContainer.offsetWidth + "px";

          setObstacleEmoji(obs, EMOJI_GROUND[kind], height);
        }

        gameContainer.appendChild(obs);
        obstacles.push(obs);
      }

      function spawnPlatformGroup() {
        const num = Math.random() < 0.5 ? 2 : 3;
        const baseBottom = groundY + randomBetween(45, 130);
        const step = 24;
        const goingUp = Math.random() < 0.5;
        const baseLeft = gameContainer.offsetWidth + 80;

        for (let i = 0; i < num; i++) {
          const p = document.createElement("div");
          p.classList.add("platform");
          const width = randomBetween(80, 150);
          const spacing = 20;

          p.style.width = width + "px";
          p.style.left = (baseLeft + i * (width + spacing)) + "px";
          p.style.bottom = (baseBottom + (goingUp ? i : -i) * step) + "px";

          gameContainer.appendChild(p);
          platforms.push(p);
        }
      }

      function makeCollectibleBase() {
        const c = document.createElement("div");
        c.classList.add("collectible");
        c.dataset.dead = "0";
        c.dataset.pulled = "0";
        return c;
      }

      function setCollectibleLane(c, forceLane) {
        const lane = (typeof forceLane === "number") ? forceLane : Math.floor(Math.random() * 3);
        let bottom;
        if (lane === 0) bottom = groundY + 60;
        else if (lane === 1) bottom = groundY + 110;
        else bottom = groundY + 150;
        c.style.bottom = bottom + "px";
        c.style.left = gameContainer.offsetWidth + "px";
        return { lane, bottom };
      }

      function spawnCoin() {
        const c = makeCollectibleBase();
        c.classList.add("coin");
        c.textContent = "ü§ë";
        setCollectibleLane(c);
        gameContainer.appendChild(c);
        collectibles.push(c);
      }

      // ‚úÖ ‡∏´‡∏±‡∏ß‡πÉ‡∏à ‚Äúsmall‚Äù ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏Å (medium ‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ rare pool)
      function spawnSmallHeart() {
        const c = makeCollectibleBase();
        c.classList.add("energy", "small");
        c.dataset.energy = String(CFG_HEART_SMALL_GAIN);
        c.textContent = "‚ù§Ô∏è";
        setCollectibleLane(c);
        gameContainer.appendChild(c);
        collectibles.push(c);
      }

      // ‚úÖ ‡∏´‡∏±‡∏ß‡πÉ‡∏à medium = rare ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö boost/giant (‡∏î‡∏π updateSpawners)
      function spawnMediumHeartRare() {
        const c = makeCollectibleBase();
        c.classList.add("energy", "medium");
        c.dataset.energy = String(CFG_HEART_MEDIUM_GAIN);
        c.textContent = "‚ù§Ô∏è";
        const lane = (Math.random() < 0.55) ? 1 : 2;
        setCollectibleLane(c, lane);
        gameContainer.appendChild(c);
        collectibles.push(c);
      }

      function spawnLargeHeartForced() {
        const c = makeCollectibleBase();
        c.classList.add("energy", "large");
        c.dataset.energy = String(CFG_HEART_LARGE_GAIN);
        c.textContent = "‚ù§Ô∏è";
        const lane = (Math.random() < 0.55) ? 1 : 2;
        setCollectibleLane(c, lane);
        gameContainer.appendChild(c);
        collectibles.push(c);
      }

      function spawnMagnet(){
        const c = makeCollectibleBase();
        c.classList.add("magnet");
        c.textContent = "üß≤";
        setCollectibleLane(c);
        gameContainer.appendChild(c);
        collectibles.push(c);
      }

      function spawnBoostOrGiant(){
        const c = makeCollectibleBase();
        if (Math.random() < 0.5){
          c.classList.add("boost");
          c.textContent = "‚ö°";
        } else {
          c.classList.add("giant");
          c.textContent = "üåÄ";
        }
        setCollectibleLane(c);
        gameContainer.appendChild(c);
        collectibles.push(c);
      }

      function spawnJellyTrail(){
        if (collectibles.length > 100) return;

        const bottoms = [groundY + 60, groundY + 110, groundY + 150];

        const count = randInt(10, 18);
        const spacing = randomBetween(52, 70);
        const startLeft = gameContainer.offsetWidth + 10;

        let lane = randInt(0, 2);
        let dir = Math.random() < 0.5 ? 1 : -1;

        let segLen = randInt(2, 4);
        let segLeft = segLen;

        for (let i = 0; i < count; i++){
          if (i > 0) {
            segLeft -= 1;
            if (segLeft <= 0) {
              const willStep = Math.random() < 0.78;
              if (willStep) lane += dir;

              if (lane <= 0) { lane = 0; dir = 1; }
              if (lane >= 2) { lane = 2; dir = -1; }

              if (Math.random() < 0.28) dir *= -1;

              segLen = randInt(2, 4);
              segLeft = segLen;
            }
          }

          const c = makeCollectibleBase();
          c.classList.add("jelly");
          c.textContent = "üç¨";

          const jitterY = randomBetween(-6, 6);
          const bottom = bottoms[lane] + jitterY;

          c.style.bottom = bottom + "px";
          c.style.left = (startLeft + i * spacing) + "px";

          gameContainer.appendChild(c);
          collectibles.push(c);
        }
      }

      function getEffectiveSpeed() {
        let s = speed;
        if (boostActive) s *= CFG_BOOST_MULTIPLIER;
        if (hitSlowTimer > 0) s *= CFG_HIT_SLOW_FACTOR;
        return s;
      }

      function triggerHitVFX() {
        gameContainer.classList.remove("shake");
        void gameContainer.offsetWidth;
        gameContainer.classList.add("shake");

        document.body.classList.add("hit-blink");
        setTimeout(() => document.body.classList.remove("hit-blink"), 120);
      }

      function isColliding(a, b) {
        const r1 = a.getBoundingClientRect();
        const r2 = b.getBoundingClientRect();
        return !(
          r1.right < r2.left ||
          r1.left > r2.right ||
          r1.bottom < r2.top ||
          r1.top > r2.bottom
        );
      }

      function pullCollectibleToPlayer(c) {
        if (!c || c.dataset.pulled === "1" || c.dataset.dead === "1") return;
        c.dataset.pulled = "1";

        const pr = player.getBoundingClientRect();
        const cr = c.getBoundingClientRect();

        const targetX = pr.left + pr.width / 2;
        const targetY = pr.top + pr.height / 2;
        const cx = cr.left + cr.width / 2;
        const cy = cr.top + cr.height / 2;

        const dx = targetX - cx;
        const dy = targetY - cy;

        c.style.transition = "transform 0.2s linear, opacity 0.2s linear";
        c.style.transform = "translate(" + dx + "px," + dy + "px) scale(0.8)";
        c.style.opacity = "0.15";

        setTimeout(() => {
          if (!c || c.dataset.dead === "1") return;
          applyCollectibleEffect(c);
          c.dataset.dead = "1";
          c.remove();
        }, 190);
      }

      function activateBoost(durationMs, fromShop){
        boostActive = true;
        boostTimer = durationMs;

        invincible = true;
        invincibleTimer = Math.max(invincibleTimer, durationMs);

        player.classList.add("invincible");
        player.classList.remove("hurt-blink"); // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå
        unlockAudioOnce();
        playSFX(Sounds.powerup);

        if (fromShop){
          cheatTimerEl.textContent = "Start Boost: ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏≠‡∏°‡∏ï‡∏∞ " + Math.ceil(durationMs/1000) + " ‡∏ß‡∏¥ ‚ö°";
        } else {
          cheatTimerEl.textContent = "Boost: ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏≠‡∏°‡∏ï‡∏∞‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‚ö°";
        }
      }

      function applyCollectibleEffect(c) {
        if (!c) return;

        if (c.classList.contains("coin")) {
          coinsCollected += 1;

          addCoins(1);
          addScore(2);

          unlockAudioOnce();
          playSFX(Sounds.coin);

          scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
          updateCoinsUI();
        }
        else if (c.classList.contains("jelly")) {
          addScore(4);
          unlockAudioOnce();
          playSFX(Sounds.coin);
          scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
        }
        else if (c.classList.contains("energy")) {
          const gain = parseInt(c.dataset.energy || "20", 10);
          energy = Math.min(maxEnergyRun, energy + gain);

          if (c.classList.contains("large")) {
            const before = speed;
            speed = Math.min(CFG_MAX_SPEED, speed + CFG_SPEED_UP_ON_BIG_HEART);
            if (speed > before) {
              messageEl.textContent = "‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÉ‡∏´‡∏ç‡πà! Energy +" + gain + " ‚Ä¢ Speed Up üî•";
            } else {
              messageEl.textContent = "‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÉ‡∏´‡∏ç‡πà! Energy +" + gain + " ‚Ä¢ Speed Max!";
            }
          }

          updateEnergyUI();
        }
        else if (c.classList.contains("magnet")) {
          magnetActive = true;
          magnetTimer = CFG_MAGNET_DURATION;
          unlockAudioOnce();
          playSFX(Sounds.powerup);
          messageEl.textContent = "Magnet: ‡∏î‡∏π‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç/‡∏´‡∏±‡∏ß‡πÉ‡∏à/‡πÄ‡∏à‡∏•‡∏•‡∏µ‡πà ‡∏£‡∏≠‡∏ö ‡πÜ ‚ú®";
        }
        else if (c.classList.contains("boost")) {
          activateBoost(CFG_BOOST_DURATION, false);
          messageEl.textContent = "Boost: ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏≠‡∏°‡∏ï‡∏∞‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‚ö°";
        }
        else if (c.classList.contains("giant")) {
          giantActive = true;
          giantTimer = CFG_GIANT_DURATION;
          player.classList.add("giant");
          unlockAudioOnce();
          playSFX(Sounds.powerup);

          messageEl.textContent = "Giant: PHANToM ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà ‡∏ä‡∏ô‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡∏û‡∏∑‡πâ‡∏ô‡∏û‡∏±‡∏á‡πÑ‡∏î‡πâ üí•";
        }

        updateMissionUI();
      }

      function updateObstacles(delta) {
        const moveX = getEffectiveSpeed() * (delta / 16.67);

        obstacles = obstacles.filter(obs => {
          if (!obs || !obs.isConnected) return false;

          const left = parseFloat(obs.style.left) || 0;
          const newLeft = left - moveX;
          obs.style.left = newLeft + "px";

          if (newLeft + obs.offsetWidth < 0) {
            obs.remove();

            addScore(1);
            obstaclesPassed += 1;

            scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
            updateMissionUI();
            return false;
          }

          if (!gameOver && isColliding(player, obs)) {
            if (invincible || giantActive) {
              addScore(2);
              obstaclesPassed += 1;

              scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
              updateMissionUI();

              obs.remove();
              return false;
            } else {
              // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡∏ã‡πâ‡∏≥ 2.5 ‡∏ß‡∏¥
              if (hitIFramesTimer > 0) return true;

              const isAir = obs.classList.contains("air") || obs.classList.contains("ceiling");
              const baseDmg = isAir ? CFG_DAMAGE_AIR : CFG_DAMAGE_GROUND;
              const dmg = baseDmg * runEnergyMult;

              energy -= dmg;
              unlockAudioOnce();
              playSFX(Sounds.hit);

              // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ä‡πâ‡∏≤‡πÜ + ‡πÄ‡∏õ‡∏¥‡∏î i-frames 2.5s
              hitIFramesTimer = CFG_HIT_IFRAMES_ON_HIT;
              player.classList.add("hurt-blink");

              if (energy <= 0) {
                energy = 0;
                updateEnergyUI();
                endGame();
                return true;
              }

              updateEnergyUI();
              triggerHitVFX();
              hitSlowTimer = CFG_HIT_SLOW_DURATION;

              obs.style.opacity = "0.4";
              setTimeout(() => { if (obs && obs.style) obs.style.opacity = "1"; }, 120);
            }
          }

          return true;
        });

        const remainingToBigHeart = CFG_BIG_HEART_EVERY_MS - timeSinceLastBigHeart;
        if (remainingToBigHeart <= 3000) {
          obstacleWaveLeft = 0;
          obstacleRestLeft = Math.max(obstacleRestLeft, remainingToBigHeart + 450);
          timeSinceLastObstacle = 0;
        }

        if (obstacleRestLeft > 0) {
          obstacleRestLeft -= delta;
          return;
        }

        timeSinceLastObstacle += delta;

        const minInterval = Math.max(850, 1400 - score * 2.0);
        const maxInterval = Math.max(minInterval + 650, 2400 - score * 2.6);

        if (timeSinceLastObstacle >= nextSpawnIn) {
          let canSpawn = true;

          if (obstacles.length > 0) {
            const lastObs = obstacles[obstacles.length - 1];
            const lastRect = lastObs.getBoundingClientRect();
            const containerRect = gameContainer.getBoundingClientRect();
            const distance = containerRect.right - lastRect.right;
            if (distance < 240) canSpawn = false;
          }

          if (canSpawn) {
            if (obstacleWaveLeft <= 0) {
              const r = Math.random();
              const waveSize = (r < 0.62) ? 1 : (r < 0.88 ? 2 : 3);
              obstacleWaveLeft = waveSize - 1;
            } else {
              obstacleWaveLeft -= 1;
            }

            spawnObstacle();
            timeSinceLastObstacle = 0;

            if (obstacleWaveLeft > 0) {
              nextSpawnIn = randomBetween(820, 1250);
            } else {
              obstacleRestLeft = randomBetween(1400, 2700);
              nextSpawnIn = randomBetween(minInterval, maxInterval);
            }
          } else {
            timeSinceLastObstacle = Math.max(0, nextSpawnIn - 120);
          }
        }
      }

      function updatePlatforms(delta) {
        const moveX = getEffectiveSpeed() * (delta / 16.67);

        platforms = platforms.filter(p => {
          if (!p || !p.isConnected) return false;

          const left = parseFloat(p.style.left) || 0;
          const newLeft = left - moveX;
          p.style.left = newLeft + "px";

          if (newLeft + p.offsetWidth < 0) {
            p.remove();
            return false;
          }
          return true;
        });

        timeSinceLastPlatform += delta;
        if (timeSinceLastPlatform >= nextPlatformIn) {
          if (platforms.length < 10) spawnPlatformGroup();
          timeSinceLastPlatform = 0;
          nextPlatformIn = 2200 + Math.random() * (5200 - 2200);
        }
      }

      function updateHoles(delta) {
        const moveX = getEffectiveSpeed() * (delta / 16.67);
        holes = holes.filter(h => {
          if (!h || !h.isConnected) return false;

          const left = parseFloat(h.style.left) || 0;
          const newLeft = left - moveX;
          h.style.left = newLeft + "px";

          if (newLeft + h.offsetWidth < 0) {
            h.remove();
            return false;
          }
          return true;
        });
      }

      function updateCollectibles(delta) {
        const moveX = getEffectiveSpeed() * (delta / 16.67);

        let playerCenterX = 0;
        let playerCenterY = 0;
        if (magnetActive) {
          const pr = player.getBoundingClientRect();
          playerCenterX = pr.left + pr.width / 2;
          playerCenterY = pr.top + pr.height / 2;
        }

        collectibles.forEach(c => {
          if (!c || c.dataset.dead === "1") return;
          if (c.dataset.pulled === "1") return;

          const left = parseFloat(c.style.left) || 0;
          const newLeft = left - moveX;
          c.style.left = newLeft + "px";

          if (newLeft + c.offsetWidth < 0) {
            c.dataset.dead = "1";
            c.remove();
            return;
          }

          if (
            magnetActive &&
            (c.classList.contains("coin") || c.classList.contains("energy") || c.classList.contains("jelly"))
          ) {
            const cr = c.getBoundingClientRect();
            const cx = cr.left + cr.width / 2;
            const cy = cr.top + cr.height / 2;
            const dist = Math.hypot(playerCenterX - cx, playerCenterY - cy);
            if (dist < CFG_MAGNET_RADIUS) {
              pullCollectibleToPlayer(c);
              return;
            }
          }

          if (!gameOver && isColliding(player, c)) {
            applyCollectibleEffect(c);
            c.dataset.dead = "1";
            c.remove();
          }
        });

        collectibles = collectibles.filter(c => c && c.isConnected && c.dataset.dead !== "1");
      }

      function updatePlayer(delta) {
        const factor = delta / 16.67;
        prevPlayerY = playerY;

        jumpVelocity -= CFG_GRAVITY * factor;
        playerY += jumpVelocity * factor;

        let supportY = groundY;
        const isFalling = jumpVelocity <= 0;

        const playerRect = player.getBoundingClientRect();
        const playerLeftScreen = playerRect.left;
        const playerRightScreen = playerRect.right;

        const playerStyleLeft = parseFloat(getComputedStyle(player).left);
        const playerStyleRight = playerStyleLeft + player.offsetWidth;

        platforms.forEach(p => {
          if (!p || !p.isConnected) return;
          const pRect = p.getBoundingClientRect();
          const pLeft = pRect.left;
          const pRight = pRect.right;

          const platformBottom = parseFloat(p.style.bottom) || 0;
          const platformTop = platformBottom + p.offsetHeight;

          const horizontallyOver = (playerRightScreen > pLeft + 5) && (playerLeftScreen < pRight - 5);
          if (horizontallyOver && isFalling && prevPlayerY >= platformTop && playerY <= platformTop) {
            if (platformTop > supportY) supportY = platformTop;
          }
        });

        let holeUnder = false;
        holes.forEach(h => {
          if (!h || !h.isConnected) return;
          const hLeft = parseFloat(h.style.left) || 0;
          const hRight = hLeft + h.offsetWidth;
          if (hRight > playerStyleLeft + 5 && hLeft < playerStyleRight - 5) holeUnder = true;
        });

        if (playerY <= supportY) {
          if (!(supportY === groundY && holeUnder && !runHoleShield)) {
            playerY = supportY;
            jumpVelocity = 0;
            jumpsLeft = CFG_MAX_JUMPS;
          }
        }

        player.style.bottom = playerY + "px";

        if (boostBeam) {
          if (boostActive) {
            const baseLeft = parseFloat(getComputedStyle(player).left) || 80;
            boostBeam.style.opacity = 1;
            boostBeam.style.left = (baseLeft - 90) + "px";
            boostBeam.style.bottom = (playerY + 8) + "px";
          } else if (boostBeam.style.opacity !== "0") {
            boostBeam.style.opacity = 0;
          }
        }
      }

      function checkHoleTrap() {
        if (runHoleShield) return;
        if (playerY < CFG_TRAP_Y) endGame();
      }

      function updateSpawners(delta){
        timeSinceLastCoin += delta;
        const coinInterval = Math.max(CFG_COIN_MIN_INTERVAL, CFG_COIN_BASE_INTERVAL - score * 1.5);
        if (timeSinceLastCoin >= coinInterval) {
          spawnCoin();
          timeSinceLastCoin = 0;
        }

        timeSinceLastJelly += delta;
        const jellyInterval = Math.max(CFG_JELLY_TRAIL_MIN_INTERVAL, CFG_JELLY_TRAIL_BASE_INTERVAL - score * 1.0);
        if (timeSinceLastJelly >= jellyInterval) {
          spawnJellyTrail();
          timeSinceLastJelly = 0;
        }

        // ‚úÖ Heart normal spawner: ‡πÇ‡∏¢‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ small (medium ‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ rare ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö boost/giant)
        timeSinceLastHeart += delta;
        const heartInterval = Math.max(CFG_HEART_MIN_INTERVAL, CFG_HEART_BASE_INTERVAL - Math.floor(score/6)*12);
        if (timeSinceLastHeart >= heartInterval) {
          spawnSmallHeart();
          timeSinceLastHeart = 0;
        }

        timeSinceLastBigHeart += delta;
        if (timeSinceLastBigHeart >= CFG_BIG_HEART_EVERY_MS) {
          spawnLargeHeartForced();
          timeSinceLastBigHeart = 0;
        }

        timeSinceLastMagnet += delta;
        const magnetInterval = Math.max(CFG_MAGNET_MIN_INTERVAL, CFG_MAGNET_BASE_INTERVAL - Math.floor(score/7)*10);
        if (timeSinceLastMagnet >= magnetInterval) {
          spawnMagnet();
          timeSinceLastMagnet = 0;
        }

        // ‚úÖ Rare pool (Boost/Giant) + ‚úÖ Medium Heart rarity ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö Boost/Giant
        timeSinceLastBG += delta;
        if (timeSinceLastBG >= nextBGIn) {
          // spawn boost/giant as before
          spawnBoostOrGiant();

          // ‚úÖ medium heart rarity = boost OR giant (50% chance per rare event)
          if (Math.random() < 0.5) {
            spawnMediumHeartRare();
          }

          timeSinceLastBG = 0;
          nextBGIn = randomBetween(CFG_BG_MIN_MS, CFG_BG_MAX_MS);
        }
      }

      function gameLoop(timestamp) {
        if (gameOver || isPaused || countdownTimer) return;

        if (!lastTime) lastTime = timestamp;
        const delta = timestamp - lastTime;
        lastTime = timestamp;

        if (!invincible) {
          energy -= (CFG_ENERGY_DECAY_PER_SEC * runEnergyMult) * (delta / 1000);
          if (energy <= 0) {
            energy = 0;
            updateEnergyUI();
            endGame();
            return;
          }
        }
        updateEnergyUI();

        updatePlayer(delta);
        updatePlatforms(delta);
        updateHoles(delta);
        checkHoleTrap();
        if (gameOver) return;

        updateSpawners(delta);

        updateObstacles(delta);
        updateCollectibles(delta);

        if (invincible) {
          invincibleTimer -= delta;
          if (invincibleTimer <= 0) {
            invincible = false;
            player.classList.remove("invincible");
            cheatTimerEl.textContent = "";
          } else if (invincibleTimer <= 3000) {
            cheatTimerEl.textContent = "‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏°‡∏ï‡∏∞: " + Math.ceil(invincibleTimer / 1000) + " ‡∏ß‡∏¥";
          }
        }

        if (magnetActive) {
          magnetTimer -= delta;
          if (magnetTimer <= 0) magnetActive = false;
        }

        if (boostActive) {
          boostTimer -= delta;
          if (boostTimer <= 0) boostActive = false;
        }

        if (giantActive) {
          giantTimer -= delta;
          if (giantTimer <= 0) {
            giantActive = false;
            player.classList.remove("giant");
          }
        }

        if (hitSlowTimer > 0) {
          hitSlowTimer -= delta;
          if (hitSlowTimer < 0) hitSlowTimer = 0;
        }

        // ‚úÖ ‡∏•‡∏î i-frames + ‡∏õ‡∏¥‡∏î blink ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏ö 2.5 ‡∏ß‡∏¥
        if (hitIFramesTimer > 0) {
          hitIFramesTimer -= delta;
          if (hitIFramesTimer <= 0) {
            hitIFramesTimer = 0;
            player.classList.remove("hurt-blink");
          }
        }

        frameId = requestAnimationFrame(gameLoop);
      }

      function endGame() {
        if (gameOver) return;
        gameOver = true;
        isRunning = false;
        isPaused = false;

        cancelCountdown();
        closeAllModals();
        resetPowerupsAndVFX();

        if (frameId) cancelAnimationFrame(frameId);
        frameId = null;
        lastTime = null;

        bgmPause();
        unlockAudioOnce();
        playSFX(Sounds.gameover);

        if (score > bestScore) {
          bestScore = score;
          localStorage.setItem(LS_BEST, String(bestScore));
        }
        bestScoreEl.textContent = "‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: " + bestScore;

        messageEl.textContent =
          "Game Over! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score +
          " ‚Ä¢ ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: " + runCoins +
          " ‚Ä¢ ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°: " + walletCoins +
          ' ‚Ä¢ ‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà';

        setStatus("OVER");
        showGameOverModal();
      }

      function reviveCore(opts){
        const { payCoins, applyPenalty } = opts || {};
        if (!gameOver) return;

        if (payCoins){
          if (revivedThisRun) return;
          if (walletCoins < CFG_REVIVE_COST) return;

          walletCoins -= CFG_REVIVE_COST;
          saveWallet();
          updateCoinsUI();

          revivedThisRun = true;
          postReviveActive = true;

          postScoreAcc = 0; postScoreCredited = 0;
          postCoinAcc  = 0; postCoinCredited  = 0;
        } else {
          if (!runFreeReviveAvailable || freeReviveUsedThisRun) return;
          freeReviveUsedThisRun = true;

          if (applyPenalty){
            postReviveActive = true;
            postScoreAcc = 0; postScoreCredited = 0;
            postCoinAcc  = 0; postCoinCredited  = 0;
          }
        }

        unlockAudioOnce();
        playSFX(Sounds.revive);

        hideGameOverModal();
        clearArrays();
        resetPowerupsAndVFX();

        energy = clamp(CFG_REVIVE_ENERGY, 1, maxEnergyRun);
        updateEnergyUI();

        invincible = true;
        invincibleTimer = Math.max(invincibleTimer, CFG_REVIVE_INVINCIBLE_MS);
        player.classList.add("invincible");
        player.classList.remove("hurt-blink");

        hitSlowTimer = 0;
        hitIFramesTimer = CFG_HIT_IFRAMES; // ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á 2.5s ‡πÉ‡∏ô revive)

        playerY = groundY;
        prevPlayerY = groundY;
        jumpVelocity = 0;
        jumpsLeft = CFG_MAX_JUMPS;
        player.style.bottom = playerY + "px";

        speed = clamp(speed, CFG_START_SPEED, CFG_MAX_SPEED);

        timeSinceLastObstacle = 0;
        nextSpawnIn = 900 + Math.random() * 700;

        timeSinceLastCoin = 0;
        timeSinceLastHeart = 0;
        timeSinceLastMagnet = 0;
        timeSinceLastJelly = 0;

        timeSinceLastBG = 0;
        nextBGIn = randomBetween(CFG_BG_MIN_MS, CFG_BG_MAX_MS);

        obstacleWaveLeft = 0;
        obstacleRestLeft = 1000;

        gameOver = false;
        isRunning = true;
        isPaused = false;
        setStatus("RUN");

        if (payCoins){
          messageEl.textContent = "‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÅ‡∏•‡πâ‡∏ß! ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -15% / ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç -50% (‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)";
        } else {
          messageEl.textContent = "‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏ü‡∏£‡∏µ (Passive) ‡πÅ‡∏•‡πâ‡∏ß! (‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)";
        }

        bgmPlay();
        lastTime = null;
        frameId = requestAnimationFrame(gameLoop);

        spawnObstacle();
      }

      function revivePaid(){ reviveCore({ payCoins:true, applyPenalty:true }); }
      function reviveFree(){ reviveCore({ payCoins:false, applyPenalty:false }); }

      function handleJump() {
        if (!isRunning && !gameOver && !countdownTimer) {
          startCountdown(false);
          return;
        }

        if (gameOver) {
          prepareNewRun();
          return;
        }

        if (!isRunning || isPaused || countdownTimer) return;

        if (jumpsLeft > 0) {
          if (isDucking) setDuck(false);

          if (jumpsLeft === 1) {
            totalDoubleJumps += 1;
            updateMissionUI();
            player.classList.remove("double-jump");
            void player.offsetWidth;
            player.classList.add("double-jump");
          }

          jumpVelocity = CFG_JUMP_STRENGTH;
          jumpsLeft -= 1;

          unlockAudioOnce();
          playSFX(Sounds.jump);
        }
      }

      function setDuck(state) {
        if (!isRunning || gameOver || isPaused || countdownTimer) return;
        if (state && !isDucking) {
          isDucking = true;
          player.classList.add("duck");
        } else if (!state && isDucking) {
          isDucking = false;
          player.classList.remove("duck");
        }
      }

      function registerCheat(code) {
        const now = performance.now();
        if (code !== "ArrowDown" && code !== "ArrowUp" && code !== "Space") return;

        const symbol = (code === "ArrowDown") ? "D" : "U";
        cheatEvents.push({ symbol, time: now });

        const cutoff = now - CFG_CHEAT_WINDOW;
        cheatEvents = cheatEvents.filter(e => e.time >= cutoff);

        const lastSix = cheatEvents.slice(-6);
        if (lastSix.length === 6) {
          const pattern = lastSix.map(e => e.symbol).join("");
          if (pattern === "DDDUUU" && isRunning && !gameOver) {
            activateCheat();
            cheatEvents = [];
          }
        }
      }

      function activateCheat() {
        invincible = true;
        invincibleTimer = Math.max(invincibleTimer, CFG_CHEAT_INVINCIBLE_DURATION);
        player.classList.add("invincible");
        player.classList.remove("hurt-blink");
        cheatTimerEl.textContent = "‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏Å‡∏á: PHANToM ‡∏≠‡∏°‡∏ï‡∏∞ 10 ‡∏ß‡∏¥ üéÉ";
        messageEl.textContent = "‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏Å‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡∏ä‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏¢ 10 ‡∏ß‡∏¥";
      }

      function toggleFullscreen(){
        const elem = document.documentElement;
        if (!document.fullscreenElement){
          if (elem.requestFullscreen) elem.requestFullscreen();
          else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
          else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
        } else {
          if (document.exitFullscreen) document.exitFullscreen();
          else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
          else if (document.msExitFullscreen) document.msExitFullscreen();
        }
      }

      fullscreenBtn.addEventListener("click",(e)=>{
        e.preventDefault();
        unlockAudioOnce();
        playSFX(Sounds.click);
        toggleFullscreen();
      });

      document.addEventListener("fullscreenchange", () => {
        if (document.fullscreenElement){
          fullscreenBtn.textContent = "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠";
          document.body.classList.add("fullscreen-game");
        } else {
          fullscreenBtn.textContent = "‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠";
          document.body.classList.remove("fullscreen-game");
        }
      });

      pauseBtn.addEventListener("click", ()=>{
        if (!isRunning || gameOver) return;
        if (countdownTimer) return;
        if (isPaused) resumeGame();
        else pauseGame(false);
      });
      resumeBtnOverlay.addEventListener("click", resumeGame);

      startGameBtn.addEventListener("click", ()=> startCountdown(false));

      restartBtn.addEventListener("click", prepareNewRun);
      restartOutsideBtn.addEventListener("click", prepareNewRun);

      revivePaidBtn.addEventListener("click", revivePaid);
      reviveFreeBtn.addEventListener("click", reviveFree);

      document.addEventListener("keydown", (e) => {
        if (e.code === "KeyP") {
          e.preventDefault();
          if (isRunning && !gameOver){
            if (countdownTimer) return;
            if (isPaused) resumeGame();
            else pauseGame(false);
          }
          return;
        }

        if (e.code === "Space" || e.code === "ArrowUp") {
          e.preventDefault();
          handleJump();
          registerCheat(e.code);
        } else if (e.code === "ArrowDown") {
          e.preventDefault();
          setDuck(true);
          registerCheat(e.code);
        }
      });

      document.addEventListener("keyup", (e) => {
        if (e.code === "ArrowDown") setDuck(false);
      });

      btnJump.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        handleJump();
        registerCheat("Space");
      });

      btnDuck.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        setDuck(true);
        registerCheat("ArrowDown");
      });
      btnDuck.addEventListener("pointerup", (e) => { e.preventDefault(); setDuck(false); });
      btnDuck.addEventListener("pointercancel",(e)=> { e.preventDefault(); setDuck(false); });
      btnDuck.addEventListener("pointerleave", () => { if (isDucking) setDuck(false); });

      function openSound(){
        cancelCountdown();
        unlockAudioOnce();
        playSFX(Sounds.click);
        if (isRunning && !gameOver && !isPaused) pauseGame(true);
        soundModal.classList.add("show");
        applyAudioSettings();
      }
      function closeSound(){
        unlockAudioOnce();
        playSFX(Sounds.click);
        soundModal.classList.remove("show");
      }

      soundBtn.addEventListener("click", openSound);
      soundCloseBtn.addEventListener("click", closeSound);
      soundModal.addEventListener("click", (e)=>{
        if (e.target === soundModal) closeSound();
      });

      audioQuickBtn.addEventListener("click", ()=>{
        unlockAudioOnce();
        audioEnabled = !audioEnabled;
        saveBool(LS_AUDIO_MASTER, audioEnabled);
        applyAudioSettings();
        playSFX(Sounds.click);
      });

      audioMasterToggle.addEventListener("change", ()=>{
        unlockAudioOnce();
        audioEnabled = !!audioMasterToggle.checked;
        saveBool(LS_AUDIO_MASTER, audioEnabled);
        applyAudioSettings();
        playSFX(Sounds.click);
      });

      bgmToggle.addEventListener("change", ()=>{
        unlockAudioOnce();
        bgmEnabled = !!bgmToggle.checked;
        saveBool(LS_AUDIO_BGM_ON, bgmEnabled);
        applyAudioSettings();
        playSFX(Sounds.click);
      });

      sfxToggle.addEventListener("change", ()=>{
        unlockAudioOnce();
        sfxEnabled = !!sfxToggle.checked;
        saveBool(LS_AUDIO_SFX_ON, sfxEnabled);
        applyAudioSettings();
        playSFX(Sounds.click);
      });

      bgmVolRange.addEventListener("input", ()=>{
        bgmVolume = clamp(parseInt(bgmVolRange.value,10)/100, 0, 1);
        saveNum(LS_AUDIO_BGM_VOL, bgmVolume);
        applyAudioSettings();
      });
      sfxVolRange.addEventListener("input", ()=>{
        sfxVolume = clamp(parseInt(sfxVolRange.value,10)/100, 0, 1);
        saveNum(LS_AUDIO_SFX_VOL, sfxVolume);
        applyAudioSettings();
      });

      audioTestBtn.addEventListener("click", ()=>{
        unlockAudioOnce();
        playSFX(Sounds.click);
        setTimeout(()=> playSFX(Sounds.jump), 90);
        setTimeout(()=> playSFX(Sounds.coin), 180);
      });

      function renderShop(){
        shopWalletCoins.textContent = String(walletCoins);

        const pricePassive = getPassiveBoxPrice(passiveDiscountSteps);
        const discountPct = passiveDiscountSteps > 0
          ? Math.round((1 - Math.pow(CFG_PASSIVE_DUPLICATE_DISCOUNT, passiveDiscountSteps)) * 100)
          : 0;

        shopPassiveInfo.textContent =
          "Passive ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: " + getPassiveName(currentPassiveId) +
          (currentPassiveId !== "none" ? (" ‚Äî " + getPassiveDesc(currentPassiveId)) : "") +
          (discountPct > 0 ? (" ‚Ä¢ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á Passive ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: -" + discountPct + "%") : "");

        shopGrid.innerHTML = "";

        const addSection = (title, note) => {
          const h = document.createElement("div");
          h.className = "shop-section-title";
          h.textContent = title;
          shopGrid.appendChild(h);

          const n = document.createElement("div");
          n.className = "shop-section-note";
          n.textContent = note;
          shopGrid.appendChild(n);
        };

        const addThemeItem = (item, kind, unlocked, selected, swatchStyle) => {
          const el = document.createElement("div");
          el.className = "shop-item";
          const priceText = item.price === 0 ? "‡∏ü‡∏£‡∏µ" : (item.price + " ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç");
          el.innerHTML = `
            <h3><span class="swatch" style="${swatchStyle}"></span>${item.name}</h3>
            <p>${item.desc}</p>
            <div class="shop-row">
              <div class="price">${priceText}</div>
              <div style="display:flex; gap:10px; align-items:center;">
                <button class="shop-action" data-kind="${kind}" data-act="buy" data-id="${item.id}" ${unlocked || item.price===0 ? "disabled" : ""}>‡∏ã‡∏∑‡πâ‡∏≠</button>
                <button class="shop-action" data-kind="${kind}" data-act="select" data-id="${item.id}" ${(!unlocked && item.price>0) ? "disabled" : ""}>
                  ${selected ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ" : "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å"}
                </button>
              </div>
            </div>
          `;
          shopGrid.appendChild(el);
        };

        const addPowerItem = (it) => {
          const el = document.createElement("div");
          el.className = "shop-item";
          const owned = powerInv[it.id] || 0;
          const priceText = it.price + " ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç";
          const canBuy = walletCoins >= it.price;

          el.innerHTML = `
            <h3>${it.icon} ${it.name}</h3>
            <p>${it.desc}<br/><span style="color:#e5e7eb;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á: <b>${owned}</b></span></p>
            <div class="shop-row">
              <div class="price">${priceText}</div>
              <div style="display:flex; gap:10px; align-items:center;">
                <button class="shop-action" data-kind="power" data-act="buy" data-id="${it.id}" ${canBuy ? "" : "disabled"}>‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
              </div>
            </div>
          `;
          shopGrid.appendChild(el);
        };

        const addPassiveBox = () => {
          const el = document.createElement("div");
          el.className = "shop-item";
          const canBuy = walletCoins >= pricePassive;
          const priceText = pricePassive + " ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç";

          el.innerHTML = `
            <h3>üé≤ Passive Box</h3>
            <p>
              ‡∏™‡∏∏‡πà‡∏° Passive ‡πÑ‡∏î‡πâ ‚Äú‡πÅ‡∏Ñ‡πà 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‚Äù (‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏Å‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏°)<br/>
              ‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡πâ‡∏≥ = ‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞ ‚Äú‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‚Äù ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ<br/>
              ‡∏ñ‡πâ‡∏≤‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°: ‚Äú‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‚Äù ‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° 15%<br/>
              <span style="color:#e5e7eb;">Passive ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b>${getPassiveName(currentPassiveId)}</b></span>
            </p>
            <div class="shop-row">
              <div class="price">${priceText}</div>
              <div style="display:flex; gap:10px; align-items:center;">
                <button class="shop-action" data-kind="passive" data-act="buy" data-id="passiveBox" ${canBuy ? "" : "disabled"}>‡∏ã‡∏∑‡πâ‡∏≠/‡∏™‡∏∏‡πà‡∏°</button>
              </div>
            </div>
          `;
          shopGrid.appendChild(el);
        };

        addSection("Background Themes", "‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏ô‡∏≤‡∏° (‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ)");
        Backdrops.forEach(b=>{
          const unlocked = !!unlockedBackdrops[b.id];
          const selected = (selectedBackdrop === b.id);
          addThemeItem(b, "backdrop", unlocked, selected, swatchBackdrop(b));
        });

        addSection("Obstacle Themes", "‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ CSS ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)");
        ObstacleThemes.forEach(t=>{
          const unlocked = !!unlockedObsThemes[t.id];
          const selected = (selectedObsTheme === t.id);
          addThemeItem(t, "obstacle", unlocked, selected, swatchObstacle(t));
        });

        addSection("Power Items (Auto-use)", "‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ 1 ‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏° ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡πÄ‡∏Å‡∏°‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏´‡∏°‡∏î");
        PowerItems.forEach(addPowerItem);

        addSection("Passive (‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á)", "Passive ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚Ä¢ ‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡πâ‡∏≥ = ‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ");
        addPassiveBox();
      }

      function openShop(){
        cancelCountdown();
        unlockAudioOnce();
        playSFX(Sounds.click);
        if (isRunning && !gameOver && !isPaused) pauseGame(true);
        renderShop();
        shopModal.classList.add("show");
        const body = shopModal.querySelector(".shop-body");
        if (body) body.scrollTop = 0;
      }
      function closeShop(){
        unlockAudioOnce();
        playSFX(Sounds.click);
        shopModal.classList.remove("show");
      }

      shopBtn.addEventListener("click", openShop);
      shopCloseBtn.addEventListener("click", closeShop);
      shopModal.addEventListener("click", (e)=>{
        if (e.target === shopModal) closeShop();
      });

      shopGrid.addEventListener("click", (e)=>{
        const btn = e.target.closest("button");
        if (!btn) return;

        unlockAudioOnce();

        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        const kind = btn.getAttribute("data-kind");

        if (kind === "backdrop" || kind === "obstacle"){
          const list = (kind === "obstacle") ? ObstacleThemes : Backdrops;
          const item = list.find(x=>x.id===id);
          if (!item) return;

          const unlockedObj = (kind === "obstacle") ? unlockedObsThemes : unlockedBackdrops;
          const saveUnlockKey = (kind === "obstacle") ? LS_OBS_UNLOCK : LS_BACKDROPS_UNLOCK;

          if (act === "buy"){
            if (unlockedObj[id] || item.price===0) return;
            if (walletCoins < item.price) return;

            walletCoins -= item.price;
            saveWallet();
            updateCoinsUI();

            unlockedObj[id] = true;
            saveUnlockedObj(saveUnlockKey, unlockedObj);
            playSFX(Sounds.click);
            renderShop();
          }

          if (act === "select"){
            if (!unlockedObj[id] && item.price>0) return;

            if (kind === "obstacle") applyObstacleTheme(id);
            else applyBackdrop(id);

            playSFX(Sounds.click);
            renderShop();
          }
          return;
        }

        if (kind === "power" && act === "buy"){
          const it = PowerItems.find(x=>x.id===id);
          if (!it) return;
          if (walletCoins < it.price) return;

          walletCoins -= it.price;
          saveWallet();

          powerInv[it.id] = (powerInv[it.id] || 0) + 1;
          savePowerInv();

          playSFX(Sounds.click);
          updateCoinsUI();
          renderShop();

          messageEl.textContent = "‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°: " + it.name + " ‚Ä¢ ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥";
          return;
        }

        if (kind === "passive" && act === "buy"){
          const price = getPassiveBoxPrice(passiveDiscountSteps);
          if (walletCoins < price) return;

          walletCoins -= price;
          saveWallet();

          const old = currentPassiveId;
          const pool = PassivePool.filter(p=>p.id!=="none");
          const rolled = pool[Math.floor(Math.random()*pool.length)].id;

          const isDup = (rolled === old);

          currentPassiveId = rolled;

          if (isDup) passiveDiscountSteps += 1;
          else passiveDiscountSteps = 0;

          savePassiveState();

          playSFX(Sounds.click);
          updateCoinsUI();
          renderShop();

          if (isDup){
            messageEl.textContent = "‡∏™‡∏∏‡πà‡∏° Passive ‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°: " + getPassiveName(rolled) + " ‚Ä¢ ‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ 15%";
          } else {
            messageEl.textContent = "‡πÑ‡∏î‡πâ Passive ‡πÉ‡∏´‡∏°‡πà: " + getPassiveName(rolled);
          }
          return;
        }
      });

      bestScoreEl.textContent = "‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: " + bestScore;
      scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;

      updateCoinsUI();
      updateEnergyUI();
      updateMissionUI();

      applyAudioSettings();
      prepareNewRun();
    })();
  </script>
</body>
</html>
