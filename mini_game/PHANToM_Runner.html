<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>PHANToM Runner</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root{
      --bg1: #1d2337;
      --bg2: #020617;

      /* Poison obstacles (themeable) */
      --obs-a: #111827;
      --obs-b: #0b1020;
      --obs-c: #2e1065;
      --obs-d: #0b1020;
      --obs-border: rgba(148,163,184,0.16);
      --obs-shadow: rgba(0,0,0,0.35);

      /* Wood ground/platform */
      --wood-1: #8b5a2b;
      --wood-2: #7a4f25;
      --wood-3: #6a4320;
      --wood-line: rgba(0,0,0,0.12);
    }

    body {
      background: #020617;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 22px;
      padding-bottom: 18px;
    }

    body.fullscreen-game{ padding-top: 12px; }

    h1 {
      margin-bottom: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      user-select: none;
    }

    #gameContainer {
      position: relative;
      width: 800px;
      max-width: 95vw;
      height: 260px;
      border: 2px solid #4b5563;
      overflow: hidden;
      border-radius: 16px;
      background: radial-gradient(circle at top, var(--bg1) 0, var(--bg2) 55%, var(--bg2) 100%);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.9);
    }

    /* in-game top bar */
    #inGameTopBar{
      position:absolute;
      top:10px;
      left:10px;
      right:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      z-index: 30;
      pointer-events:none;
    }
    .ig-pill{
      pointer-events:auto;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.35);
      color:#e5e7eb;
      font-size:12px;
      box-shadow:0 8px 18px rgba(0,0,0,0.18);
      backdrop-filter: blur(2px);
      user-select:none;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .ig-btn{
      pointer-events:auto;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.55);
      color: #e5e7eb;
      font-size:12px;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,0.22);
      user-select:none;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .ig-btn:hover{ border-color: rgba(99,102,241,0.65); }
    .ig-btn:active{ transform: translateY(1px) scale(0.99); }

    #ground {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 200%;
      height: 40px;
      background: repeating-linear-gradient(
        -45deg,
        var(--wood-1) 0,
        var(--wood-1) 12px,
        var(--wood-2) 12px,
        var(--wood-2) 24px
      );
      animation: groundMove 1s linear infinite;
      opacity: 0.95;
      z-index: 1;
      box-shadow: inset 0 2px 0 rgba(255,255,255,0.05);
    }

    @keyframes groundMove {
      from { transform: translateX(0); }
      to   { transform: translateX(-50%); }
    }

    /* ==== player ==== */
    #player {
      position: absolute;
      bottom: 40px;
      left: 80px;
      width: 60px;
      height: 60px;
      transform-origin: center bottom;
      transition: transform 0.08s ease, width 0.12s ease, height 0.12s ease;
      z-index: 5;
    }

    #player img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
      user-select: none;
      background: transparent;
      filter: drop-shadow(0 0 16px rgba(56,189,248,0.8));
    }

    #player.duck { transform: translateY(-8px) scaleY(0.5); }
    #player.duck img { filter: drop-shadow(0 0 14px rgba(56,189,248,0.9)); }

    #player.invincible img {
      filter:
        drop-shadow(0 0 26px rgba(250,204,21,1))
        drop-shadow(0 0 70px rgba(250,204,21,0.7));
    }

    #player.giant { width: 130px; height: 130px; }
    #player.giant img {
      filter:
        drop-shadow(0 0 26px rgba(59,130,246,1))
        drop-shadow(0 0 70px rgba(59,130,246,0.7));
    }

    #player.double-jump img { animation: djumpSpin 0.2s linear; }
    @keyframes djumpSpin { from{transform:rotate(0)} to{transform:rotate(360deg)} }

    /* Boost beam */
    #boostBeam {
      position: absolute;
      width: 140px;
      height: 35px;
      left: -9999px;
      bottom: 40px;
      background: linear-gradient(90deg, rgba(34,197,94,0), rgba(34,197,94,0.9), rgba(56,189,248,0));
      filter: blur(8px);
      opacity: 0;
      transition: opacity 0.12s ease;
      pointer-events: none;
      z-index: 4;
      mix-blend-mode: screen;
    }

    /* ‚úÖ Obstacles can be emoji */
    .obstacle {
      position: absolute;
      bottom: 40px;
      border-radius: 10px;
      z-index: 3;

      display:flex;
      align-items:center;
      justify-content:center;
      line-height: 1;
      user-select:none;

      background: linear-gradient(135deg, var(--obs-a), var(--obs-b), var(--obs-c), var(--obs-d));
      border: 1px solid var(--obs-border);
      box-shadow:
        0 14px 22px var(--obs-shadow),
        inset 0 1px 0 rgba(255,255,255,0.05);
    }

    /* ceiling stalactites (duck to avoid) */
    .obstacle.ceiling{
      border-radius: 14px;
      overflow: visible;
    }
    .obstacle.ceiling::before{
      content:"";
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top:-220px;
      width: 6px;
      height: 220px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(148,163,184,0.04), rgba(148,163,184,0.16), rgba(148,163,184,0.05));
      box-shadow: 0 10px 26px rgba(0,0,0,0.18);
      pointer-events:none;
    }

    /* platform wood */
    .platform {
      position: absolute;
      height: 10px;
      background:
        repeating-linear-gradient(
          90deg,
          var(--wood-1) 0 14px,
          var(--wood-2) 14px 28px
        );
      border-radius: 8px;
      box-shadow: 0 10px 18px rgba(0,0,0,0.28);
      border: 1px solid rgba(0,0,0,0.18);
      z-index: 2;
    }
    .platform::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      background: repeating-linear-gradient(180deg, transparent 0 6px, var(--wood-line) 6px 7px);
      opacity:0.55;
      pointer-events:none;
    }

    /* hole */
    .hole {
      position: absolute;
      bottom: 0;
      height: 40px;
      background: linear-gradient(to top, #000000 0%, #020617 55%);
      border-radius: 6px 6px 0 0;
      box-shadow:
        inset 0 0 24px rgba(0,0,0,0.9),
        0 -2px 0 rgba(148,163,184,0.6);
      z-index: 1;
      overflow: hidden;
    }
    .hole::before {
      content: "";
      position: absolute;
      left: 0; right: 0; bottom: 0;
      height: 14px;
      background: repeating-linear-gradient(-45deg, transparent 0 10px, #b91c1c 10px 20px);
      box-shadow: 0 -2px 8px rgba(248,113,113,0.8);
    }
    .hole::after {
      content: "";
      position: absolute;
      left: 50%;
      bottom: 2px;
      width: 60%;
      height: 10px;
      transform: translateX(-50%);
      background: radial-gradient(circle, rgba(248,113,113,0.7), transparent);
      opacity: 0.9;
    }

    /* collectibles */
    .collectible {
      position: absolute;
      z-index: 4;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      line-height: 1;
      user-select: none;
      pointer-events: none;
      will-change: transform, opacity;
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.10);
    }

    /* ‚úÖ lighten item glow a lot */
    .collectible.coin {
      background: radial-gradient(circle at 30% 30%, #fff7d6, #fde047, #f59e0b);
      box-shadow: 0 0 18px rgba(250, 204, 21, 0.38), inset 0 1px 0 rgba(255,255,255,0.14);
    }

    .collectible.energy {
      background: radial-gradient(circle at 30% 20%, #ffe4e6, #fb7185, #ef4444);
      box-shadow: 0 0 18px rgba(248, 113, 113, 0.38), inset 0 1px 0 rgba(255,255,255,0.14);
      font-size: 18px;
      transform: scale(1);
    }
    .collectible.energy.small  { transform: scale(0.85); }
    .collectible.energy.medium { transform: scale(1.0); }
    .collectible.energy.large  { transform: scale(1.25); }

    .collectible.magnet {
      background: radial-gradient(circle at 30% 20%, #e0f2fe, #7dd3fc, #0284c7);
      box-shadow: 0 0 18px rgba(56, 189, 248, 0.38), inset 0 1px 0 rgba(255,255,255,0.14);
    }
    .collectible.boost {
      background: linear-gradient(90deg, #bbf7d0, #22c55e);
      box-shadow: 0 0 18px rgba(34, 197, 94, 0.38), inset 0 1px 0 rgba(255,255,255,0.14);
    }
    .collectible.giant {
      background: radial-gradient(circle at 30% 20%, #e0e7ff, #a5b4fc, #4f46e5);
      box-shadow: 0 0 18px rgba(129, 140, 248, 0.38), inset 0 1px 0 rgba(255,255,255,0.14);
    }

    /* UI under game */
    #touchControls {
      margin-top: 14px;
      width: 800px;
      max-width: 95vw;
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .ctrl-btn {
      flex: 1;
      padding: 12px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: radial-gradient(circle at 20% 0, #1f2937, #020617);
      color: #e5e7eb;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.04em;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(15,23,42,0.9);
      text-transform: uppercase;
      user-select:none;
    }
    .ctrl-btn span {
      font-size: 11px;
      display: block;
      opacity: 0.7;
      margin-top: 2px;
    }
    .ctrl-btn:hover { border-color: #38bdf8; box-shadow: 0 0 14px rgba(56,189,248,0.7); }
    .ctrl-btn:active { transform: translateY(1px) scale(0.98); }

    #energyContainer {
      margin-top: 10px;
      width: 800px;
      max-width: 95vw;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    #energyLabel {
      font-size: 11px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    #energyBarWrapper {
      flex: 1;
      height: 12px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #4b5563;
      overflow: hidden;
      box-shadow: 0 0 8px rgba(15,23,42,0.9);
    }
    #energyBar {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #22c55e, #facc15, #fb923c);
      box-shadow: 0 0 12px rgba(250,204,21,0.8);
      transition: width 0.15s ease;
    }
    #energyText {
      width: 86px;
      text-align: right;
      font-size: 11px;
      color: #e5e7eb;
    }

    #scoreBoard {
      margin-top: 10px;
      width: 800px;
      max-width: 95vw;
      display:flex;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      font-size: 15px;
      user-select:none;
    }

    #coinsBox{ color: #facc15; }
    #coinsBox small{ color:#9ca3af; font-size: 11px; margin-left: 6px; }

    #miniActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top: 10px;
    }
    .mini-btn{
      padding:8px 14px;
      border-radius:999px;
      border:1px solid #4b5563;
      background: radial-gradient(circle at 20% 0, #1f2937, #020617);
      color:#e5e7eb;
      font-size:13px;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(15,23,42,0.9);
      user-select:none;
    }
    .mini-btn:hover{ border-color: rgba(99,102,241,0.65); }
    .mini-btn:active{ transform: translateY(1px) scale(0.98); }

    #cheatTimer {
      margin-top: 4px;
      font-size: 14px;
      min-height: 20px;
      color: #facc15;
      text-shadow: 0 0 8px rgba(250, 204, 21, 0.35);
      user-select:none;
    }

    #mission {
      margin-top: 6px;
      font-size: 12px;
      color: #9ca3af;
      max-width: 800px;
      text-align: center;
      padding: 0 12px;
      user-select:none;
    }

    #message {
      margin-top: 6px;
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
      max-width: 800px;
      padding: 0 12px;
      user-select:none;
      min-height: 18px;
    }

    #itemGuide {
      margin-top: 10px;
      font-size: 12px;
      color: #e5e7eb;
      max-width: 800px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(148,163,184,0.45);
    }
    #itemGuide strong { color: #facc15; }
    #itemGuide ul { margin: 6px 0 0; padding-left: 18px; }
    #itemGuide li { margin-bottom: 4px; }

    @keyframes hitShake {
      0%   { transform: translate(0, 0); }
      20%  { transform: translate(-4px, 2px); }
      40%  { transform: translate(4px, -2px); }
      60%  { transform: translate(-3px, 1px); }
      80%  { transform: translate(3px, -1px); }
      100% { transform: translate(0, 0); }
    }
    #gameContainer.shake { animation: hitShake 0.25s ease; }

    #hitFlash {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle, rgba(248,250,252,0.25), transparent 60%);
      mix-blend-mode: screen;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.12s ease;
      z-index: 999;
    }
    body.hit-blink #hitFlash { opacity: 1; }

    /* Start overlay */
    #startOverlay{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
      z-index: 50;
      background: rgba(2,6,23,0.65);
      backdrop-filter: blur(3px);
    }
    #startOverlay.hidden{ display:none; }

    #startOverlay .title{
      font-weight: 900;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #e5e7eb;
      opacity: 0.95;
      text-shadow: 0 12px 28px rgba(0,0,0,0.35);
    }
    #startGameBtn{
      padding: 12px 18px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      cursor:pointer;
      font-weight: 900;
      letter-spacing: 0.04em;
      background: linear-gradient(90deg, rgba(34,197,94,0.95), rgba(45,212,191,0.95));
      color: #022c22;
      box-shadow: 0 18px 44px rgba(34,197,94,0.22);
    }
    #startGameBtn:hover{ filter: brightness(1.03); transform: translateY(-1px); }
    #startGameBtn:active{ transform: translateY(1px); }

    #countdownText{
      font-size: 54px;
      font-weight: 950;
      letter-spacing: 0.08em;
      color: #facc15;
      text-shadow: 0 0 16px rgba(250,204,21,0.28);
      min-height: 62px;
    }
    #startHintMini{
      font-size: 12px;
      color:#9ca3af;
      text-align:center;
      padding: 0 14px;
      line-height: 1.4;
    }

    /* Pause overlay */
    #pauseOverlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:10px;
      z-index: 60;
      background: rgba(2,6,23,0.55);
      backdrop-filter: blur(2px);
    }
    #pauseOverlay.show{ display:flex; }
    #pauseOverlay .pTitle{
      font-weight: 900;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color:#e5e7eb;
      opacity: 0.95;
    }
    #resumeBtnOverlay{
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.35);
      cursor:pointer;
      font-weight: 900;
      background: rgba(2,6,23,0.65);
      color:#e5e7eb;
      box-shadow: 0 14px 34px rgba(0,0,0,0.28);
    }
    #resumeBtnOverlay:hover{ border-color: rgba(99,102,241,0.65); }
    #resumeBtnOverlay:active{ transform: translateY(1px); }

    /* Game Over modal */
    #gameOverModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 1200;
      background: rgba(2,6,23,0.72);
      backdrop-filter: blur(4px);
    }
    #gameOverModal.show { display: flex; }

    .modal-card {
      width: min(520px, 96vw);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.92);
      box-shadow: 0 24px 60px rgba(0,0,0,0.55);
      padding: 16px 16px 14px;
    }
    .modal-title {
      font-weight: 900;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #facc15;
      text-shadow: 0 0 18px rgba(250,204,21,0.25);
      margin-bottom: 8px;
      font-size: 18px;
    }
    .modal-stats {
      color: #e5e7eb;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 12px;
    }
    .modal-stats b { color: #facc15; }
    .modal-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    .modal-btn {
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.35);
      cursor: pointer;
      font-weight: 900;
      letter-spacing: 0.03em;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
      transition: transform 0.08s ease, filter 0.12s ease, opacity 0.12s ease;
      user-select:none;
    }
    .modal-btn:hover { filter: brightness(1.05); transform: translateY(-1px); }
    .modal-btn:active { transform: translateY(1px); }

    #reviveBtn {
      background: linear-gradient(90deg, rgba(56,189,248,0.95), rgba(34,197,94,0.95));
      color: #02121a;
      border-color: rgba(56,189,248,0.55);
    }
    #restartBtn {
      background: linear-gradient(90deg, #22c55e, #2dd4bf);
      color: #022c22;
      border-color: rgba(34,197,94,0.55);
    }
    .modal-note {
      margin-top: 10px;
      font-size: 12px;
      color: #9ca3af;
      text-align: center;
      user-select:none;
    }

    /* Shop modal */
    #shopModal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 1300;
      background: rgba(2,6,23,0.78);
      backdrop-filter: blur(4px);
    }
    #shopModal.show{ display:flex; }

    /* ‚úÖ FIX: shop scrollable */
    .shop-card{
      width: min(760px, 96vw);
      max-height: 86vh;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.95);
      box-shadow: 0 28px 70px rgba(0,0,0,0.6);
      padding: 14px 14px 12px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .shop-body{
      overflow:auto;
      padding-right: 4px;
      margin-top: 6px;
    }

    .shop-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      margin-bottom: 4px;
      flex: 0 0 auto;
    }
    .shop-title{
      font-weight: 950;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color:#facc15;
      text-shadow: 0 0 18px rgba(250,204,21,0.20);
    }
    .shop-sub{
      font-size: 12px;
      color:#9ca3af;
      margin-top: 4px;
      line-height:1.4;
    }
    .shop-close{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.55);
      color:#e5e7eb;
      cursor:pointer;
      user-select:none;
    }
    .shop-close:hover{ border-color: rgba(99,102,241,0.65); }
    .shop-close:active{ transform: translateY(1px); }

    .shop-balance{
      margin-top: 6px;
      font-size: 12px;
      color:#e5e7eb;
    }
    .shop-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-top: 8px;
      padding-bottom: 6px;
    }
    .shop-section-title{
      grid-column: 1 / -1;
      margin-top: 6px;
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
      opacity: 0.95;
    }
    .shop-section-note{
      grid-column: 1 / -1;
      margin-top: -6px;
      font-size: 12px;
      color:#9ca3af;
      line-height:1.35;
    }

    .shop-item{
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.25);
      background: rgba(2,6,23,0.35);
      padding: 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,0.22);
      overflow:hidden;
    }
    .shop-item h3{
      font-size: 14px;
      color:#e5e7eb;
      margin-bottom: 6px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .shop-item p{
      font-size: 12px;
      color:#9ca3af;
      line-height:1.4;
      margin-bottom: 10px;
    }
    .shop-row{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
    }
    .price{
      font-size: 12px;
      color:#facc15;
      font-weight: 800;
    }
    .shop-action{
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.65);
      color:#e5e7eb;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
    }
    .shop-action:hover{ filter: brightness(1.06); }
    .shop-action:active{ transform: translateY(1px); }
    .shop-action[disabled]{
      opacity: 0.45;
      cursor:not-allowed;
    }
    .swatch{
      width: 26px;
      height: 26px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06), 0 10px 20px rgba(0,0,0,0.25);
      flex: 0 0 auto;
    }

    /* Sound modal */
    #soundModal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 1350;
      background: rgba(2,6,23,0.78);
      backdrop-filter: blur(4px);
    }
    #soundModal.show{ display:flex; }
    .sound-card{
      width: min(640px, 96vw);
      max-height: 86vh;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.95);
      box-shadow: 0 28px 70px rgba(0,0,0,0.6);
      padding: 14px 14px 12px;
      overflow:auto;
    }
    .sound-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }
    .sound-title{
      font-weight: 950;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color:#facc15;
      text-shadow: 0 0 18px rgba(250,204,21,0.20);
    }
    .sound-sub{
      font-size: 12px;
      color:#9ca3af;
      margin-top: 4px;
      line-height:1.4;
    }
    .sound-close{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.55);
      color:#e5e7eb;
      cursor:pointer;
      user-select:none;
    }
    .sound-close:hover{ border-color: rgba(99,102,241,0.65); }
    .sound-close:active{ transform: translateY(1px); }

    .sound-body{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .s-row{
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.25);
      background: rgba(2,6,23,0.35);
      padding: 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,0.18);
    }
    .s-row h3{
      font-size: 13px;
      color:#e5e7eb;
      margin-bottom: 8px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .s-line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .toggle input{ transform: scale(1.1); }
    .range-wrap{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 1;
      min-width: 240px;
    }
    .range-wrap input[type="range"]{
      width: 100%;
      accent-color: #facc15;
    }
    .pct{
      width: 56px;
      text-align:right;
      font-size: 12px;
      color:#e5e7eb;
      font-weight: 800;
    }
    .s-note{
      margin-top: 8px;
      font-size: 12px;
      color:#9ca3af;
      line-height: 1.4;
    }

    /* Bottom hint */
    #hint {
      margin-top: 12px;
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
      max-width: 900px;
      padding: 0 12px;
      line-height: 1.5;
    }

    @media (max-width: 600px) {
      #gameContainer { height: 230px; }
      #player { left: 40px; }
      #touchControls { margin-top: 12px; gap: 8px; }
      .ctrl-btn { padding: 10px 8px; font-size: 13px; }
      #energyContainer { font-size: 12px; }
      #energyText { width: 70px; font-size: 10px; }
      .shop-grid{ grid-template-columns: 1fr; }
      .range-wrap{ min-width: 200px; }
    }
  </style>
</head>

<body>
  <h1>PHANToM Runner</h1>

  <div id="gameContainer">
    <div id="ground"></div>
    <div id="boostBeam"></div>

    <div id="inGameTopBar">
      <div class="ig-pill">
        <span>‚è∏ P</span>
        <span id="statusPill">READY</span>
      </div>

      <div style="display:flex; gap:8px; align-items:center; pointer-events:auto;">
        <button id="audioQuickBtn" class="ig-btn" title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á">üîä</button>
        <button id="pauseBtn" class="ig-btn">Pause</button>
      </div>
    </div>

    <div id="player">
      <img src="phantom-runner.png" alt="PHANToM" />
    </div>

    <div id="startOverlay">
      <div class="title">PHANToM RUNNER</div>
      <div id="countdownText"></div>
      <button id="startGameBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
      <div id="startHintMini">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ ‡∏Å‡∏î Space ‡∏Å‡πá‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ</div>
    </div>

    <div id="pauseOverlay">
      <div class="pTitle">PAUSED</div>
      <button id="resumeBtnOverlay">Resume</button>
      <div style="font-size:12px;color:#9ca3af;">‡∏Å‡∏î P ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Resume</div>
    </div>
  </div>

  <div id="touchControls">
    <button id="btnJump" class="ctrl-btn">‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î <span>JUMP / SPACE</span></button>
    <button id="btnDuck" class="ctrl-btn">‡∏´‡∏°‡∏≠‡∏ö <span>DUCK / ‚Üì</span></button>
  </div>

  <div id="energyContainer">
    <div id="energyLabel">Energy</div>
    <div id="energyBarWrapper"><div id="energyBar"></div></div>
    <div id="energyText">100 / 100</div>
  </div>

  <div id="scoreBoard">
    <div id="score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</div>
    <div id="coinsBox">
      ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°: <span id="walletCoins">0</span>
      <small>(‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: <span id="runCoins">0</span>)</small>
    </div>
    <div id="bestScore">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: 0</div>
  </div>

  <div id="miniActions">
    <button id="fullscreenBtn" class="mini-btn">‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠</button>
    <button id="soundBtn" class="mini-btn">‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
    <button id="shopBtn" class="mini-btn">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    <button id="restartOutsideBtn" class="mini-btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
  </div>

  <div id="cheatTimer"></div>
  <div id="mission"></div>
  <div id="message">‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‚Äù ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Å‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</div>

  <div id="itemGuide">
    <strong>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°:</strong>
    <ul>
      <li>ü§ë <b>‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç (Coin)</b> : +‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô / ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</li>
      <li>‚ù§Ô∏è <b>‡∏´‡∏±‡∏ß‡πÉ‡∏à (Energy)</b> : ‡πÄ‡∏û‡∏¥‡πà‡∏° Energy (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å 40 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</li>
      <li>üß≤ <b>Magnet</b> : ‡∏î‡∏π‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç/‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏£‡∏≠‡∏ö ‡πÜ ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</li>
      <li>‚ö° <b>Boost</b> : ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏≠‡∏°‡∏ï‡∏∞‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</li>
      <li>üåÄ <b>Giant</b> : ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏£‡πà‡∏≤‡∏á ‡∏ä‡∏ô‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡∏û‡∏∑‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏á‡πÑ‡∏î‡πâ</li>
    </ul>
  </div>

  <div id="hint">
    Space / ‚Üë = ‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î (2 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞) ‚Ä¢ ‚Üì = ‡∏´‡∏°‡∏≠‡∏ö ‚Ä¢ ‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏•‡∏≠‡∏¢/‡∏ö‡∏±‡∏ô‡πÑ‡∏î ‚Ä¢ ‡∏´‡∏•‡∏∏‡∏°‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å (‡∏ï‡∏Å‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ) ‚Ä¢
    ‡∏Å‡∏î P = Pause/Resume ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏£‡∏≠‡∏ö (‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏î 15% ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏•‡∏î 50%)
  </div>

  <div id="hitFlash"></div>

  <!-- GAME OVER MODAL -->
  <div id="gameOverModal" aria-modal="true" role="dialog">
    <div class="modal-card">
      <div class="modal-title">Game Over</div>
      <div id="modalStats" class="modal-stats"></div>

      <div class="modal-actions">
        <button id="reviveBtn" class="modal-btn" style="display:none;">‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏î‡πâ‡∏ß‡∏¢ 50 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</button>
        <button id="restartBtn" class="modal-btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</button>
      </div>

      <div class="modal-note">‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ</div>
    </div>
  </div>

  <!-- SHOP MODAL -->
  <div id="shopModal" aria-modal="true" role="dialog">
    <div class="shop-card">
      <div class="shop-header">
        <div>
          <div class="shop-title">SHOP</div>
          <div class="shop-sub">‡∏ã‡∏∑‡πâ‡∏≠/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏ò‡∏µ‡∏°‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‚Äù ‡πÅ‡∏•‡∏∞ ‚Äú‡∏ò‡∏µ‡∏°‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‚Äù ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏° (‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ)</div>
          <div class="shop-balance">‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°: <b id="shopWalletCoins">0</b></div>
        </div>
        <button id="shopCloseBtn" class="shop-close">‡∏õ‡∏¥‡∏î</button>
      </div>

      <!-- ‚úÖ scroll area -->
      <div class="shop-body">
        <div class="shop-grid" id="shopGrid"></div>
      </div>
    </div>
  </div>

  <!-- SOUND MODAL -->
  <div id="soundModal" aria-modal="true" role="dialog">
    <div class="sound-card">
      <div class="sound-header">
        <div>
          <div class="sound-title">SOUND</div>
          <div class="sound-sub">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å BGM / SFX ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä (localStorage)</div>
        </div>
        <button id="soundCloseBtn" class="sound-close">‡∏õ‡∏¥‡∏î</button>
      </div>

      <div class="sound-body">
        <div class="s-row">
          <h3>Master</h3>
          <div class="s-line">
            <label class="toggle">
              <input type="checkbox" id="audioMasterToggle">
              <span>‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
            </label>
            <button id="audioTestBtn" class="shop-action" style="border-radius:12px;">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
          </div>
          <div class="s-note">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ö‡∏≤‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ï‡πâ‡∏≠‡∏á ‚Äú‡πÅ‡∏ï‡∏∞/‡∏Ñ‡∏•‡∏¥‡∏Å‚Äù ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ</div>
        </div>

        <div class="s-row">
          <h3>BGM</h3>
          <div class="s-line">
            <label class="toggle">
              <input type="checkbox" id="bgmToggle">
              <span>‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á BGM</span>
            </label>
            <div class="range-wrap">
              <input type="range" id="bgmVolRange" min="0" max="100" value="65">
              <div class="pct" id="bgmPct">65%</div>
            </div>
          </div>
        </div>

        <div class="s-row">
          <h3>SFX</h3>
          <div class="s-line">
            <label class="toggle">
              <input type="checkbox" id="sfxToggle">
              <span>‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á SFX</span>
            </label>
            <div class="range-wrap">
              <input type="range" id="sfxVolRange" min="0" max="100" value="80">
              <div class="pct" id="sfxPct">80%</div>
            </div>
          </div>
        </div>

        <div class="s-note">Tip: ‡∏õ‡∏∏‡πà‡∏° ‚Äúüîä/üîá‚Äù ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡πÉ‡∏ô‡πÄ‡∏Å‡∏° = ‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß</div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      // =========================
      // CONFIG
      // =========================
      const CFG_GRAVITY = 0.9;
      const CFG_JUMP_STRENGTH = 13.5;
      const CFG_MAX_JUMPS = 2;

      const CFG_MAX_ENERGY = 100;
      const CFG_ENERGY_DECAY_PER_SEC = 4;
      const CFG_DAMAGE_GROUND = 15;
      const CFG_DAMAGE_AIR = 21;

      const CFG_START_SPEED = 6;
      const CFG_SPEED_UP_EVERY_SCORE = 5;
      const CFG_SPEED_UP_AMOUNT = 0.5;
      const CFG_BOOST_MULTIPLIER = 1.6;

      const CFG_HIT_SLOW_FACTOR = 0.8;
      const CFG_HIT_SLOW_DURATION = 500;
      const CFG_HIT_IFRAMES = 350;

      const CFG_HOLE_CHANCE = 0.18;
      const CFG_TRAP_Y = -60;

      const CFG_CHEAT_INVINCIBLE_DURATION = 10000;
      const CFG_MAGNET_DURATION = 10000;
      const CFG_BOOST_DURATION = 5000;
      const CFG_GIANT_DURATION = 6000;

      const CFG_MAGNET_RADIUS = 400;

      const CFG_HEART_SMALL_GAIN = 15;
      const CFG_HEART_MEDIUM_GAIN = 25;
      const CFG_HEART_LARGE_GAIN = 40;

      const CFG_MISSION_COIN_TARGET = 20;
      const CFG_MISSION_DJ_TARGET = 10;
      const CFG_MISSION_OBS_TARGET = 30;

      // ‚úÖ Items less frequent
      const CFG_COIN_BASE_INTERVAL = 900;
      const CFG_COIN_MIN_INTERVAL  = 450;

      const CFG_HEART_BASE_INTERVAL = 1900;
      const CFG_HEART_MIN_INTERVAL  = 1050;

      const CFG_POWERUP_BASE_INTERVAL = 1400;
      const CFG_POWERUP_MIN_INTERVAL  = 850;

      const CFG_BIG_HEART_EVERY_MS = 45000;

      const CFG_CHEAT_WINDOW = 1000;

      const CFG_REVIVE_COST = 50;
      const CFG_REVIVE_ENERGY = 55;
      const CFG_REVIVE_INVINCIBLE_MS = 1200;
      const CFG_POST_REVIVE_SCORE_MULT = 0.85;
      const CFG_POST_REVIVE_COIN_MULT  = 0.50;
      const CFG_COUNTDOWN_SECONDS = 3;

      // localStorage keys
      const LS_BEST = "phantom_runner_best";
      const LS_WALLET = "phantom_runner_wallet_coins";

      const LS_BACKDROPS_UNLOCK = "phantom_runner_backdrops_unlocked";
      const LS_BACKDROP_SELECTED = "phantom_runner_backdrop_selected";
      const LS_OBS_UNLOCK = "phantom_runner_obstacles_unlocked";
      const LS_OBS_SELECTED = "phantom_runner_obstacles_selected";

      // audio settings
      const LS_AUDIO_MASTER = "phantom_runner_audio_master";
      const LS_AUDIO_BGM_ON = "phantom_runner_audio_bgm_on";
      const LS_AUDIO_SFX_ON = "phantom_runner_audio_sfx_on";
      const LS_AUDIO_BGM_VOL = "phantom_runner_audio_bgm_vol";
      const LS_AUDIO_SFX_VOL = "phantom_runner_audio_sfx_vol";

      // =========================
      // DOM
      // =========================
      const gameContainer = document.getElementById("gameContainer");
      const player = document.getElementById("player");
      const scoreEl = document.getElementById("score");
      const bestScoreEl = document.getElementById("bestScore");
      const messageEl = document.getElementById("message");
      const cheatTimerEl = document.getElementById("cheatTimer");
      const btnJump = document.getElementById("btnJump");
      const btnDuck = document.getElementById("btnDuck");
      const energyBar = document.getElementById("energyBar");
      const energyText = document.getElementById("energyText");

      const walletCoinsEl = document.getElementById("walletCoins");
      const runCoinsEl = document.getElementById("runCoins");

      const missionEl = document.getElementById("mission");
      const boostBeam = document.getElementById("boostBeam");

      const fullscreenBtn = document.getElementById("fullscreenBtn");
      const restartOutsideBtn = document.getElementById("restartOutsideBtn");

      const pauseBtn = document.getElementById("pauseBtn");
      const pauseOverlay = document.getElementById("pauseOverlay");
      const resumeBtnOverlay = document.getElementById("resumeBtnOverlay");
      const statusPill = document.getElementById("statusPill");

      const startOverlay = document.getElementById("startOverlay");
      const startGameBtn = document.getElementById("startGameBtn");
      const countdownText = document.getElementById("countdownText");

      const gameOverModal = document.getElementById("gameOverModal");
      const modalStats = document.getElementById("modalStats");
      const reviveBtn = document.getElementById("reviveBtn");
      const restartBtn = document.getElementById("restartBtn");

      const shopBtn = document.getElementById("shopBtn");
      const shopModal = document.getElementById("shopModal");
      const shopCloseBtn = document.getElementById("shopCloseBtn");
      const shopGrid = document.getElementById("shopGrid");
      const shopWalletCoins = document.getElementById("shopWalletCoins");

      // sound UI
      const audioQuickBtn = document.getElementById("audioQuickBtn");
      const soundBtn = document.getElementById("soundBtn");
      const soundModal = document.getElementById("soundModal");
      const soundCloseBtn = document.getElementById("soundCloseBtn");
      const audioMasterToggle = document.getElementById("audioMasterToggle");
      const bgmToggle = document.getElementById("bgmToggle");
      const sfxToggle = document.getElementById("sfxToggle");
      const bgmVolRange = document.getElementById("bgmVolRange");
      const sfxVolRange = document.getElementById("sfxVolRange");
      const bgmPct = document.getElementById("bgmPct");
      const sfxPct = document.getElementById("sfxPct");
      const audioTestBtn = document.getElementById("audioTestBtn");

      // =========================
      // SOUND
      // =========================
      const Sounds = {
        bgm: new Audio("bgm_main.mp3"),
        countdown: new Audio("sfx_countdown.mp3"),
        jump: new Audio("sfx_jump.mp3"),
        coin: new Audio("sfx_coin.mp3"),
        powerup: new Audio("sfx_powerup.mp3"),
        hit: new Audio("sfx_hit.mp3"),
        gameover: new Audio("sfx_gameover.mp3"),
        revive: new Audio("sfx_revive.mp3"),
        click: new Audio("sfx_click.mp3"),
      };

      const BASE_VOL = {
        bgm: 0.22,
        countdown: 0.35,
        jump: 0.35,
        coin: 0.35,
        powerup: 0.40,
        hit: 0.45,
        gameover: 0.50,
        revive: 0.45,
        click: 0.35,
      };

      Sounds.bgm.loop = true;

      let audioUnlocked = false;

      function loadBool(key, def){
        try{
          const v = localStorage.getItem(key);
          if (v === null || v === undefined) return def;
          return v === "1" || v === "true";
        }catch(_){ return def; }
      }
      function loadNum(key, def){
        try{
          const v = parseFloat(localStorage.getItem(key));
          return Number.isFinite(v) ? v : def;
        }catch(_){ return def; }
      }
      function saveBool(key, v){ try{ localStorage.setItem(key, v ? "1" : "0"); }catch(_){ } }
      function saveNum(key, v){ try{ localStorage.setItem(key, String(v)); }catch(_){ } }

      let audioEnabled = loadBool(LS_AUDIO_MASTER, true);
      let bgmEnabled = loadBool(LS_AUDIO_BGM_ON, true);
      let sfxEnabled = loadBool(LS_AUDIO_SFX_ON, true);
      let bgmVolume = clamp(loadNum(LS_AUDIO_BGM_VOL, 0.65), 0, 1);
      let sfxVolume = clamp(loadNum(LS_AUDIO_SFX_VOL, 0.80), 0, 1);

      function unlockAudioOnce(){
        if (audioUnlocked) return;
        audioUnlocked = true;
        try{
          const prev = Sounds.click.volume;
          Sounds.click.volume = 0;
          const p = Sounds.click.play();
          if (p && p.catch) p.catch(()=>{});
          setTimeout(()=>{ try{ Sounds.click.pause(); Sounds.click.currentTime = 0; Sounds.click.volume = prev; }catch(_){ } }, 80);
        }catch(_){}
      }
      document.addEventListener("pointerdown", unlockAudioOnce, { once:true });

      function applyAudioVolumes(){
        Sounds.bgm.volume = BASE_VOL.bgm * bgmVolume;

        const s = sfxVolume;
        Sounds.countdown.volume = BASE_VOL.countdown * s;
        Sounds.jump.volume      = BASE_VOL.jump * s;
        Sounds.coin.volume      = BASE_VOL.coin * s;
        Sounds.powerup.volume   = BASE_VOL.powerup * s;
        Sounds.hit.volume       = BASE_VOL.hit * s;
        Sounds.gameover.volume  = BASE_VOL.gameover * s;
        Sounds.revive.volume    = BASE_VOL.revive * s;
        Sounds.click.volume     = BASE_VOL.click * s;
      }

      function updateAudioQuickBtn(){
        audioQuickBtn.textContent = audioEnabled ? "üîä" : "üîá";
      }

      function playSFX(a){
        if (!audioEnabled || !sfxEnabled) return;
        if (!a) return;
        try{
          a.currentTime = 0;
          const p = a.play();
          if (p && typeof p.catch === "function") p.catch(()=>{});
        }catch(_){}
      }

      function bgmPlay(){
        if (!audioEnabled || !bgmEnabled) return;
        try{
          const p = Sounds.bgm.play();
          if (p && p.catch) p.catch(()=>{});
        }catch(_){}
      }
      function bgmPause(){
        try{ Sounds.bgm.pause(); }catch(_){}
      }

      function applyAudioSettings(){
        applyAudioVolumes();
        updateAudioQuickBtn();

        audioMasterToggle.checked = !!audioEnabled;
        bgmToggle.checked = !!bgmEnabled;
        sfxToggle.checked = !!sfxEnabled;

        bgmVolRange.value = String(Math.round(bgmVolume * 100));
        sfxVolRange.value = String(Math.round(sfxVolume * 100));
        bgmPct.textContent = Math.round(bgmVolume * 100) + "%";
        sfxPct.textContent = Math.round(sfxVolume * 100) + "%";

        if (!audioEnabled || !bgmEnabled) bgmPause();
        else {
          if (isRunning && !gameOver && !isPaused) bgmPlay();
        }
      }

      // =========================
      // Shop (themes)
      // =========================
      const Backdrops = [
        { id:"toxic",  name:"Toxic Lab (Default)", desc:"‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏° ‡πÜ ‡πÇ‡∏ó‡∏ô‡∏û‡∏¥‡∏©", price:0,   css:{ "--bg1":"#1d2337", "--bg2":"#020617" } },
        { id:"nebula", name:"Purple Nebula",       desc:"‡∏°‡πà‡∏ß‡∏á‡∏•‡∏∂‡∏Å ‡πÜ ‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏•", price:120, css:{ "--bg1":"#20102e", "--bg2":"#050312" } },
        { id:"neon",   name:"Neon City",           desc:"‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô/‡∏ô‡∏µ‡∏≠‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏° ‡πÜ",  price:150, css:{ "--bg1":"#0b1b2e", "--bg2":"#020617" } },
        { id:"dusk",   name:"Midnight Dusk",       desc:"‡πÄ‡∏Ç‡πâ‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô",      price:180, css:{ "--bg1":"#0a1224", "--bg2":"#020617" } },
        { id:"sunset", name:"Sunset Ember",        desc:"‡∏™‡πâ‡∏°/‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ï‡∏Å", price:220, css:{ "--bg1":"#2a0f10", "--bg2":"#07040a" } },
        { id:"arctic", name:"Arctic Cyan",         desc:"‡∏ü‡πâ‡∏≤/‡πÑ‡∏ã‡πÅ‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô ‡πÜ",      price:240, css:{ "--bg1":"#061a2b", "--bg2":"#020617" } },
      ];

      const ObstacleThemes = [
        { id:"poison", name:"Poison Slate (Default)", desc:"‡πÇ‡∏ó‡∏ô‡∏û‡∏¥‡∏©‡∏°‡∏∑‡∏î ‡πÜ", price:0,
          css:{ "--obs-a":"#111827","--obs-b":"#0b1020","--obs-c":"#2e1065","--obs-d":"#0b1020","--obs-border":"rgba(148,163,184,0.16)","--obs-shadow":"rgba(0,0,0,0.35)" } },
        { id:"ember", name:"Ember Core", desc:"‡πÅ‡∏î‡∏á/‡∏™‡πâ‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏î ‡πÜ", price:140,
          css:{ "--obs-a":"#2b0a0a","--obs-b":"#3b0a0a","--obs-c":"#7f1d1d","--obs-d":"#1f0a0a","--obs-border":"rgba(248,113,113,0.18)","--obs-shadow":"rgba(0,0,0,0.38)" } },
        { id:"cyber", name:"Cyber Neon", desc:"‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô/‡∏°‡πà‡∏ß‡∏á‡∏ô‡∏µ‡∏≠‡∏≠‡∏ô", price:170,
          css:{ "--obs-a":"#0a1020","--obs-b":"#0b2a3a","--obs-c":"#5b21b6","--obs-d":"#0b1020","--obs-border":"rgba(56,189,248,0.18)","--obs-shadow":"rgba(0,0,0,0.36)" } },
        { id:"forest", name:"Deep Forest", desc:"‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°/‡∏î‡∏≥", price:190,
          css:{ "--obs-a":"#07110b","--obs-b":"#0a1a12","--obs-c":"#14532d","--obs-d":"#07110b","--obs-border":"rgba(34,197,94,0.16)","--obs-shadow":"rgba(0,0,0,0.36)" } },
        { id:"ice", name:"Frost Byte", desc:"‡∏ü‡πâ‡∏≤‡πÄ‡∏¢‡πá‡∏ô/‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô", price:210,
          css:{ "--obs-a":"#07141f","--obs-b":"#0b2a3a","--obs-c":"#1d4ed8","--obs-d":"#07141f","--obs-border":"rgba(147,197,253,0.18)","--obs-shadow":"rgba(0,0,0,0.34)" } },
      ];

      function loadUnlockedObj(key, defaultId){
        try{
          const raw = localStorage.getItem(key);
          let obj = raw ? JSON.parse(raw) : {};
          if (!obj || typeof obj !== "object") obj = {};
          obj[defaultId] = true;
          return obj;
        }catch(_){
          const o = {}; o[defaultId] = true; return o;
        }
      }
      function saveUnlockedObj(key, obj){
        try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(_){}
      }
      function loadSelectedId(key, fallback){
        return localStorage.getItem(key) || fallback;
      }
      function saveSelectedId(key, id){
        try{ localStorage.setItem(key, id); }catch(_){}
      }

      let unlockedBackdrops = loadUnlockedObj(LS_BACKDROPS_UNLOCK, "toxic");
      let selectedBackdrop = loadSelectedId(LS_BACKDROP_SELECTED, "toxic");
      if (!unlockedBackdrops[selectedBackdrop]) selectedBackdrop = "toxic";

      let unlockedObsThemes = loadUnlockedObj(LS_OBS_UNLOCK, "poison");
      let selectedObsTheme = loadSelectedId(LS_OBS_SELECTED, "poison");
      if (!unlockedObsThemes[selectedObsTheme]) selectedObsTheme = "poison";

      function applyThemeVars(cssObj){
        for (const k in cssObj){
          document.documentElement.style.setProperty(k, cssObj[k]);
        }
      }
      function applyBackdrop(id){
        const b = Backdrops.find(x=>x.id===id) || Backdrops[0];
        applyThemeVars(b.css);
        selectedBackdrop = b.id;
        saveSelectedId(LS_BACKDROP_SELECTED, selectedBackdrop);
      }
      function applyObstacleTheme(id){
        const t = ObstacleThemes.find(x=>x.id===id) || ObstacleThemes[0];
        applyThemeVars(t.css);
        selectedObsTheme = t.id;
        saveSelectedId(LS_OBS_SELECTED, selectedObsTheme);
      }
      applyBackdrop(selectedBackdrop);
      applyObstacleTheme(selectedObsTheme);

      function swatchBackdrop(b){
        const c1 = b.css["--bg1"] || "#111827";
        const c2 = b.css["--bg2"] || "#020617";
        return `background: linear-gradient(180deg, ${c1}, ${c2});`;
      }
      function swatchObstacle(t){
        const a = t.css["--obs-a"], b = t.css["--obs-b"], c = t.css["--obs-c"], d = t.css["--obs-d"];
        return `background: linear-gradient(135deg, ${a}, ${b}, ${c}, ${d});`;
      }

      function renderShop(){
        shopWalletCoins.textContent = String(walletCoins);
        shopGrid.innerHTML = "";

        const addSection = (title, note) => {
          const h = document.createElement("div");
          h.className = "shop-section-title";
          h.textContent = title;
          shopGrid.appendChild(h);

          const n = document.createElement("div");
          n.className = "shop-section-note";
          n.textContent = note;
          shopGrid.appendChild(n);
        };

        const addItem = (item, kind, unlocked, selected, swatchStyle) => {
          const el = document.createElement("div");
          el.className = "shop-item";
          const priceText = item.price === 0 ? "‡∏ü‡∏£‡∏µ" : (item.price + " ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç");
          el.innerHTML = `
            <h3><span class="swatch" style="${swatchStyle}"></span>${item.name}</h3>
            <p>${item.desc}</p>
            <div class="shop-row">
              <div class="price">${priceText}</div>
              <div style="display:flex; gap:10px; align-items:center;">
                <button class="shop-action" data-kind="${kind}" data-act="buy" data-id="${item.id}" ${unlocked || item.price===0 ? "disabled" : ""}>‡∏ã‡∏∑‡πâ‡∏≠</button>
                <button class="shop-action" data-kind="${kind}" data-act="select" data-id="${item.id}" ${(!unlocked && item.price>0) ? "disabled" : ""}>
                  ${selected ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ" : "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å"}
                </button>
              </div>
            </div>
          `;
          shopGrid.appendChild(el);
        };

        addSection("Background Themes", "‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏ô‡∏≤‡∏° (‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ)");
        Backdrops.forEach(b=>{
          const unlocked = !!unlockedBackdrops[b.id];
          const selected = (selectedBackdrop === b.id);
          addItem(b, "backdrop", unlocked, selected, swatchBackdrop(b));
        });

        addSection("Obstacle Themes", "‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ CSS ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)");
        ObstacleThemes.forEach(t=>{
          const unlocked = !!unlockedObsThemes[t.id];
          const selected = (selectedObsTheme === t.id);
          addItem(t, "obstacle", unlocked, selected, swatchObstacle(t));
        });
      }

      function openShop(){
        unlockAudioOnce();
        playSFX(Sounds.click);
        if (isRunning && !gameOver && !isPaused) pauseGame(true);
        renderShop();
        shopModal.classList.add("show");
        // ‚úÖ ensure scroll starts at top
        const body = shopModal.querySelector(".shop-body");
        if (body) body.scrollTop = 0;
      }
      function closeShop(){
        unlockAudioOnce();
        playSFX(Sounds.click);
        shopModal.classList.remove("show");
      }

      shopBtn.addEventListener("click", openShop);
      shopCloseBtn.addEventListener("click", closeShop);
      shopModal.addEventListener("click", (e)=>{
        if (e.target === shopModal) closeShop();
      });

      shopGrid.addEventListener("click", (e)=>{
        const btn = e.target.closest("button");
        if (!btn) return;

        unlockAudioOnce();

        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        const kind = btn.getAttribute("data-kind");

        const list = (kind === "obstacle") ? ObstacleThemes : Backdrops;
        const item = list.find(x=>x.id===id);
        if (!item) return;

        const unlockedObj = (kind === "obstacle") ? unlockedObsThemes : unlockedBackdrops;
        const saveUnlockKey = (kind === "obstacle") ? LS_OBS_UNLOCK : LS_BACKDROPS_UNLOCK;

        if (act === "buy"){
          if (unlockedObj[id] || item.price===0) return;
          if (walletCoins < item.price) return;

          walletCoins -= item.price;
          saveWallet();
          updateCoinsUI();

          unlockedObj[id] = true;
          saveUnlockedObj(saveUnlockKey, unlockedObj);
          playSFX(Sounds.click);
          renderShop();
        }

        if (act === "select"){
          if (!unlockedObj[id] && item.price>0) return;

          if (kind === "obstacle") applyObstacleTheme(id);
          else applyBackdrop(id);

          playSFX(Sounds.click);
          renderShop();
        }
      });

      // =========================
      // State
      // =========================
      const groundY = 40;

      let playerY = groundY;
      let prevPlayerY = groundY;
      let jumpVelocity = 0;
      let jumpsLeft = CFG_MAX_JUMPS;

      let isDucking = false;

      let energy = CFG_MAX_ENERGY;

      let score = 0;
      let bestScore = Number(localStorage.getItem(LS_BEST) || 0);

      let runCoins = 0;
      let walletCoins = Number(localStorage.getItem(LS_WALLET) || 0);

      let coinsCollected = 0;
      let totalDoubleJumps = 0;
      let obstaclesPassed = 0;

      let obstacles = [];
      let collectibles = [];
      let platforms = [];
      let holes = [];

      let speed = CFG_START_SPEED;

      let gameOver = false;
      let frameId = null;
      let lastTime = null;

      let isRunning = false;
      let isPaused = false;
      let countdownTimer = null;
      let countdownLeft = 0;

      let timeSinceLastObstacle = 0;
      let nextSpawnIn = 900;

      let timeSinceLastCoin = 0;
      let timeSinceLastHeart = 0;
      let timeSinceLastPowerup = 0;
      let timeSinceLastBigHeart = 0;

      let timeSinceLastPlatform = 0;
      let nextPlatformIn = 2000 + Math.random() * (4500 - 2000);

      let invincible = false;
      let invincibleTimer = 0;

      let magnetActive = false;
      let magnetTimer = 0;

      let boostActive = false;
      let boostTimer = 0;

      let giantActive = false;
      let giantTimer = 0;

      let hitSlowTimer = 0;
      let hitIFramesTimer = 0;

      let cheatEvents = [];

      let revivedThisRun = false;
      let postReviveActive = false;
      let postScoreAcc = 0;
      let postScoreCredited = 0;
      let postCoinAcc = 0;
      let postCoinCredited = 0;

      // =========================
      // Helpers
      // =========================
      function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
      function randomBetween(min, max) { return Math.random() * (max - min) + min; }

      function saveWallet(){ try{ localStorage.setItem(LS_WALLET, String(walletCoins)); }catch(_){ } }

      function updateCoinsUI(){
        walletCoinsEl.textContent = String(walletCoins);
        runCoinsEl.textContent = String(runCoins);
        if (shopModal.classList.contains("show")) shopWalletCoins.textContent = String(walletCoins);
      }

      function updateEnergyUI() {
        const ratio = clamp(energy / CFG_MAX_ENERGY, 0, 1);
        energyBar.style.width = (ratio * 100) + "%";
        energyText.textContent = Math.round(energy) + " / " + CFG_MAX_ENERGY;
      }

      function updateMissionUI() {
        missionEl.textContent =
          "Mission: ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç " + coinsCollected + "/" + CFG_MISSION_COIN_TARGET +
          " ‚Ä¢ Double Jump " + totalDoubleJumps + "/" + CFG_MISSION_DJ_TARGET +
          " ‚Ä¢ ‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ " + obstaclesPassed + "/" + CFG_MISSION_OBS_TARGET;
      }

      function setStatus(text){ statusPill.textContent = text; }

      function showStartOverlay(){
        startOverlay.classList.remove("hidden");
        countdownText.textContent = "";
        setStatus("READY");
      }
      function hideStartOverlay(){ startOverlay.classList.add("hidden"); }

      function showPauseOverlay(){
        pauseOverlay.classList.add("show");
        setStatus("PAUSED");
      }
      function hidePauseOverlay(){ pauseOverlay.classList.remove("show"); }

      function hideGameOverModal(){ gameOverModal.classList.remove("show"); }

      function showGameOverModal(){
        const canRevive = (!revivedThisRun && walletCoins >= CFG_REVIVE_COST);
        reviveBtn.style.display = canRevive ? "block" : "none";
        reviveBtn.textContent = canRevive
          ? ("‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏î‡πâ‡∏ß‡∏¢ " + CFG_REVIVE_COST + " ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: " + walletCoins + ")")
          : "";

        modalStats.innerHTML =
          "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <b>" + score + "</b><br/>" +
          "‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: <b>" + runCoins + "</b><br/>" +
          "‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b>" + walletCoins + "</b><br/>" +
          "Energy ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>" + Math.round(energy) + "</b><br/>" +
          (postReviveActive ? "<br/><b>‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û:</b> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -15% / ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç -50%" : "");

        gameOverModal.classList.add("show");
      }

      function clearArrays() {
        obstacles.forEach(o => o && o.remove());
        obstacles = [];
        collectibles.forEach(c => c && c.remove());
        collectibles = [];
        platforms.forEach(p => p && p.remove());
        platforms = [];
        holes.forEach(h => h && h.remove());
        holes = [];
      }

      function addScore(base){
        if (!postReviveActive){
          score += base;
          return;
        }
        postScoreAcc += base * CFG_POST_REVIVE_SCORE_MULT;
        const newCred = Math.ceil(postScoreAcc);
        const gain = newCred - postScoreCredited;
        postScoreCredited = newCred;
        if (gain > 0) score += gain;
      }

      function addCoins(base){
        if (!postReviveActive){
          runCoins += base;
          walletCoins += base;
          saveWallet();
          return;
        }
        postCoinAcc += base * CFG_POST_REVIVE_COIN_MULT;
        const newCred = Math.ceil(postCoinAcc);
        const gain = newCred - postCoinCredited;
        postCoinCredited = newCred;
        if (gain > 0){
          runCoins += gain;
          walletCoins += gain;
          saveWallet();
        }
      }

      function prepareNewRun(){
        clearArrays();
        hideGameOverModal();
        hidePauseOverlay();

        score = 0;
        runCoins = 0;
        coinsCollected = 0;
        totalDoubleJumps = 0;
        obstaclesPassed = 0;
        speed = CFG_START_SPEED;

        playerY = groundY;
        prevPlayerY = groundY;
        jumpVelocity = 0;
        jumpsLeft = CFG_MAX_JUMPS;

        isDucking = false;
        player.classList.remove("duck", "invincible", "giant", "double-jump");
        player.style.bottom = playerY + "px";

        invincible = false;
        invincibleTimer = 0;

        magnetActive = false; magnetTimer = 0;
        boostActive = false; boostTimer = 0;
        giantActive = false; giantTimer = 0;

        hitSlowTimer = 0;
        hitIFramesTimer = 0;

        energy = CFG_MAX_ENERGY;

        timeSinceLastObstacle = 0;
        nextSpawnIn = 850 + Math.random() * 550;

        timeSinceLastCoin = 0;
        timeSinceLastHeart = 0;
        timeSinceLastPowerup = 0;
        timeSinceLastBigHeart = 0;

        timeSinceLastPlatform = 0;
        nextPlatformIn = 2000 + Math.random() * (4500 - 2000);

        revivedThisRun = false;
        postReviveActive = false;
        postScoreAcc = 0; postScoreCredited = 0;
        postCoinAcc = 0;  postCoinCredited = 0;

        gameOver = false;
        isRunning = false;
        isPaused = false;

        if (frameId) cancelAnimationFrame(frameId);
        frameId = null;
        lastTime = null;

        if (boostBeam) {
          boostBeam.style.opacity = 0;
          boostBeam.style.left = "-9999px";
        }

        scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
        updateCoinsUI();
        updateEnergyUI();
        updateMissionUI();

        cheatTimerEl.textContent = "";
        messageEl.textContent = "‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‚Äù ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Å‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°";

        bgmPause();
        showStartOverlay();
      }

      function startCountdown(){
        if (countdownTimer) return;
        if (gameOver) return;

        unlockAudioOnce();
        playSFX(Sounds.click);

        countdownLeft = CFG_COUNTDOWN_SECONDS;
        countdownText.textContent = String(countdownLeft);
        startGameBtn.disabled = true;
        setStatus("COUNTDOWN");

        playSFX(Sounds.countdown);

        countdownTimer = setInterval(() => {
          countdownLeft -= 1;
          if (countdownLeft > 0){
            countdownText.textContent = String(countdownLeft);
            playSFX(Sounds.countdown);
            return;
          }

          countdownText.textContent = "GO!";
          playSFX(Sounds.countdown);

          clearInterval(countdownTimer);
          countdownTimer = null;

          setTimeout(() => {
            countdownText.textContent = "";
            startGameBtn.disabled = false;
            hideStartOverlay();
            beginRun();
          }, 350);
        }, 1000);
      }

      function beginRun(){
        if (isRunning || gameOver) return;
        isRunning = true;
        isPaused = false;
        setStatus("RUN");

        messageEl.textContent = postReviveActive
          ? "‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û: ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -15% / ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç -50%"
          : "‡∏´‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏∏‡∏°‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!";

        spawnObstacle();
        lastTime = null;

        bgmPlay();
        frameId = requestAnimationFrame(gameLoop);
      }

      function pauseGame(silent){
        if (!isRunning || gameOver) return;
        if (isPaused) return;
        isPaused = true;

        if (!silent){
          unlockAudioOnce();
          playSFX(Sounds.click);
        }
        showPauseOverlay();

        bgmPause();
        if (frameId) cancelAnimationFrame(frameId);
        frameId = null;
        lastTime = null;
      }

      function resumeGame(){
        if (!isRunning || gameOver) return;
        if (!isPaused) return;
        isPaused = false;

        unlockAudioOnce();
        playSFX(Sounds.click);
        hidePauseOverlay();
        setStatus("RUN");

        bgmPlay();
        lastTime = null;
        frameId = requestAnimationFrame(gameLoop);
      }

      // =========================
      // Spawners
      // =========================
      function spawnHole() {
        const h = document.createElement("div");
        h.classList.add("hole");
        const width = randomBetween(80, 160);
        h.style.width = width + "px";
        h.style.left = gameContainer.offsetWidth + "px";
        h.style.bottom = "0px";
        gameContainer.appendChild(h);
        holes.push(h);
      }

      function setObstacleEmoji(obs, emoji, heightPx){
        obs.textContent = emoji;
        const fs = Math.max(18, Math.min(38, Math.round(heightPx * 0.55)));
        obs.style.fontSize = fs + "px";
      }

      // ‚úÖ obstacle emojis + stalactites
      const EMOJI_GROUND = {
        tree:"ü™µ", bush:"ü™¥", rock:"ü™®", spike:"üî∫", crate:"üì¶", barrel:"üõ¢Ô∏è", sign:"üöß", laser:"üíÄ", low:"üß±"
      };
      const EMOJI_AIR = {
        bird:"üê¶", drone:"üõ∏", fireball:"üî•"
      };
      const EMOJI_STAL = {
        stal1:"üîª", stal2:"ü™®", stal3:"üßä"
      };

      function spawnObstacle() {
        // 0.18 ceiling stalactite, 0.32 air, rest ground
        const roll = Math.random();

        // ‚úÖ ceiling stalactites (duck to avoid)
        if (roll < 0.18) {
          const obs = document.createElement("div");
          obs.classList.add("obstacle", "ceiling");

          const types = ["stal1","stal2","stal3"];
          const kind = types[Math.floor(Math.random() * types.length)];
          obs.classList.add(kind);

          const height = randomBetween(68, 104);
          const width  = randomBetween(34, 52);

          // important: bottom band that hits standing but not duck
          const bottom = randomBetween(groundY + 22, groundY + 38); // ~62-78

          obs.style.width = width + "px";
          obs.style.height = height + "px";
          obs.style.bottom = bottom + "px";
          obs.style.left = gameContainer.offsetWidth + "px";

          setObstacleEmoji(obs, EMOJI_STAL[kind], height);

          gameContainer.appendChild(obs);
          obstacles.push(obs);
          return;
        }

        const isAir = roll < 0.50;

        // hole chance on ground
        if (!isAir && Math.random() < CFG_HOLE_CHANCE) {
          spawnHole();
          return;
        }

        const obs = document.createElement("div");
        obs.classList.add("obstacle");

        if (isAir) {
          const airTypes = ["bird", "drone", "fireball"];
          const kind = airTypes[Math.floor(Math.random() * airTypes.length)];
          obs.classList.add("air", kind);

          const height = randomBetween(24, 32);
          const width = randomBetween(34, 40);
          obs.style.width = width + "px";
          obs.style.height = height + "px";
          obs.style.bottom = randomBetween(95, 125) + "px";
          obs.style.left = gameContainer.offsetWidth + "px";

          setObstacleEmoji(obs, EMOJI_AIR[kind], height);
        } else {
          obs.classList.add("ground");

          const groundTypes = ["tree", "bush", "rock", "spike", "crate", "barrel", "sign", "laser", "low"];
          const kind = groundTypes[Math.floor(Math.random() * groundTypes.length)];
          obs.classList.add(kind);

          let height, width;
          if (kind === "low") {
            height = randomBetween(28, 52);
            width  = randomBetween(28, 48);
            obs.style.borderRadius = "14px";
          } else {
            height = randomBetween(45, 80);
            width  = randomBetween(22, 40);
          }

          obs.style.width = width + "px";
          obs.style.height = height + "px";
          obs.style.bottom = groundY + "px";
          obs.style.left = gameContainer.offsetWidth + "px";

          setObstacleEmoji(obs, EMOJI_GROUND[kind], height);
        }

        gameContainer.appendChild(obs);
        obstacles.push(obs);
      }

      function spawnPlatformGroup() {
        const num = Math.random() < 0.5 ? 2 : 3;
        const baseBottom = groundY + randomBetween(45, 130);
        const step = 24;
        const goingUp = Math.random() < 0.5;
        const baseLeft = gameContainer.offsetWidth + 80;

        for (let i = 0; i < num; i++) {
          const p = document.createElement("div");
          p.classList.add("platform");
          const width = randomBetween(80, 150);
          const spacing = 20;

          p.style.width = width + "px";
          p.style.left = (baseLeft + i * (width + spacing)) + "px";
          p.style.bottom = (baseBottom + (goingUp ? i : -i) * step) + "px";

          gameContainer.appendChild(p);
          platforms.push(p);
        }
      }

      function makeCollectibleBase() {
        const c = document.createElement("div");
        c.classList.add("collectible");
        c.dataset.dead = "0";
        c.dataset.pulled = "0";
        return c;
      }

      function setCollectibleLane(c) {
        const lane = Math.floor(Math.random() * 3);
        let bottom;
        if (lane === 0) bottom = groundY + 60;
        else if (lane === 1) bottom = groundY + 110;
        else bottom = groundY + 150;
        c.style.bottom = bottom + "px";
        c.style.left = gameContainer.offsetWidth + "px";
      }

      function spawnCoin() {
        const c = makeCollectibleBase();
        c.classList.add("coin");
        c.textContent = "ü§ë";
        setCollectibleLane(c);
        gameContainer.appendChild(c);
        collectibles.push(c);
      }

      function spawnSmallMediumHeart() {
        const c = makeCollectibleBase();
        c.classList.add("energy");
        const sizes = ["small","medium"];
        const gains = [CFG_HEART_SMALL_GAIN, CFG_HEART_MEDIUM_GAIN];
        const idx = Math.floor(Math.random() * sizes.length);
        c.classList.add(sizes[idx]);
        c.dataset.energy = String(gains[idx]);
        c.textContent = "‚ù§Ô∏è";
        setCollectibleLane(c);
        gameContainer.appendChild(c);
        collectibles.push(c);
      }

      function spawnLargeHeartForced() {
        const c = makeCollectibleBase();
        c.classList.add("energy", "large");
        c.dataset.energy = String(CFG_HEART_LARGE_GAIN);
        c.textContent = "‚ù§Ô∏è";
        setCollectibleLane(c);
        gameContainer.appendChild(c);
        collectibles.push(c);
      }

      function spawnPowerup(){
        const c = makeCollectibleBase();
        const r = Math.random();

        if (r < 0.34) {
          c.classList.add("magnet");
          c.textContent = "üß≤";
        } else if (r < 0.67) {
          c.classList.add("boost");
          c.textContent = "‚ö°";
        } else {
          c.classList.add("giant");
          c.textContent = "üåÄ";
        }

        setCollectibleLane(c);
        gameContainer.appendChild(c);
        collectibles.push(c);
      }

      // =========================
      // Movement & Collision
      // =========================
      function getEffectiveSpeed() {
        let s = speed;
        if (boostActive) s *= CFG_BOOST_MULTIPLIER;
        if (hitSlowTimer > 0) s *= CFG_HIT_SLOW_FACTOR;
        return s;
      }

      function triggerHitVFX() {
        gameContainer.classList.remove("shake");
        void gameContainer.offsetWidth;
        gameContainer.classList.add("shake");

        document.body.classList.add("hit-blink");
        setTimeout(() => document.body.classList.remove("hit-blink"), 120);
      }

      function isColliding(a, b) {
        const r1 = a.getBoundingClientRect();
        const r2 = b.getBoundingClientRect();
        return !(
          r1.right < r2.left ||
          r1.left > r2.right ||
          r1.bottom < r2.top ||
          r1.top > r2.bottom
        );
      }

      function pullCollectibleToPlayer(c) {
        if (!c || c.dataset.pulled === "1" || c.dataset.dead === "1") return;
        c.dataset.pulled = "1";

        const pr = player.getBoundingClientRect();
        const cr = c.getBoundingClientRect();

        const targetX = pr.left + pr.width / 2;
        const targetY = pr.top + pr.height / 2;
        const cx = cr.left + cr.width / 2;
        const cy = cr.top + cr.height / 2;

        const dx = targetX - cx;
        const dy = targetY - cy;

        c.style.transition = "transform 0.2s linear, opacity 0.2s linear";
        c.style.transform = "translate(" + dx + "px," + dy + "px) scale(0.8)";
        c.style.opacity = "0.15";

        setTimeout(() => {
          if (!c || c.dataset.dead === "1") return;
          applyCollectibleEffect(c);
          c.dataset.dead = "1";
          c.remove();
        }, 190);
      }

      function applyCollectibleEffect(c) {
        if (!c) return;

        if (c.classList.contains("coin")) {
          coinsCollected += 1;

          addCoins(1);
          addScore(2);

          unlockAudioOnce();
          playSFX(Sounds.coin);

          scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
          updateCoinsUI();
        }
        else if (c.classList.contains("energy")) {
          const gain = parseInt(c.dataset.energy || "20", 10);
          energy = Math.min(CFG_MAX_ENERGY, energy + gain);
          updateEnergyUI();
        }
        else if (c.classList.contains("magnet")) {
          magnetActive = true;
          magnetTimer = CFG_MAGNET_DURATION;
          unlockAudioOnce();
          playSFX(Sounds.powerup);
          messageEl.textContent = "Magnet: ‡∏î‡∏π‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏£‡∏≠‡∏ö ‡πÜ ‚ú®";
        }
        else if (c.classList.contains("boost")) {
          boostActive = true;
          boostTimer = CFG_BOOST_DURATION;

          invincible = true;
          invincibleTimer = Math.max(invincibleTimer, CFG_BOOST_DURATION);

          player.classList.add("invincible");
          unlockAudioOnce();
          playSFX(Sounds.powerup);

          cheatTimerEl.textContent = "Boost: ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏≠‡∏°‡∏ï‡∏∞‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‚ö°";
          messageEl.textContent = "Boost: ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏≠‡∏°‡∏ï‡∏∞‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‚ö°";
        }
        else if (c.classList.contains("giant")) {
          giantActive = true;
          giantTimer = CFG_GIANT_DURATION;
          player.classList.add("giant");
          unlockAudioOnce();
          playSFX(Sounds.powerup);

          messageEl.textContent = "Giant: PHANToM ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà ‡∏ä‡∏ô‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡∏û‡∏∑‡πâ‡∏ô‡∏û‡∏±‡∏á‡πÑ‡∏î‡πâ üí•";
        }

        updateMissionUI();
      }

      function updateObstacles(delta) {
        const moveX = getEffectiveSpeed() * (delta / 16.67);

        obstacles = obstacles.filter(obs => {
          if (!obs || !obs.isConnected) return false;

          const left = parseFloat(obs.style.left);
          const newLeft = left - moveX;
          obs.style.left = newLeft + "px";

          if (newLeft + obs.offsetWidth < 0) {
            obs.remove();

            addScore(1);
            obstaclesPassed += 1;

            scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
            updateMissionUI();

            if (CFG_SPEED_UP_EVERY_SCORE > 0 && score % CFG_SPEED_UP_EVERY_SCORE === 0) {
              speed += CFG_SPEED_UP_AMOUNT;
            }
            return false;
          }

          if (!gameOver && isColliding(player, obs)) {
            if (invincible || giantActive) {
              addScore(2);
              obstaclesPassed += 1;

              scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
              updateMissionUI();

              obs.remove();
              return false;
            } else {
              if (hitIFramesTimer > 0) return true;

              const isAir = obs.classList.contains("air") || obs.classList.contains("ceiling");
              const dmg = isAir ? CFG_DAMAGE_AIR : CFG_DAMAGE_GROUND;

              energy -= dmg;
              unlockAudioOnce();
              playSFX(Sounds.hit);

              if (energy <= 0) {
                energy = 0;
                updateEnergyUI();
                endGame();
                return true;
              }

              updateEnergyUI();
              triggerHitVFX();
              hitSlowTimer = CFG_HIT_SLOW_DURATION;
              hitIFramesTimer = CFG_HIT_IFRAMES;

              obs.style.opacity = "0.4";
              setTimeout(() => { if (obs && obs.style) obs.style.opacity = "1"; }, 120);
            }
          }

          return true;
        });

        timeSinceLastObstacle += delta;

        const minInterval = Math.max(650, 1200 - score * 4);
        const maxInterval = Math.max(minInterval + 350, 1900 - score * 6);

        if (timeSinceLastObstacle >= nextSpawnIn) {
          let canSpawn = true;

          if (obstacles.length > 0) {
            const lastObs = obstacles[obstacles.length - 1];
            const lastRect = lastObs.getBoundingClientRect();
            const containerRect = gameContainer.getBoundingClientRect();
            const distance = containerRect.right - lastRect.right;
            if (distance < 200) canSpawn = false;
          }

          if (canSpawn) {
            spawnObstacle();
            timeSinceLastObstacle = 0;
            nextSpawnIn = randomBetween(minInterval, maxInterval);
          } else {
            timeSinceLastObstacle = minInterval - 50;
          }
        }
      }

      function updatePlatforms(delta) {
        const moveX = getEffectiveSpeed() * (delta / 16.67);

        platforms = platforms.filter(p => {
          if (!p || !p.isConnected) return false;

          const left = parseFloat(p.style.left);
          const newLeft = left - moveX;
          p.style.left = newLeft + "px";

          if (newLeft + p.offsetWidth < 0) {
            p.remove();
            return false;
          }
          return true;
        });

        timeSinceLastPlatform += delta;
        if (timeSinceLastPlatform >= nextPlatformIn) {
          if (platforms.length < 10) spawnPlatformGroup();
          timeSinceLastPlatform = 0;
          nextPlatformIn = 2200 + Math.random() * (5200 - 2200);
        }
      }

      function updateHoles(delta) {
        const moveX = getEffectiveSpeed() * (delta / 16.67);
        holes = holes.filter(h => {
          if (!h || !h.isConnected) return false;

          const left = parseFloat(h.style.left);
          const newLeft = left - moveX;
          h.style.left = newLeft + "px";

          if (newLeft + h.offsetWidth < 0) {
            h.remove();
            return false;
          }
          return true;
        });
      }

      function updateCollectibles(delta) {
        const moveX = getEffectiveSpeed() * (delta / 16.67);

        let playerCenterX = 0;
        let playerCenterY = 0;
        if (magnetActive) {
          const pr = player.getBoundingClientRect();
          playerCenterX = pr.left + pr.width / 2;
          playerCenterY = pr.top + pr.height / 2;
        }

        collectibles.forEach(c => {
          if (!c || c.dataset.dead === "1") return;
          if (c.dataset.pulled === "1") return;

          const left = parseFloat(c.style.left);
          const newLeft = left - moveX;
          c.style.left = newLeft + "px";

          if (newLeft + c.offsetWidth < 0) {
            c.dataset.dead = "1";
            c.remove();
            return;
          }

          if (
            magnetActive &&
            (c.classList.contains("coin") || c.classList.contains("energy"))
          ) {
            const cr = c.getBoundingClientRect();
            const cx = cr.left + cr.width / 2;
            const cy = cr.top + cr.height / 2;
            const dist = Math.hypot(playerCenterX - cx, playerCenterY - cy);
            if (dist < CFG_MAGNET_RADIUS) {
              pullCollectibleToPlayer(c);
              return;
            }
          }

          if (!gameOver && isColliding(player, c)) {
            applyCollectibleEffect(c);
            c.dataset.dead = "1";
            c.remove();
          }
        });

        collectibles = collectibles.filter(c => c && c.isConnected && c.dataset.dead !== "1");
      }

      function updatePlayer(delta) {
        const factor = delta / 16.67;
        prevPlayerY = playerY;

        jumpVelocity -= CFG_GRAVITY * factor;
        playerY += jumpVelocity * factor;

        let supportY = groundY;
        const isFalling = jumpVelocity <= 0;

        const playerRect = player.getBoundingClientRect();
        const playerLeftScreen = playerRect.left;
        const playerRightScreen = playerRect.right;

        const playerStyleLeft = parseFloat(getComputedStyle(player).left);
        const playerStyleRight = playerStyleLeft + player.offsetWidth;

        platforms.forEach(p => {
          if (!p || !p.isConnected) return;
          const pRect = p.getBoundingClientRect();
          const pLeft = pRect.left;
          const pRight = pRect.right;

          const platformBottom = parseFloat(p.style.bottom);
          const platformTop = platformBottom + p.offsetHeight;

          const horizontallyOver = (playerRightScreen > pLeft + 5) && (playerLeftScreen < pRight - 5);
          if (horizontallyOver && isFalling && prevPlayerY >= platformTop && playerY <= platformTop) {
            if (platformTop > supportY) supportY = platformTop;
          }
        });

        let holeUnder = false;
        holes.forEach(h => {
          if (!h || !h.isConnected) return;
          const hLeft = parseFloat(h.style.left);
          const hRight = hLeft + h.offsetWidth;
          if (hRight > playerStyleLeft + 5 && hLeft < playerStyleRight - 5) holeUnder = true;
        });

        if (playerY <= supportY) {
          if (!(supportY === groundY && holeUnder)) {
            playerY = supportY;
            jumpVelocity = 0;
            jumpsLeft = CFG_MAX_JUMPS;
          }
        }

        player.style.bottom = playerY + "px";

        if (boostBeam) {
          if (boostActive) {
            const baseLeft = parseFloat(getComputedStyle(player).left) || 80;
            boostBeam.style.opacity = 1;
            boostBeam.style.left = (baseLeft - 90) + "px";
            boostBeam.style.bottom = (playerY + 8) + "px";
          } else if (boostBeam.style.opacity !== "0") {
            boostBeam.style.opacity = 0;
          }
        }
      }

      function checkHoleTrap() {
        if (playerY < CFG_TRAP_Y) endGame();
      }

      function updateSpawners(delta){
        timeSinceLastCoin += delta;
        const coinInterval = Math.max(CFG_COIN_MIN_INTERVAL, CFG_COIN_BASE_INTERVAL - score * 1.5);
        if (timeSinceLastCoin >= coinInterval) {
          spawnCoin();
          timeSinceLastCoin = 0;
        }

        timeSinceLastHeart += delta;
        const heartInterval = Math.max(CFG_HEART_MIN_INTERVAL, CFG_HEART_BASE_INTERVAL - Math.floor(score/6)*12);
        if (timeSinceLastHeart >= heartInterval) {
          spawnSmallMediumHeart();
          timeSinceLastHeart = 0;
        }

        timeSinceLastPowerup += delta;
        const powerInterval = Math.max(CFG_POWERUP_MIN_INTERVAL, CFG_POWERUP_BASE_INTERVAL - Math.floor(score/7)*10);
        if (timeSinceLastPowerup >= powerInterval) {
          spawnPowerup();
          timeSinceLastPowerup = 0;
        }

        timeSinceLastBigHeart += delta;
        if (timeSinceLastBigHeart >= CFG_BIG_HEART_EVERY_MS) {
          spawnLargeHeartForced();
          timeSinceLastBigHeart = 0;
        }
      }

      function gameLoop(timestamp) {
        if (gameOver || isPaused) return;

        if (!lastTime) lastTime = timestamp;
        const delta = timestamp - lastTime;
        lastTime = timestamp;

        if (!invincible) {
          energy -= CFG_ENERGY_DECAY_PER_SEC * (delta / 1000);
          if (energy <= 0) {
            energy = 0;
            updateEnergyUI();
            endGame();
            return;
          }
        }
        updateEnergyUI();

        updatePlayer(delta);
        updatePlatforms(delta);
        updateHoles(delta);
        checkHoleTrap();
        if (gameOver) return;

        updateObstacles(delta);
        updateCollectibles(delta);
        updateSpawners(delta);

        if (invincible) {
          invincibleTimer -= delta;
          if (invincibleTimer <= 0) {
            invincible = false;
            player.classList.remove("invincible");
            cheatTimerEl.textContent = "";
            if (!boostActive) messageEl.textContent = postReviveActive
              ? "‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà: ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -15% / ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç -50%"
              : "‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏°‡∏ï‡∏∞‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏µ üòà";
          } else if (invincibleTimer <= 3000) {
            cheatTimerEl.textContent = "‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏°‡∏ï‡∏∞: " + Math.ceil(invincibleTimer / 1000) + " ‡∏ß‡∏¥";
          }
        }

        if (magnetActive) {
          magnetTimer -= delta;
          if (magnetTimer <= 0) magnetActive = false;
        }

        if (boostActive) {
          boostTimer -= delta;
          if (boostTimer <= 0) boostActive = false;
        }

        if (giantActive) {
          giantTimer -= delta;
          if (giantTimer <= 0) {
            giantActive = false;
            player.classList.remove("giant");
          }
        }

        if (hitSlowTimer > 0) {
          hitSlowTimer -= delta;
          if (hitSlowTimer < 0) hitSlowTimer = 0;
        }

        if (hitIFramesTimer > 0) {
          hitIFramesTimer -= delta;
          if (hitIFramesTimer < 0) hitIFramesTimer = 0;
        }

        frameId = requestAnimationFrame(gameLoop);
      }

      function endGame() {
        if (gameOver) return;
        gameOver = true;
        isRunning = false;
        isPaused = false;

        if (frameId) cancelAnimationFrame(frameId);
        frameId = null;
        lastTime = null;

        bgmPause();
        unlockAudioOnce();
        playSFX(Sounds.gameover);

        if (score > bestScore) {
          bestScore = score;
          localStorage.setItem(LS_BEST, String(bestScore));
        }
        bestScoreEl.textContent = "‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: " + bestScore;

        cheatTimerEl.textContent = "";
        messageEl.textContent =
          "Game Over! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score +
          " ‚Ä¢ ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: " + runCoins +
          " ‚Ä¢ ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°: " + walletCoins +
          ' ‚Ä¢ ‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà';

        if (boostBeam) boostBeam.style.opacity = 0;
        setStatus("OVER");

        showGameOverModal();
      }

      function reviveNow(){
        if (!gameOver) return;
        if (revivedThisRun) return;
        if (walletCoins < CFG_REVIVE_COST) return;

        unlockAudioOnce();
        playSFX(Sounds.revive);

        walletCoins -= CFG_REVIVE_COST;
        saveWallet();
        updateCoinsUI();

        revivedThisRun = true;
        postReviveActive = true;

        postScoreAcc = 0; postScoreCredited = 0;
        postCoinAcc  = 0; postCoinCredited  = 0;

        hideGameOverModal();
        clearArrays();

        energy = clamp(CFG_REVIVE_ENERGY, 1, CFG_MAX_ENERGY);
        updateEnergyUI();

        invincible = true;
        invincibleTimer = Math.max(invincibleTimer, CFG_REVIVE_INVINCIBLE_MS);
        player.classList.add("invincible");

        hitSlowTimer = 0;
        hitIFramesTimer = CFG_HIT_IFRAMES;

        playerY = groundY;
        prevPlayerY = groundY;
        jumpVelocity = 0;
        jumpsLeft = CFG_MAX_JUMPS;
        player.style.bottom = playerY + "px";

        gameOver = false;
        isRunning = true;
        isPaused = false;
        setStatus("RUN");

        messageEl.textContent = "‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡πÅ‡∏•‡πâ‡∏ß! ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -15% / ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç -50%";

        timeSinceLastObstacle = 0;
        nextSpawnIn = 650 + Math.random() * 500;

        timeSinceLastCoin = 0;
        timeSinceLastHeart = 0;
        timeSinceLastPowerup = 0;

        bgmPlay();
        lastTime = null;
        frameId = requestAnimationFrame(gameLoop);

        spawnObstacle();
      }

      function handleJump() {
        if (!isRunning && !gameOver && !countdownTimer) {
          startCountdown();
          return;
        }

        if (gameOver) {
          prepareNewRun();
          return;
        }

        if (!isRunning || isPaused) return;

        if (jumpsLeft > 0) {
          if (isDucking) setDuck(false);

          if (jumpsLeft === 1) {
            totalDoubleJumps += 1;
            updateMissionUI();
            player.classList.remove("double-jump");
            void player.offsetWidth;
            player.classList.add("double-jump");
          }

          jumpVelocity = CFG_JUMP_STRENGTH;
          jumpsLeft -= 1;

          unlockAudioOnce();
          playSFX(Sounds.jump);
        }
      }

      function setDuck(state) {
        if (!isRunning || gameOver || isPaused) return;
        if (state && !isDucking) {
          isDucking = true;
          player.classList.add("duck");
        } else if (!state && isDucking) {
          isDucking = false;
          player.classList.remove("duck");
        }
      }

      function registerCheat(code) {
        const now = performance.now();
        if (code !== "ArrowDown" && code !== "ArrowUp" && code !== "Space") return;

        const symbol = (code === "ArrowDown") ? "D" : "U";
        cheatEvents.push({ symbol, time: now });

        const cutoff = now - CFG_CHEAT_WINDOW;
        cheatEvents = cheatEvents.filter(e => e.time >= cutoff);

        const lastSix = cheatEvents.slice(-6);
        if (lastSix.length === 6) {
          const pattern = lastSix.map(e => e.symbol).join("");
          if (pattern === "DDDUUU" && isRunning && !gameOver) {
            activateCheat();
            cheatEvents = [];
          }
        }
      }

      function activateCheat() {
        invincible = true;
        invincibleTimer = Math.max(invincibleTimer, CFG_CHEAT_INVINCIBLE_DURATION);
        player.classList.add("invincible");
        cheatTimerEl.textContent = "‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏Å‡∏á: PHANToM ‡∏≠‡∏°‡∏ï‡∏∞ 10 ‡∏ß‡∏¥ üéÉ";
        messageEl.textContent = "‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏Å‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡∏ä‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏¢ 10 ‡∏ß‡∏¥";
      }

      function toggleFullscreen(){
        const elem = document.documentElement;
        if (!document.fullscreenElement){
          if (elem.requestFullscreen) elem.requestFullscreen();
          else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
          else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
        } else {
          if (document.exitFullscreen) document.exitFullscreen();
          else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
          else if (document.msExitFullscreen) document.msExitFullscreen();
        }
      }

      fullscreenBtn.addEventListener("click",(e)=>{
        e.preventDefault();
        unlockAudioOnce();
        playSFX(Sounds.click);
        toggleFullscreen();
      });

      document.addEventListener("fullscreenchange", () => {
        if (document.fullscreenElement){
          fullscreenBtn.textContent = "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠";
          document.body.classList.add("fullscreen-game");
        } else {
          fullscreenBtn.textContent = "‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠";
          document.body.classList.remove("fullscreen-game");
        }
      });

      pauseBtn.addEventListener("click", ()=>{
        if (!isRunning || gameOver) return;
        if (isPaused) resumeGame();
        else pauseGame(false);
      });
      resumeBtnOverlay.addEventListener("click", resumeGame);

      startGameBtn.addEventListener("click", startCountdown);

      restartBtn.addEventListener("click", prepareNewRun);
      restartOutsideBtn.addEventListener("click", prepareNewRun);

      reviveBtn.addEventListener("click", reviveNow);

      document.addEventListener("keydown", (e) => {
        if (e.code === "KeyP") {
          e.preventDefault();
          if (isRunning && !gameOver){
            if (isPaused) resumeGame();
            else pauseGame(false);
          }
          return;
        }

        if (e.code === "Space" || e.code === "ArrowUp") {
          e.preventDefault();
          handleJump();
          registerCheat(e.code);
        } else if (e.code === "ArrowDown") {
          e.preventDefault();
          setDuck(true);
          registerCheat(e.code);
        }
      });

      document.addEventListener("keyup", (e) => {
        if (e.code === "ArrowDown") setDuck(false);
      });

      btnJump.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        handleJump();
        registerCheat("Space");
      });

      btnDuck.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        setDuck(true);
        registerCheat("ArrowDown");
      });
      btnDuck.addEventListener("pointerup", (e) => { e.preventDefault(); setDuck(false); });
      btnDuck.addEventListener("pointercancel",(e)=> { e.preventDefault(); setDuck(false); });
      btnDuck.addEventListener("pointerleave", () => { if (isDucking) setDuck(false); });

      // =========================
      // Sound modal + quick toggle
      // =========================
      function openSound(){
        unlockAudioOnce();
        playSFX(Sounds.click);
        if (isRunning && !gameOver && !isPaused) pauseGame(true);
        soundModal.classList.add("show");
        applyAudioSettings();
      }
      function closeSound(){
        unlockAudioOnce();
        playSFX(Sounds.click);
        soundModal.classList.remove("show");
      }

      soundBtn.addEventListener("click", openSound);
      soundCloseBtn.addEventListener("click", closeSound);
      soundModal.addEventListener("click", (e)=>{
        if (e.target === soundModal) closeSound();
      });

      audioQuickBtn.addEventListener("click", ()=>{
        unlockAudioOnce();
        audioEnabled = !audioEnabled;
        saveBool(LS_AUDIO_MASTER, audioEnabled);
        applyAudioSettings();
        playSFX(Sounds.click);
      });

      audioMasterToggle.addEventListener("change", ()=>{
        unlockAudioOnce();
        audioEnabled = !!audioMasterToggle.checked;
        saveBool(LS_AUDIO_MASTER, audioEnabled);
        applyAudioSettings();
        playSFX(Sounds.click);
      });

      bgmToggle.addEventListener("change", ()=>{
        unlockAudioOnce();
        bgmEnabled = !!bgmToggle.checked;
        saveBool(LS_AUDIO_BGM_ON, bgmEnabled);
        applyAudioSettings();
        playSFX(Sounds.click);
      });

      sfxToggle.addEventListener("change", ()=>{
        unlockAudioOnce();
        sfxEnabled = !!sfxToggle.checked;
        saveBool(LS_AUDIO_SFX_ON, sfxEnabled);
        applyAudioSettings();
        playSFX(Sounds.click);
      });

      bgmVolRange.addEventListener("input", ()=>{
        bgmVolume = clamp(parseInt(bgmVolRange.value,10)/100, 0, 1);
        saveNum(LS_AUDIO_BGM_VOL, bgmVolume);
        applyAudioSettings();
      });
      sfxVolRange.addEventListener("input", ()=>{
        sfxVolume = clamp(parseInt(sfxVolRange.value,10)/100, 0, 1);
        saveNum(LS_AUDIO_SFX_VOL, sfxVolume);
        applyAudioSettings();
      });

      audioTestBtn.addEventListener("click", ()=>{
        unlockAudioOnce();
        playSFX(Sounds.click);
        setTimeout(()=> playSFX(Sounds.jump), 90);
        setTimeout(()=> playSFX(Sounds.coin), 180);
      });

      // =========================
      // Init
      // =========================
      bestScoreEl.textContent = "‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: " + bestScore;
      updateCoinsUI();
      updateEnergyUI();
      updateMissionUI();

      applyAudioSettings();
      prepareNewRun();
    })();
  </script>
</body>
</html>
