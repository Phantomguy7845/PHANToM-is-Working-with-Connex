<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PHANToM Runner</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#020617;
      --bg1:#0b1022;
      --bg2:#030712;
      --card:rgba(15,23,42,.86);
      --glass:rgba(2,6,23,.68);
      --border:rgba(148,163,184,.35);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#22d3ee;
      --accent2:#a855f7;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow:0 20px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Prompt",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 30%, rgba(34,211,238,.15), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(168,85,247,.12), transparent 50%),
        linear-gradient(180deg,var(--bg1),var(--bg0));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .wrap{
      width:min(980px, 100%);
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }

    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid rgba(148,163,184,.22);
      background:linear-gradient(90deg, rgba(34,211,238,.08), rgba(168,85,247,.06));
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      font-weight:800; letter-spacing:.4px;
    }
    .brand .logo{
      width:34px;height:34px;border-radius:12px;
      background:
        radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.4), transparent 60%),
        linear-gradient(135deg, rgba(34,211,238,.8), rgba(168,85,247,.65));
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 10px 30px rgba(34,211,238,.18);
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.28);
      background:rgba(2,6,23,.55);
      color:var(--text);
      font-weight:600;
      font-size:13px;
      white-space:nowrap;
    }
    .btnrow{display:flex; gap:8px; flex-wrap:wrap;}
    button{
      appearance:none;
      border:1px solid rgba(148,163,184,.28);
      background:rgba(2,6,23,.55);
      color:var(--text);
      border-radius:12px;
      padding:9px 12px;
      font-weight:700;
      cursor:pointer;
      transition:.15s ease;
      user-select:none;
    }
    button:hover{transform:translateY(-1px); border-color:rgba(34,211,238,.45)}
    button:active{transform:translateY(0px)}
    button.primary{
      background:linear-gradient(135deg, rgba(34,211,238,.9), rgba(168,85,247,.8));
      border-color:rgba(255,255,255,.2);
    }
    button.danger{background:rgba(251,113,133,.12); border-color:rgba(251,113,133,.35)}
    button.good{background:rgba(52,211,153,.12); border-color:rgba(52,211,153,.35)}
    button:disabled{opacity:.45; cursor:not-allowed; transform:none !important}

    /* GAME */
    #gamePanel{padding:0}
    #gameContainer{
      position:relative;
      width:100%;
      height:420px;
      overflow:hidden;
      background:
        radial-gradient(900px 520px at 30% 20%, rgba(34,211,238,.12), transparent 60%),
        radial-gradient(700px 520px at 85% 25%, rgba(168,85,247,.10), transparent 58%),
        linear-gradient(180deg, rgba(2,6,23,1), rgba(3,7,18,1));
    }
    #bgLayer{
      position:absolute; inset:-30px -30px -30px -30px;
      opacity:.9;
      filter: blur(0px);
      pointer-events:none;
      background:
        radial-gradient(600px 320px at 10% 30%, rgba(34,211,238,.18), transparent 60%),
        radial-gradient(520px 360px at 85% 25%, rgba(168,85,247,.14), transparent 60%),
        radial-gradient(540px 260px at 60% 75%, rgba(251,191,36,.06), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,1), rgba(2,6,23,.6));
      transform: translate3d(0,0,0);
    }

    /* In-game top bar layout */
    #inGameTopBar{
      position:absolute;
      top:10px;
      left:10px;
      right:10px;
      display:grid;
      grid-template-columns: 1.2fr 1fr 1.1fr;
      gap:10px;
      align-items:start;
      z-index:50;
      pointer-events:none;
    }
    #igLeft, #igMid, #igRight{pointer-events:none}
    #igLeft{
      display:flex; flex-direction:column; gap:8px; align-items:flex-start;
    }
    #igMid{
      display:flex; justify-content:center; align-items:flex-start;
    }
    #igRight{
      display:flex; flex-direction:column; gap:8px; align-items:flex-end;
    }
    #igBtnRow{
      display:flex; gap:8px;
      pointer-events:auto;
    }

    /* Energy UI (moved into game screen) */
    #energyContainer{
      width:220px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.28);
      background:rgba(2,6,23,.55);
      box-shadow:0 12px 40px rgba(0,0,0,.25);
      pointer-events:auto;
    }
    #energyTop{
      display:flex; align-items:center; justify-content:space-between;
      font-weight:800; font-size:13px;
      color:rgba(229,231,235,.92);
      margin-bottom:6px;
    }
    #energyBarWrap{
      height:10px; border-radius:999px;
      background:rgba(148,163,184,.20);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.06);
    }
    #energyBar{
      height:100%;
      width:100%;
      background:linear-gradient(90deg, rgba(52,211,153,.9), rgba(34,211,238,.9));
      border-radius:999px;
      transform-origin:left center;
    }
    #energyText{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }

    /* Coins box (center top, same line level as pause) */
    #coinsBox{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.28);
      background:rgba(2,6,23,.55);
      pointer-events:auto;
      box-shadow:0 12px 40px rgba(0,0,0,.25);
      font-weight:800;
      font-size:14px;
      white-space:nowrap;
    }
    #coinsBox small{
      font-weight:800;
      color:rgba(229,231,235,.78);
      opacity:.9;
    }

    /* Score (right top under pause) */
    #scoreWrap{
      width:240px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.28);
      background:rgba(2,6,23,.55);
      box-shadow:0 12px 40px rgba(0,0,0,.25);
      pointer-events:auto;
      text-align:right;
    }
    #score{
      font-weight:900;
      font-size:16px;
      letter-spacing:.2px;
    }
    #bestScore{
      margin-top:6px;
      font-weight:800;
      font-size:12px;
      color:rgba(229,231,235,.72);
    }

    /* quick buttons */
    #audioQuickBtn, #pauseBtn{
      width:46px; height:46px;
      border-radius:14px;
      padding:0;
      display:grid; place-items:center;
    }

    /* Player / ground */
    #ground{
      position:absolute;
      left:0; right:0;
      bottom:28px;
      height:6px;
      background:linear-gradient(90deg, rgba(34,211,238,.55), rgba(168,85,247,.50));
      filter:blur(.2px);
      opacity:.9;
      box-shadow: 0 10px 30px rgba(34,211,238,.12);
    }
    #player{
      position:absolute;
      left:70px;
      bottom:28px;
      width:52px;
      height:68px;
      border-radius:18px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.25), transparent 55%),
        linear-gradient(135deg, rgba(34,211,238,.95), rgba(168,85,247,.8));
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 18px 50px rgba(34,211,238,.16);
      transform:translate3d(0,0,0);
    }
    #player::after{
      content:"";
      position:absolute;
      inset:10px 12px 12px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.22);
      opacity:.7;
    }
    .ducking{
      transform:translate3d(0,10px,0) scaleY(.55);
      border-radius:16px;
    }
    .invincible{
      box-shadow:0 0 0 3px rgba(251,191,36,.25), 0 18px 60px rgba(251,191,36,.20);
      filter:saturate(1.15);
    }
    .boosting{
      box-shadow:0 0 0 3px rgba(34,211,238,.25), 0 18px 60px rgba(34,211,238,.20);
    }
    .giant{
      transform: translate3d(0,-8px,0) scale(1.35);
      border-radius:22px;
      box-shadow:0 0 0 3px rgba(168,85,247,.25), 0 18px 60px rgba(168,85,247,.22);
    }

    /* Obstacles */
    .obstacle{
      position:absolute;
      bottom:28px;
      width:34px;
      height:52px;
      border-radius:14px;
      background:rgba(148,163,184,.18);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 60px rgba(0,0,0,.28);
    }
    .obstacle.floor{
      background:
        radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(148,163,184,.22), rgba(148,163,184,.10));
    }
    .obstacle.ceiling{
      background:
        radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(148,163,184,.10), rgba(148,163,184,.22));
      border-radius:14px 14px 18px 18px;
    }
    .obstacle.ceiling::before{
      content:"";
      position:absolute;
      left:50%;
      top:-240px;
      transform:translateX(-50%);
      width:2px;
      height:240px;
      background:linear-gradient(180deg, rgba(148,163,184,.0), rgba(148,163,184,.35));
      opacity:.65;
    }
    .hole{
      position:absolute;
      bottom:28px;
      width:78px;
      height:12px;
      border-radius:999px;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(148,163,184,.18);
      box-shadow: inset 0 6px 20px rgba(0,0,0,.65);
      filter: blur(.15px);
    }

    /* Platforms */
    .platform{
      position:absolute;
      height:10px;
      border-radius:999px;
      background:rgba(34,211,238,.14);
      border:1px solid rgba(34,211,238,.32);
      box-shadow:0 18px 60px rgba(34,211,238,.10);
    }

    /* Collectibles */
    .collectible{
      position:absolute;
      width:26px; height:26px;
      border-radius:14px;
      display:grid;
      place-items:center;
      font-size:16px;
      user-select:none;
      pointer-events:none;
      transform:translate3d(0,0,0);
    }
    .collectible.coin{
      background:rgba(251,191,36,.14);
      border:1px solid rgba(251,191,36,.35);
      box-shadow:0 10px 30px rgba(251,191,36,.12);
    }
    .collectible.energy{
      background:rgba(52,211,153,.12);
      border:1px solid rgba(52,211,153,.32);
      box-shadow:0 10px 30px rgba(52,211,153,.10);
    }
    .collectible.energy.small{transform:scale(.95)}
    .collectible.energy.medium{transform:scale(1.08)}
    /* BIG HEART: gold glow + 2x size */
    .collectible.energy.large{
      width:52px; height:52px;
      font-size:30px;
      border-radius:20px;
      background:rgba(251,191,36,.14);
      border:1px solid rgba(251,191,36,.55);
      box-shadow:0 0 0 3px rgba(251,191,36,.12), 0 22px 80px rgba(251,191,36,.25);
      filter:saturate(1.1);
    }

    /* Jelly: smaller 25%, score > coin 2x, trail up-down, magnet can pull */
    .collectible.jelly{
      width:19px; height:19px;
      font-size:13px;
      border-radius:12px;
      background:rgba(168,85,247,.12);
      border:1px solid rgba(168,85,247,.32);
      box-shadow:0 10px 30px rgba(168,85,247,.10);
    }

    .collectible.magnet{
      background:rgba(34,211,238,.12);
      border:1px solid rgba(34,211,238,.35);
      box-shadow:0 10px 30px rgba(34,211,238,.12);
    }
    .collectible.boost{
      background:rgba(34,211,238,.12);
      border:1px solid rgba(34,211,238,.35);
      box-shadow:0 10px 30px rgba(34,211,238,.12);
    }
    .collectible.giant{
      background:rgba(168,85,247,.12);
      border:1px solid rgba(168,85,247,.35);
      box-shadow:0 10px 30px rgba(168,85,247,.12);
    }

    /* overlays */
    .overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(2,6,23,.62);
      backdrop-filter: blur(6px);
      z-index:90;
    }
    .overlay .card{
      width:min(620px, calc(100% - 26px));
      background:rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.35);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:16px 16px 14px;
    }
    .overlay h2{
      margin:0 0 6px;
      font-size:20px;
      letter-spacing:.3px;
    }
    .overlay p{
      margin:8px 0;
      color:rgba(229,231,235,.8);
      font-weight:600;
      line-height:1.45;
      font-size:14px;
    }
    .overlay .hint{
      color:rgba(229,231,235,.68);
      font-size:13px;
      font-weight:700;
    }
    .overlay .split{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin-top:10px;
    }
    .overlay .count{
      font-size:56px;
      font-weight:900;
      letter-spacing:1px;
      text-align:center;
      margin:10px 0 6px;
    }
    .hidden{display:none !important}

    /* touch controls */
    #touchControls{
      position:absolute;
      left:10px; right:10px;
      bottom:10px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      z-index:60;
      pointer-events:auto;
    }
    .touchBtn{
      flex:1;
      border-radius:18px;
      padding:12px 12px;
      background:rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.28);
      font-weight:900;
      font-size:14px;
    }

    /* below game info (still useful) */
    .info{
      padding:12px 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .info .note{
      color:rgba(229,231,235,.72);
      font-weight:700;
      font-size:13px;
    }

    /* Modals */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(2,6,23,.65);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:200;
    }
    .modal .modalCard{
      width:min(720px, 100%);
      background:rgba(15,23,42,.95);
      border:1px solid rgba(148,163,184,.35);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 14px;
      border-bottom:1px solid rgba(148,163,184,.22);
      background:linear-gradient(90deg, rgba(34,211,238,.08), rgba(168,85,247,.06));
    }
    .modalBody{padding:14px 14px 16px}
    .sectionTitle{
      margin:8px 0 10px;
      font-weight:900;
      font-size:14px;
      color:rgba(229,231,235,.9);
      letter-spacing:.2px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width:820px){
      #gameContainer{height:440px}
      #inGameTopBar{grid-template-columns:1fr; gap:8px}
      #igRight{align-items:flex-start}
      #scoreWrap{width:100%; text-align:left}
      #energyContainer{width:100%}
      #igBtnRow{align-self:flex-end}
      .grid{grid-template-columns:1fr}
    }
    .item{
      background:rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.28);
      border-radius:18px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:126px;
    }
    .item .name{font-weight:900}
    .item .desc{color:rgba(229,231,235,.72); font-weight:700; font-size:12px; line-height:1.35}
    .item .meta{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:auto}
    .item .price{font-weight:900; color:rgba(251,191,36,.95)}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      border:1px solid rgba(148,163,184,.28);
      background:rgba(15,23,42,.45);
      font-weight:900;
      font-size:12px;
      color:rgba(229,231,235,.85);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel" id="gamePanel">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>PHANToM RUNNER</div>
        </div>
        <div class="btnrow">
          <button id="fullscreenBtn">‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠</button>
          <button id="soundBtn">‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
          <button id="shopBtn">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
          <button id="restartBtn" class="danger">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
        </div>
      </div>

      <div id="gameContainer">
        <div id="bgLayer"></div>

        <!-- In-game HUD -->
        <div id="inGameTopBar">
          <div id="igLeft">
            <div class="pill" id="statusPill">‚è∏ <span id="statusKey">P</span> <span id="statusText">READY</span></div>

            <div id="energyContainer">
              <div id="energyTop">
                <span>Energy</span>
                <span id="energyNowMini">100</span>
              </div>
              <div id="energyBarWrap"><div id="energyBar"></div></div>
              <div id="energyText">100 / 100</div>
            </div>
          </div>

          <div id="igMid">
            <div id="coinsBox">
              <span>‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ <span id="runCoins">0</span></span>
              <span style="opacity:.35">‚Ä¢</span>
              <small>‡∏™‡∏∞‡∏™‡∏° <span id="walletCoins">0</span></small>
            </div>
          </div>

          <div id="igRight">
            <div id="igBtnRow">
              <button id="audioQuickBtn" title="‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß">/</button>
              <button id="pauseBtn" title="Pause">‚è∏</button>
            </div>
            <div id="scoreWrap">
              <div id="score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</div>
              <div id="bestScore">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: 0</div>
            </div>
          </div>
        </div>

        <div id="ground"></div>
        <div id="player" aria-label="PHANToM"></div>

        <div id="touchControls">
          <button class="touchBtn" id="jumpBtn">‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î</button>
          <button class="touchBtn" id="duckBtn">‡∏´‡∏°‡∏≠‡∏ö</button>
        </div>

        <!-- Start Overlay -->
        <div class="overlay" id="startOverlay">
          <div class="card">
            <h2>PHANToM RUNNER</h2>
            <p class="hint" id="startPassiveHint"></p>
            <div class="split">
              <div>
                <p class="hint">‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‚Äù ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Å‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</p>
                <p class="hint">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ ‡∏Å‡∏î Space ‡∏Å‡πá‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ</p>
              </div>
              <div class="btnrow">
                <button id="startGameBtn" class="primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
              </div>
            </div>

            <p class="hint" style="margin-top:10px">
              ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°:
              <br>‚Ä¢ ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç (Coin) : +‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô / ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤
              <br>‚Ä¢ ‚ù§Ô∏è ‡∏´‡∏±‡∏ß‡πÉ‡∏à (Energy) : ‡πÄ‡∏û‡∏¥‡πà‡∏° Energy (‡πÄ‡∏•‡πá‡∏Å +10 / ‡∏Å‡∏•‡∏≤‡∏á +20 / ‡πÉ‡∏´‡∏ç‡πà +45 ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß)
              <br>‚Ä¢ ‡πÄ‡∏à‡∏•‡∏•‡∏µ‡πà (Jelly) : ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏Å‡∏¥‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 2 ‡πÄ‡∏ó‡πà‡∏≤ ‡πÅ‡∏•‡∏∞‡∏î‡∏£‡∏≠‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏ï‡πà‡∏Ç‡∏∂‡πâ‡∏ô-‡∏•‡∏á (‡∏î‡∏π‡∏î‡∏î‡πâ‡∏ß‡∏¢ Magnet ‡πÑ‡∏î‡πâ)
              <br>‚Ä¢ Magnet : ‡∏î‡∏π‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç/‡∏´‡∏±‡∏ß‡πÉ‡∏à/‡πÄ‡∏à‡∏•‡∏•‡∏µ‡πà ‡∏£‡∏≠‡∏ö ‡πÜ ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
              <br>‚Ä¢ ‚ö° Boost : ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏≠‡∏°‡∏ï‡∏∞‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡∏î‡∏£‡∏≠‡∏õ‡∏´‡πà‡∏≤‡∏á 22.5‚Äì37.5 ‡∏ß‡∏¥)
              <br>‚Ä¢ Giant : ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏£‡πà‡∏≤‡∏á ‡∏ä‡∏ô‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡∏û‡∏∑‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏á‡πÑ‡∏î‡πâ (‡∏î‡∏£‡∏≠‡∏õ‡∏´‡πà‡∏≤‡∏á 22.5‚Äì37.5 ‡∏ß‡∏¥)
              <br><span style="opacity:.85">Space / ‚Üë = ‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î (2 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞) ‚Ä¢ ‚Üì = ‡∏´‡∏°‡∏≠‡∏ö ‚Ä¢ ‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏•‡∏≠‡∏¢/‡∏ö‡∏±‡∏ô‡πÑ‡∏î ‚Ä¢ ‡∏´‡∏•‡∏∏‡∏°‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å (‡∏ï‡∏Å‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ) ‚Ä¢ ‡∏Å‡∏î P = Pause/Resume (Resume ‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥) ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏£‡∏≠‡∏ö (‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -15% ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç -50% ‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)</span>
            </p>
          </div>
        </div>

        <!-- Pause Overlay -->
        <div class="overlay hidden" id="pauseOverlay">
          <div class="card">
            <h2>PAUSED</h2>
            <p class="hint">‡∏Å‡∏î P ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Resume (‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥)</p>
            <div class="btnrow" style="margin-top:10px">
              <button id="resumeBtn" class="primary">Resume</button>
            </div>
          </div>
        </div>

        <!-- Countdown Overlay -->
        <div class="overlay hidden" id="countdownOverlay">
          <div class="card" style="text-align:center">
            <h2 id="countdownTitle">READY</h2>
            <div class="count" id="countdownText">3</div>
            <p class="hint" id="countdownHint"></p>
          </div>
        </div>
      </div>

      <div class="info">
        <div class="note">Tip: ‡∏õ‡∏∏‡πà‡∏° ‚Äú/‚Äù ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡πÉ‡∏ô‡πÄ‡∏Å‡∏° = ‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß</div>
        <div class="pill">Space / ‚Üë = JUMP ‚Ä¢ ‚Üì = DUCK ‚Ä¢ P = Pause</div>
      </div>
    </div>
  </div>

  <!-- GAME OVER MODAL -->
  <div class="modal hidden" id="gameOverModal">
    <div class="modalCard">
      <div class="modalHead">
        <div style="font-weight:900">Game Over</div>
        <div class="pill" id="gameOverSummaryPill">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0 ‚Ä¢ ‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ 0</div>
      </div>
      <div class="modalBody">
        <div class="btnrow" style="margin-bottom:10px">
          <button id="freeReviveBtn" class="good hidden">‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏ü‡∏£‡∏µ (Passive)</button>
          <button id="reviveBtn" class="primary">‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏î‡πâ‡∏ß‡∏¢ 50 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</button>
          <button id="newGameBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</button>
        </div>
        <div class="hint" style="color:rgba(229,231,235,.72); font-weight:800">
          ‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
        </div>
      </div>
    </div>
  </div>

  <!-- SHOP MODAL -->
  <div class="modal hidden" id="shopModal">
    <div class="modalCard">
      <div class="modalHead">
        <div style="font-weight:900">SHOP</div>
        <div class="btnrow">
          <div class="pill">‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°: <span id="shopCoins">0</span></div>
          <button id="closeShopBtn">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
      <div class="modalBody" id="shopBody">
        <!-- injected -->
      </div>
    </div>
  </div>

  <!-- SOUND MODAL -->
  <div class="modal hidden" id="soundModal">
    <div class="modalCard">
      <div class="modalHead">
        <div style="font-weight:900">SOUND</div>
        <button id="closeSoundBtn">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="modalBody">
        <div class="sectionTitle">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å BGM / SFX ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä (localStorage)</div>

        <div style="display:grid; gap:12px">
          <div class="item">
            <div class="name">### Master</div>
            <div class="desc">‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="meta">
              <span class="tag"><input id="masterToggle" type="checkbox" /> ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
              <button id="testSoundBtn">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
            </div>
            <div class="desc">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ö‡∏≤‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ï‡πâ‡∏≠‡∏á ‚Äú‡πÅ‡∏ï‡∏∞/‡∏Ñ‡∏•‡∏¥‡∏Å‚Äù ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ</div>
          </div>

          <div class="item">
            <div class="name">### BGM</div>
            <div class="desc">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏•‡∏á ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á</div>
            <div class="meta">
              <span class="tag"><input id="bgmToggle" type="checkbox" /> ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á BGM</span>
              <span class="tag"><span id="bgmVolLabel">65%</span></span>
            </div>
            <input id="bgmVol" type="range" min="0" max="1" step="0.01" />
          </div>

          <div class="item">
            <div class="name">### SFX</div>
            <div class="desc">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á</div>
            <div class="meta">
              <span class="tag"><input id="sfxToggle" type="checkbox" /> ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á SFX</span>
              <span class="tag"><span id="sfxVolLabel">80%</span></span>
            </div>
            <input id="sfxVol" type="range" min="0" max="1" step="0.01" />
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  CONFIG (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
 *  ========================= */
const CFG = {
  // Core
  GRAVITY: 1800,
  JUMP_V: 740,
  DOUBLE_JUMP_V: 660,
  MAX_JUMPS: 2,

  // Speed
  BASE_SPEED: 260,
  MAX_SPEED: 780,
  SPEED_UP_PER_SCORE: 0.015,         // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡∏î ‡πÜ ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
  SPEED_UP_ON_BIG_HEART: 22,         // ‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß

  // Energy
  MAX_ENERGY: 100,                   // (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å override ‡πÄ‡∏õ‡πá‡∏ô 150 ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°)
  ENERGY_DECAY_PER_SEC: 7.2,
  ENERGY_DAMAGE_HIT: 18,
  REVIVE_ENERGY: 55,

  // Heart gain (‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏Å‡πâ‡πÄ‡∏≠‡∏á‚Äî‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
  HEART_SMALL_GAIN: 10,
  HEART_MEDIUM_GAIN: 20,
  HEART_LARGE_GAIN: 45,

  // Spawns
  COIN_BASE_INTERVAL: 520,
  COIN_MIN_INTERVAL: 250,

  HEART_BASE_INTERVAL: 1400,
  HEART_MIN_INTERVAL: 720,

  BIG_HEART_EVERY_MS: 16000,          // (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏Å‡πâ‡πÄ‡∏≠‡∏á‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
  QUIET_BEFORE_BIG_HEART_MS: 2800,    // ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÉ‡∏´‡∏ç‡πà 2‚Äì3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏´‡πâ‡πÇ‡∏•‡πà‡∏á ‡πÜ

  // Magnet spawn (‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏∏‡∏ì: ‚Äú‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á magnet ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‚Äù -> ‡πÅ‡∏Å‡πâ 2 ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ)
  MAGNET_BASE_INTERVAL: 16000,
  MAGNET_MIN_INTERVAL: 9000,

  // Boost/Giant (‡∏î‡∏£‡∏≠‡∏õ‡∏´‡πà‡∏≤‡∏á 15‚Äì25 ‡∏ß‡∏¥ ‡πÅ‡∏•‡∏∞ ‚Äú‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á 1.5 ‡πÄ‡∏ó‡πà‡∏≤‚Äù => 22.5‚Äì37.5 ‡∏ß‡∏¥)
  BG_DROP_MIN_MS: 22500,
  BG_DROP_MAX_MS: 37500,

  // Duration (‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏Å‡πâ‡πÄ‡∏≠‡∏á‚Äî‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö logic)
  BOOST_DURATION_MS: 4250,
  GIANT_DURATION_MS: 5100,
  MAGNET_DURATION_MS: 5200,

  // Multipliers
  BOOST_MULT: 1.55,
  GIANT_MULT: 1.35,

  // Revive penalties
  POST_REVIVE_SCORE_MULT: 0.85,
  POST_REVIVE_COIN_MULT: 0.5,

  // Collectible score
  SCORE_PER_COIN: 2,
  SCORE_PER_JELLY: 4,

  // Magnet
  MAGNET_RADIUS: 380,
  MAGNET_PULL: 1150,

  // Obstacle waves
  OB_MIN_BASE: 1150,
  OB_MAX_BASE: 2300,
  OB_MIN_FLOOR: 780,
  OB_WAVE_CHANCE: 0.30,
  OB_WAVE_EXTRA_MIN: 260,
  OB_WAVE_EXTRA_MAX: 520,
  OB_REST_CHANCE: 0.28,
  OB_REST_MIN: 1400,
  OB_REST_MAX: 2500,

  // Revive cost
  REVIVE_COST: 50,

  // Shop items
  ITEM_START_ENERGY_PRICE: 90,
  ITEM_START_BOOST_PRICE: 120,
  PASSIVE_BOX_BASE_PRICE: 220,
  PASSIVE_DUP_DISCOUNT: 0.15,
  START_BOOST_MS: 5000,
};

/** =========================
 *  LOCAL STORAGE KEYS
 *  ========================= */
const LS = {
  WALLET: "phantom_runner_wallet",
  BEST: "phantom_runner_best",
  SOUND: "phantom_runner_sound",
  THEME_BG: "phantom_runner_theme_bg",
  THEME_OBS: "phantom_runner_theme_obs",

  INV: "phantom_runner_inv_consumables",
  PASSIVE: "phantom_runner_passive_active",
  PASSIVE_NEXT_DISC: "phantom_runner_passive_next_discount",
};

/** =========================
 *  HELPERS
 *  ========================= */
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
const rand = (a,b) => a + Math.random() * (b-a);
const randi = (a,b) => Math.floor(rand(a,b+1));
const fmtCoins = (n) => {
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏ä‡πà‡∏ô 12.5)
  const isInt = Math.abs(n - Math.round(n)) < 1e-9;
  return isInt ? String(Math.round(n)) : (Math.round(n*10)/10).toFixed(1);
};
const now = () => performance.now();

/** =========================
 *  ELEMENTS
 *  ========================= */
const gameContainer = document.getElementById("gameContainer");
const playerEl = document.getElementById("player");
const groundEl = document.getElementById("ground");
const bgLayer = document.getElementById("bgLayer");

const statusTextEl = document.getElementById("statusText");
const scoreEl = document.getElementById("score");
const bestScoreEl = document.getElementById("bestScore");
const walletCoinsEl = document.getElementById("walletCoins");
const runCoinsEl = document.getElementById("runCoins");

const energyBarEl = document.getElementById("energyBar");
const energyTextEl = document.getElementById("energyText");
const energyNowMiniEl = document.getElementById("energyNowMini");

const startOverlay = document.getElementById("startOverlay");
const startGameBtn = document.getElementById("startGameBtn");
const startPassiveHint = document.getElementById("startPassiveHint");

const pauseOverlay = document.getElementById("pauseOverlay");
const resumeBtn = document.getElementById("resumeBtn");

const countdownOverlay = document.getElementById("countdownOverlay");
const countdownTitleEl = document.getElementById("countdownTitle");
const countdownTextEl = document.getElementById("countdownText");
const countdownHintEl = document.getElementById("countdownHint");

const gameOverModal = document.getElementById("gameOverModal");
const gameOverSummaryPill = document.getElementById("gameOverSummaryPill");
const reviveBtn = document.getElementById("reviveBtn");
const freeReviveBtn = document.getElementById("freeReviveBtn");
const newGameBtn = document.getElementById("newGameBtn");

const pauseBtn = document.getElementById("pauseBtn");
const audioQuickBtn = document.getElementById("audioQuickBtn");

const jumpBtn = document.getElementById("jumpBtn");
const duckBtn = document.getElementById("duckBtn");

const fullscreenBtn = document.getElementById("fullscreenBtn");
const shopBtn = document.getElementById("shopBtn");
const restartBtn = document.getElementById("restartBtn");
const soundBtn = document.getElementById("soundBtn");

const shopModal = document.getElementById("shopModal");
const closeShopBtn = document.getElementById("closeShopBtn");
const shopCoinsEl = document.getElementById("shopCoins");
const shopBody = document.getElementById("shopBody");

const soundModal = document.getElementById("soundModal");
const closeSoundBtn = document.getElementById("closeSoundBtn");
const masterToggle = document.getElementById("masterToggle");
const bgmToggle = document.getElementById("bgmToggle");
const sfxToggle = document.getElementById("sfxToggle");
const bgmVol = document.getElementById("bgmVol");
const sfxVol = document.getElementById("sfxVol");
const bgmVolLabel = document.getElementById("bgmVolLabel");
const sfxVolLabel = document.getElementById("sfxVolLabel");
const testSoundBtn = document.getElementById("testSoundBtn");

/** =========================
 *  STATE
 *  ========================= */
let bestScore = Number(localStorage.getItem(LS.BEST) || 0);
let walletCoins = Number(localStorage.getItem(LS.WALLET) || 0);

let score = 0;
let runCoins = 0;

let groundY = 28;             // bottom offset matches #ground bottom
let playerY = groundY;
let vy = 0;
let jumpsUsed = 0;

let isPaused = false;
let isGameOver = false;
let frameId = 0;
let lastT = null;

let speed = CFG.BASE_SPEED;

let obstacles = [];
let holes = [];
let platforms = [];
let collectibles = [];

let timeCoin = 0;
let timeHeart = 0;
let timeBigHeart = 0;

let timeMagnet = 0;
let timeBG = 0;
let nextBGIn = rand(CFG.BG_DROP_MIN_MS, CFG.BG_DROP_MAX_MS);

let timeJelly = 0;
let nextJellyIn = rand(950, 1550);

let timeObstacle = 0;
let nextObstacleIn = rand(CFG.OB_MIN_BASE, CFG.OB_MAX_BASE);
let waveRemaining = 0;

let energy = CFG.MAX_ENERGY;
let maxEnergyThisRun = CFG.MAX_ENERGY;

let magnetActive = false;
let magnetTimer = 0;

let boostActive = false;
let boostTimer = 0;

let giantActive = false;
let giantTimer = 0;

let invincible = false;
let invTimer = 0;

let ducking = false;

let postReviveActive = false;
let coinRevivedThisRun = false;
let freeRevivedThisRun = false;

let countdownTimer = null;

// run modifiers from passive
let runMod = {
  coinMult: 1,
  energyUseMult: 1,
  holeGuard: false,
  freeRevive: false,
};

// Consumables active this run (consumed at run start)
let runConsumable = {
  startEnergyUsed: false,
  startBoostUsed: false,
};

/** =========================
 *  SHOP DATA
 *  ========================= */
const THEMES_BG = [
  {id:"aurora", name:"Aurora", price:0, desc:"‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏ó‡∏ô‡∏ü‡πâ‡∏≤-‡∏°‡πà‡∏ß‡∏á (default)"},
  {id:"gold", name:"Gold Dust", price:180, desc:"‡πÅ‡∏™‡∏á‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ö‡∏ß‡∏±‡∏ö"},
  {id:"neon", name:"Neon Grid", price:220, desc:"‡∏ô‡∏µ‡∏≠‡∏≠‡∏ô‡∏ï‡∏±‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏£‡∏¥‡∏î"},
];
const THEMES_OBS = [
  {id:"glass", name:"Glass", price:0, desc:"‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡πÉ‡∏™‡πÜ"},
  {id:"stone", name:"Stone", price:140, desc:"‡πÇ‡∏ó‡∏ô‡∏´‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°"},
  {id:"shadow", name:"Shadow", price:170, desc:"‡πÄ‡∏á‡∏≤‡∏î‡∏≥‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢"},
];

const CONSUMABLES = [
  {
    id:"start_energy_150",
    name:"Energy ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 150",
    price: CFG.ITEM_START_ENERGY_PRICE,
    desc:"‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 1 ‡πÄ‡∏Å‡∏°/‡∏ä‡∏¥‡πâ‡∏ô (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥). ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏∞‡∏™‡∏° ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Å‡∏°‡∏à‡∏ô‡∏´‡∏°‡∏î",
  },
  {
    id:"start_boost_5s",
    name:"Boost ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ 5 ‡∏ß‡∏¥",
    price: CFG.ITEM_START_BOOST_PRICE,
    desc:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß Boost ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) 1 ‡πÄ‡∏Å‡∏°/‡∏ä‡∏¥‡πâ‡∏ô",
  }
];

const PASSIVES = [
  {id:"coin2x", name:"‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 2 ‡πÄ‡∏ó‡πà‡∏≤", desc:"‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏Ñ‡∏π‡∏ì 2"},
  {id:"energy_save", name:"‡πÉ‡∏ä‡πâ Energy ‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á 15%", desc:"‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Energy (Decay + Damage) ‡∏•‡∏á 15%"},
  {id:"free_revive", name:"‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏ü‡∏£‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á", desc:"‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏ü‡∏£‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡πÄ‡∏Å‡∏° (‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç) ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å"},
  {id:"hole_guard", name:"‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏´‡∏•‡∏∏‡∏°‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ", desc:"‡πÄ‡∏î‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏•‡∏∏‡∏°‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏ï‡∏Å ‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏∏‡∏°"},
];

/** =========================
 *  STORAGE (INV / PASSIVE)
 *  ========================= */
function loadInv(){
  try{
    const raw = localStorage.getItem(LS.INV);
    if(!raw) return { start_energy_150:0, start_boost_5s:0 };
    const obj = JSON.parse(raw);
    return {
      start_energy_150: Number(obj.start_energy_150||0),
      start_boost_5s: Number(obj.start_boost_5s||0),
    };
  }catch(e){
    return { start_energy_150:0, start_boost_5s:0 };
  }
}
function saveInv(inv){ localStorage.setItem(LS.INV, JSON.stringify(inv)); }

function getPassive(){
  const id = localStorage.getItem(LS.PASSIVE);
  return id || "";
}
function setPassive(id){
  localStorage.setItem(LS.PASSIVE, id || "");
}
function getPassiveNextDiscount(){
  return Number(localStorage.getItem(LS.PASSIVE_NEXT_DISC) || 0);
}
function setPassiveNextDiscount(v){
  localStorage.setItem(LS.PASSIVE_NEXT_DISC, String(v||0));
}

/** =========================
 *  THEMES
 *  ========================= */
function applyTheme(){
  const bg = localStorage.getItem(LS.THEME_BG) || "aurora";
  const obs = localStorage.getItem(LS.THEME_OBS) || "glass";

  if(bg === "gold"){
    bgLayer.style.background =
      `radial-gradient(700px 360px at 20% 25%, rgba(251,191,36,.16), transparent 60%),
       radial-gradient(520px 340px at 80% 25%, rgba(34,211,238,.08), transparent 60%),
       radial-gradient(520px 320px at 50% 80%, rgba(168,85,247,.06), transparent 60%),
       linear-gradient(180deg, rgba(2,6,23,1), rgba(2,6,23,.65))`;
  }else if(bg === "neon"){
    bgLayer.style.background =
      `linear-gradient(180deg, rgba(2,6,23,1), rgba(2,6,23,.65)),
       repeating-linear-gradient(90deg, rgba(34,211,238,.08) 0 1px, transparent 1px 24px),
       repeating-linear-gradient(0deg, rgba(168,85,247,.07) 0 1px, transparent 1px 24px),
       radial-gradient(700px 360px at 30% 20%, rgba(34,211,238,.12), transparent 60%)`;
  }else{
    bgLayer.style.background =
      `radial-gradient(600px 320px at 10% 30%, rgba(34,211,238,.18), transparent 60%),
       radial-gradient(520px 360px at 85% 25%, rgba(168,85,247,.14), transparent 60%),
       radial-gradient(540px 260px at 60% 75%, rgba(251,191,36,.06), transparent 60%),
       linear-gradient(180deg, rgba(2,6,23,1), rgba(2,6,23,.6))`;
  }

  // obstacle styles
  document.querySelectorAll(".obstacle").forEach(el=>{
    if(obs === "stone"){
      el.style.background = "linear-gradient(180deg, rgba(100,116,139,.28), rgba(51,65,85,.18))";
      el.style.borderColor = "rgba(148,163,184,.35)";
    }else if(obs === "shadow"){
      el.style.background = "linear-gradient(180deg, rgba(0,0,0,.55), rgba(15,23,42,.25))";
      el.style.borderColor = "rgba(148,163,184,.22)";
    }else{
      el.style.background = "";
      el.style.borderColor = "";
    }
  });
}

/** =========================
 *  UI UPDATE
 *  ========================= */
function setStatus(t){
  statusTextEl.textContent = t;
}
function updateScoreUI(){
  scoreEl.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${Math.floor(score)}`;
  bestScoreEl.textContent = `‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${bestScore}`;
}
function updateCoinsUI(){
  walletCoinsEl.textContent = fmtCoins(walletCoins);
  runCoinsEl.textContent = fmtCoins(runCoins);
  shopCoinsEl.textContent = fmtCoins(walletCoins);
}
function updateEnergyUI(){
  const p = clamp(energy / maxEnergyThisRun, 0, 1);
  energyBarEl.style.transform = `scaleX(${p})`;
  energyTextEl.textContent = `${Math.round(energy)} / ${maxEnergyThisRun}`;
  energyNowMiniEl.textContent = `${Math.round(energy)}`;
}
function updateStartPassiveHint(){
  const p = getPassive();
  if(!p){
    startPassiveHint.textContent = "Passive: (‡πÑ‡∏°‡πà‡∏°‡∏µ) ‚Ä¢ ‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏° Passive ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤";
    return;
    }
  const meta = PASSIVES.find(x=>x.id===p);
  startPassiveHint.textContent = `Passive: ${meta ? meta.name : p}`;
}

/** =========================
 *  AUDIO (simple WebAudio)
 *  ========================= */
let audioCtx = null;
let soundState = {
  master:true,
  bgm:true,
  sfx:true,
  bgmVol:0.65,
  sfxVol:0.80
};
function loadSound(){
  try{
    const raw = localStorage.getItem(LS.SOUND);
    if(raw){
      const o = JSON.parse(raw);
      soundState.master = !!o.master;
      soundState.bgm = !!o.bgm;
      soundState.sfx = !!o.sfx;
      soundState.bgmVol = clamp(Number(o.bgmVol??0.65),0,1);
      soundState.sfxVol = clamp(Number(o.sfxVol??0.8),0,1);
    }
  }catch(e){}
}
function saveSound(){
  localStorage.setItem(LS.SOUND, JSON.stringify(soundState));
}
function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}
function beep(freq=440, dur=0.08, vol=0.2){
  if(!soundState.master || !soundState.sfx) return;
  ensureAudio();
  const t0 = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type="sine"; o.frequency.value=freq;
  g.gain.value = vol * soundState.sfxVol;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(t0);
  o.stop(t0 + dur);
}
let bgmOsc = null;
let bgmGain = null;
function bgmPlay(){
  if(!soundState.master || !soundState.bgm) return;
  ensureAudio();
  if(bgmOsc) return;
  bgmOsc = audioCtx.createOscillator();
  bgmGain = audioCtx.createGain();
  bgmOsc.type="triangle";
  bgmOsc.frequency.value = 110;
  bgmGain.gain.value = 0.05 * soundState.bgmVol;
  bgmOsc.connect(bgmGain);
  bgmGain.connect(audioCtx.destination);
  bgmOsc.start();
}
function bgmStop(){
  if(bgmOsc){
    try{ bgmOsc.stop(); }catch(e){}
    bgmOsc.disconnect();
    bgmGain.disconnect();
    bgmOsc=null; bgmGain=null;
  }
}
function audioRefresh(){
  if(!soundState.master){ bgmStop(); return; }
  if(soundState.bgm){ bgmPlay(); }
  else { bgmStop(); }
  if(bgmGain) bgmGain.gain.value = 0.05 * soundState.bgmVol;
}

/** =========================
 *  GAME OBJECT FACTORIES
 *  ========================= */
function addObstacleFloor(x, w=34, h=52){
  const el = document.createElement("div");
  el.className = "obstacle floor";
  el.style.left = x + "px";
  el.style.width = w + "px";
  el.style.height = h + "px";
  el.style.bottom = groundY + "px";
  gameContainer.appendChild(el);
  const obj = {type:"floor", x, w, h, y:groundY, el};
  obstacles.push(obj);
  applyTheme();
}
function addObstacleCeiling(x){
  const el = document.createElement("div");
  el.className = "obstacle ceiling";
  // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÉ‡∏´‡πâ "‡∏´‡∏°‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏•‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡πÜ"
  // (‡∏¢‡∏Å‡∏´‡∏¥‡∏ô‡∏¢‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô)
  const h = randi(66, 96);
  const bottom = randi(groundY + 86, groundY + 112);
  el.style.left = x + "px";
  el.style.width = "34px";
  el.style.height = h + "px";
  el.style.bottom = bottom + "px";
  gameContainer.appendChild(el);
  const obj = {type:"ceiling", x, w:34, h, y:bottom, el};
  obstacles.push(obj);
  applyTheme();
}
function addHole(x){
  const el = document.createElement("div");
  el.className = "hole";
  el.style.left = x + "px";
  gameContainer.appendChild(el);
  const obj = {x, w:78, el};
  holes.push(obj);
}
function addPlatform(x, y, w){
  const el = document.createElement("div");
  el.className = "platform";
  el.style.left = x + "px";
  el.style.bottom = y + "px";
  el.style.width = w + "px";
  gameContainer.appendChild(el);
  platforms.push({x,y,w,el});
}
function addCollectible(type, x, y, extraClass=""){
  const el = document.createElement("div");
  el.className = `collectible ${type} ${extraClass}`.trim();
  el.style.left = x + "px";
  el.style.bottom = y + "px";
  if(type==="coin") el.textContent = "ü™ô";
  if(type==="energy") el.textContent = "‚ù§Ô∏è";
  if(type==="magnet") el.textContent = "üß≤";
  if(type==="boost") el.textContent = "‚ö°";
  if(type==="giant") el.textContent = "üü£";
  if(type==="jelly") el.textContent = "üç¨";
  gameContainer.appendChild(el);
  collectibles.push({type, x, y, el, vx:0, vy:0, pulled:false, cls:extraClass});
}

/** =========================
 *  SPAWN LOGIC
 *  ========================= */
function spawnCoinCluster(){
  const baseX = gameContainer.clientWidth + 40;
  const n = randi(3,6);
  const laneY = groundY + randi(70, 150);
  for(let i=0;i<n;i++){
    addCollectible("coin", baseX + i*34, laneY + randi(-6,6));
  }
}
function spawnHeart(){
  const x = gameContainer.clientWidth + 40;
  const roll = Math.random();
  let size = "small";
  if(roll > 0.66) size = "medium";
  const y = groundY + randi(80, 165);
  addCollectible("energy", x, y, size);
}
function spawnBigHeart(){
  const x = gameContainer.clientWidth + 50;
  const y = groundY + randi(90, 175);
  addCollectible("energy", x, y, "large");
}
function spawnMagnet(){
  const x = gameContainer.clientWidth + 40;
  const y = groundY + randi(90, 170);
  addCollectible("magnet", x, y);
}
function spawnBoostOrGiant(){
  const x = gameContainer.clientWidth + 40;
  const y = groundY + randi(90, 170);
  if(Math.random() < 0.5) addCollectible("boost", x, y);
  else addCollectible("giant", x, y);
}

// Jelly trail up-down (‡πÑ‡∏ï‡πà‡∏Ç‡∏∂‡πâ‡∏ô-‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á)
function spawnJellyTrail(){
  const startX = gameContainer.clientWidth + 50;
  const count = randi(10, 18);
  const amp = randi(45, 70);      // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á
  const baseY = groundY + randi(88, 135);
  const step = randi(26, 34);

  // sin-wave trail
  const phase = rand(0, Math.PI*2);
  const freq = rand(0.35, 0.55);

  for(let i=0;i<count;i++){
    const x = startX + i*step;
    const y = clamp(baseY + Math.sin(phase + i*freq) * amp, groundY + 70, groundY + 200);
    addCollectible("jelly", x, y);
  }
}

/** =========================
 *  OBSTACLE SPAWN (wave + rest)
 *  ========================= */
function canSpawnObstacle(timeToNextBigHeart){
  if(timeToNextBigHeart <= CFG.QUIET_BEFORE_BIG_HEART_MS) return false;
  return true;
}
function spawnObstaclePack(){
  const x = gameContainer.clientWidth + 40;

  // chance spawn platform sometimes
  if(Math.random() < 0.12){
    addPlatform(x, groundY + randi(80, 160), randi(110, 180));
  }

  const r = Math.random();

  // holes less frequent and allow passive guard
  if(r < 0.16){
    addHole(x);
    return;
  }

  // floor or ceiling
  if(r < 0.68){
    addObstacleFloor(x, 34, randi(46, 62));
  }else{
    addObstacleCeiling(x);
  }
}

/** =========================
 *  COLLISION
 *  ========================= */
function rectOf(el){
  const r = el.getBoundingClientRect();
  const g = gameContainer.getBoundingClientRect();
  return {x:r.left-g.left, y:r.top-g.top, w:r.width, h:r.height};
}
function overlap(a,b){
  return (a.x < b.x + b.w &&
          a.x + a.w > b.x &&
          a.y < b.y + b.h &&
          a.y + a.h > b.y);
}

/** =========================
 *  SCORE/COINS/ENERGY
 *  ========================= */
function addScore(v){
  let inc = v;
  if(postReviveActive) inc *= CFG.POST_REVIVE_SCORE_MULT;
  score += inc;
  if(score > bestScore){
    bestScore = Math.floor(score);
    localStorage.setItem(LS.BEST, String(bestScore));
  }
}
function addCoins(v){
  let inc = v * runMod.coinMult;
  if(postReviveActive) inc *= CFG.POST_REVIVE_COIN_MULT; // allow decimal
  runCoins += inc;
  walletCoins += inc; // allow decimal; will ceil on end
}
function addEnergy(amount){
  const gain = amount;
  energy = clamp(energy + gain, 0, maxEnergyThisRun);
}
function damageEnergy(amount){
  energy = clamp(energy - (amount * runMod.energyUseMult), 0, maxEnergyThisRun);
}

/** =========================
 *  PASSIVE APPLY
 *  ========================= */
function computeRunMod(){
  runMod = {coinMult:1, energyUseMult:1, holeGuard:false, freeRevive:false};
  const p = getPassive();
  if(p === "coin2x") runMod.coinMult = 2;
  if(p === "energy_save") runMod.energyUseMult = 0.85;
  if(p === "hole_guard") runMod.holeGuard = true;
  if(p === "free_revive") runMod.freeRevive = true;
}

/** =========================
 *  CONSUMABLE AUTO-USE
 *  ========================= */
function consumeAtRunStart(){
  runConsumable = {startEnergyUsed:false, startBoostUsed:false};
  const inv = loadInv();

  if(inv.start_energy_150 > 0){
    inv.start_energy_150 -= 1;
    saveInv(inv);
    maxEnergyThisRun = Math.max(maxEnergyThisRun, 150);
    energy = maxEnergyThisRun;
    runConsumable.startEnergyUsed = true;
  }
  if(inv.start_boost_5s > 0){
    inv.start_boost_5s -= 1;
    saveInv(inv);
    runConsumable.startBoostUsed = true;
  }
}

/** =========================
 *  EFFECTS (collect)
 *  ========================= */
function collect(item){
  const {type, cls} = item;

  if(type === "coin"){
    addScore(CFG.SCORE_PER_COIN);
    addCoins(1);
    beep(740, 0.05, 0.18);
  }
  if(type === "jelly"){
    addScore(CFG.SCORE_PER_JELLY);
    beep(520, 0.06, 0.16);
  }
  if(type === "energy"){
    if(cls.includes("small")) addEnergy(CFG.HEART_SMALL_GAIN);
    else if(cls.includes("medium")) addEnergy(CFG.HEART_MEDIUM_GAIN);
    else if(cls.includes("large")){
      addEnergy(CFG.HEART_LARGE_GAIN);
      // speed up on big heart
      speed = Math.min(CFG.MAX_SPEED, speed + CFG.SPEED_UP_ON_BIG_HEART);
      beep(880, 0.07, 0.20);
    }else{
      addEnergy(CFG.HEART_SMALL_GAIN);
    }
    beep(660, 0.05, 0.16);
  }
  if(type === "magnet"){
    magnetActive = true;
    magnetTimer = CFG.MAGNET_DURATION_MS;
    beep(420, 0.08, 0.20);
  }
  if(type === "boost"){
    boostActive = true;
    boostTimer = CFG.BOOST_DURATION_MS;
    invincible = true;
    invTimer = Math.max(invTimer, 350);
    beep(980, 0.08, 0.22);
  }
  if(type === "giant"){
    giantActive = true;
    giantTimer = CFG.GIANT_DURATION_MS;
    invincible = true;
    invTimer = Math.max(invTimer, 350);
    beep(300, 0.10, 0.22);
  }

  // remove element
  item.el.remove();
  item._dead = true;
}

/** =========================
 *  GAME LOOP
 *  ========================= */
function prepareNewRun(){
  // clear objects
  [...obstacles, ...holes, ...platforms, ...collectibles].forEach(o => o.el?.remove());
  obstacles=[]; holes=[]; platforms=[]; collectibles=[];

  score = 0;
  runCoins = 0;
  speed = CFG.BASE_SPEED;

  timeCoin=0; timeHeart=0; timeBigHeart=0;
  timeMagnet=0; timeBG=0; nextBGIn = rand(CFG.BG_DROP_MIN_MS, CFG.BG_DROP_MAX_MS);
  timeJelly=0; nextJellyIn = rand(950, 1550);

  timeObstacle=0; nextObstacleIn = rand(CFG.OB_MIN_BASE, CFG.OB_MAX_BASE); waveRemaining=0;

  maxEnergyThisRun = CFG.MAX_ENERGY;
  energy = maxEnergyThisRun;

  magnetActive=false; magnetTimer=0;
  boostActive=false; boostTimer=0;
  giantActive=false; giantTimer=0;
  invincible=false; invTimer=0;
  ducking=false;
  postReviveActive=false;

  coinRevivedThisRun=false;
  freeRevivedThisRun=false;

  playerY = groundY;
  vy = 0;
  jumpsUsed = 0;

  playerEl.classList.remove("ducking","invincible","boosting","giant");

  isPaused=false;
  isGameOver=false;

  computeRunMod();
  updateStartPassiveHint();
  applyTheme();
  updateScoreUI();
  updateCoinsUI();
  updateEnergyUI();
}

function startCountdown(title, hint, onDone){
  if(countdownTimer) clearInterval(countdownTimer);
  countdownTitleEl.textContent = title;
  countdownHintEl.textContent = hint || "";
  countdownOverlay.classList.remove("hidden");

  let n = 3;
  countdownTextEl.textContent = String(n);

  countdownTimer = setInterval(()=>{
    n--;
    if(n > 0){
      countdownTextEl.textContent = String(n);
      beep(540, 0.05, 0.12);
    }else{
      clearInterval(countdownTimer);
      countdownTimer=null;
      countdownTextEl.textContent = "GO!";
      beep(980, 0.06, 0.16);
      setTimeout(()=>{
        countdownOverlay.classList.add("hidden");
        onDone?.();
      }, 280);
    }
  }, 1000);
}

function beginRun(){
  // Apply auto-consumables at start of run
  consumeAtRunStart();

  // if start energy item applied, energy & max already set
  // Apply start boost if item consumed
  if(runConsumable.startBoostUsed){
    boostActive = true;
    boostTimer = Math.max(boostTimer, CFG.START_BOOST_MS);
    invincible = true;
    invTimer = Math.max(invTimer, 350);
  }

  updateCoinsUI();
  updateEnergyUI();

  // run
  setStatus("RUN");
  bgmPlay();
  lastT = null;
  frameId = requestAnimationFrame(loop);
}

function endRun(){
  isGameOver=true;
  setStatus("OVER");

  // round up wallet if decimal (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
  walletCoins = Math.ceil(walletCoins);
  runCoins = Math.ceil(runCoins);
  localStorage.setItem(LS.WALLET, String(walletCoins));

  updateCoinsUI();
  updateScoreUI();
  showGameOverModal();
}

function loop(t){
  if(isPaused || isGameOver) return;
  if(lastT === null) lastT = t;
  const dt = (t - lastT) / 1000;
  lastT = t;

  // energy decay
  energy -= CFG.ENERGY_DECAY_PER_SEC * dt * runMod.energyUseMult;
  if(energy <= 0){
    energy = 0;
    updateEnergyUI();
    endRun();
    return;
  }

  // speed up slowly by score
  speed = Math.min(CFG.MAX_SPEED, speed + (score * CFG.SPEED_UP_PER_SCORE) * dt);

  // timers
  if(invincible){
    invTimer -= dt*1000;
    if(invTimer <= 0 && !boostActive && !giantActive){
      invincible=false;
      playerEl.classList.remove("invincible");
    }
  }
  if(magnetActive){
    magnetTimer -= dt*1000;
    if(magnetTimer <= 0){ magnetActive=false; }
  }
  if(boostActive){
    boostTimer -= dt*1000;
    if(boostTimer <= 0){
      boostActive=false;
      // invincible might remain from giant
      if(!giantActive){
        invincible=false;
        playerEl.classList.remove("invincible");
      }
    }
  }
  if(giantActive){
    giantTimer -= dt*1000;
    if(giantTimer <= 0){
      giantActive=false;
      if(!boostActive){
        invincible=false;
        playerEl.classList.remove("invincible");
      }
    }
  }

  // player visuals
  playerEl.classList.toggle("ducking", ducking);
  playerEl.classList.toggle("giant", giantActive);
  playerEl.classList.toggle("invincible", invincible);
  playerEl.classList.toggle("boosting", boostActive);

  // physics
  vy -= CFG.GRAVITY * dt;
  playerY += vy * dt;
  if(playerY < groundY){
    playerY = groundY;
    vy = 0;
    jumpsUsed = 0;
  }

  // ground support (platforms + holes)
  // determine supportY and if hole below
  let supportY = groundY;
  const px = 70; // player x fixed
  const pW = 52;
  const pH = 68 * (ducking ? 0.55 : 1) * (giantActive ? 1.35 : 1);

  // platform support
  for(const pf of platforms){
    if(px + pW > pf.x && px < pf.x + pf.w){
      if(playerY >= pf.y && playerY <= pf.y + 6 && vy <= 0){
        supportY = Math.max(supportY, pf.y);
      }
    }
  }

  // hole check
  let holeUnder = false;
  for(const h of holes){
    if(px + pW > h.x && px < h.x + h.w){
      holeUnder = true;
      break;
    }
  }
  if(runMod.holeGuard) holeUnder = false;

  // snap to support if not falling into hole
  if(vy <= 0){
    if(supportY > groundY || !holeUnder){
      if(playerY < supportY){
        playerY = supportY;
        vy = 0;
        jumpsUsed = 0;
      }
    }
  }

  // apply player position
  playerEl.style.bottom = playerY + "px";

  // if falling into hole: allow fall but not instant death
  if(holeUnder && supportY === groundY){
    // allow falling until trap threshold
    if(playerY < groundY - 55){
      // trap death (unless holeGuard)
      endRun();
      return;
    }
  }

  // ===== spawners =====
  const dtms = dt * 1000;

  timeCoin += dtms;
  const coinInt = Math.max(CFG.COIN_MIN_INTERVAL, CFG.COIN_BASE_INTERVAL - score * 1.8);
  if(timeCoin >= coinInt){
    timeCoin = 0;
    spawnCoinCluster();
  }

  timeHeart += dtms;
  const heartInt = Math.max(CFG.HEART_MIN_INTERVAL, CFG.HEART_BASE_INTERVAL - score * 1.2);
  if(timeHeart >= heartInt){
    timeHeart = 0;
    spawnHeart();
  }

  // Big heart every fixed time + quiet window handled in obstacle spawning
  timeBigHeart += dtms;
  if(timeBigHeart >= CFG.BIG_HEART_EVERY_MS){
    timeBigHeart = 0;
    spawnBigHeart();
  }
  const timeToNextBigHeart = CFG.BIG_HEART_EVERY_MS - timeBigHeart;

  // Magnet spawn (adjust interval here)
  timeMagnet += dtms;
  const magnetInt = Math.max(CFG.MAGNET_MIN_INTERVAL, CFG.MAGNET_BASE_INTERVAL - score * 3.2);
  if(timeMagnet >= magnetInt){
    timeMagnet = 0;
    spawnMagnet();
  }

  // Boost/Giant spawn with cooldown range
  timeBG += dtms;
  if(timeBG >= nextBGIn){
    timeBG = 0;
    nextBGIn = rand(CFG.BG_DROP_MIN_MS, CFG.BG_DROP_MAX_MS);
    spawnBoostOrGiant();
  }

  // Jelly trail spawn (more frequent)
  timeJelly += dtms;
  if(timeJelly >= nextJellyIn){
    timeJelly = 0;
    nextJellyIn = rand(900, 1550);
    if(Math.random() < 0.78) spawnJellyTrail();
  }

  // Obstacles wave system
  timeObstacle += dtms;
  if(timeObstacle >= nextObstacleIn){
    if(canSpawnObstacle(timeToNextBigHeart)){
      spawnObstaclePack();
      timeObstacle = 0;

      if(waveRemaining > 0){
        waveRemaining--;
        nextObstacleIn = rand(CFG.OB_WAVE_EXTRA_MIN, CFG.OB_WAVE_EXTRA_MAX);
      }else{
        // decide if start a wave
        if(Math.random() < CFG.OB_WAVE_CHANCE){
          waveRemaining = randi(1,2);
          nextObstacleIn = rand(CFG.OB_WAVE_EXTRA_MIN, CFG.OB_WAVE_EXTRA_MAX);
        }else if(Math.random() < CFG.OB_REST_CHANCE){
          nextObstacleIn = rand(CFG.OB_REST_MIN, CFG.OB_REST_MAX);
        }else{
          const minI = Math.max(CFG.OB_MIN_FLOOR, CFG.OB_MIN_BASE - score*2.2);
          const maxI = Math.max(minI + 450, CFG.OB_MAX_BASE - score*2.6);
          nextObstacleIn = rand(minI, maxI);
        }
      }
    }else{
      // force delay during quiet window
      timeObstacle = 0;
      nextObstacleIn = Math.max(650, timeToNextBigHeart + 260);
      waveRemaining = 0;
    }
  }

  // ===== move world =====
  const move = (boostActive ? speed * CFG.BOOST_MULT : speed) * dt;

  // obstacles move & collision
  const pRect = rectOf(playerEl);

  for(const o of obstacles){
    o.x -= move;
    o.el.style.left = o.x + "px";

    // giant can break floor obstacles
    if(giantActive && o.type==="floor"){
      const or = rectOf(o.el);
      if(overlap(pRect, or)){
        // break
        o.el.remove();
        o._dead = true;
        addScore(6);
        beep(240, 0.06, 0.22);
        continue;
      }
    }

    // collision (if not invincible)
    if(!invincible){
      const or = rectOf(o.el);
      if(overlap(pRect, or)){
        // damage or end
        damageEnergy(CFG.ENERGY_DAMAGE_HIT);
        invincible = true;
        invTimer = 650;
        playerEl.classList.add("invincible");
        beep(180, 0.08, 0.22);
        if(energy <= 0){
          energy = 0;
          updateEnergyUI();
          endRun();
          return;
        }
      }
    }
  }

  // holes move
  for(const h of holes){
    h.x -= move;
    h.el.style.left = h.x + "px";
  }

  // platforms move
  for(const pf of platforms){
    pf.x -= move;
    pf.el.style.left = pf.x + "px";
  }

  // collectibles move & magnet pull
  const pxCenter = pRect.x + pRect.w*0.5;
  const pyCenter = pRect.y + pRect.h*0.5;

  for(const c of collectibles){
    if(c._dead) continue;

    c.x -= move;
    // magnet pull for coin/energy/jelly
    if(magnetActive && (c.type==="coin" || c.type==="energy" || c.type==="jelly")){
      const cr = rectOf(c.el);
      const cx = cr.x + cr.w*0.5;
      const cy = cr.y + cr.h*0.5;
      const dx = pxCenter - cx;
      const dy = pyCenter - cy;
      const dist = Math.hypot(dx,dy);
      if(dist < CFG.MAGNET_RADIUS){
        const nx = dx / (dist||1);
        const ny = dy / (dist||1);
        c.x += nx * CFG.MAGNET_PULL * dt;
        c.y += ny * CFG.MAGNET_PULL * dt;
      }
    }

    c.el.style.left = c.x + "px";
    c.el.style.bottom = c.y + "px";

    // collect check
    const cr2 = rectOf(c.el);
    if(overlap(pRect, cr2)){
      collect(c);
    }
  }

  // cleanup offscreen
  obstacles = obstacles.filter(o=>{
    if(o._dead) return false;
    if(o.x < -120){ o.el.remove(); return false; }
    return true;
  });
  holes = holes.filter(h=>{
    if(h.x < -140){ h.el.remove(); return false; }
    return true;
  });
  platforms = platforms.filter(pf=>{
    if(pf.x < -260){ pf.el.remove(); return false; }
    return true;
  });
  collectibles = collectibles.filter(c=>{
    if(c._dead) return false;
    if(c.x < -120){ c.el.remove(); return false; }
    return true;
  });

  // update UI
  updateScoreUI();
  updateCoinsUI();
  updateEnergyUI();

  frameId = requestAnimationFrame(loop);
}

/** =========================
 *  PAUSE / RESUME / REVIVE
 *  ========================= */
function pauseGame(){
  if(isGameOver) return;
  if(isPaused) return;
  isPaused=true;
  setStatus("PAUSED");
  pauseOverlay.classList.remove("hidden");
}
function resumeGame(){
  if(isGameOver) return;
  if(!isPaused) return;
  pauseOverlay.classList.add("hidden");
  startCountdown("RESUME", "‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥", ()=>{
    isPaused=false;
    setStatus("RUN");
    bgmPlay();
    lastT=null;
    frameId = requestAnimationFrame(loop);
  });
}

function showGameOverModal(){
  gameOverSummaryPill.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${Math.floor(score)} ‚Ä¢ ‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ ${fmtCoins(runCoins)}`;
  gameOverModal.classList.remove("hidden");

  // coin revive button
  const canCoinRevive = (!coinRevivedThisRun) && (walletCoins >= CFG.REVIVE_COST);
  reviveBtn.disabled = !canCoinRevive;
  reviveBtn.textContent = `‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏î‡πâ‡∏ß‡∏¢ ${CFG.REVIVE_COST} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç`;

  // free revive from passive
  const canFree = runMod.freeRevive && !freeRevivedThisRun;
  freeReviveBtn.classList.toggle("hidden", !canFree);
}

function doRevive({type}){
  gameOverModal.classList.add("hidden");
  isGameOver=false;

  // clear near objects
  obstacles.forEach(o=>{
    if(o.x < 220){ o.el.remove(); o._dead=true; }
  });
  holes.forEach(h=>{
    if(h.x < 260){ h.el.remove(); h._dead=true; }
  });
  collectibles.forEach(c=>{
    if(c.x < 240){ c.el.remove(); c._dead=true; }
  });
  obstacles = obstacles.filter(o=>!o._dead);
  holes = holes.filter(h=>!h._dead);
  collectibles = collectibles.filter(c=>!c._dead);

  // reset player
  playerY = groundY;
  vy = 0;
  jumpsUsed = 0;
  ducking = false;

  energy = clamp(CFG.REVIVE_ENERGY, 1, maxEnergyThisRun);

  invincible = true;
  invTimer = 1300;
  playerEl.classList.add("invincible");

  // penalties
  if(type === "coin"){
    postReviveActive = true;
  }else{
    postReviveActive = false;
  }

  setStatus("REVIVE");
  startCountdown("REVIVE", "‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!", ()=>{
    setStatus("RUN");
    bgmPlay();
    lastT=null;
    frameId = requestAnimationFrame(loop);
  });
}

/** =========================
 *  INPUT
 *  ========================= */
document.addEventListener("keydown", (e)=>{
  if(e.code === "KeyP"){
    if(isGameOver) return;
    if(isPaused) resumeGame();
    else pauseGame();
  }

  if(e.code === "Space" || e.code === "ArrowUp"){
    e.preventDefault();

    if(!startOverlay.classList.contains("hidden")){
      // start from overlay
      startOverlay.classList.add("hidden");
      startCountdown("READY", "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°!", beginRun);
      return;
    }
    if(gameOverModal && !gameOverModal.classList.contains("hidden")){
      // new game
      gameOverModal.classList.add("hidden");
      prepareNewRun();
      startOverlay.classList.remove("hidden");
      return;
    }
    if(isPaused || isGameOver) return;
    jump();
  }

  if(e.code === "ArrowDown"){
    if(isPaused || isGameOver) return;
    duck(true);
  }
});
document.addEventListener("keyup", (e)=>{
  if(e.code === "ArrowDown"){
    duck(false);
  }
});

function jump(){
  if(jumpsUsed >= CFG.MAX_JUMPS) return;
  if(jumpsUsed === 0){
    vy = CFG.JUMP_V;
  }else{
    vy = CFG.DOUBLE_JUMP_V;
  }
  jumpsUsed++;
  beep(520, 0.05, 0.16);
}
function duck(on){
  ducking = !!on;
}

/** touch */
jumpBtn.addEventListener("pointerdown", ()=>{
  if(isPaused || isGameOver) return;
  if(!startOverlay.classList.contains("hidden")) return;
  jump();
});
duckBtn.addEventListener("pointerdown", ()=> duck(true));
duckBtn.addEventListener("pointerup", ()=> duck(false));
duckBtn.addEventListener("pointercancel", ()=> duck(false));

/** buttons */
startGameBtn.addEventListener("click", ()=>{
  startOverlay.classList.add("hidden");
  startCountdown("READY", "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°!", beginRun);
});
pauseBtn.addEventListener("click", ()=>{
  if(isPaused) resumeGame();
  else pauseGame();
});
resumeBtn.addEventListener("click", resumeGame);

restartBtn.addEventListener("click", ()=>{
  cancelAnimationFrame(frameId);
  isPaused=false; isGameOver=false;
  pauseOverlay.classList.add("hidden");
  gameOverModal.classList.add("hidden");
  countdownOverlay.classList.add("hidden");
  prepareNewRun();
  startOverlay.classList.remove("hidden");
});

newGameBtn.addEventListener("click", ()=>{
  gameOverModal.classList.add("hidden");
  prepareNewRun();
  startOverlay.classList.remove("hidden");
});

reviveBtn.addEventListener("click", ()=>{
  if(coinRevivedThisRun) return;
  if(walletCoins < CFG.REVIVE_COST) return;
  coinRevivedThisRun = true;
  walletCoins -= CFG.REVIVE_COST;
  updateCoinsUI();
  doRevive({type:"coin"});
});

freeReviveBtn.addEventListener("click", ()=>{
  if(freeRevivedThisRun) return;
  freeRevivedThisRun = true;
  doRevive({type:"free"});
});

/** fullscreen */
fullscreenBtn.addEventListener("click", async ()=>{
  try{
    if(!document.fullscreenElement){
      await document.documentElement.requestFullscreen();
    }else{
      await document.exitFullscreen();
    }
  }catch(e){}
});

/** quick audio toggle */
audioQuickBtn.addEventListener("click", ()=>{
  soundState.master = !soundState.master;
  saveSound();
  syncSoundUI();
  audioRefresh();
});

/** SHOP */
shopBtn.addEventListener("click", ()=>{
  openShop();
});
closeShopBtn.addEventListener("click", ()=> shopModal.classList.add("hidden"));

function openShop(){
  renderShop();
  shopModal.classList.remove("hidden");
}
function canAfford(price){ return walletCoins >= price; }
function spend(price){
  if(walletCoins < price) return false;
  walletCoins -= price;
  updateCoinsUI();
  localStorage.setItem(LS.WALLET, String(walletCoins));
  return true;
}

function renderShop(){
  shopCoinsEl.textContent = fmtCoins(walletCoins);
  const inv = loadInv();
  const currentBg = localStorage.getItem(LS.THEME_BG) || "aurora";
  const currentObs = localStorage.getItem(LS.THEME_OBS) || "glass";

  const passive = getPassive();
  const passiveMeta = PASSIVES.find(x=>x.id===passive);
  const nextDisc = getPassiveNextDiscount();
  const passivePrice = Math.round(CFG.PASSIVE_BOX_BASE_PRICE * (1 - nextDisc));

  let html = "";

  // Passive section
  html += `<div class="sectionTitle">Passive Skill (‡∏°‡∏µ‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á) ‚Äî ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Å‡∏°</div>`;
  html += `<div class="item" style="margin-bottom:10px">
      <div class="name">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏° Passive Skill</div>
      <div class="desc">‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚Äú‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‚Äù ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‚Ä¢ ‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡πâ‡∏≥ = ‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ó‡∏ô‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° -> ‚Äú‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‚Äù ‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ 15%</div>
      <div class="meta">
        <span class="tag">‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: ${passiveMeta ? passiveMeta.name : "(‡πÑ‡∏°‡πà‡∏°‡∏µ)"}</span>
        <div style="display:flex; gap:8px; align-items:center">
          <span class="price">ü™ô ${passivePrice}${nextDisc>0 ? ` <span style="opacity:.7; font-size:12px">(‡∏•‡∏î ${Math.round(nextDisc*100)}%)</span>` : ""}</span>
          <button id="buyPassiveBtn" class="primary" ${canAfford(passivePrice) ? "" : "disabled"}>‡∏™‡∏∏‡πà‡∏° Passive</button>
        </div>
      </div>
      <div class="desc" style="margin-top:8px">
        <b>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ:</b><br>
        ${PASSIVES.map(p=>`‚Ä¢ ${p.name}: ${p.desc}`).join("<br>")}
      </div>
    </div>`;

  // Consumables
  html += `<div class="sectionTitle">‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏° (‡∏™‡∏∞‡∏™‡∏°‡πÑ‡∏î‡πâ) ‚Äî ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</div>`;
  html += `<div class="grid">`;
  for(const it of CONSUMABLES){
    const owned = inv[it.id] || 0;
    html += `<div class="item">
      <div class="name">${it.name}</div>
      <div class="desc">${it.desc}</div>
      <div class="meta">
        <span class="tag">‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà: ${owned}</span>
        <div style="display:flex; gap:8px; align-items:center">
          <span class="price">ü™ô ${it.price}</span>
          <button data-buy-cons="${it.id}" class="primary" ${canAfford(it.price) ? "" : "disabled"}>‡∏ã‡∏∑‡πâ‡∏≠</button>
        </div>
      </div>
    </div>`;
  }
  html += `</div>`;

  // Themes
  html += `<div class="sectionTitle">‡∏ò‡∏µ‡∏°‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á</div>`;
  html += `<div class="grid">`;
  for(const t of THEMES_BG){
    const owned = (t.price===0) || (localStorage.getItem("owned_bg_"+t.id)==="1");
    const isSel = currentBg===t.id;
    html += `<div class="item">
      <div class="name">${t.name}</div>
      <div class="desc">${t.desc}</div>
      <div class="meta">
        <span class="tag">${owned ? "‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß" : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠"}${isSel ? " ‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà" : ""}</span>
        <div style="display:flex; gap:8px; align-items:center">
          <span class="price">ü™ô ${t.price}</span>
          ${
            owned
              ? `<button data-sel-bg="${t.id}" class="good"${isSel?" disabled":""}>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>`
              : `<button data-buy-bg="${t.id}" class="primary" ${canAfford(t.price) ? "" : "disabled"}>‡∏ã‡∏∑‡πâ‡∏≠</button>`
          }
        </div>
      </div>
    </div>`;
  }
  html += `</div>`;

  html += `<div class="sectionTitle">‡∏ò‡∏µ‡∏°‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ</div>`;
  html += `<div class="grid">`;
  for(const t of THEMES_OBS){
    const owned = (t.price===0) || (localStorage.getItem("owned_obs_"+t.id)==="1");
    const isSel = currentObs===t.id;
    html += `<div class="item">
      <div class="name">${t.name}</div>
      <div class="desc">${t.desc}</div>
      <div class="meta">
        <span class="tag">${owned ? "‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß" : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠"}${isSel ? " ‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà" : ""}</span>
        <div style="display:flex; gap:8px; align-items:center">
          <span class="price">ü™ô ${t.price}</span>
          ${
            owned
              ? `<button data-sel-obs="${t.id}" class="good"${isSel?" disabled":""}>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>`
              : `<button data-buy-obs="${t.id}" class="primary" ${canAfford(t.price) ? "" : "disabled"}>‡∏ã‡∏∑‡πâ‡∏≠</button>`
          }
        </div>
      </div>
    </div>`;
  }
  html += `</div>`;

  shopBody.innerHTML = html;

  // bind events
  const buyPassiveBtn = document.getElementById("buyPassiveBtn");
  if(buyPassiveBtn){
    buyPassiveBtn.addEventListener("click", ()=>{
      const disc = getPassiveNextDiscount();
      const price = Math.round(CFG.PASSIVE_BOX_BASE_PRICE * (1 - disc));
      if(!spend(price)) return;

      const current = getPassive();
      const rolled = PASSIVES[randi(0, PASSIVES.length-1)].id;

      setPassive(rolled);

      // if rolled same => next buy discount 15%, else reset
      if(rolled === current){
        setPassiveNextDiscount(CFG.PASSIVE_DUP_DISCOUNT);
      }else{
        setPassiveNextDiscount(0);
      }

      computeRunMod();
      updateStartPassiveHint();
      renderShop();
    });
  }

  document.querySelectorAll("[data-buy-cons]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-buy-cons");
      const item = CONSUMABLES.find(x=>x.id===id);
      if(!item) return;
      if(!spend(item.price)) return;
      const inv2 = loadInv();
      inv2[id] = (inv2[id]||0) + 1;
      saveInv(inv2);
      renderShop();
    });
  });

  document.querySelectorAll("[data-buy-bg]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-buy-bg");
      const t = THEMES_BG.find(x=>x.id===id);
      if(!t) return;
      if(!spend(t.price)) return;
      localStorage.setItem("owned_bg_"+id,"1");
      renderShop();
    });
  });
  document.querySelectorAll("[data-sel-bg]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-sel-bg");
      localStorage.setItem(LS.THEME_BG, id);
      applyTheme();
      renderShop();
    });
  });

  document.querySelectorAll("[data-buy-obs]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-buy-obs");
      const t = THEMES_OBS.find(x=>x.id===id);
      if(!t) return;
      if(!spend(t.price)) return;
      localStorage.setItem("owned_obs_"+id,"1");
      renderShop();
    });
  });
  document.querySelectorAll("[data-sel-obs]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-sel-obs");
      localStorage.setItem(LS.THEME_OBS, id);
      applyTheme();
      renderShop();
    });
  });
}

/** SOUND MODAL */
soundBtn.addEventListener("click", ()=>{
  syncSoundUI();
  soundModal.classList.remove("hidden");
});
closeSoundBtn.addEventListener("click", ()=> soundModal.classList.add("hidden"));

function syncSoundUI(){
  masterToggle.checked = soundState.master;
  bgmToggle.checked = soundState.bgm;
  sfxToggle.checked = soundState.sfx;
  bgmVol.value = soundState.bgmVol;
  sfxVol.value = soundState.sfxVol;
  bgmVolLabel.textContent = Math.round(soundState.bgmVol*100) + "%";
  sfxVolLabel.textContent = Math.round(soundState.sfxVol*100) + "%";
}
masterToggle.addEventListener("change", ()=>{
  soundState.master = masterToggle.checked;
  saveSound(); audioRefresh();
});
bgmToggle.addEventListener("change", ()=>{
  soundState.bgm = bgmToggle.checked;
  saveSound(); audioRefresh();
});
sfxToggle.addEventListener("change", ()=>{
  soundState.sfx = sfxToggle.checked;
  saveSound(); audioRefresh();
});
bgmVol.addEventListener("input", ()=>{
  soundState.bgmVol = Number(bgmVol.value);
  bgmVolLabel.textContent = Math.round(soundState.bgmVol*100) + "%";
  saveSound(); audioRefresh();
});
sfxVol.addEventListener("input", ()=>{
  soundState.sfxVol = Number(sfxVol.value);
  sfxVolLabel.textContent = Math.round(soundState.sfxVol*100) + "%";
  saveSound();
});
testSoundBtn.addEventListener("click", ()=>{
  beep(440,0.08,0.25);
  setTimeout(()=>beep(660,0.08,0.25),120);
  setTimeout(()=>beep(880,0.10,0.25),260);
});

/** INIT */
loadSound();
syncSoundUI();
applyTheme();
prepareNewRun();
updateCoinsUI();
updateScoreUI();
updateEnergyUI();
updateStartPassiveHint();
</script>
</body>
</html>
