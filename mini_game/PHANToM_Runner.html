<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>PHANToM Runner</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root{
      --bg1: #1d2337;
      --bg2: #020617;

      /* Poison obstacles (no glow) */
      --obs-a: #111827;  /* slate */
      --obs-b: #0b1020;  /* deep */
      --obs-c: #2e1065;  /* deep purple */
      --obs-d: #0b1020;  /* deep */
      --obs-border: rgba(148,163,184,0.16);
      --obs-shadow: rgba(0,0,0,0.35);

      /* Wood ground/platform */
      --wood-1: #8b5a2b;
      --wood-2: #7a4f25;
      --wood-3: #6a4320;
      --wood-line: rgba(0,0,0,0.12);
    }

    body {
      background: #020617;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 22px;
      padding-bottom: 18px;
    }

    body.fullscreen-game{ padding-top: 12px; }

    h1 {
      margin-bottom: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      user-select: none;
    }

    #gameContainer {
      position: relative;
      width: 800px;
      max-width: 95vw;
      height: 260px;
      border: 2px solid #4b5563;
      overflow: hidden;
      border-radius: 16px;
      background: radial-gradient(circle at top, var(--bg1) 0, var(--bg2) 55%, var(--bg2) 100%);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.9);
    }

    /* in-game top bar */
    #inGameTopBar{
      position:absolute;
      top:10px;
      left:10px;
      right:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      z-index: 30;
      pointer-events:none;
    }
    .ig-pill{
      pointer-events:auto;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.35);
      color:#e5e7eb;
      font-size:12px;
      box-shadow:0 8px 18px rgba(0,0,0,0.18);
      backdrop-filter: blur(2px);
      user-select:none;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .ig-btn{
      pointer-events:auto;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.55);
      color:#e5e7eb;
      font-size:12px;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,0.22);
      user-select:none;
    }
    .ig-btn:hover{ border-color: rgba(99,102,241,0.65); }
    .ig-btn:active{ transform: translateY(1px) scale(0.99); }

    #ground {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 200%;
      height: 40px;
      background: repeating-linear-gradient(
        -45deg,
        var(--wood-1) 0,
        var(--wood-1) 12px,
        var(--wood-2) 12px,
        var(--wood-2) 24px
      );
      animation: groundMove 1s linear infinite;
      opacity: 0.95;
      z-index: 1;
      box-shadow: inset 0 2px 0 rgba(255,255,255,0.05);
    }

    @keyframes groundMove {
      from { transform: translateX(0); }
      to   { transform: translateX(-50%); }
    }

    /* ==== player ==== */
    #player {
      position: absolute;
      bottom: 40px;
      left: 80px;
      width: 60px;
      height: 60px;
      transform-origin: center bottom;
      transition: transform 0.08s ease, width 0.12s ease, height 0.12s ease;
      z-index: 5;
    }

    #player img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
      user-select: none;
      background: transparent;
      filter: drop-shadow(0 0 16px rgba(56,189,248,0.8));
    }

    #player.duck { transform: translateY(-8px) scaleY(0.5); }
    #player.duck img { filter: drop-shadow(0 0 14px rgba(56,189,248,0.9)); }

    #player.invincible img {
      filter:
        drop-shadow(0 0 26px rgba(250,204,21,1))
        drop-shadow(0 0 70px rgba(250,204,21,0.7));
    }

    #player.giant { width: 130px; height: 130px; }
    #player.giant img {
      filter:
        drop-shadow(0 0 26px rgba(59,130,246,1))
        drop-shadow(0 0 70px rgba(59,130,246,0.7));
    }

    #player.double-jump img { animation: djumpSpin 0.2s linear; }
    @keyframes djumpSpin { from{transform:rotate(0)} to{transform:rotate(360deg)} }

    /* Boost beam */
    #boostBeam {
      position: absolute;
      width: 140px;
      height: 35px;
      left: -9999px;
      bottom: 40px;
      background: linear-gradient(90deg, rgba(34,197,94,0), rgba(34,197,94,0.9), rgba(56,189,248,0));
      filter: blur(8px);
      opacity: 0;
      transition: opacity 0.12s ease;
      pointer-events: none;
      z-index: 4;
      mix-blend-mode: screen;
    }

    .obstacle {
      position: absolute;
      bottom: 40px;
      border-radius: 8px;
      z-index: 3;

      /* poison look - no glow */
      background: linear-gradient(135deg, var(--obs-a), var(--obs-b), var(--obs-c), var(--obs-d));
      border: 1px solid var(--obs-border);
      box-shadow:
        0 14px 22px var(--obs-shadow),
        inset 0 1px 0 rgba(255,255,255,0.05);
    }

    /* keep type classes but unified color */
    .obstacle.ground.tree { border-radius: 6px 6px 0 0; }
    .obstacle.ground.bush { border-radius: 14px; }
    .obstacle.ground.rock { border-radius: 40% 60% 30% 70%; }
    .obstacle.ground.sign::before { content: ""; } /* remove "!" */
    .obstacle.air.fireball { border-radius: 50%; }
    .obstacle.air.drone { border-radius: 40%; }
    .obstacle.air.bird { border-radius: 10px; }

    /* platform wood */
    .platform {
      position: absolute;
      height: 10px;
      background:
        repeating-linear-gradient(
          90deg,
          var(--wood-1) 0 14px,
          var(--wood-2) 14px 28px
        );
      border-radius: 8px;
      box-shadow: 0 10px 18px rgba(0,0,0,0.28);
      border: 1px solid rgba(0,0,0,0.18);
      z-index: 2;
    }
    .platform::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      background: repeating-linear-gradient(180deg, transparent 0 6px, var(--wood-line) 6px 7px);
      opacity:0.55;
      pointer-events:none;
    }

    /* hole */
    .hole {
      position: absolute;
      bottom: 0;
      height: 40px;
      background: linear-gradient(to top, #000000 0%, #020617 55%);
      border-radius: 6px 6px 0 0;
      box-shadow:
        inset 0 0 24px rgba(0,0,0,0.9),
        0 -2px 0 rgba(148,163,184,0.6);
      z-index: 1;
      overflow: hidden;
    }
    .hole::before {
      content: "";
      position: absolute;
      left: 0; right: 0; bottom: 0;
      height: 14px;
      background: repeating-linear-gradient(-45deg, transparent 0 10px, #b91c1c 10px 20px);
      box-shadow: 0 -2px 8px rgba(248,113,113,0.8);
    }
    .hole::after {
      content: "";
      position: absolute;
      left: 50%;
      bottom: 2px;
      width: 60%;
      height: 10px;
      transform: translateX(-50%);
      background: radial-gradient(circle, rgba(248,113,113,0.7), transparent);
      opacity: 0.9;
    }

    /* collectibles */
    .collectible {
      position: absolute;
      z-index: 4;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      line-height: 1;
      user-select: none;
      pointer-events: none;
      will-change: transform, opacity;
    }

    .collectible.coin {
      background: radial-gradient(circle at 30% 30%, #fef9c3, #facc15, #b45309);
      box-shadow: 0 0 12px rgba(250, 204, 21, 0.9);
    }

    .collectible.energy {
      background: radial-gradient(circle at 30% 20%, #fecaca, #ef4444, #b91c1c);
      box-shadow: 0 0 12px rgba(248, 113, 113, 0.95);
      font-size: 18px;
      transform: scale(1);
    }
    .collectible.energy.small  { transform: scale(0.85); }
    .collectible.energy.medium { transform: scale(1.0); }
    .collectible.energy.large  { transform: scale(1.25); }

    .collectible.magnet {
      background: radial-gradient(circle at 30% 20%, #e0f2fe, #38bdf8, #0369a1);
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.95);
    }
    .collectible.boost {
      background: linear-gradient(90deg, #22c55e, #a3e635);
      box-shadow: 0 0 14px rgba(34, 197, 94, 0.95);
    }
    .collectible.giant {
      background: radial-gradient(circle at 30% 20%, #e0e7ff, #6366f1, #312e81);
      box-shadow: 0 0 14px rgba(129, 140, 248, 0.95);
    }

    /* UI under game */
    #touchControls {
      margin-top: 14px;
      width: 800px;
      max-width: 95vw;
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .ctrl-btn {
      flex: 1;
      padding: 12px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: radial-gradient(circle at 20% 0, #1f2937, #020617);
      color: #e5e7eb;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.04em;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(15,23,42,0.9);
      text-transform: uppercase;
      user-select:none;
    }
    .ctrl-btn span {
      font-size: 11px;
      display: block;
      opacity: 0.7;
      margin-top: 2px;
    }
    .ctrl-btn:hover { border-color: #38bdf8; box-shadow: 0 0 14px rgba(56,189,248,0.7); }
    .ctrl-btn:active { transform: translateY(1px) scale(0.98); }

    #energyContainer {
      margin-top: 10px;
      width: 800px;
      max-width: 95vw;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    #energyLabel {
      font-size: 11px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    #energyBarWrapper {
      flex: 1;
      height: 12px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #4b5563;
      overflow: hidden;
      box-shadow: 0 0 8px rgba(15,23,42,0.9);
    }
    #energyBar {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #22c55e, #facc15, #fb923c);
      box-shadow: 0 0 12px rgba(250,204,21,0.8);
      transition: width 0.15s ease;
    }
    #energyText {
      width: 86px;
      text-align: right;
      font-size: 11px;
      color: #e5e7eb;
    }

    #scoreBoard {
      margin-top: 10px;
      width: 800px;
      max-width: 95vw;
      display:flex;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      font-size: 15px;
      user-select:none;
    }

    #coinsBox{
      color: #facc15;
    }
    #coinsBox small{ color:#9ca3af; font-size: 11px; margin-left: 6px; }

    #miniActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top: 10px;
    }
    .mini-btn{
      padding:8px 14px;
      border-radius:999px;
      border:1px solid #4b5563;
      background: radial-gradient(circle at 20% 0, #1f2937, #020617);
      color:#e5e7eb;
      font-size:13px;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(15,23,42,0.9);
      user-select:none;
    }
    .mini-btn:hover{ border-color: rgba(99,102,241,0.65); }
    .mini-btn:active{ transform: translateY(1px) scale(0.98); }

    #cheatTimer {
      margin-top: 4px;
      font-size: 14px;
      min-height: 20px;
      color: #facc15;
      text-shadow: 0 0 8px rgba(250, 204, 21, 0.35);
      user-select:none;
    }

    #mission {
      margin-top: 6px;
      font-size: 12px;
      color: #9ca3af;
      max-width: 800px;
      text-align: center;
      padding: 0 12px;
      user-select:none;
    }

    #message {
      margin-top: 6px;
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
      max-width: 800px;
      padding: 0 12px;
      user-select:none;
      min-height: 18px;
    }

    /* Item guide */
    #itemGuide {
      margin-top: 10px;
      font-size: 12px;
      color: #e5e7eb;
      max-width: 800px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(148,163,184,0.45);
    }
    #itemGuide strong { color: #facc15; }
    #itemGuide ul { margin: 6px 0 0; padding-left: 18px; }
    #itemGuide li { margin-bottom: 4px; }

    /* Hit VFX */
    @keyframes hitShake {
      0%   { transform: translate(0, 0); }
      20%  { transform: translate(-4px, 2px); }
      40%  { transform: translate(4px, -2px); }
      60%  { transform: translate(-3px, 1px); }
      80%  { transform: translate(3px, -1px); }
      100% { transform: translate(0, 0); }
    }
    #gameContainer.shake { animation: hitShake 0.25s ease; }

    #hitFlash {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle, rgba(248,250,252,0.25), transparent 60%);
      mix-blend-mode: screen;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.12s ease;
      z-index: 999;
    }
    body.hit-blink #hitFlash { opacity: 1; }

    /* Start overlay (inside game) */
    #startOverlay{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
      z-index: 50;
      background: rgba(2,6,23,0.65);
      backdrop-filter: blur(3px);
    }
    #startOverlay.hidden{ display:none; }

    #startOverlay .title{
      font-weight: 900;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #e5e7eb;
      opacity: 0.95;
      text-shadow: 0 12px 28px rgba(0,0,0,0.35);
    }
    #startGameBtn{
      padding: 12px 18px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      cursor:pointer;
      font-weight: 900;
      letter-spacing: 0.04em;
      background: linear-gradient(90deg, rgba(34,197,94,0.95), rgba(45,212,191,0.95));
      color: #022c22;
      box-shadow: 0 18px 44px rgba(34,197,94,0.22);
    }
    #startGameBtn:hover{ filter: brightness(1.03); transform: translateY(-1px); }
    #startGameBtn:active{ transform: translateY(1px); }

    #countdownText{
      font-size: 54px;
      font-weight: 950;
      letter-spacing: 0.08em;
      color: #facc15;
      text-shadow: 0 0 16px rgba(250,204,21,0.28);
      min-height: 62px;
    }
    #startHintMini{
      font-size: 12px;
      color:#9ca3af;
      text-align:center;
      padding: 0 14px;
      line-height: 1.4;
    }

    /* Pause overlay (inside game) */
    #pauseOverlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:10px;
      z-index: 60;
      background: rgba(2,6,23,0.55);
      backdrop-filter: blur(2px);
    }
    #pauseOverlay.show{ display:flex; }
    #pauseOverlay .pTitle{
      font-weight: 900;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color:#e5e7eb;
      opacity: 0.95;
    }
    #resumeBtnOverlay{
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.35);
      cursor:pointer;
      font-weight: 900;
      background: rgba(2,6,23,0.65);
      color:#e5e7eb;
      box-shadow: 0 14px 34px rgba(0,0,0,0.28);
    }
    #resumeBtnOverlay:hover{ border-color: rgba(99,102,241,0.65); }
    #resumeBtnOverlay:active{ transform: translateY(1px); }

    /* Game Over modal */
    #gameOverModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 1200;
      background: rgba(2,6,23,0.72);
      backdrop-filter: blur(4px);
    }
    #gameOverModal.show { display: flex; }

    .modal-card {
      width: min(520px, 96vw);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.92);
      box-shadow: 0 24px 60px rgba(0,0,0,0.55);
      padding: 16px 16px 14px;
    }
    .modal-title {
      font-weight: 900;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #facc15;
      text-shadow: 0 0 18px rgba(250,204,21,0.25);
      margin-bottom: 8px;
      font-size: 18px;
    }
    .modal-stats {
      color: #e5e7eb;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 12px;
    }
    .modal-stats b { color: #facc15; }
    .modal-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    .modal-btn {
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.35);
      cursor: pointer;
      font-weight: 900;
      letter-spacing: 0.03em;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
      transition: transform 0.08s ease, filter 0.12s ease, opacity 0.12s ease;
      user-select:none;
    }
    .modal-btn:hover { filter: brightness(1.05); transform: translateY(-1px); }
    .modal-btn:active { transform: translateY(1px); }

    #reviveBtn {
      background: linear-gradient(90deg, rgba(56,189,248,0.95), rgba(34,197,94,0.95));
      color: #02121a;
      border-color: rgba(56,189,248,0.55);
    }
    #restartBtn {
      background: linear-gradient(90deg, #22c55e, #2dd4bf);
      color: #022c22;
      border-color: rgba(34,197,94,0.55);
    }
    .modal-note {
      margin-top: 10px;
      font-size: 12px;
      color: #9ca3af;
      text-align: center;
      user-select:none;
    }

    /* Shop modal */
    #shopModal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 1300;
      background: rgba(2,6,23,0.78);
      backdrop-filter: blur(4px);
    }
    #shopModal.show{ display:flex; }
    .shop-card{
      width: min(720px, 96vw);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.95);
      box-shadow: 0 28px 70px rgba(0,0,0,0.6);
      padding: 14px 14px 12px;
    }
    .shop-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }
    .shop-title{
      font-weight: 950;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color:#facc15;
      text-shadow: 0 0 18px rgba(250,204,21,0.20);
    }
    .shop-sub{
      font-size: 12px;
      color:#9ca3af;
      margin-top: 4px;
      line-height:1.4;
    }
    .shop-close{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.55);
      color:#e5e7eb;
      cursor:pointer;
      user-select:none;
    }
    .shop-close:hover{ border-color: rgba(99,102,241,0.65); }
    .shop-close:active{ transform: translateY(1px); }

    .shop-balance{
      margin-top: 6px;
      font-size: 12px;
      color:#e5e7eb;
    }
    .shop-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .shop-item{
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.25);
      background: rgba(2,6,23,0.35);
      padding: 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,0.22);
    }
    .shop-item h3{
      font-size: 14px;
      color:#e5e7eb;
      margin-bottom: 6px;
    }
    .shop-item p{
      font-size: 12px;
      color:#9ca3af;
      line-height:1.4;
      margin-bottom: 10px;
    }
    .shop-row{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
    }
    .price{
      font-size: 12px;
      color:#facc15;
      font-weight: 800;
    }
    .shop-action{
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.65);
      color:#e5e7eb;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
    }
    .shop-action:hover{ filter: brightness(1.06); }
    .shop-action:active{ transform: translateY(1px); }
    .shop-action[disabled]{
      opacity: 0.45;
      cursor:not-allowed;
    }

    /* Bottom hint (moved to bottom) */
    #hint {
      margin-top: 12px;
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
      max-width: 900px;
      padding: 0 12px;
      line-height: 1.5;
    }

    @media (max-width: 600px) {
      #gameContainer { height: 230px; }
      #player { left: 40px; }
      #touchControls { margin-top: 12px; gap: 8px; }
      .ctrl-btn { padding: 10px 8px; font-size: 13px; }
      #energyContainer { font-size: 12px; }
      #energyText { width: 70px; font-size: 10px; }
      .shop-grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <h1>PHANToM Runner</h1>

  <div id="gameContainer">
    <div id="ground"></div>
    <div id="boostBeam"></div>

    <div id="inGameTopBar">
      <div class="ig-pill">
        <span>‚è∏ P</span>
        <span id="statusPill">READY</span>
      </div>

      <!-- ‚úÖ Sound toggle + Pause -->
      <div style="display:flex; gap:8px; align-items:center; pointer-events:none;">
        <button id="soundBtn" class="ig-btn" title="‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á" style="pointer-events:auto;">üîä</button>
        <button id="pauseBtn" class="ig-btn" style="pointer-events:auto;">Pause</button>
      </div>
    </div>

    <div id="player">
      <img src="phantom-runner.png" alt="PHANToM" />
    </div>

    <!-- Start overlay (inside game) -->
    <div id="startOverlay">
      <div class="title">PHANToM RUNNER</div>
      <div id="countdownText"></div>
      <button id="startGameBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
      <div id="startHintMini">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ ‡∏Å‡∏î Space ‡∏Å‡πá‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ</div>
    </div>

    <!-- Pause overlay -->
    <div id="pauseOverlay">
      <div class="pTitle">PAUSED</div>
      <button id="resumeBtnOverlay">Resume</button>
      <div style="font-size:12px;color:#9ca3af;">‡∏Å‡∏î P ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Resume</div>
    </div>
  </div>

  <div id="touchControls">
    <button id="btnJump" class="ctrl-btn">‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î <span>JUMP / SPACE</span></button>
    <button id="btnDuck" class="ctrl-btn">‡∏´‡∏°‡∏≠‡∏ö <span>DUCK / ‚Üì</span></button>
  </div>

  <div id="energyContainer">
    <div id="energyLabel">Energy</div>
    <div id="energyBarWrapper"><div id="energyBar"></div></div>
    <div id="energyText">100 / 100</div>
  </div>

  <div id="scoreBoard">
    <div id="score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</div>
    <div id="coinsBox">
      ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°: <span id="walletCoins">0</span>
      <small>(‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: <span id="runCoins">0</span>)</small>
    </div>
    <div id="bestScore">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: 0</div>
  </div>

  <div id="miniActions">
    <button id="fullscreenBtn" class="mini-btn">‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠</button>
    <button id="shopBtn" class="mini-btn">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    <button id="restartOutsideBtn" class="mini-btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
  </div>

  <div id="cheatTimer"></div>
  <div id="mission"></div>
  <div id="message">‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‚Äù ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Å‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</div>

  <div id="itemGuide">
    <strong>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°:</strong>
    <ul>
      <li>ü§ë <b>‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç (Coin)</b> : +‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô / ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</li>
      <li>‚ù§Ô∏è <b>‡∏´‡∏±‡∏ß‡πÉ‡∏à (Energy)</b> : ‡πÄ‡∏û‡∏¥‡πà‡∏° Energy (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å 40 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</li>
      <li>üß≤ <b>Magnet</b> : ‡∏î‡∏π‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç/‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏£‡∏≠‡∏ö ‡πÜ ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</li>
      <li>‚ö° <b>Boost</b> : ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏≠‡∏°‡∏ï‡∏∞‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</li>
      <li>üåÄ <b>Giant</b> : ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏£‡πà‡∏≤‡∏á ‡∏ä‡∏ô‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡∏û‡∏∑‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏á‡πÑ‡∏î‡πâ</li>
    </ul>
  </div>

  <!-- Moved hint to bottom -->
  <div id="hint">
    Space / ‚Üë = ‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î (2 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞) ‚Ä¢ ‚Üì = ‡∏´‡∏°‡∏≠‡∏ö ‚Ä¢ ‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏•‡∏≠‡∏¢/‡∏ö‡∏±‡∏ô‡πÑ‡∏î ‚Ä¢ ‡∏´‡∏•‡∏∏‡∏°‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å (‡∏ï‡∏Å‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ) ‚Ä¢
    ‡∏Å‡∏î P = Pause/Resume ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏£‡∏≠‡∏ö (‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏î 15% ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏•‡∏î 50%)
  </div>

  <div id="hitFlash"></div>

  <!-- GAME OVER MODAL -->
  <div id="gameOverModal" aria-modal="true" role="dialog">
    <div class="modal-card">
      <div class="modal-title">Game Over</div>
      <div id="modalStats" class="modal-stats"></div>

      <div class="modal-actions">
        <button id="reviveBtn" class="modal-btn" style="display:none;">‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏î‡πâ‡∏ß‡∏¢ 50 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</button>
        <button id="restartBtn" class="modal-btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</button>
      </div>

      <div class="modal-note">‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ</div>
    </div>
  </div>

  <!-- SHOP MODAL -->
  <div id="shopModal" aria-modal="true" role="dialog">
    <div class="shop-card">
      <div class="shop-header">
        <div>
          <div class="shop-title">SHOP</div>
          <div class="shop-sub">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (cosmetic): ‡∏ã‡∏∑‡πâ‡∏≠/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏ô‡∏≤‡∏°‚Äù ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°</div>
          <div class="shop-balance">‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°: <b id="shopWalletCoins">0</b></div>
        </div>
        <button id="shopCloseBtn" class="shop-close">‡∏õ‡∏¥‡∏î</button>
      </div>

      <div class="shop-grid" id="shopGrid"></div>
    </div>
  </div>

  <script>
    (function () {
      // =========================
      // CONFIG
      // =========================
      const CFG_GRAVITY = 0.9;
      const CFG_JUMP_STRENGTH = 13.5;
      const CFG_MAX_JUMPS = 2;

      const CFG_MAX_ENERGY = 100;
      const CFG_ENERGY_DECAY_PER_SEC = 4;
      const CFG_DAMAGE_GROUND = 15;
      const CFG_DAMAGE_AIR = 21;

      const CFG_START_SPEED = 6;
      const CFG_SPEED_UP_EVERY_SCORE = 5;
      const CFG_SPEED_UP_AMOUNT = 0.5;
      const CFG_BOOST_MULTIPLIER = 1.6;

      const CFG_HIT_SLOW_FACTOR = 0.8;
      const CFG_HIT_SLOW_DURATION = 500;
      const CFG_HIT_IFRAMES = 350;

      const CFG_HOLE_CHANCE = 0.18;
      const CFG_TRAP_Y = -60;

      const CFG_CHEAT_INVINCIBLE_DURATION = 10000;
      const CFG_MAGNET_DURATION = 10000;
      const CFG_BOOST_DURATION = 5000;
      const CFG_GIANT_DURATION = 6000;

      const CFG_MAGNET_RADIUS = 400;

      const CFG_HEART_SMALL_GAIN = 15;
      const CFG_HEART_MEDIUM_GAIN = 25;
      const CFG_HEART_LARGE_GAIN = 40;

      const CFG_MISSION_COIN_TARGET = 20;
      const CFG_MISSION_DJ_TARGET = 10;
      const CFG_MISSION_OBS_TARGET = 30;

      // Spawn timers
      const CFG_COIN_BASE_INTERVAL = 520;
      const CFG_COIN_MIN_INTERVAL  = 250;

      const CFG_HEART_BASE_INTERVAL = 1200;   // small/medium heart
      const CFG_HEART_MIN_INTERVAL  = 650;

      // ‚úÖ powerups appear LESS (2x less frequent)
      const CFG_POWERUP_BASE_INTERVAL = 1200; // was 600
      const CFG_POWERUP_MIN_INTERVAL  = 640;  // was 320

      const CFG_BIG_HEART_EVERY_MS = 40000;

      const CFG_CHEAT_WINDOW = 1000;

      // ‚úÖ Revive rules
      const CFG_REVIVE_COST = 50;
      const CFG_REVIVE_ENERGY = 55;
      const CFG_REVIVE_INVINCIBLE_MS = 1200;
      const CFG_POST_REVIVE_SCORE_MULT = 0.85; // -15%
      const CFG_POST_REVIVE_COIN_MULT  = 0.50; // -50%
      const CFG_COUNTDOWN_SECONDS = 3;

      // localStorage keys
      const LS_BEST = "phantom_runner_best";
      const LS_WALLET = "phantom_runner_wallet_coins";
      const LS_BACKDROPS_UNLOCK = "phantom_runner_backdrops_unlocked";
      const LS_BACKDROP_SELECTED = "phantom_runner_backdrop_selected";

      // =========================
      // DOM
      // =========================
      const gameContainer = document.getElementById("gameContainer");
      const player = document.getElementById("player");
      const scoreEl = document.getElementById("score");
      const bestScoreEl = document.getElementById("bestScore");
      const messageEl = document.getElementById("message");
      const cheatTimerEl = document.getElementById("cheatTimer");
      const btnJump = document.getElementById("btnJump");
      const btnDuck = document.getElementById("btnDuck");
      const energyBar = document.getElementById("energyBar");
      const energyText = document.getElementById("energyText");

      const walletCoinsEl = document.getElementById("walletCoins");
      const runCoinsEl = document.getElementById("runCoins");

      const missionEl = document.getElementById("mission");
      const boostBeam = document.getElementById("boostBeam");

      const fullscreenBtn = document.getElementById("fullscreenBtn");
      const restartOutsideBtn = document.getElementById("restartOutsideBtn");

      const pauseBtn = document.getElementById("pauseBtn");
      const soundBtn = document.getElementById("soundBtn"); // ‚úÖ NEW
      const pauseOverlay = document.getElementById("pauseOverlay");
      const resumeBtnOverlay = document.getElementById("resumeBtnOverlay");
      const statusPill = document.getElementById("statusPill");

      const startOverlay = document.getElementById("startOverlay");
      const startGameBtn = document.getElementById("startGameBtn");
      const countdownText = document.getElementById("countdownText");

      const gameOverModal = document.getElementById("gameOverModal");
      const modalStats = document.getElementById("modalStats");
      const reviveBtn = document.getElementById("reviveBtn");
      const restartBtn = document.getElementById("restartBtn");

      const shopBtn = document.getElementById("shopBtn");
      const shopModal = document.getElementById("shopModal");
      const shopCloseBtn = document.getElementById("shopCloseBtn");
      const shopGrid = document.getElementById("shopGrid");
      const shopWalletCoins = document.getElementById("shopWalletCoins");

      // =========================
      // SOUND
      // =========================
      const Sounds = {
        bgm: new Audio("bgm_main.mp3"),
        countdown: new Audio("sfx_countdown.mp3"),
        jump: new Audio("sfx_jump.mp3"),
        coin: new Audio("sfx_coin.mp3"),
        powerup: new Audio("sfx_powerup.mp3"),
        hit: new Audio("sfx_hit.mp3"),
        gameover: new Audio("sfx_gameover.mp3"),
        revive: new Audio("sfx_revive.mp3"),
        click: new Audio("sfx_click.mp3"),
      };

      let audioUnlocked = false;
      let audioEnabled = true;

      // configure bgm
      Sounds.bgm.loop = true;
      Sounds.bgm.volume = 0.22;

      // sfx volumes
      Sounds.countdown.volume = 0.35;
      Sounds.jump.volume = 0.35;
      Sounds.coin.volume = 0.35;
      Sounds.powerup.volume = 0.40;
      Sounds.hit.volume = 0.45;
      Sounds.gameover.volume = 0.50;
      Sounds.revive.volume = 0.45;
      Sounds.click.volume = 0.35;

      function safePlay(a){
        if (!audioEnabled) return;
        if (!a) return;
        try{
          a.currentTime = 0;
          const p = a.play();
          if (p && typeof p.catch === "function") p.catch(()=>{});
        }catch(_){}
      }

      function unlockAudioOnce(){
        if (audioUnlocked) return;
        audioUnlocked = true;
        try{
          const p = Sounds.click.play();
          if (p && p.catch) p.catch(()=>{});
          setTimeout(()=>{ try{ Sounds.click.pause(); Sounds.click.currentTime = 0; }catch(_){ } }, 60);
        }catch(_){}
      }
      document.addEventListener("pointerdown", unlockAudioOnce, { once:true });

      function bgmPlay(){
        if (!audioEnabled) return;
        try{
          const p = Sounds.bgm.play();
          if (p && p.catch) p.catch(()=>{});
        }catch(_){}
      }
      function bgmPause(){
        try{ Sounds.bgm.pause(); }catch(_){}
      }

      // ‚úÖ NEW: Sound button UI + toggle
      function updateSoundBtnUI(){
        if (!soundBtn) return;
        soundBtn.textContent = audioEnabled ? "üîä" : "üîá";
        soundBtn.title = audioEnabled ? "‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á" : "‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
      }

      if (soundBtn){
        soundBtn.addEventListener("click", () => {
          unlockAudioOnce();

          if (audioEnabled){
            safePlay(Sounds.click);   // click ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î
            audioEnabled = false;
            bgmPause();
          } else {
            audioEnabled = true;
            safePlay(Sounds.click);
            if (isRunning && !isPaused && !gameOver) bgmPlay();
          }
          updateSoundBtnUI();
        });
      }

      // =========================
      // Shop (starter / cosmetic backdrops)
      // =========================
      const Backdrops = [
        { id:"toxic",  name:"Toxic Lab (Default)", desc:"‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏° ‡πÜ ‡πÇ‡∏ó‡∏ô‡∏û‡∏¥‡∏©", price:0, css:{ "--bg1":"#1d2337", "--bg2":"#020617" } },
        { id:"nebula", name:"Purple Nebula", desc:"‡∏°‡πà‡∏ß‡∏á‡∏•‡∏∂‡∏Å ‡πÜ ‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏•", price:120, css:{ "--bg1":"#20102e", "--bg2":"#050312" } },
        { id:"neon",   name:"Neon City", desc:"‡πÇ‡∏ó‡∏ô‡∏ô‡∏µ‡∏≠‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏° ‡πÜ", price:150, css:{ "--bg1":"#0b1b2e", "--bg2":"#020617" } },
        { id:"dusk",   name:"Midnight Dusk", desc:"‡πÄ‡∏Ç‡πâ‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô", price:180, css:{ "--bg1":"#0a1224", "--bg2":"#020617" } },
      ];

      function loadUnlockedBackdrops(){
        try{
          const raw = localStorage.getItem(LS_BACKDROPS_UNLOCK);
          if (!raw) return { toxic:true };
          const obj = JSON.parse(raw);
          if (!obj || typeof obj !== "object") return { toxic:true };
          obj.toxic = true;
          return obj;
        }catch(_){
          return { toxic:true };
        }
      }
      function saveUnlockedBackdrops(obj){
        try{ localStorage.setItem(LS_BACKDROPS_UNLOCK, JSON.stringify(obj)); }catch(_){}
      }
      function loadSelectedBackdrop(){
        return localStorage.getItem(LS_BACKDROP_SELECTED) || "toxic";
      }
      function saveSelectedBackdrop(id){
        try{ localStorage.setItem(LS_BACKDROP_SELECTED, id); }catch(_){}
      }

      let unlockedBackdrops = loadUnlockedBackdrops();
      let selectedBackdrop = loadSelectedBackdrop();
      if (!unlockedBackdrops[selectedBackdrop]) selectedBackdrop = "toxic";

      function applyBackdrop(id){
        const b = Backdrops.find(x=>x.id===id) || Backdrops[0];
        for (const k in b.css){
          document.documentElement.style.setProperty(k, b.css[k]);
        }
        selectedBackdrop = b.id;
        saveSelectedBackdrop(selectedBackdrop);
      }
      applyBackdrop(selectedBackdrop);

      function renderShop(){
        shopWalletCoins.textContent = String(walletCoins);
        shopGrid.innerHTML = "";

        Backdrops.forEach(b=>{
          const unlocked = !!unlockedBackdrops[b.id];
          const selected = (selectedBackdrop === b.id);

          const el = document.createElement("div");
          el.className = "shop-item";
          el.innerHTML = `
            <h3>${b.name}</h3>
            <p>${b.desc}</p>
            <div class="shop-row">
              <div class="price">${b.price === 0 ? "‡∏ü‡∏£‡∏µ" : (b.price + " ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç")}</div>
              <div style="display:flex; gap:10px; align-items:center;">
                <button class="shop-action" data-act="buy" data-id="${b.id}" ${unlocked || b.price===0 ? "disabled" : ""}>
                  ‡∏ã‡∏∑‡πâ‡∏≠
                </button>
                <button class="shop-action" data-act="select" data-id="${b.id}" ${!unlocked && b.price>0 ? "disabled" : ""}>
                  ${selected ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ" : "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å"}
                </button>
              </div>
            </div>
          `;
          shopGrid.appendChild(el);
        });
      }

      function openShop(){
        safePlay(Sounds.click);
        if (isRunning && !gameOver && !isPaused) pauseGame(true);

        renderShop();
        shopModal.classList.add("show");
      }
      function closeShop(){
        safePlay(Sounds.click);
        shopModal.classList.remove("show");
      }

      shopBtn.addEventListener("click", openShop);
      shopCloseBtn.addEventListener("click", closeShop);
      shopModal.addEventListener("click", (e)=>{
        if (e.target === shopModal) closeShop();
      });

      shopGrid.addEventListener("click", (e)=>{
        const btn = e.target.closest("button");
        if (!btn) return;
        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        const b = Backdrops.find(x=>x.id===id);
        if (!b) return;

        if (act === "buy"){
          if (unlockedBackdrops[id] || b.price===0) return;
          if (walletCoins < b.price) return;

          walletCoins -= b.price;
          saveWallet();
          updateCoinsUI();

          unlockedBackdrops[id] = true;
          saveUnlockedBackdrops(unlockedBackdrops);
          safePlay(Sounds.click);
          renderShop();
        }

        if (act === "select"){
          if (!unlockedBackdrops[id] && b.price>0) return;
          applyBackdrop(id);
          safePlay(Sounds.click);
          renderShop();
        }
      });

      // =========================
      // State
      // =========================
      const groundY = 40;
      const maxJumps = CFG_MAX_JUMPS;

      let playerY = groundY;
      let prevPlayerY = groundY;
      let jumpVelocity = 0;
      let jumpsLeft = maxJumps;

      let isDucking = false;

      let energy = CFG_MAX_ENERGY;

      let score = 0;
      let bestScore = Number(localStorage.getItem(LS_BEST) || 0);

      let runCoins = 0;
      let walletCoins = Number(localStorage.getItem(LS_WALLET) || 0);

      let coinsCollected = 0;
      let totalDoubleJumps = 0;
      let obstaclesPassed = 0;

      let obstacles = [];
      let collectibles = [];
      let platforms = [];
      let holes = [];

      let speed = CFG_START_SPEED;

      let gameOver = false;
      let frameId = null;
      let lastTime = null;

      let isRunning = false;
      let isPaused = false;
      let countdownTimer = null;
      let countdownLeft = 0;

      let timeSinceLastObstacle = 0;
      let nextSpawnIn = 900;

      let timeSinceLastCoin = 0;
      let timeSinceLastHeart = 0;
      let timeSinceLastPowerup = 0;
      let timeSinceLastBigHeart = 0;

      let timeSinceLastPlatform = 0;
      let nextPlatformIn = 2000 + Math.random() * (4500 - 2000);

      let invincible = false;
      let invincibleTimer = 0;

      let magnetActive = false;
      let magnetTimer = 0;

      let boostActive = false;
      let boostTimer = 0;

      let giantActive = false;
      let giantTimer = 0;

      let hitSlowTimer = 0;
      let hitIFramesTimer = 0;

      let cheatEvents = [];

      // ‚úÖ revive limitation + post-revive penalty accumulation
      let revivedThisRun = false;
      let postReviveActive = false;
      let postScoreAcc = 0;
      let postScoreCredited = 0;
      let postCoinAcc = 0;
      let postCoinCredited = 0;

      // =========================
      // UI Helpers
      // =========================
      function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
      function randomBetween(min, max) { return Math.random() * (max - min) + min; }

      function saveWallet(){ try{ localStorage.setItem(LS_WALLET, String(walletCoins)); }catch(_){ } }

      function updateCoinsUI(){
        walletCoinsEl.textContent = String(walletCoins);
        runCoinsEl.textContent = String(runCoins);
        if (shopModal.classList.contains("show")) shopWalletCoins.textContent = String(walletCoins);
      }

      function updateEnergyUI() {
        const ratio = clamp(energy / CFG_MAX_ENERGY, 0, 1);
        energyBar.style.width = (ratio * 100) + "%";
        energyText.textContent = Math.round(energy) + " / " + CFG_MAX_ENERGY;
      }

      function updateMissionUI() {
        missionEl.textContent =
          "Mission: ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç " + coinsCollected + "/" + CFG_MISSION_COIN_TARGET +
          " ‚Ä¢ Double Jump " + totalDoubleJumps + "/" + CFG_MISSION_DJ_TARGET +
          " ‚Ä¢ ‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ " + obstaclesPassed + "/" + CFG_MISSION_OBS_TARGET;
      }

      function setStatus(text){
        statusPill.textContent = text;
      }

      function showStartOverlay(){
        startOverlay.classList.remove("hidden");
        countdownText.textContent = "";
        setStatus("READY");
      }
      function hideStartOverlay(){
        startOverlay.classList.add("hidden");
      }

      function showPauseOverlay(){
        pauseOverlay.classList.add("show");
        setStatus("PAUSED");
      }
      function hidePauseOverlay(){
        pauseOverlay.classList.remove("show");
      }

      function hideGameOverModal(){
        gameOverModal.classList.remove("show");
      }
      function showGameOverModal(){
        const canRevive = (!revivedThisRun && walletCoins >= CFG_REVIVE_COST);
        reviveBtn.style.display = canRevive ? "block" : "none";
        reviveBtn.textContent = canRevive
          ? ("‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏î‡πâ‡∏ß‡∏¢ " + CFG_REVIVE_COST + " ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: " + walletCoins + ")")
          : "";

        modalStats.innerHTML =
          "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <b>" + score + "</b><br/>" +
          "‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: <b>" + runCoins + "</b><br/>" +
          "‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b>" + walletCoins + "</b><br/>" +
          "Energy ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>" + Math.round(energy) + "</b><br/>" +
          (postReviveActive ? "<br/><b>‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û:</b> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -15% / ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç -50%" : "");

        gameOverModal.classList.add("show");
      }

      function clearArrays() {
        obstacles.forEach(o => o && o.remove());
        obstacles = [];
        collectibles.forEach(c => c && c.remove());
        collectibles = [];
        platforms.forEach(p => p && p.remove());
        platforms = [];
        holes.forEach(h => h && h.remove());
        holes = [];
      }

      // =========================
      // Post-Revive Penalty Accounting (ceil on accumulated)
      // =========================
      function addScore(base){
        if (!postReviveActive){
          score += base;
          return;
        }
        postScoreAcc += base * CFG_POST_REVIVE_SCORE_MULT;
        const newCred = Math.ceil(postScoreAcc);
        const gain = newCred - postScoreCredited;
        postScoreCredited = newCred;
        if (gain > 0) score += gain;
      }

      function addCoins(base){
        if (!postReviveActive){
          runCoins += base;
          walletCoins += base;
          saveWallet();
          return;
        }
        postCoinAcc += base * CFG_POST_REVIVE_COIN_MULT;
        const newCred = Math.ceil(postCoinAcc);
        const gain = newCred - postCoinCredited;
        postCoinCredited = newCred;
        if (gain > 0){
          runCoins += gain;
          walletCoins += gain;
          saveWallet();
        }
      }

      // =========================
      // Game Setup (no auto-run; uses countdown)
      // =========================
      function prepareNewRun(){
        // ‚úÖ prevent countdown ghost-timer bug
        if (countdownTimer){
          clearInterval(countdownTimer);
          countdownTimer = null;
        }
        countdownLeft = 0;
        startGameBtn.disabled = false;

        clearArrays();
        hideGameOverModal();
        hidePauseOverlay();

        score = 0;
        runCoins = 0;
        coinsCollected = 0;
        totalDoubleJumps = 0;
        obstaclesPassed = 0;
        speed = CFG_START_SPEED;

        playerY = groundY;
        prevPlayerY = groundY;
        jumpVelocity = 0;
        jumpsLeft = maxJumps;

        isDucking = false;
        player.classList.remove("duck", "invincible", "giant", "double-jump");
        player.style.bottom = playerY + "px";

        invincible = false;
        invincibleTimer = 0;

        magnetActive = false; magnetTimer = 0;
        boostActive = false; boostTimer = 0;
        giantActive = false; giantTimer = 0;

        hitSlowTimer = 0;
        hitIFramesTimer = 0;

        energy = CFG_MAX_ENERGY;

        timeSinceLastObstacle = 0;
        nextSpawnIn = 850 + Math.random() * 550;

        timeSinceLastCoin = 0;
        timeSinceLastHeart = 0;
        timeSinceLastPowerup = 0;
        timeSinceLastBigHeart = 0;

        timeSinceLastPlatform = 0;
        nextPlatformIn = 2000 + Math.random() * (4500 - 2000);

        revivedThisRun = false;
        postReviveActive = false;
        postScoreAcc = 0; postScoreCredited = 0;
        postCoinAcc = 0;  postCoinCredited = 0;

        gameOver = false;
        isRunning = false;
        isPaused = false;

        if (frameId) cancelAnimationFrame(frameId);
        frameId = null;
        lastTime = null;

        if (boostBeam) {
          boostBeam.style.opacity = 0;
          boostBeam.style.left = "-9999px";
        }

        scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
        updateCoinsUI();
        updateEnergyUI();
        updateMissionUI();

        cheatTimerEl.textContent = "";
        messageEl.textContent = "‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‚Äù ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Å‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°";

        bgmPause();
        showStartOverlay();

        updateSoundBtnUI();
      }

      // =========================
      // Countdown -> Start
      // =========================
      function startCountdown(){
        if (countdownTimer) return;
        if (gameOver) return;

        unlockAudioOnce();
        safePlay(Sounds.click);

        countdownLeft = CFG_COUNTDOWN_SECONDS;
        countdownText.textContent = String(countdownLeft);
        startGameBtn.disabled = true;
        setStatus("COUNTDOWN");

        safePlay(Sounds.countdown);

        countdownTimer = setInterval(() => {
          countdownLeft -= 1;
          if (countdownLeft > 0){
            countdownText.textContent = String(countdownLeft);
            safePlay(Sounds.countdown);
            return;
          }

          countdownText.textContent = "GO!";
          safePlay(Sounds.countdown);

          clearInterval(countdownTimer);
          countdownTimer = null;

          setTimeout(() => {
            countdownText.textContent = "";
            startGameBtn.disabled = false;
            hideStartOverlay();
            beginRun();
          }, 350);
        }, 1000);
      }

      function beginRun(){
        if (isRunning || gameOver) return;
        isRunning = true;
        isPaused = false;
        setStatus("RUN");

        messageEl.textContent = postReviveActive
          ? "‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û: ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -15% / ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç -50%"
          : "‡∏´‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏∏‡∏°‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!";

        spawnObstacle();
        lastTime = null;

        bgmPlay();
        frameId = requestAnimationFrame(gameLoop);
      }

      // =========================
      // Pause / Resume
      // =========================
      function pauseGame(silent){
        if (!isRunning || gameOver) return;
        if (isPaused) return;
        isPaused = true;

        if (!silent) safePlay(Sounds.click);
        showPauseOverlay();

        bgmPause();
        if (frameId) cancelAnimationFrame(frameId);
        frameId = null;
        lastTime = null;
      }

      function resumeGame(){
        if (!isRunning || gameOver) return;
        if (!isPaused) return;
        isPaused = false;

        safePlay(Sounds.click);
        hidePauseOverlay();
        setStatus("RUN");

        bgmPlay();
        lastTime = null;
        frameId = requestAnimationFrame(gameLoop);
      }

      // =========================
      // Spawners
      // =========================
      function spawnHole() {
        const h = document.createElement("div");
        h.classList.add("hole");
        const width = randomBetween(80, 160);
        h.style.width = width + "px";
        h.style.left = gameContainer.offsetWidth + "px";
        h.style.bottom = "0px";
        gameContainer.appendChild(h);
        holes.push(h);
      }

      function spawnObstacle() {
        const isAir = Math.random() < 0.35;

        if (!isAir && Math.random() < CFG_HOLE_CHANCE) {
          spawnHole();
          return;
        }

        const obs = document.createElement("div");
        obs.classList.add("obstacle");

        if (isAir) {
          const airTypes = ["bird", "drone", "fireball"];
          const kind = airTypes[Math.floor(Math.random() * airTypes.length)];
          obs.classList.add("air", kind);

          const height = randomBetween(24, 32);
          const width = randomBetween(34, 40);
          obs.style.width = width + "px";
          obs.style.height = height + "px";
          obs.style.bottom = randomBetween(95, 125) + "px";
        } else {
          obs.classList.add("ground");

          const groundTypes = ["tree", "bush", "rock", "spike", "crate", "barrel", "sign", "laser", "low"];
          const kind = groundTypes[Math.floor(Math.random() * groundTypes.length)];
          obs.classList.add(kind);

          let height, width;
          if (kind === "low") {
            height = randomBetween(28, 52);
            width  = randomBetween(28, 48);
            obs.style.borderRadius = "14px";
          } else {
            height = randomBetween(45, 80);
            width  = randomBetween(22, 40);
          }

          obs.style.width = width + "px";
          obs.style.height = height + "px";
          obs.style.bottom = groundY + "px";
        }

        obs.style.left = gameContainer.offsetWidth + "px";
        gameContainer.appendChild(obs);
        obstacles.push(obs);
      }

      function spawnPlatformGroup() {
        const num = Math.random() < 0.5 ? 2 : 3;
        const baseBottom = groundY + randomBetween(45, 130);
        const step = 24;
        const goingUp = Math.random() < 0.5;
        const baseLeft = gameContainer.offsetWidth + 80;

        for (let i = 0; i < num; i++) {
          const p = document.createElement("div");
          p.classList.add("platform");
          const width = randomBetween(80, 150);
          const spacing = 20;

          p.style.width = width + "px";
          p.style.left = (baseLeft + i * (width + spacing)) + "px";
          p.style.bottom = (baseBottom + (goingUp ? i : -i) * step) + "px";

          gameContainer.appendChild(p);
          platforms.push(p);
        }
      }

      function makeCollectibleBase() {
        const c = document.createElement("div");
        c.classList.add("collectible");
        c.dataset.dead = "0";
        c.dataset.pulled = "0";
        return c;
      }

      function setCollectibleLane(c) {
        const lane = Math.floor(Math.random() * 3);
        let bottom;
        if (lane === 0) bottom = groundY + 60;
        else if (lane === 1) bottom = groundY + 110;
        else bottom = groundY + 150;
        c.style.bottom = bottom + "px";
        c.style.left = gameContainer.offsetWidth + "px";
      }

      function spawnCoin() {
        const c = makeCollectibleBase();
        c.classList.add("coin");
        c.textContent = "ü§ë";
        setCollectibleLane(c);
        gameContainer.appendChild(c);
        collectibles.push(c);
      }

      function spawnSmallMediumHeart() {
        const c = makeCollectibleBase();
        c.classList.add("energy");
        const sizes = ["small","medium"];
        const gains = [CFG_HEART_SMALL_GAIN, CFG_HEART_MEDIUM_GAIN];
        const idx = Math.floor(Math.random() * sizes.length);
        c.classList.add(sizes[idx]);
        c.dataset.energy = String(gains[idx]);
        c.textContent = "‚ù§Ô∏è";
        setCollectibleLane(c);
        gameContainer.appendChild(c);
        collectibles.push(c);
      }

      function spawnLargeHeartForced() {
        const c = makeCollectibleBase();
        c.classList.add("energy", "large");
        c.dataset.energy = String(CFG_HEART_LARGE_GAIN);
        c.textContent = "‚ù§Ô∏è";
        setCollectibleLane(c);
        gameContainer.appendChild(c);
        collectibles.push(c);
      }

      function spawnPowerup(){
        const c = makeCollectibleBase();
        const r = Math.random();

        if (r < 0.34) {
          c.classList.add("magnet");
          c.textContent = "üß≤";
        } else if (r < 0.67) {
          c.classList.add("boost");
          c.textContent = "‚ö°";
        } else {
          c.classList.add("giant");
          c.textContent = "üåÄ";
        }

        setCollectibleLane(c);
        gameContainer.appendChild(c);
        collectibles.push(c);
      }

      // =========================
      // Movement & VFX
      // =========================
      function getEffectiveSpeed() {
        let s = speed;
        if (boostActive) s *= CFG_BOOST_MULTIPLIER;
        if (hitSlowTimer > 0) s *= CFG_HIT_SLOW_FACTOR;
        return s;
      }

      function triggerHitVFX() {
        gameContainer.classList.remove("shake");
        void gameContainer.offsetWidth;
        gameContainer.classList.add("shake");

        document.body.classList.add("hit-blink");
        setTimeout(() => document.body.classList.remove("hit-blink"), 120);
      }

      function isColliding(a, b) {
        const r1 = a.getBoundingClientRect();
        const r2 = b.getBoundingClientRect();
        return !(
          r1.right < r2.left ||
          r1.left > r2.right ||
          r1.bottom < r2.top ||
          r1.top > r2.bottom
        );
      }

      function pullCollectibleToPlayer(c) {
        if (!c || c.dataset.pulled === "1" || c.dataset.dead === "1") return;
        c.dataset.pulled = "1";

        const pr = player.getBoundingClientRect();
        const cr = c.getBoundingClientRect();

        const targetX = pr.left + pr.width / 2;
        const targetY = pr.top + pr.height / 2;
        const cx = cr.left + cr.width / 2;
        const cy = cr.top + cr.height / 2;

        const dx = targetX - cx;
        const dy = targetY - cy;

        c.style.transition = "transform 0.2s linear, opacity 0.2s linear";
        c.style.transform = "translate(" + dx + "px," + dy + "px) scale(0.8)";
        c.style.opacity = "0.15";

        setTimeout(() => {
          if (!c || c.dataset.dead === "1") return;
          applyCollectibleEffect(c);
          c.dataset.dead = "1";
          c.remove();
        }, 190);
      }

      // =========================
      // Collectible Effects
      // =========================
      function applyCollectibleEffect(c) {
        if (!c) return;

        if (c.classList.contains("coin")) {
          coinsCollected += 1;

          addCoins(1);
          addScore(2);

          safePlay(Sounds.coin);

          scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
          updateCoinsUI();
        }
        else if (c.classList.contains("energy")) {
          const gain = parseInt(c.dataset.energy || "20", 10);
          energy = Math.min(CFG_MAX_ENERGY, energy + gain);
          updateEnergyUI();
        }
        else if (c.classList.contains("magnet")) {
          magnetActive = true;
          magnetTimer = CFG_MAGNET_DURATION;
          safePlay(Sounds.powerup);
          messageEl.textContent = "Magnet: ‡∏î‡∏π‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏£‡∏≠‡∏ö ‡πÜ ‚ú®";
        }
        else if (c.classList.contains("boost")) {
          boostActive = true;
          boostTimer = CFG_BOOST_DURATION;

          invincible = true;
          invincibleTimer = Math.max(invincibleTimer, CFG_BOOST_DURATION);

          player.classList.add("invincible");
          safePlay(Sounds.powerup);

          cheatTimerEl.textContent = "Boost: ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏≠‡∏°‡∏ï‡∏∞‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‚ö°";
          messageEl.textContent = "Boost: ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏≠‡∏°‡∏ï‡∏∞‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‚ö°";
        }
        else if (c.classList.contains("giant")) {
          giantActive = true;
          giantTimer = CFG_GIANT_DURATION;
          player.classList.add("giant");
          safePlay(Sounds.powerup);

          messageEl.textContent = "Giant: PHANToM ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà ‡∏ä‡∏ô‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡∏û‡∏∑‡πâ‡∏ô‡∏û‡∏±‡∏á‡πÑ‡∏î‡πâ üí•";
        }

        updateMissionUI();
      }

      // =========================
      // Updates
      // =========================
      function updateObstacles(delta) {
        const moveX = getEffectiveSpeed() * (delta / 16.67);

        obstacles = obstacles.filter(obs => {
          if (!obs || !obs.isConnected) return false;

          const left = parseFloat(obs.style.left);
          const newLeft = left - moveX;
          obs.style.left = newLeft + "px";

          if (newLeft + obs.offsetWidth < 0) {
            obs.remove();

            addScore(1);
            obstaclesPassed += 1;

            scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
            updateMissionUI();

            if (CFG_SPEED_UP_EVERY_SCORE > 0 && score % CFG_SPEED_UP_EVERY_SCORE === 0) {
              speed += CFG_SPEED_UP_AMOUNT;
            }
            return false;
          }

          if (!gameOver && isColliding(player, obs)) {
            if (invincible || giantActive) {
              addScore(2);
              obstaclesPassed += 1;

              scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
              updateMissionUI();

              obs.remove();
              return false;
            } else {
              if (hitIFramesTimer > 0) return true;

              const isAir = obs.classList.contains("air");
              const dmg = isAir ? CFG_DAMAGE_AIR : CFG_DAMAGE_GROUND;

              energy -= dmg;
              safePlay(Sounds.hit);

              if (energy <= 0) {
                energy = 0;
                updateEnergyUI();
                endGame();
                return true;
              }

              updateEnergyUI();
              triggerHitVFX();
              hitSlowTimer = CFG_HIT_SLOW_DURATION;
              hitIFramesTimer = CFG_HIT_IFRAMES;

              obs.style.opacity = "0.4";
              setTimeout(() => { if (obs && obs.style) obs.style.opacity = "1"; }, 120);
            }
          }

          return true;
        });

        timeSinceLastObstacle += delta;

        const minInterval = Math.max(550, 1000 - score * 5);
        const maxInterval = Math.max(minInterval + 300, 1600 - score * 8);

        if (timeSinceLastObstacle >= nextSpawnIn) {
          let canSpawn = true;

          if (obstacles.length > 0) {
            const lastObs = obstacles[obstacles.length - 1];
            const lastRect = lastObs.getBoundingClientRect();
            const containerRect = gameContainer.getBoundingClientRect();
            const distance = containerRect.right - lastRect.right;
            if (distance < 180) canSpawn = false;
          }

          if (canSpawn) {
            spawnObstacle();
            timeSinceLastObstacle = 0;
            nextSpawnIn = randomBetween(minInterval, maxInterval);
          } else {
            timeSinceLastObstacle = minInterval - 50;
          }
        }
      }

      function updatePlatforms(delta) {
        const moveX = getEffectiveSpeed() * (delta / 16.67);

        platforms = platforms.filter(p => {
          if (!p || !p.isConnected) return false;

          const left = parseFloat(p.style.left);
          const newLeft = left - moveX;
          p.style.left = newLeft + "px";

          if (newLeft + p.offsetWidth < 0) {
            p.remove();
            return false;
          }
          return true;
        });

        timeSinceLastPlatform += delta;
        if (timeSinceLastPlatform >= nextPlatformIn) {
          if (platforms.length < 10) spawnPlatformGroup();
          timeSinceLastPlatform = 0;
          nextPlatformIn = 2000 + Math.random() * (4500 - 2000);
        }
      }

      function updateHoles(delta) {
        const moveX = getEffectiveSpeed() * (delta / 16.67);
        holes = holes.filter(h => {
          if (!h || !h.isConnected) return false;

          const left = parseFloat(h.style.left);
          const newLeft = left - moveX;
          h.style.left = newLeft + "px";

          if (newLeft + h.offsetWidth < 0) {
            h.remove();
            return false;
          }
          return true;
        });
      }

      function updateCollectibles(delta) {
        const moveX = getEffectiveSpeed() * (delta / 16.67);

        let playerCenterX = 0;
        let playerCenterY = 0;
        if (magnetActive) {
          const pr = player.getBoundingClientRect();
          playerCenterX = pr.left + pr.width / 2;
          playerCenterY = pr.top + pr.height / 2;
        }

        collectibles.forEach(c => {
          if (!c || c.dataset.dead === "1") return;
          if (c.dataset.pulled === "1") return;

          const left = parseFloat(c.style.left);
          const newLeft = left - moveX;
          c.style.left = newLeft + "px";

          if (newLeft + c.offsetWidth < 0) {
            c.dataset.dead = "1";
            c.remove();
            return;
          }

          if (
            magnetActive &&
            (c.classList.contains("coin") || c.classList.contains("energy"))
          ) {
            const cr = c.getBoundingClientRect();
            const cx = cr.left + cr.width / 2;
            const cy = cr.top + cr.height / 2;
            const dist = Math.hypot(playerCenterX - cx, playerCenterY - cy);
            if (dist < CFG_MAGNET_RADIUS) {
              pullCollectibleToPlayer(c);
              return;
            }
          }

          if (!gameOver && isColliding(player, c)) {
            applyCollectibleEffect(c);
            c.dataset.dead = "1";
            c.remove();
          }
        });

        collectibles = collectibles.filter(c => c && c.isConnected && c.dataset.dead !== "1");
      }

      function updatePlayer(delta) {
        const factor = delta / 16.67;
        prevPlayerY = playerY;

        jumpVelocity -= CFG_GRAVITY * factor;
        playerY += jumpVelocity * factor;

        let supportY = groundY;
        const isFalling = jumpVelocity <= 0;

        const playerRect = player.getBoundingClientRect();
        const playerLeftScreen = playerRect.left;
        const playerRightScreen = playerRect.right;

        const playerStyleLeft = parseFloat(getComputedStyle(player).left);
        const playerStyleRight = playerStyleLeft + player.offsetWidth;

        // platforms
        platforms.forEach(p => {
          if (!p || !p.isConnected) return;
          const pRect = p.getBoundingClientRect();
          const pLeft = pRect.left;
          const pRight = pRect.right;

          const platformBottom = parseFloat(p.style.bottom);
          const platformTop = platformBottom + p.offsetHeight;

          const horizontallyOver = (playerRightScreen > pLeft + 5) && (playerLeftScreen < pRight - 5);
          if (horizontallyOver && isFalling && prevPlayerY >= platformTop && playerY <= platformTop) {
            if (platformTop > supportY) supportY = platformTop;
          }
        });

        // hole under
        let holeUnder = false;
        holes.forEach(h => {
          if (!h || !h.isConnected) return;
          const hLeft = parseFloat(h.style.left);
          const hRight = hLeft + h.offsetWidth;
          if (hRight > playerStyleLeft + 5 && hLeft < playerStyleRight - 5) holeUnder = true;
        });

        if (playerY <= supportY) {
          if (!(supportY === groundY && holeUnder)) {
            playerY = supportY;
            jumpVelocity = 0;
            jumpsLeft = CFG_MAX_JUMPS;
          }
        }

        player.style.bottom = playerY + "px";

        // boost beam
        if (boostBeam) {
          if (boostActive) {
            const baseLeft = parseFloat(getComputedStyle(player).left) || 80;
            boostBeam.style.opacity = 1;
            boostBeam.style.left = (baseLeft - 90) + "px";
            boostBeam.style.bottom = (playerY + 8) + "px";
          } else if (boostBeam.style.opacity !== "0") {
            boostBeam.style.opacity = 0;
          }
        }
      }

      function checkHoleTrap() {
        if (playerY < CFG_TRAP_Y) endGame();
      }

      function updateSpawners(delta){
        timeSinceLastCoin += delta;
        const coinInterval = Math.max(CFG_COIN_MIN_INTERVAL, CFG_COIN_BASE_INTERVAL - score * 2);
        if (timeSinceLastCoin >= coinInterval) {
          spawnCoin();
          timeSinceLastCoin = 0;
        }

        timeSinceLastHeart += delta;
        const heartInterval = Math.max(CFG_HEART_MIN_INTERVAL, CFG_HEART_BASE_INTERVAL - Math.floor(score/4)*10);
        if (timeSinceLastHeart >= heartInterval) {
          spawnSmallMediumHeart();
          timeSinceLastHeart = 0;
        }

        // ‚úÖ powerups (‡∏≠‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á 2 ‡πÄ‡∏ó‡πà‡∏≤ + ‡πÄ‡∏£‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á)
        timeSinceLastPowerup += delta;
        const powerInterval = Math.max(
          CFG_POWERUP_MIN_INTERVAL,
          CFG_POWERUP_BASE_INTERVAL - Math.floor(score/5)*4   // was *8
        );
        if (timeSinceLastPowerup >= powerInterval) {
          spawnPowerup();
          timeSinceLastPowerup = 0;
        }

        timeSinceLastBigHeart += delta;
        if (timeSinceLastBigHeart >= CFG_BIG_HEART_EVERY_MS) {
          spawnLargeHeartForced();
          timeSinceLastBigHeart = 0;
        }
      }

      // =========================
      // Main Loop
      // =========================
      function gameLoop(timestamp) {
        if (gameOver || isPaused) return;

        if (!lastTime) lastTime = timestamp;
        const delta = timestamp - lastTime;
        lastTime = timestamp;

        if (!invincible) {
          energy -= CFG_ENERGY_DECAY_PER_SEC * (delta / 1000);
          if (energy <= 0) {
            energy = 0;
            updateEnergyUI();
            endGame();
            return;
          }
        }
        updateEnergyUI();

        updatePlayer(delta);
        updatePlatforms(delta);
        updateHoles(delta);
        checkHoleTrap();
        if (gameOver) return;

        updateObstacles(delta);
        updateCollectibles(delta);
        updateSpawners(delta);

        if (invincible) {
          invincibleTimer -= delta;
          if (invincibleTimer <= 0) {
            invincible = false;
            player.classList.remove("invincible");
            cheatTimerEl.textContent = "";
            if (!boostActive) messageEl.textContent = postReviveActive
              ? "‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà: ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -15% / ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç -50%"
              : "‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏°‡∏ï‡∏∞‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏µ üòà";
          } else if (invincibleTimer <= 3000) {
            cheatTimerEl.textContent = "‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏°‡∏ï‡∏∞: " + Math.ceil(invincibleTimer / 1000) + " ‡∏ß‡∏¥";
          }
        }

        if (magnetActive) {
          magnetTimer -= delta;
          if (magnetTimer <= 0) magnetActive = false;
        }

        if (boostActive) {
          boostTimer -= delta;
          if (boostTimer <= 0) boostActive = false;
        }

        if (giantActive) {
          giantTimer -= delta;
          if (giantTimer <= 0) {
            giantActive = false;
            player.classList.remove("giant");
          }
        }

        if (hitSlowTimer > 0) {
          hitSlowTimer -= delta;
          if (hitSlowTimer < 0) hitSlowTimer = 0;
        }

        if (hitIFramesTimer > 0) {
          hitIFramesTimer -= delta;
          if (hitIFramesTimer < 0) hitIFramesTimer = 0;
        }

        frameId = requestAnimationFrame(gameLoop);
      }

      // =========================
      // End / Revive
      // =========================
      function endGame() {
        if (gameOver) return;
        gameOver = true;
        isRunning = false;
        isPaused = false;

        if (frameId) cancelAnimationFrame(frameId);
        frameId = null;
        lastTime = null;

        bgmPause();
        safePlay(Sounds.gameover);

        if (score > bestScore) {
          bestScore = score;
          localStorage.setItem(LS_BEST, String(bestScore));
        }
        bestScoreEl.textContent = "‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: " + bestScore;

        cheatTimerEl.textContent = "";
        messageEl.textContent =
          "Game Over! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score +
          " ‚Ä¢ ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: " + runCoins +
          " ‚Ä¢ ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏™‡∏∞‡∏™‡∏°: " + walletCoins +
          ' ‚Ä¢ ‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà';

        if (boostBeam) boostBeam.style.opacity = 0;
        setStatus("OVER");

        showGameOverModal();
      }

      function reviveNow(){
        if (!gameOver) return;
        if (revivedThisRun) return;
        if (walletCoins < CFG_REVIVE_COST) return;

        safePlay(Sounds.revive);

        walletCoins -= CFG_REVIVE_COST;
        saveWallet();
        updateCoinsUI();

        revivedThisRun = true;
        postReviveActive = true;

        postScoreAcc = 0; postScoreCredited = 0;
        postCoinAcc  = 0; postCoinCredited  = 0;

        hideGameOverModal();
        clearArrays();

        energy = clamp(CFG_REVIVE_ENERGY, 1, CFG_MAX_ENERGY);
        updateEnergyUI();

        invincible = true;
        invincibleTimer = Math.max(invincibleTimer, CFG_REVIVE_INVINCIBLE_MS);
        player.classList.add("invincible");

        hitSlowTimer = 0;
        hitIFramesTimer = CFG_HIT_IFRAMES;

        playerY = groundY;
        prevPlayerY = groundY;
        jumpVelocity = 0;
        jumpsLeft = CFG_MAX_JUMPS;
        player.style.bottom = playerY + "px";

        gameOver = false;
        isRunning = true;
        isPaused = false;
        setStatus("RUN");

        messageEl.textContent = "‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡πÅ‡∏•‡πâ‡∏ß! ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -15% / ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç -50% (‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)";

        timeSinceLastObstacle = 0;
        nextSpawnIn = 650 + Math.random() * 500;

        timeSinceLastCoin = 0;
        timeSinceLastHeart = 0;
        timeSinceLastPowerup = 0;

        bgmPlay();
        lastTime = null;
        frameId = requestAnimationFrame(gameLoop);

        spawnObstacle();
      }

      // =========================
      // Controls
      // =========================
      function handleJump() {
        if (!isRunning && !gameOver && !countdownTimer) {
          startCountdown();
          return;
        }

        if (gameOver) {
          prepareNewRun();
          return;
        }

        if (!isRunning || isPaused) return;

        if (jumpsLeft > 0) {
          if (isDucking) setDuck(false);

          if (jumpsLeft === 1) {
            totalDoubleJumps += 1;
            updateMissionUI();
            player.classList.remove("double-jump");
            void player.offsetWidth;
            player.classList.add("double-jump");
          }

          jumpVelocity = CFG_JUMP_STRENGTH;
          jumpsLeft -= 1;
          safePlay(Sounds.jump);
        }
      }

      function setDuck(state) {
        if (!isRunning || gameOver || isPaused) return;
        if (state && !isDucking) {
          isDucking = true;
          player.classList.add("duck");
        } else if (!state && isDucking) {
          isDucking = false;
          player.classList.remove("duck");
        }
      }

      // cheat DDD UUU
      function registerCheat(code) {
        const now = performance.now();
        if (code !== "ArrowDown" && code !== "ArrowUp" && code !== "Space") return;

        const symbol = (code === "ArrowDown") ? "D" : "U";
        cheatEvents.push({ symbol, time: now });

        const cutoff = now - CFG_CHEAT_WINDOW;
        cheatEvents = cheatEvents.filter(e => e.time >= cutoff);

        const lastSix = cheatEvents.slice(-6);
        if (lastSix.length === 6) {
          const pattern = lastSix.map(e => e.symbol).join("");
          if (pattern === "DDDUUU" && isRunning && !gameOver) {
            activateCheat();
            cheatEvents = [];
          }
        }
      }

      function activateCheat() {
        invincible = true;
        invincibleTimer = Math.max(invincibleTimer, CFG_CHEAT_INVINCIBLE_DURATION);
        player.classList.add("invincible");
        cheatTimerEl.textContent = "‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏Å‡∏á: PHANToM ‡∏≠‡∏°‡∏ï‡∏∞ 10 ‡∏ß‡∏¥ üéÉ";
        messageEl.textContent = "‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏Å‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡∏ä‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏¢ 10 ‡∏ß‡∏¥";
      }

      // fullscreen
      function toggleFullscreen(){
        const elem = document.documentElement;
        if (!document.fullscreenElement){
          if (elem.requestFullscreen) elem.requestFullscreen();
          else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
          else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
        } else {
          if (document.exitFullscreen) document.exitFullscreen();
          else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
          else if (document.msExitFullscreen) document.msExitFullscreen();
        }
      }

      fullscreenBtn.addEventListener("click",(e)=>{
        e.preventDefault();
        safePlay(Sounds.click);
        toggleFullscreen();
      });

      document.addEventListener("fullscreenchange", () => {
        if (document.fullscreenElement){
          fullscreenBtn.textContent = "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠";
          document.body.classList.add("fullscreen-game");
        } else {
          fullscreenBtn.textContent = "‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠";
          document.body.classList.remove("fullscreen-game");
        }
      });

      // pause button
      pauseBtn.addEventListener("click", ()=>{
        if (!isRunning || gameOver) return;
        if (isPaused) resumeGame();
        else pauseGame(false);
      });
      resumeBtnOverlay.addEventListener("click", resumeGame);

      // start overlay button
      startGameBtn.addEventListener("click", startCountdown);

      // restart buttons
      restartBtn.addEventListener("click", prepareNewRun);
      restartOutsideBtn.addEventListener("click", prepareNewRun);

      // revive
      reviveBtn.addEventListener("click", reviveNow);

      // keyboard
      document.addEventListener("keydown", (e) => {
        if (e.code === "KeyP") {
          e.preventDefault();
          if (isRunning && !gameOver){
            if (isPaused) resumeGame();
            else pauseGame(false);
          }
          return;
        }

        if (e.code === "Space" || e.code === "ArrowUp") {
          e.preventDefault();
          handleJump();
          registerCheat(e.code);
        } else if (e.code === "ArrowDown") {
          e.preventDefault();
          setDuck(true);
          registerCheat(e.code);
        }
      });

      document.addEventListener("keyup", (e) => {
        if (e.code === "ArrowDown") setDuck(false);
      });

      // touch buttons
      btnJump.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        handleJump();
        registerCheat("Space");
      });

      btnDuck.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        setDuck(true);
        registerCheat("ArrowDown");
      });
      btnDuck.addEventListener("pointerup", (e) => { e.preventDefault(); setDuck(false); });
      btnDuck.addEventListener("pointercancel",(e)=> { e.preventDefault(); setDuck(false); });
      btnDuck.addEventListener("pointerleave", () => { if (isDucking) setDuck(false); });

      // =========================
      // Init
      // =========================
      function updateBestUI(){
        bestScoreEl.textContent = "‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: " + bestScore;
      }

      updateBestUI();
      updateCoinsUI();
      updateEnergyUI();
      updateMissionUI();
      updateSoundBtnUI();
      prepareNewRun();
    })();
  </script>
</body>
</html>
