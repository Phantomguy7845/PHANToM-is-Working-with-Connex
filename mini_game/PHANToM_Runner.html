<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>PHANToM Runner</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #020617;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 40px;
    }

    h1 {
      margin-bottom: 8px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    #hint {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 12px;
      text-align: center;
    }

    #gameContainer {
      position: relative;
      width: 800px;
      max-width: 95vw;
      height: 260px;
      border: 2px solid #4b5563;
      overflow: hidden;
      border-radius: 16px;
      background: radial-gradient(circle at top, #1d2337 0, #020617 55%, #020617 100%);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.9);
    }

    #ground {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 200%;
      height: 40px;
      background: repeating-linear-gradient(
        -45deg,
        #6b7280 0,
        #6b7280 12px,
        #4b5563 12px,
        #4b5563 24px
      );
      animation: groundMove 1s linear infinite;
      opacity: 0.9;
      z-index: 1;
    }

    @keyframes groundMove {
      from { transform: translateX(0); }
      to   { transform: translateX(-50%); }
    }

    /* ==== ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ==== */
    #player {
      position: absolute;
      bottom: 40px;
      left: 80px;
      width: 60px;
      height: 60px;
      transform-origin: center bottom;
      transition: transform 0.08s ease, box-shadow 0.15s ease, width 0.12s ease, height 0.12s ease;
      box-shadow: 0 0 20px rgba(56, 189, 248, 0.85);
      z-index: 5;
    }

    #player img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
      user-select: none;
      filter: drop-shadow(0 0 10px rgba(15,23,42,0.9));
    }

    /* ‡∏´‡∏°‡∏≠‡∏ö */
    #player.duck {
      transform: translateY(-8px) scaleY(0.7);
      box-shadow: 0 0 14px rgba(56, 189, 248, 0.9);
    }

    /* ‡∏≠‡∏°‡∏ï‡∏∞ (‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏Å‡∏á / Boost) */
    #player.invincible {
      box-shadow:
        0 0 26px rgba(250, 204, 21, 1),
        0 0 70px rgba(250, 204, 21, 0.7);
    }

    /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏£‡πà‡∏≤‡∏á (Giant) */
    #player.giant {
      width: 80px;
      height: 80px;
      box-shadow:
        0 0 26px rgba(59,130,246,1),
        0 0 70px rgba(59,130,246,0.7);
    }

    /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå double jump: ‡∏´‡∏°‡∏∏‡∏ô‡∏ï‡∏±‡∏ß */
    #player.double-jump img {
      animation: djumpSpin 0.35s linear;
    }

    @keyframes djumpSpin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    .obstacle {
      position: absolute;
      bottom: 40px;
      border-radius: 6px;
      box-shadow: 0 0 12px rgba(15, 23, 42, 1);
      z-index: 3;
    }

    .obstacle.ground.tree {
      background: linear-gradient(to top, #14532d, #16a34a);
      border-radius: 4px 4px 0 0;
    }

    .obstacle.ground.bush {
      background: linear-gradient(to top, #166534, #22c55e);
      border-radius: 16px;
    }

    .obstacle.ground.rock {
      background: radial-gradient(circle at 30% 20%, #9ca3af, #4b5563);
      border-radius: 40% 60% 30% 70%;
    }

    /* ‡∏ô‡∏Å (‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏°‡∏≠‡∏ö) = ‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏Ç‡πâ‡∏° */
    .obstacle.air.bird {
      background: linear-gradient(to bottom, #1f2937, #020617);
      border-radius: 4px;
      box-shadow: 0 0 10px rgba(15,23,42,0.95);
    }

    /* ‡∏û‡∏∑‡πâ‡∏ô/‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏ß‡∏¥‡πà‡∏á‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏î‡∏≤‡πÄ‡∏°‡∏à) */
    .platform {
      position: absolute;
      height: 10px;
      background: linear-gradient(to top, #020617, #111827);
      border-radius: 8px;
      box-shadow: 0 6px 14px rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.35);
      z-index: 2;
    }

    /* ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ: Coin / Hearts / Power-up */
    .collectible {
      position: absolute;
      z-index: 4;
    }

    .collectible.coin {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fef9c3, #facc15, #b45309);
      box-shadow: 0 0 12px rgba(250,204,21,0.9);
    }

    /* ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô (Energy) */
    .collectible.energy {
      --heart-scale: 1;
      width: 18px;
      height: 18px;
      background: radial-gradient(circle at 30% 20%, #fecaca, #ef4444, #b91c1c);
      position: absolute;
      transform: rotate(-45deg) scale(var(--heart-scale));
      border-radius: 4px;
      box-shadow: 0 0 12px rgba(248,113,113,0.95);
    }
    .collectible.energy::before,
    .collectible.energy::after {
      content: "";
      position: absolute;
      width: 100%;
      height: 100%;
      background: inherit;
      border-radius: 50%;
    }
    .collectible.energy::before {
      top: -50%;
      left: 0;
    }
    .collectible.energy::after {
      left: 50%;
      top: 0;
    }
    .collectible.energy.small  { --heart-scale: 0.8; }
    .collectible.energy.medium { --heart-scale: 1.0; }
    .collectible.energy.large  { --heart-scale: 1.3; }

    /* Magnet */
    .collectible.magnet {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #e0f2fe, #38bdf8, #0369a1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 12px rgba(56,189,248,0.95);
    }
    .collectible.magnet::before,
    .collectible.magnet::after {
      content: "";
      position: absolute;
      width: 40%;
      height: 60%;
      border-radius: 999px 999px 0 0;
      background: #0f172a;
      top: 25%;
    }
    .collectible.magnet::before {
      left: 16%;
    }
    .collectible.magnet::after {
      right: 16%;
    }

    /* Boost (Speed up + ‡∏≠‡∏°‡∏ï‡∏∞) */
    .collectible.boost {
      width: 24px;
      height: 14px;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #a3e635);
      box-shadow: 0 0 14px rgba(34,197,94,0.95);
      transform: skewX(-20deg);
    }

    /* Giant (‡∏Ç‡∏¢‡∏≤‡∏¢‡∏£‡πà‡∏≤‡∏á) */
    .collectible.giant {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #e0e7ff, #6366f1, #312e81);
      box-shadow: 0 0 14px rgba(129,140,248,0.95);
    }

    /* Energy bar */
    #energyContainer {
      margin-top: 10px;
      width: 800px;
      max-width: 95vw;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    #energyLabel {
      font-size: 11px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    #energyBarWrapper {
      flex: 1;
      height: 12px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #4b5563;
      overflow: hidden;
      box-shadow: 0 0 8px rgba(15,23,42,0.9);
    }

    #energyBar {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #22c55e, #facc15, #fb923c);
      box-shadow: 0 0 12px rgba(250,204,21,0.8);
      transition: width 0.15s ease;
    }

    #energyText {
      width: 70px;
      text-align: right;
      font-size: 11px;
      color: #e5e7eb;
    }

    #scoreBoard {
      margin-top: 10px;
      font-size: 15px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: center;
    }

    #coins {
      color: #facc15;
    }

    #cheatTimer {
      margin-top: 4px;
      font-size: 14px;
      min-height: 20px;
      color: #facc15;
      text-shadow: 0 0 8px rgba(250, 204, 21, 0.9);
    }

    #mission {
      margin-top: 6px;
      font-size: 12px;
      color: #9ca3af;
      max-width: 800px;
      text-align: center;
    }

    #message {
      margin-top: 6px;
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
      max-width: 800px;
    }

    #startBtn {
      margin-top: 14px;
      padding: 8px 22px;
      border: none;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      background: linear-gradient(to right, #22c55e, #2dd4bf);
      color: #022c22;
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.35);
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s;
    }

    #startBtn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(34, 197, 94, 0.55);
      filter: brightness(1.05);
    }

    #startBtn:active {
      transform: translateY(1px);
      box-shadow: 0 6px 16px rgba(34, 197, 94, 0.4);
      filter: brightness(0.98);
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
    #touchControls {
      margin-top: 14px;
      width: 800px;
      max-width: 95vw;
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .ctrl-btn {
      flex: 1;
      padding: 12px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: radial-gradient(circle at 20% 0, #1f2937, #020617);
      color: #e5e7eb;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.04em;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(15,23,42,0.9);
      text-transform: uppercase;
    }

    .ctrl-btn span {
      font-size: 11px;
      display: block;
      opacity: 0.7;
      margin-top: 2px;
    }

    .ctrl-btn:hover {
      border-color: #38bdf8;
      box-shadow: 0 0 14px rgba(56,189,248,0.7);
    }

    .ctrl-btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 4px 10px rgba(15,23,42,0.9);
    }

    @media (max-width: 600px) {
      #gameContainer { height: 230px; }
      #player { left: 40px; }

      #touchControls {
        margin-top: 12px;
        gap: 8px;
      }

      .ctrl-btn {
        padding: 10px 8px;
        font-size: 13px;
      }

      #energyContainer {
        font-size: 12px;
      }

      #energyText {
        width: 54px;
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <h1>PHANToM Runner</h1>
  <div id="hint">
    Space / ‚Üë = ‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î (2 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞) ‚Ä¢ ‚Üì = ‡∏´‡∏°‡∏≠‡∏ö ‚Ä¢ ‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏•‡∏≠‡∏¢/‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏ö ‚Ä¢ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç / ‡∏´‡∏±‡∏ß‡πÉ‡∏à / Magnet / Boost(‡∏≠‡∏°‡∏ï‡∏∞) / Giant
  </div>

  <div id="gameContainer">
    <div id="ground"></div>
    <div id="player">
      <!-- ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á -->
      <img src="phantom-runner.png" alt="PHANToM" />
    </div>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏° -->
  <div id="touchControls">
    <button id="btnJump" class="ctrl-btn">
      ‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î
      <span>JUMP / SPACE</span>
    </button>
    <button id="btnDuck" class="ctrl-btn">
      ‡∏´‡∏°‡∏≠‡∏ö
      <span>DUCK / ‚Üì</span>
    </button>
  </div>

  <!-- Energy bar -->
  <div id="energyContainer">
    <div id="energyLabel">Energy</div>
    <div id="energyBarWrapper">
      <div id="energyBar"></div>
    </div>
    <div id="energyText">100 / 100</div>
  </div>

  <div id="scoreBoard">
    <div id="score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</div>
    <div id="coins">‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç: 0</div>
    <div id="bestScore">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: 0</div>
  </div>
  <div id="cheatTimer"></div>
  <div id="mission"></div>
  <div id="message">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° / ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà" ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
  <button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° / ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>

  <script>
    (function () {
      const gameContainer = document.getElementById("gameContainer");
      const player = document.getElementById("player");
      const scoreEl = document.getElementById("score");
      const bestScoreEl = document.getElementById("bestScore");
      const messageEl = document.getElementById("message");
      const startBtn = document.getElementById("startBtn");
      const cheatTimerEl = document.getElementById("cheatTimer");
      const btnJump = document.getElementById("btnJump");
      const btnDuck = document.getElementById("btnDuck");
      const energyBar = document.getElementById("energyBar");
      const energyText = document.getElementById("energyText");
      const coinsEl = document.getElementById("coins");
      const missionEl = document.getElementById("mission");

      const groundY = 40;

      // ‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î + Double Jump
      const gravity = 0.6;
      const jumpStrength = 11;
      const maxJumps = 2;
      let playerY = groundY;
      let prevPlayerY = groundY;
      let isJumping = false;
      let jumpVelocity = 0;
      let jumpsLeft = maxJumps;

      // ‡∏´‡∏°‡∏≠‡∏ö
      let isDucking = false;

      // Energy
      const maxEnergy = 100;
      let energy = maxEnergy;
      const energyDecayPerSec = 4; // ‡∏û‡∏•‡∏±‡∏á‡∏•‡∏î‡πÄ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      const damageGround = 25;     // ‡∏ä‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô
      const damageAir = 35;        // ‡∏ä‡∏ô‡∏ô‡∏Å/‡∏≠‡∏≤‡∏Å‡∏≤‡∏®

      // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô + ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç + ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à
      let score = 0;
      let bestScore = Number(localStorage.getItem("phantom_runner_best") || 0);
      let coins = 0;
      let coinsCollected = 0;
      let totalDoubleJumps = 0;
      let obstaclesPassed = 0;

      const MISSION_COIN_TARGET = 20;
      const MISSION_DJ_TARGET = 10;
      const MISSION_OBS_TARGET = 30;

      bestScoreEl.textContent = "‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: " + bestScore;

      // ‡πÄ‡∏Å‡∏°
      let obstacles = [];
      let collectibles = [];
      let platforms = [];
      let speed = 6;
      const BOOST_MULTIPLIER = 1.6;

      let gameOver = false;
      let frameId = null;
      let lastTime = null;

      let timeSinceLastObstacle = 0;
      let nextSpawnIn = 1000;

      let timeSinceLastCollectible = 0;

      let timeSinceLastPlatform = 0;
      let nextPlatformIn = 2500;

      // ‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏Å‡∏á/‡∏≠‡∏°‡∏ï‡∏∞‡∏£‡∏ß‡∏°
      let invincible = false;
      let invincibleTimer = 0;
      const CHEAT_INVINCIBLE_DURATION = 10000; // 10 ‡∏ß‡∏¥ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£‡πÇ‡∏Å‡∏á

      // Power-ups
      let magnetActive = false;
      let magnetTimer = 0;
      const MAGNET_DURATION = 10000;
      const MAGNET_RADIUS = 260;

      let boostActive = false;
      let boostTimer = 0;
      const BOOST_DURATION = 5000;

      let giantActive = false;
      let giantTimer = 0;
      const GIANT_DURATION = 6000;

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£‡πÇ‡∏Å‡∏á
      const CHEAT_WINDOW = 1000; // 1 ‡∏ß‡∏¥
      let cheatEvents = []; // {symbol: 'D'|'U', time}

      function randomBetween(min, max) {
        return Math.random() * (max - min) + min;
      }

      function updateEnergyUI() {
        const ratio = Math.max(0, Math.min(1, energy / maxEnergy));
        energyBar.style.width = (ratio * 100) + "%";
        energyText.textContent = Math.round(energy) + " / " + maxEnergy;
      }

      function updateMissionUI() {
        if (!missionEl) return;
        missionEl.textContent =
          "Mission: ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç " + coinsCollected + "/" + MISSION_COIN_TARGET +
          " ‚Ä¢ Double Jump " + totalDoubleJumps + "/" + MISSION_DJ_TARGET +
          " ‚Ä¢ ‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ " + obstaclesPassed + "/" + MISSION_OBS_TARGET;
      }

      function clearArrays() {
        obstacles.forEach(o => o.remove());
        obstacles = [];
        collectibles.forEach(c => c.remove());
        collectibles = [];
        platforms.forEach(p => p.remove());
        platforms = [];
      }

      function resetGame() {
        clearArrays();

        score = 0;
        coins = 0;
        coinsCollected = 0;
        totalDoubleJumps = 0;
        obstaclesPassed = 0;
        speed = 6;

        scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
        coinsEl.textContent = "‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç: " + coins;

        gameOver = false;

        isJumping = false;
        isDucking = false;
        playerY = groundY;
        prevPlayerY = groundY;
        jumpVelocity = 0;
        jumpsLeft = maxJumps;
        player.style.bottom = playerY + "px";
        player.classList.remove("duck", "invincible", "giant", "double-jump");

        invincible = false;
        invincibleTimer = 0;
        cheatEvents = [];
        cheatTimerEl.textContent = "";

        magnetActive = false;
        magnetTimer = 0;
        boostActive = false;
        boostTimer = 0;
        giantActive = false;
        giantTimer = 0;

        energy = maxEnergy;
        updateEnergyUI();

        timeSinceLastObstacle = 0;
        nextSpawnIn = 800 + Math.random() * 600;
        timeSinceLastCollectible = 0;

        timeSinceLastPlatform = 0;
        nextPlatformIn = 2000 + Math.random() * 2000;

        updateMissionUI();

        messageEl.textContent = "‡∏´‡∏•‡∏ö‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ/‡∏Å‡πâ‡∏≠‡∏ô‡∏´‡∏¥‡∏ô (‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î) ‡πÅ‡∏•‡∏∞‡∏ô‡∏Å (‡∏´‡∏°‡∏≠‡∏ö) ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!";

        if (frameId) cancelAnimationFrame(frameId);
        lastTime = null;
        frameId = requestAnimationFrame(gameLoop);

        spawnObstacle();
      }

      function spawnObstacle() {
        const obs = document.createElement("div");
        obs.classList.add("obstacle");

        const isAir = Math.random() < 0.35; // 35% ‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏Å

        if (isAir) {
          obs.classList.add("air", "bird");
          const height = randomBetween(24, 32);
          const width = randomBetween(34, 40);
          obs.style.width = width + "px";
          obs.style.height = height + "px";
          const bottom = randomBetween(95, 125);
          obs.style.bottom = bottom + "px";
        } else {
          obs.classList.add("ground");
          const types = ["tree", "bush", "rock"];
          const kind = types[Math.floor(Math.random() * types.length)];
          obs.classList.add(kind);

          const height = randomBetween(45, 80);
          const width = randomBetween(22, 40);
          obs.style.width = width + "px";
          obs.style.height = height + "px";
          obs.style.bottom = groundY + "px";
        }

        obs.style.left = gameContainer.offsetWidth + "px";
        gameContainer.appendChild(obs);
        obstacles.push(obs);
      }

      function spawnCollectible() {
        const c = document.createElement("div");
        c.classList.add("collectible");

        const r = Math.random();
        if (r < 0.55) {
           c.classList.add("coin");
        } else if (r < 0.70) {
           c.classList.add("energy");
           const sizes = ["small","medium","large"];
           const gains = [15, 25, 40];
           const idx = Math.floor(Math.random() * sizes.length);
           c.classList.add(sizes[idx]);
           c.dataset.energy = gains[idx];
        } else if (r < 0.85) {
           c.classList.add("magnet");
        } else if (r < 0.93) {
           c.classList.add("boost");
        } else {
           c.classList.add("giant");
        }

        const lane = Math.floor(Math.random() * 3); // 0 = ‡∏ï‡πà‡∏≥, 1 = ‡∏Å‡∏•‡∏≤‡∏á, 2 = ‡∏™‡∏π‡∏á
        let bottom;
        if (lane === 0) bottom = groundY + 60;
        else if (lane === 1) bottom = groundY + 110;
        else bottom = groundY + 150;

        c.style.bottom = bottom + "px";
        c.style.left = gameContainer.offsetWidth + "px";

        gameContainer.appendChild(c);
        collectibles.push(c);
      }

      function spawnPlatformGroup() {
        const num = Math.random() < 0.5 ? 2 : 3;
        const baseBottom = groundY + randomBetween(45, 130);
        const step = 24;
        const goingUp = Math.random() < 0.5;
        const baseLeft = gameContainer.offsetWidth + 80;

        for (let i = 0; i < num; i++) {
          const p = document.createElement("div");
          p.classList.add("platform");
          const width = randomBetween(80, 150);
          const spacing = 20;
          const left = baseLeft + i * (width + spacing);
          const bottom = baseBottom + (goingUp ? i : -i) * step;

          p.style.width = width + "px";
          p.style.left = left + "px";
          p.style.bottom = bottom + "px";

          gameContainer.appendChild(p);
          platforms.push(p);
        }
      }

      function updateObstacles(delta) {
        const moveX = speed * (boostActive ? BOOST_MULTIPLIER : 1) * (delta / 16.67);
        const toRemove = [];

        obstacles.forEach((obs, index) => {
          if (gameOver) return;

          const left = parseFloat(obs.style.left);
          const newLeft = left - moveX;
          obs.style.left = newLeft + "px";

          if (newLeft + obs.offsetWidth < 0) {
            toRemove.push(index);
            score += 1;
            obstaclesPassed += 1;
            scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
            updateMissionUI();

            if (score % 5 === 0) {
              speed += 0.5;
            }
          }

          if (!gameOver && isColliding(player, obs)) {
            if (invincible || giantActive) {
              // Giant ‡∏´‡∏£‡∏∑‡∏≠ Boost/‡πÇ‡∏Å‡∏á ‡∏ä‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡∏•‡∏≤‡∏¢
              score += 2;
              obstaclesPassed += 1;
              scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
              updateMissionUI();
              toRemove.push(index);
            } else {
              const isAir = obs.classList.contains("air");
              const dmg = isAir ? damageAir : damageGround;
              energy -= dmg;
              if (energy <= 0) {
                energy = 0;
                updateEnergyUI();
                endGame();
                return;
              } else {
                updateEnergyUI();
                obs.style.opacity = "0.4";
                setTimeout(() => { if (obs && obs.style) obs.style.opacity = "1"; }, 100);
              }
            }
          }
        });

        toRemove.reverse().forEach(i => {
          if (obstacles[i]) obstacles[i].remove();
          obstacles.splice(i, 1);
        });

        timeSinceLastObstacle += delta;

        const minInterval = Math.max(550, 1000 - score * 5);
        const maxInterval = Math.max(minInterval + 300, 1600 - score * 8);

        if (timeSinceLastObstacle >= nextSpawnIn) {
          let canSpawn = true;
          if (obstacles.length > 0) {
            const lastObs = obstacles[obstacles.length - 1];
            const lastRect = lastObs.getBoundingClientRect();
            const containerRect = gameContainer.getBoundingClientRect();
            const distance = containerRect.right - lastRect.right;
            if (distance < 180) {
              canSpawn = false;
            }
          }

          if (canSpawn) {
            spawnObstacle();
            timeSinceLastObstacle = 0;
            nextSpawnIn = randomBetween(minInterval, maxInterval);
          } else {
            timeSinceLastObstacle = minInterval - 50;
          }
        }
      }

      function updatePlatforms(delta) {
        const moveX = speed * (boostActive ? BOOST_MULTIPLIER : 1) * (delta / 16.67);
        const toRemove = [];

        platforms.forEach((p, index) => {
          const left = parseFloat(p.style.left);
          const newLeft = left - moveX;
          p.style.left = newLeft + "px";

          if (newLeft + p.offsetWidth < 0) {
            toRemove.push(index);
          }
        });

        toRemove.reverse().forEach(i => {
          if (platforms[i]) platforms[i].remove();
          platforms.splice(i, 1);
        });

        timeSinceLastPlatform += delta;
        if (timeSinceLastPlatform >= nextPlatformIn) {
          if (platforms.length < 10) {
            spawnPlatformGroup();
          }
          timeSinceLastPlatform = 0;
          nextPlatformIn = 2000 + Math.random() * 2500;
        }
      }

      function updateCollectibles(delta) {
        const moveX = speed * (boostActive ? BOOST_MULTIPLIER : 1) * (delta / 16.67);
        const toRemove = [];

        let playerCenterX = 0;
        let playerCenterY = 0;
        if (magnetActive) {
          const pr = player.getBoundingClientRect();
          playerCenterX = pr.left + pr.width / 2;
          playerCenterY = pr.top + pr.height / 2;
        }

        collectibles.forEach((c, index) => {
          const left = parseFloat(c.style.left);
          const newLeft = left - moveX;
          c.style.left = newLeft + "px";

          if (newLeft + c.offsetWidth < 0) {
            toRemove.push(index);
            return;
          }

          let collected = false;

          if (!gameOver) {
            if (magnetActive && (c.classList.contains("coin") || c.classList.contains("energy"))) {
              const cr = c.getBoundingClientRect();
              const cx = cr.left + cr.width / 2;
              const cy = cr.top + cr.height / 2;
              const dx = playerCenterX - cx;
              const dy = playerCenterY - cy;
              const dist = Math.hypot(dx, dy);
              if (dist < MAGNET_RADIUS) {
                collected = true;
              }
            }

            if (!collected && isColliding(player, c)) {
              collected = true;
            }
          }

          if (collected) {
            if (c.classList.contains("coin")) {
              coins += 1;
              coinsCollected += 1;
              score += 2;
              coinsEl.textContent = "‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç: " + coins;
              scoreEl.textContent = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score;
            } else if (c.classList.contains("energy")) {
              const gain = parseInt(c.dataset.energy || "20", 10);
              energy = Math.min(maxEnergy, energy + gain);
              updateEnergyUI();
            } else if (c.classList.contains("magnet")) {
              magnetActive = true;
              magnetTimer = MAGNET_DURATION;
              messageEl.textContent = "Magnet: ‡∏î‡∏π‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏£‡∏≠‡∏ö ‡πÜ ‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏ß‡πâ‡∏≤‡∏á ‚ú®";
            } else if (c.classList.contains("boost")) {
              boostActive = true;
              boostTimer = BOOST_DURATION;
              invincible = true;
              // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏°‡∏ï‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î
              invincibleTimer = Math.max(invincibleTimer, BOOST_DURATION);
              cheatTimerEl.textContent = "Boost: ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏≠‡∏°‡∏ï‡∏∞‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‚ö°";
              messageEl.textContent = "Boost: ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏≠‡∏°‡∏ï‡∏∞‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‚ö°";
            } else if (c.classList.contains("giant")) {
              giantActive = true;
              giantTimer = GIANT_DURATION;
              player.classList.add("giant");
              messageEl.textContent = "Giant: PHANToM ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà ‡∏ä‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á‡πÅ‡∏ï‡∏Å‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢ üí•";
            }

            updateMissionUI();
            toRemove.push(index);
          }
        });

        toRemove.reverse().forEach(i => {
          if (collectibles[i]) collectibles[i].remove();
          collectibles.splice(i, 1);
        });

        timeSinceLastCollectible += delta;
        const baseInterval = 900;
        const minInterval = 500;
        const interval = Math.max(minInterval, baseInterval - score * 4);

        if (timeSinceLastCollectible >= interval) {
          spawnCollectible();
          timeSinceLastCollectible = 0;
        }
      }

      function isColliding(a, b) {
        const r1 = a.getBoundingClientRect();
        const r2 = b.getBoundingClientRect();
        return !(
          r1.right < r2.left ||
          r1.left > r2.right ||
          r1.bottom < r2.top ||
          r1.top > r2.bottom
        );
      }

      function updatePlayer(delta) {
        const factor = delta / 16.67;
        prevPlayerY = playerY;

        // ‡πÉ‡∏ä‡πâ‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤
        jumpVelocity -= gravity * factor;
        playerY += jumpVelocity * factor;

        let supportY = groundY;
        const isFalling = jumpVelocity <= 0;

        const playerRect = player.getBoundingClientRect();
        const playerLeft = playerRect.left;
        const playerRight = playerRect.right;

        platforms.forEach(p => {
          const pRect = p.getBoundingClientRect();
          const pLeft = pRect.left;
          const pRight = pRect.right;

          const platformBottom = parseFloat(p.style.bottom);
          const platformTop = platformBottom + p.offsetHeight;

          const horizontallyOver = (playerRight > pLeft + 5) && (playerLeft < pRight - 5);

          if (horizontallyOver && isFalling && prevPlayerY >= platformTop && playerY <= platformTop) {
            if (platformTop > supportY) {
              supportY = platformTop;
            }
          }
        });

        if (playerY <= supportY) {
          playerY = supportY;
          jumpVelocity = 0;
          isJumping = false;
          jumpsLeft = maxJumps;
        } else {
          isJumping = true;
        }

        player.style.bottom = playerY + "px";
      }

      function gameLoop(timestamp) {
        if (gameOver) return;
        if (!lastTime) lastTime = timestamp;
        const delta = timestamp - lastTime;
        lastTime = timestamp;

        // Energy ‡∏•‡∏î‡πÄ‡∏≠‡∏á (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏°‡∏ï‡∏∞)
        if (!invincible) {
          energy -= energyDecayPerSec * (delta / 1000);
          if (energy <= 0) {
            energy = 0;
            updateEnergyUI();
            endGame();
            return;
          }
        }
        updateEnergyUI();

        updatePlayer(delta);
        updatePlatforms(delta);
        updateObstacles(delta);
        updateCollectibles(delta);

        // ‡∏≠‡∏°‡∏ï‡∏∞ (‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÇ‡∏Å‡∏á + Boost)
        if (invincible) {
          invincibleTimer -= delta;
          if (invincibleTimer <= 0) {
            invincible = false;
            player.classList.remove("invincible");
            cheatTimerEl.textContent = "";
            if (!boostActive) {
              messageEl.textContent = "‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏°‡∏ï‡∏∞‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏µ üòà";
            }
          } else {
            if (invincibleTimer <= 3000) {
              const secs = Math.ceil(invincibleTimer / 1000);
              cheatTimerEl.textContent = "‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏°‡∏ï‡∏∞: " + secs + " ‡∏ß‡∏¥";
            }
          }
        }

        // Magnet timer
        if (magnetActive) {
          magnetTimer -= delta;
          if (magnetTimer <= 0) {
            magnetActive = false;
          }
        }

        // Boost timer
        if (boostActive) {
          boostTimer -= delta;
          if (boostTimer <= 0) {
            boostActive = false;
          }
        }

        // Giant timer
        if (giantActive) {
          giantTimer -= delta;
          if (giantTimer <= 0) {
            giantActive = false;
            player.classList.remove("giant");
          }
        }

        frameId = requestAnimationFrame(gameLoop);
      }

      function endGame() {
        if (gameOver) return;
        gameOver = true;
        if (frameId) cancelAnimationFrame(frameId);

        if (score > bestScore) {
          bestScore = score;
          localStorage.setItem("phantom_runner_best", bestScore);
        }
        bestScoreEl.textContent = "‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: " + bestScore;

        cheatTimerEl.textContent = "";
        messageEl.textContent =
          "Game Over! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: " + score +
          " ‚Ä¢ ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç: " + coins +
          ' ‚Ä¢ ‡∏Å‡∏î "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° / ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà" ‡∏´‡∏£‡∏∑‡∏≠ Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà';
      }

      function handleJump() {
        if (gameOver) {
          resetGame();
          return;
        }
        if (jumpsLeft > 0) {
          if (isDucking) {
            setDuck(false);
          }
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ó‡∏µ‡πà 2 = Double Jump (‡∏°‡∏µ 1 ‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î)
          if (jumpsLeft === 1) {
            totalDoubleJumps += 1;
            updateMissionUI();
            // ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó animation double-jump
            player.classList.remove("double-jump");
            void player.offsetWidth; // force reflow
            player.classList.add("double-jump");
          }
          isJumping = true;
          jumpVelocity = jumpStrength;
          jumpsLeft -= 1;
        }
      }

      function setDuck(state) {
        if (gameOver) return;
        if (state && !isDucking) {
          isDucking = true;
          player.classList.add("duck");
        } else if (!state && isDucking) {
          isDucking = false;
          player.classList.remove("duck");
        }
      }

      // ‚Üì‚Üì‚Üì ‡∏™‡∏π‡∏ï‡∏£‡πÇ‡∏Å‡∏á: DDD UUU (U = ‚Üë ‡∏´‡∏£‡∏∑‡∏≠ Space)
      function registerCheat(code) {
        const now = performance.now();
        if (code !== "ArrowDown" && code !== "ArrowUp" && code !== "Space") return;

        const symbol = (code === "ArrowDown") ? "D" : "U";
        cheatEvents.push({ symbol, time: now });

        const cutoff = now - CHEAT_WINDOW;
        cheatEvents = cheatEvents.filter(e => e.time >= cutoff);

        const lastSix = cheatEvents.slice(-6);
        if (lastSix.length === 6) {
          const pattern = lastSix.map(e => e.symbol).join("");
          if (pattern === "DDDUUU" && !gameOver) {
            activateCheat();
            cheatEvents = [];
          }
        }
      }

      function activateCheat() {
        invincible = true;
        invincibleTimer = Math.max(invincibleTimer, CHEAT_INVINCIBLE_DURATION);
        player.classList.add("invincible");
        cheatTimerEl.textContent = "‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏Å‡∏á: PHANToM ‡∏≠‡∏°‡∏ï‡∏∞ 10 ‡∏ß‡∏¥ üéÉ";
        messageEl.textContent = "‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏Å‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡∏ä‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏¢ 10 ‡∏ß‡∏¥";
      }

      // ‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î
      document.addEventListener("keydown", (e) => {
        if (e.code === "Space" || e.code === "ArrowUp") {
          e.preventDefault();
          handleJump();
          registerCheat(e.code); // Space/‚Üë ‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô U
        } else if (e.code === "ArrowDown") {
          e.preventDefault();
          setDuck(true);
          registerCheat(e.code);
        }
      });

      document.addEventListener("keyup", (e) => {
        if (e.code === "ArrowDown") {
          setDuck(false);
        }
      });

      // ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡πÄ‡∏°‡∏≤‡∏™‡πå + ‡∏ó‡∏±‡∏ä)
      if (btnJump) {
        btnJump.addEventListener("pointerdown", (e) => {
          e.preventDefault();
          handleJump();
          registerCheat("Space");
        });
      }

      if (btnDuck) {
        btnDuck.addEventListener("pointerdown", (e) => {
          e.preventDefault();
          setDuck(true);
          registerCheat("ArrowDown");
        });
        btnDuck.addEventListener("pointerup", (e) => {
          e.preventDefault();
          setDuck(false);
        });
        btnDuck.addEventListener("pointercancel", (e) => {
          e.preventDefault();
          setDuck(false);
        });
        btnDuck.addEventListener("pointerleave", (e) => {
          if (isDucking) setDuck(false);
        });
      }

      startBtn.addEventListener("click", resetGame);

      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ UI ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      updateEnergyUI();
      updateMissionUI();
    })();
  </script>
</body>
</html>
