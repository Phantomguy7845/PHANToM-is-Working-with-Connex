<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>PHANToM Runner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root{
      --bg1: #020617;
      --bg2: #020617;
      --surface: rgba(15,23,42,0.96);
      --accent: #22d3ee;
      --accent-soft: rgba(56,189,248,0.22);
      --accent-2: #a855f7;
      --accent-amber: #fbbf24;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --danger: #fb7185;
      --energy-high: #22c55e;
      --energy-mid: #eab308;
      --energy-low: #fb7185;
      --glass-bg: rgba(15,23,42,0.45);
      --glass-border: rgba(148,163,184,0.6);
      --glass-highlight: rgba(248,250,252,0.9);
      --shadow-soft: 0 18px 40px rgba(15,23,42,0.88);
      --shadow-pill: 0 10px 26px rgba(15,23,42,0.85);
      --transition-fast: 0.2s ease-out;
      --transition-med: 0.28s ease;
    }

    body{
      min-height: 100vh;
      background:
        radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
      font-family: "Prompt", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 18px 8px 24px;
    }

    #app{
      width: 100%;
      max-width: 1180px;
    }

    h1{
      font-size: clamp(1.55rem, 1.1vw + 1.2rem, 1.9rem);
      letter-spacing: .12em;
      text-transform: uppercase;
      color:#f9fafb;
      text-shadow:
        0 0 14px rgba(94,234,212,0.6),
        0 0 40px rgba(56,189,248,0.55);
      margin-bottom: 6px;
    }

    .sub-title{
      font-size: .9rem;
      color: var(--text-sub);
      margin-bottom: 12px;
    }

    .shell{
      background: linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.86));
      border-radius: 22px;
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 18px;
      border: 1px solid rgba(148,163,184,0.45);
    }

    /* -------- GAME AREA -------- */

    #gameFrame{
      position: relative;
      width: 100%;
      border-radius: 20px;
      overflow: hidden;
      background: radial-gradient(circle at 10% 0%, #111827, #020617);
      border: 1px solid rgba(148,163,184,0.4);
    }

    #gameContainer{
      position: relative;
      width: 100%;
      /* ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á 1333 x 600 / 2400 x1080 (‚âà20:9) */
      aspect-ratio: 20 / 9;
      overflow: hidden;
      background: radial-gradient(circle at 0% 0%, #1f2937 0, #020617 45%, #000 100%);
      isolation: isolate;
      touch-action: none; /* ‡πÉ‡∏´‡πâ pointer ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏° */
    }

    /* background scrolling layer */
    .bg-layer{
      position:absolute;
      inset:0;
      background-image:
        linear-gradient(to bottom, rgba(15,23,42,0.4), rgba(0,0,0,0.9)),
        url("https://images.pexels.com/photos/257360/pexels-photo-257360.jpeg?auto=compress&cs=tinysrgb&w=1200");
      background-size: cover;
      background-position: center;
      filter: saturate(1.3) contrast(1.05);
      opacity: .46;
      z-index: 0;
    }

    .bg-layer::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        repeating-linear-gradient(
          to right,
          rgba(15,23,42,0.35) 0,
          rgba(15,23,42,0.35) 1px,
          transparent 1px,
          transparent 24px
        );
      mix-blend-mode: soft-light;
      opacity:.75;
      pointer-events:none;
    }

    /* top HUD bar */
    #inGameTopBar{
      position:absolute;
      top:10px;
      left:10px;
      right:10px;
      z-index:20;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      pointer-events:none;
    }

    .ig-left,
    .ig-right{
      display:flex;
      gap:8px;
      align-items:flex-start;
      pointer-events:none;
    }

    .ig-pill{
      pointer-events:auto;
      border-radius: 999px;
      padding: 6px 12px;
      background: linear-gradient(135deg, rgba(15,23,42,0.96), rgba(15,23,42,0.82));
      border: 1px solid rgba(148,163,184,0.72);
      box-shadow: var(--shadow-pill);
      display:flex;
      align-items:center;
      gap:8px;
      font-size:.78rem;
      white-space:nowrap;
    }

    .energy-bar{
      position:relative;
      width: 150px;
      height: 9px;
      border-radius:999px;
      overflow:hidden;
      background:rgba(15,23,42,0.92);
      border:1px solid rgba(15,23,42,1);
    }
    .energy-fill{
      position:absolute;
      inset:0;
      width:60%;
      background: linear-gradient(90deg, #22c55e, #eab308, #fb7185);
      transform-origin:left center;
      transform:scaleX(1);
      transition: transform 0.1s linear;
    }

    .ig-stat-label{
      font-size:.75rem;
      color:var(--text-sub);
    }
    .ig-stat-value{
      font-weight:600;
      font-size:.86rem;
      color:#f9fafb;
    }

    .ig-right-col{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
      pointer-events:none;
    }

    .ig-right-top{
      display:flex;
      gap:6px;
      pointer-events:auto;
    }

    .ig-scorebox{
      font-size:.8rem;
      gap:12px;
    }

    .ig-scorebox span.label{
      color:var(--text-sub);
    }
    .ig-scorebox span.value{
      font-weight:600;
      color:#f9fafb;
      min-width:60px;
      text-align:right;
    }

    .ig-btn-icon{
      position:relative;
      width:28px;
      height:28px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background: radial-gradient(circle at 20% 0%, rgba(248,250,252,0.75), rgba(30,64,175,0.1));
      backdrop-filter: blur(14px);
      box-shadow: 0 8px 20px rgba(15,23,42,0.85);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.8rem;
      color:#020617;
      cursor:pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), border-color var(--transition-fast), opacity var(--transition-fast);
    }

    .ig-btn-icon span{
      pointer-events:none;
    }

    .ig-btn-icon:hover{
      transform: translateY(-1px);
      box-shadow:0 14px 28px rgba(15,23,42,0.95);
      border-color: rgba(248,250,252,0.9);
      background: radial-gradient(circle at 18% 0%, rgba(248,250,252,0.92), rgba(191,219,254,0.26));
    }

    .ig-btn-icon:active{
      transform: translateY(1px) scale(.96);
      box-shadow:0 6px 16px rgba(15,23,42,0.9);
    }

    .ig-btn-icon.muted{
      opacity:.5;
    }

    /* GAMEPLAY LAYERS */

    #ground{
      position:absolute;
      left:0;
      right:0;
      height:46px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡∏û‡∏∑‡πâ‡∏ô (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢ JS) */
      background: linear-gradient(to top, #0b1120, #111827);
      border-top: 2px solid rgba(148,163,184,0.7);
      box-shadow: 0 -6px 16px rgba(0,0,0,0.8);
      z-index:3;
    }

    #ground::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        repeating-linear-gradient(
          to right,
          rgba(15,23,42,0.9) 0,
          rgba(15,23,42,0.9) 18px,
          rgba(30,64,175,0.9) 18px,
          rgba(30,64,175,0.9) 22px
        );
      opacity:.7;
      mix-blend-mode:screen;
      pointer-events:none;
    }

    #entitiesLayer{
      position:absolute;
      inset:0;
      z-index:4;
      pointer-events:none;
    }

    #player{
      position:absolute;
      width:64px;
      height:72px;
      left:18%;
      bottom:120px; /* ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å override ‡∏î‡πâ‡∏ß‡∏¢ JS ‡πÑ‡∏õ‡∏ï‡∏≤‡∏° groundY */
      border-radius:18px;
      background: radial-gradient(circle at 30% 10%, #fde68a, #f97316);
      box-shadow:
        0 16px 30px rgba(15,23,42,0.9),
        0 0 0 2px rgba(15,23,42,0.85);
      overflow:hidden;
      z-index:10;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      transform-origin:50% 50%;
    }

    #player::before{
      content:"";
      position:absolute;
      inset:6px 8px 10px;
      border-radius:14px;
      background:
        radial-gradient(circle at 25% 0%, rgba(254,249,195,0.8), transparent 55%),
        radial-gradient(circle at 70% 10%, rgba(251,191,36,0.9), transparent 55%),
        linear-gradient(to bottom, rgba(248,250,252,0.3), rgba(248,250,252,0.02));
      mix-blend-mode:screen;
    }

    .player-silhouette{
      position:absolute;
      bottom:8px;
      left:50%;
      transform:translateX(-50%);
      width:30px;
      height:52px;
      border-radius:16px;
      background:linear-gradient(to bottom, rgba(15,23,42,0.3), rgba(15,23,42,0.95));
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.8),
        0 6px 12px rgba(15,23,42,0.9);
      overflow:hidden;
    }

    .player-silhouette::before{
      content:"";
      position:absolute;
      inset:6px 7px auto 7px;
      height:16px;
      border-radius:999px;
      background: radial-gradient(circle at 25% 0%, rgba(248,250,252,0.85), rgba(148,163,184,0.35));
    }

    .player-silhouette::after{
      content:"";
      position:absolute;
      inset:auto 4px 6px 4px;
      height:18px;
      border-radius:999px;
      background: radial-gradient(circle at 50% 0%, rgba(51,65,85,0.3), rgba(15,23,42,1));
    }

    .player-shadow{
      position:absolute;
      width:60px;
      height:18px;
      background: radial-gradient(circle, rgba(15,23,42,0.85), transparent 65%);
      bottom:-6px;
      left:50%;
      transform:translateX(-50%);
      filter:blur(1px);
      opacity:.9;
      z-index:-1;
    }

    #player.is-ducking .player-silhouette{
      height:40px;
      bottom:8px;
      transition:height 0.12s ease-out, bottom 0.12s ease-out;
    }
    #player.is-ducking .player-shadow{
      width:72px;
      height:18px;
      opacity:.95;
    }

    #player.hit-iframe{
      animation: player-blink 0.22s linear infinite;
    }

    #player.is-boost{
      box-shadow:
        0 0 0 2px rgba(248,250,252,0.9),
        0 0 24px rgba(56,189,248,0.9),
        0 20px 40px rgba(15,23,42,0.95);
    }
    #player.is-giant{
      transform:scale(1.2);
    }

    @keyframes player-blink{
      0%, 50% { opacity: .28; }
      51%,100% { opacity: 1; }
    }

    /* Collectibles, obstacles */

    .collectible,
    .obstacle,
    .hole{
      position:absolute;
      will-change:transform;
      pointer-events:none;
    }

    .collectible.jelly{
      width:26px;
      height:26px;
      border-radius:50%;
      background:
        radial-gradient(circle at 28% 18%, #fff7ed, #fed7aa 32%, #fdba74 48%, #fb923c 70%, #c2410c 100%);
      box-shadow:
        0 0 0 1px rgba(248,250,252,0.8),
        0 0 16px rgba(251,146,60,0.9);
    }

    .collectible.heart-small,
    .collectible.heart-medium,
    .collectible.heart-large{
      width:22px;
      height:22px;
      transform-origin:center;
    }

    .collectible.heart-small::before,
    .collectible.heart-medium::before,
    .collectible.heart-large::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 30% 30%, #fecaca, #f97373 45%, #be123c 80%);
      clip-path: path("M12 21s-6.5-3.8-9.6-8C-0.2 10 0 7.3 1.8 5.5 3.7 3.6 6.8 3.7 8.7 5.6L12 8.9l3.3-3.3c1.9-1.9 5-2 6.9-0.1C23.9 7.3 24.1 10 21.6 13c-3.1 4.2-9.6 8-9.6 8z");
    }

    .collectible.heart-medium{
      transform:scale(1.2);
      filter: drop-shadow(0 0 12px rgba(239,68,68,0.85));
    }
    .collectible.heart-large{
      transform:scale(1.6);
      filter: drop-shadow(0 0 18px rgba(250,204,21,0.95));
    }

    .collectible.magnet{
      width:30px;
      height:30px;
      border-radius:50%;
      background:
        radial-gradient(circle at 20% 0%, #fee2e2, #fecaca 45%, #ef4444 70%, #991b1b);
      box-shadow:
        0 0 0 1px rgba(248,250,252,0.9),
        0 0 20px rgba(248,113,113,0.95);
    }

    .collectible.boost,
    .collectible.giant{
      width:32px;
      height:32px;
      border-radius:10px;
      background: radial-gradient(circle at 20% 0%, #f9fafb, #bae6fd 44%, #0ea5e9 80%);
      box-shadow:
        0 0 0 1px rgba(219,234,254,0.9),
        0 0 20px rgba(56,189,248,0.95);
    }
    .collectible.giant{
      background: radial-gradient(circle at 20% 0%, #fef9c3, #fde68a 40%, #f97316 90%);
      box-shadow:
        0 0 0 1px rgba(254,249,195,0.9),
        0 0 24px rgba(251,191,36,0.95);
    }

    .obstacle.ground{
      width:40px;
      height:52px;
      border-radius:10px;
      background: linear-gradient(to top, #020617, #111827);
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.75),
        0 12px 20px rgba(15,23,42,0.95);
    }

    .obstacle.ceiling{
      width:46px;
      height:80px;
      border-radius:14px;
      background: linear-gradient(to bottom, #0f172a, #020617);
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.85),
        0 -12px 22px rgba(15,23,42,0.96);
    }

    .hole{
      width:120px;
      height:72px;
      background: radial-gradient(circle at 50% 60%, #020617 10%, #000 60%, transparent 72%);
      filter: blur(.4px);
      opacity:.95;
    }

    .hole::before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 50% 0%, rgba(15,23,42,0.15), transparent 70%);
      mix-blend-mode:screen;
    }

    /* mission bubble */
    #missionBubble{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top: 24%;
      z-index:6;
      padding: 7px 14px;
      border-radius:999px;
      background: radial-gradient(circle at 0% 0%, rgba(248,250,252,0.9), rgba(241,245,249,0.82));
      color:#020617;
      font-size:.78rem;
      border:1px solid rgba(148,163,184,0.75);
      box-shadow:0 12px 34px rgba(15,23,42,0.85);
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    #missionLabel{
      font-weight:600;
    }
    #missionDetail{
      color:#4b5563;
    }

    /* countdown + overlays */

    #countdownOverlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:4rem;
      color:#e5e7eb;
      text-shadow:
        0 0 20px rgba(56,189,248,0.7),
        0 0 40px rgba(56,189,248,0.8);
      z-index:40;
      background: radial-gradient(circle at 20% 0%, rgba(15,23,42,0.66), rgba(15,23,42,0.96));
      opacity:0;
      pointer-events:none;
      transition: opacity 0.15s ease-out;
    }
    #countdownOverlay.visible{
      opacity:1;
      pointer-events:auto;
    }

    #infoOverlay{
      position:absolute;
      inset:0;
      z-index:35;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    #infoOverlayContent{
      pointer-events:auto;
      padding:10px 16px;
      border-radius:999px;
      background: radial-gradient(circle at 0% 0%, rgba(248,250,252,0.95), rgba(241,245,249,0.9));
      color:#020617;
      font-size:.82rem;
      border:1px solid rgba(148,163,184,0.85);
      box-shadow:0 14px 34px rgba(15,23,42,0.95);
      display:flex;
      align-items:center;
      gap:10px;
    }

    /* touch controls (glass buttons) */

    #touchControls{
      position:absolute;
      left:0;
      right:0;
      bottom:8%;
      padding:0 5vw;
      display:flex;
      justify-content:space-between;
      align-items:center;
      z-index:30;
      pointer-events:none; /* ‡πÉ‡∏´‡πâ side tap ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ï‡∏±‡∏ß‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏≠‡∏á override */
    }

    .touch-btn{
      pointer-events:auto;
      min-width:120px;
      padding:12px 22px;
      border-radius:999px;
      border:1px solid var(--glass-border);
      background:
        radial-gradient(circle at 10% 0%, rgba(248,250,252,0.92), rgba(248,250,252,0.15)),
        linear-gradient(145deg, rgba(148,163,184,0.22), rgba(15,23,42,0.85));
      backdrop-filter: blur(18px);
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.6),
        0 18px 42px rgba(15,23,42,0.95);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      text-transform:uppercase;
      letter-spacing:.08em;
      font-weight:600;
      font-size:.8rem;
      color:#0f172a;
      text-shadow:
        0 2px 3px rgba(248,250,252,0.85);
      cursor:pointer;
      transition:
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        border-color var(--transition-fast),
        background var(--transition-fast),
        opacity var(--transition-fast);
      opacity:.96;
    }

    .touch-btn span.icon{
      font-size:.9rem;
    }

    .touch-btn:hover{
      transform: translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(148,163,184,0.9),
        0 22px 40px rgba(15,23,42,0.98);
      border-color: rgba(248,250,252,0.95);
      background:
        radial-gradient(circle at 0% 0%, rgba(248,250,252,0.96), rgba(248,250,252,0.2)),
        linear-gradient(145deg, rgba(191,219,254,0.55), rgba(15,23,42,0.9));
    }

    .touch-btn:active{
      transform:translateY(1px) scale(.97);
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.9),
        0 10px 22px rgba(15,23,42,0.98);
    }

    .touch-btn.secondary{
      min-width:118px;
    }

    /* lobby */

    #lobby{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:.86rem;
      color:var(--text-sub);
    }

    .lobby-left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .lobby-right{
      display:flex;
      gap:8px;
    }

    .pill{
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(148,163,184,0.4);
      background: radial-gradient(circle at 0% 0%, rgba(30,64,175,0.45), rgba(15,23,42,0.98));
      font-size:.78rem;
      color:#e5e7eb;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .primary-btn{
      border-radius:999px;
      padding:8px 16px;
      border:1px solid rgba(56,189,248,0.8);
      background: linear-gradient(135deg, #0ea5e9, #22d3ee);
      color:#0b1120;
      font-weight:600;
      font-size:.88rem;
      letter-spacing:.06em;
      text-transform:uppercase;
      cursor:pointer;
      box-shadow:0 12px 28px rgba(8,47,73,0.95);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .primary-btn:hover{
      filter:brightness(1.05);
      box-shadow:0 16px 36px rgba(8,47,73,0.98);
      transform:translateY(-1px);
    }

    .primary-btn:active{
      transform:translateY(1px) scale(.97);
      box-shadow:0 10px 22px rgba(8,47,73,0.96);
    }

    /* Modals */

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.82);
      backdrop-filter:blur(16px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:80;
    }

    .modal{
      min-width:min(480px, 96vw);
      max-width:96vw;
      max-height:80vh;
      overflow:auto;
      border-radius:20px;
      padding:18px 18px 16px;
      background: radial-gradient(circle at 0% 0%, rgba(30,64,175,0.85), rgba(15,23,42,0.98));
      border:1px solid rgba(148,163,184,0.8);
      box-shadow:0 24px 70px rgba(0,0,0,0.98);
      font-size:.9rem;
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      gap:10px;
    }

    .modal-title{
      font-weight:600;
      font-size:1rem;
      color:#e5e7eb;
    }

    .modal-close{
      border-radius:999px;
      width:30px;
      height:30px;
      border:1px solid rgba(148,163,184,0.8);
      background: radial-gradient(circle at 0% 0%, rgba(248,250,252,0.95), rgba(148,163,184,0.25));
      color:#020617;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:600;
      box-shadow:0 10px 24px rgba(15,23,42,0.95);
    }

    .modal-section-title{
      font-weight:600;
      font-size:.9rem;
      margin:10px 0 6px;
      color:#e5e7eb;
    }

    .shop-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));
      gap:10px;
      margin-top:4px;
    }

    .shop-card{
      border-radius:16px;
      padding:8px 10px;
      background: radial-gradient(circle at 0% 0%, rgba(15,23,42,0.9), rgba(15,23,42,0.96));
      border:1px solid rgba(148,163,184,0.65);
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.82rem;
    }

    .shop-title{
      font-weight:600;
      font-size:.86rem;
      color:#e5e7eb;
    }

    .shop-desc{
      color:var(--text-sub);
      font-size:.78rem;
    }

    .shop-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:4px;
      gap:6px;
    }

    .shop-btn{
      border-radius:999px;
      padding:4px 10px;
      font-size:.78rem;
      border:1px solid rgba(56,189,248,0.85);
      background: linear-gradient(135deg, rgba(14,165,233,0.95), rgba(45,212,191,0.95));
      color:#020617;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(8,47,73,0.9);
      white-space:nowrap;
    }

    .shop-btn.disabled{
      opacity:.4;
      cursor:not-allowed;
      box-shadow:none;
    }

    .badge{
      padding:2px 8px;
      border-radius:999px;
      font-size:.72rem;
      border:1px solid rgba(148,163,184,0.7);
      color:var(--text-sub);
    }

    .badge.highlight{
      border-color:rgba(56,189,248,0.95);
      color:#e0f2fe;
      background:rgba(15,23,42,0.9);
    }

    .help-list{
      padding-left:18px;
      margin:4px 0 10px;
      font-size:.8rem;
      color:#e5e7eb;
    }

    .help-list li{
      margin-bottom:4px;
    }

    /* game over / pause */

    #gameOverPanel,
    #pausePanel{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.9);
      backdrop-filter:blur(14px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:90;
      visibility:hidden;
      opacity:0;
      transition:opacity 0.18s ease-out, visibility 0.18s ease-out;
    }

    #gameOverPanel.visible,
    #pausePanel.visible{
      visibility:visible;
      opacity:1;
    }

    .panel-card{
      min-width:min(420px, 95vw);
      max-width:95vw;
      border-radius:20px;
      padding:18px 18px 16px;
      background: radial-gradient(circle at 0% 0%, rgba(30,64,175,0.9), rgba(15,23,42,0.98));
      border:1px solid rgba(148,163,184,0.85);
      box-shadow:0 24px 70px rgba(0,0,0,0.98);
      font-size:.9rem;
    }

    .panel-card h2{
      font-size:1.05rem;
      margin-bottom:8px;
    }

    .panel-row{
      display:flex;
      justify-content:space-between;
      margin-bottom:3px;
      font-size:.84rem;
    }

    .panel-row span.label{
      color:var(--text-sub);
    }
    .panel-row span.value{
      font-weight:600;
    }

    .panel-actions{
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .btn-outline{
      border-radius:999px;
      padding:6px 12px;
      border:1px solid rgba(148,163,184,0.9);
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
      cursor:pointer;
      font-size:.82rem;
    }

    .btn-danger{
      border-color:rgba(248,113,113,0.85);
      color:#fecaca;
    }

    .btn-main{
      border-color:rgba(56,189,248,0.95);
      background: linear-gradient(135deg, #0ea5e9, #22d3ee);
      color:#020617;
      font-weight:600;
    }

    /* small screens */
    @media (max-width: 720px){
      #inGameTopBar{
        top:8px;
        left:8px;
        right:8px;
      }
      .energy-bar{
        width:120px;
      }
      .ig-scorebox{
        font-size:.76rem;
      }
      #touchControls{
        bottom:6%;
        padding:0 4vw;
      }
      .touch-btn{
        min-width:110px;
        padding:10px 18px;
        font-size:.74rem;
      }
      #missionBubble{
        top:22%;
        font-size:.74rem;
      }
    }
  </style>
</head>
<body>
<div id="app">
  <div class="shell">
    <h1>PHANToM Runner</h1>
    <div class="sub-title">‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏ß‡∏¥‡πà‡∏á ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏à‡∏•‡∏•‡∏µ‡πà ‡∏≠‡∏±‡∏õ‡∏û‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡πÉ‡∏ô‡∏™‡πÑ‡∏ï‡∏•‡πå PHANToM</div>

    <div id="gameFrame">
      <div id="gameContainer">
        <div class="bg-layer"></div>

        <!-- HUD -->
        <div id="inGameTopBar">
          <div class="ig-left">
            <div class="ig-pill">
              <span class="ig-stat-label">Energy</span>
              <div class="energy-bar"><div id="energyFill" class="energy-fill"></div></div>
              <span id="energyText" class="ig-stat-value">100 / 140</span>
            </div>
          </div>
          <div class="ig-right">
            <div class="ig-right-col">
              <div class="ig-right-top" data-ui-block="true">
                <button id="btnGuide" class="ig-btn-icon" title="‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ / ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢">
                  <span>?</span>
                </button>
                <button id="btnFullscreen" class="ig-btn-icon" title="‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">
                  <span>‚õ∂</span>
                </button>
                <button id="btnSound" class="ig-btn-icon" title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á">
                  <span>‚ô™</span>
                </button>
                <button id="btnShop" class="ig-btn-icon" title="‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤">
                  <span>üõí</span>
                </button>
                <button id="btnMute" class="ig-btn-icon" title="‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡πà‡∏ß‡∏ô">
                  <span>üîä</span>
                </button>
                <button id="btnRestartTop" class="ig-btn-icon" title="‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà">
                  <span>‚ü≤</span>
                </button>
                <button id="btnPause" class="ig-btn-icon" title="‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß">
                  <span>II</span>
                </button>
              </div>
              <div class="ig-pill ig-scorebox">
                <span class="label">Score</span><span id="scoreText" class="value">0</span>
                <span class="label">Coins</span><span id="coinsText" class="value">0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Mission -->
        <div id="missionBubble">
          <span id="missionLabel">MISSION</span>
          <span id="missionDetail">‡∏ß‡∏¥‡πà‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏Å‡∏• ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏à‡∏•‡∏•‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!</span>
        </div>

        <!-- Entities -->
        <div id="ground"></div>
        <div id="entitiesLayer">
          <div id="player">
            <div class="player-silhouette"></div>
            <div class="player-shadow"></div>
          </div>
        </div>

        <!-- Countdown / Info -->
        <div id="countdownOverlay"><span id="countdownText">3</span></div>
        <div id="infoOverlay">
          <div id="infoOverlayContent">
            <span>‡πÅ‡∏ï‡∏∞‡∏õ‡∏∏‡πà‡∏° <strong>Start</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‚Äî ‡∏ã‡∏µ‡∏Å‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏à‡∏≠ = ‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î / ‡∏ã‡∏µ‡∏Å‡∏Ç‡∏ß‡∏≤ = ‡∏™‡πÑ‡∏•‡∏î‡πå</span>
          </div>
        </div>

        <!-- Touch controls (glass buttons) -->
        <div id="touchControls">
          <button id="btnJump" class="touch-btn">
            <span class="icon">‚¨Ü</span><span>Jump</span>
          </button>
          <button id="btnDuck" class="touch-btn secondary">
            <span class="icon">‚¨á</span><span>Slide</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Lobby -->
    <div id="lobby">
      <div class="lobby-left">
        <div>‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏ß‡∏°: <strong id="totalCoinsLabel">0</strong> ‚Ä¢ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <strong id="bestScoreLabel">0</strong></div>
        <div style="font-size:.78rem;color:var(--text-sub);">
          ‡πÅ‡∏ï‡∏∞‡∏ã‡∏µ‡∏Å‡∏ã‡πâ‡∏≤‡∏¢‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î / ‡∏ã‡∏µ‡∏Å‡∏Ç‡∏ß‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÑ‡∏•‡∏î‡πå ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏´‡∏•‡∏∏‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á
        </div>
      </div>
      <div class="lobby-right">
        <button id="btnStartRun" class="primary-btn">
          <span>‚ñ∂ Start Run</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Shop Modal -->
<div id="shopModalRoot" class="modal-backdrop" style="display:none;">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ PHANToM</div>
      <button class="modal-close" data-close="shop">‚úï</button>
    </div>
    <div style="font-size:.8rem;color:var(--text-sub);margin-bottom:6px;">
      ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡πà‡∏° Passive Skill
    </div>
    <div class="modal-section-title">‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏° (1 ‡∏ä‡∏¥‡πâ‡∏ô / 1 ‡πÄ‡∏Å‡∏°)</div>
    <div class="shop-grid" id="shopConsumables">
      <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
    </div>

    <div class="modal-section-title" style="margin-top:12px;">Passive Skill (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Å‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏°)</div>
    <div class="shop-grid" id="shopPassives">
      <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
    </div>

    <div style="margin-top:10px;font-size:.8rem;color:var(--text-sub);display:flex;justify-content:space-between;align-items:center;gap:6px;">
      <div>Passive ‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏• <strong>‡∏ó‡∏µ‡∏•‡∏∞ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á</strong> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏≤‡∏Å‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏à‡∏∞‡∏°‡∏≤‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°</div>
      <div class="badge highlight">‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏ß‡∏°: <span id="shopCoinsLabel">0</span></div>
    </div>
  </div>
</div>

<!-- Help / Guide Modal -->
<div id="guideModalRoot" class="modal-backdrop" style="display:none;">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÄ‡∏Å‡∏° PHANToM Runner</div>
      <button class="modal-close" data-close="guide">‚úï</button>
    </div>

    <div class="modal-section-title">‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</div>
    <ul class="help-list">
      <li><strong>‡∏ã‡∏µ‡∏Å‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Å‡∏°</strong> ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏° <strong>Jump</strong> = ‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î</li>
      <li><strong>‡∏ã‡∏µ‡∏Å‡∏Ç‡∏ß‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Å‡∏°</strong> ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏° <strong>Slide</strong> = ‡∏´‡∏°‡∏≠‡∏ö / ‡∏™‡πÑ‡∏•‡∏î‡πå (‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á)</li>
      <li><strong>‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î</strong>: Space / ‚Üë = Jump, ‚Üì = Slide</li>
    </ul>

    <div class="modal-section-title">‡∏´‡∏±‡∏ß‡πÉ‡∏à &amp; Energy</div>
    <ul class="help-list">
      <li>‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÄ‡∏•‡πá‡∏Å <strong>+10</strong> Energy</li>
      <li>‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Å‡∏•‡∏≤‡∏á (‡∏î‡∏£‡∏≠‡∏õ‡∏¢‡∏≤‡∏Å‡πÄ‡∏ó‡πà‡∏≤ Boost/Giant) <strong>+20</strong> Energy</li>
      <li>‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏≠‡∏á <strong>+45</strong> Energy ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</li>
    </ul>

    <div class="modal-section-title">‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©</div>
    <ul class="help-list">
      <li><strong>Boost</strong> ‚Äì ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</li>
      <li><strong>Giant</strong> ‚Äì ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà ‡∏ä‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á</li>
      <li><strong>Magnet</strong> ‚Äì ‡∏î‡∏π‡∏î‡πÄ‡∏à‡∏•‡∏•‡∏µ‡πà‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á</li>
    </ul>

    <div class="modal-section-title">‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏ö‡∏ö‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</div>
    <ul class="help-list">
      <li><strong>Start Energy+</strong> ‚Äì ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏î‡πâ‡∏ß‡∏¢ Energy ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô (‡πÉ‡∏ä‡πâ 1 ‡∏ä‡∏¥‡πâ‡∏ô ‡∏ï‡πà‡∏≠ 1 ‡πÄ‡∏Å‡∏°)</li>
      <li><strong>Start Boost</strong> ‚Äì ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏° Boost ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ~5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</li>
      <li><strong>Passive Box</strong> ‚Äì ‡∏™‡∏∏‡πà‡∏° Passive Skill ‡∏û‡∏¥‡πÄ‡∏®‡∏© 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç x2 / ‡πÉ‡∏ä‡πâ Energy ‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á / ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏ü‡∏£‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á / ‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏´‡∏•‡∏∏‡∏° ‡∏Ø‡∏•‡∏Ø)</li>
    </ul>
  </div>
</div>

<!-- Pause panel -->
<div id="pausePanel">
  <div class="panel-card">
    <h2>‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Å‡∏°‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</h2>
    <div class="panel-row">
      <span class="label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span><span id="pauseScore" class="value">0</span>
    </div>
    <div class="panel-row">
      <span class="label">‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</span><span id="pauseCoins" class="value">0</span>
    </div>
    <div class="panel-actions">
      <button class="btn-outline" id="btnPauseQuit">‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ Lobby</button>
      <button class="btn-outline btn-main" id="btnPauseResume">‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏°</button>
    </div>
  </div>
</div>

<!-- Game over panel -->
<div id="gameOverPanel">
  <div class="panel-card">
    <h2>Game Over</h2>
    <div class="panel-row">
      <span class="label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</span><span id="overScore" class="value">0</span>
    </div>
    <div class="panel-row">
      <span class="label">‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ</span><span id="overCoins" class="value">0</span>
    </div>
    <div class="panel-row">
      <span class="label">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span><span id="overBest" class="value">0</span>
    </div>
    <div class="panel-actions">
      <button class="btn-outline btn-danger" id="btnOverToLobby">‡∏Å‡∏•‡∏±‡∏ö Lobby</button>
      <button class="btn-outline btn-main" id="btnOverRetry">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
    </div>
  </div>
</div>

<script>
(() => {
  const CONFIG = {
    MAX_ENERGY: 140,
    START_ENERGY: 100,
    RUN_DRAIN_PER_SEC: 3.1,
    JUMP_VELOCITY: 780,
    GRAVITY: 2700,
    SLIDE_MIN_MS: 220,

    HEART_SMALL_GAIN: 10,
    HEART_MEDIUM_GAIN: 20,
    HEART_LARGE_GAIN: 45,

    MAGNET_DURATION_MS: 5200,
    BOOST_DURATION_MS: 5150,
    GIANT_DURATION_MS: 3800,

    HIT_LOSS: 28,
    HIT_IFRAMES_MS: 2500,  // ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠: ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö + ‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡∏ã‡πâ‡∏≥ ~2.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    HIT_SLOW_MS: 500,

    GROUND_LEVEL_FRACTION: 0.44, // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (0-1) ‚Äî ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠
    SPECIAL_MIN_MS: 25500,
    SPECIAL_MAX_MS: 37500,

    JELLY_TRAIL_MIN_MS: 1800,
    JELLY_TRAIL_MAX_MS: 3400,
    HEART_MIN_MS: 6500,
    HEART_MAX_MS: 10500,

    SIDE_TAP_DUCK_RELEASE_MS: 140,

    REVIVE_COST: 80,
    REVIVE_SCORE_MULTIPLIER: 0.85,
    REVIVE_COIN_MULTIPLIER: 0.5
  };

  const saveKey = "phantomRunnerSave_v5";

  const $ = sel => document.querySelector(sel);

  const els = {
    gameContainer: $("#gameContainer"),
    ground: $("#ground"),
    player: $("#player"),
    energyFill: $("#energyFill"),
    energyText: $("#energyText"),
    scoreText: $("#scoreText"),
    coinsText: $("#coinsText"),
    countdownOverlay: $("#countdownOverlay"),
    countdownText: $("#countdownText"),
    infoOverlay: $("#infoOverlay"),
    missionDetail: $("#missionDetail"),
    touchControls: $("#touchControls"),
    btnJump: $("#btnJump"),
    btnDuck: $("#btnDuck"),
    btnStartRun: $("#btnStartRun"),
    btnPause: $("#btnPause"),
    btnRestartTop: $("#btnRestartTop"),
    btnShop: $("#btnShop"),
    btnGuide: $("#btnGuide"),
    btnFullscreen: $("#btnFullscreen"),
    btnSound: $("#btnSound"),
    btnMute: $("#btnMute"),
    totalCoinsLabel: $("#totalCoinsLabel"),
    bestScoreLabel: $("#bestScoreLabel"),
    shopModalRoot: $("#shopModalRoot"),
    guideModalRoot: $("#guideModalRoot"),
    shopCoinsLabel: $("#shopCoinsLabel"),
    shopConsumables: $("#shopConsumables"),
    shopPassives: $("#shopPassives"),
    gameOverPanel: $("#gameOverPanel"),
    pausePanel: $("#pausePanel"),
    pauseScore: $("#pauseScore"),
    pauseCoins: $("#pauseCoins"),
    overScore: $("#overScore"),
    overCoins: $("#overCoins"),
    overBest: $("#overBest"),
  };

  const state = {
    running: false,
    paused: false,
    countdown: 0,
    lastTs: performance.now(),
    speed: 0,
    baseSpeed: 0,
    groundY: 40,
    entities: {
      collectibles: [],
      obstacles: [],
      holes: []
    },
    player: {
      vy: 0,
      yOffset: 0,
      ducking: false,
      slideHold: false,
      onGround: true,
      hitIframes: 0,
      hitSlow: 0
    },
    timers: {
      jellyTrail: 0,
      heart: 0,
      special: 0,
      magnet: 0,
      boost: 0,
      giant: 0
    },
    energy: CONFIG.START_ENERGY,
    score: 0,
    bestScore: 0,
    coinsTotal: 0,
    coinsRun: 0,
    revivePenalty: false,
    freeReviveUsed: false,
    passive: null,
    duckPointerId: null
  };

  const save = {
    coins: 0,
    bestScore: 0,
    consumables: {
      startEnergy: 0,
      startBoost: 0
    },
    passive: {
      current: null, // "doubleCoins" | "lessEnergy" | "freeRevive" | "antiPit"
      rerollPrice: 120,
      rerollDiscountCount: 0
    },
    settings: {
      muted: false
    }
  };

  function loadSave(){
    const raw = localStorage.getItem(saveKey);
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      Object.assign(save, data);
    }catch(e){
      console.warn("loadSave error", e);
    }
  }

  function persistSave(){
    localStorage.setItem(saveKey, JSON.stringify(save));
  }

  function clamp(v,min,max){ return v < min ? min : v > max ? max : v; }
  function randRange(min,max){ return min + Math.random()*(max-min); }
  function randInt(min,max){ return Math.floor(randRange(min,max+1)); }

  function recalcLayout(){
    const rect = els.gameContainer.getBoundingClientRect();
    const h = rect.height;
    const groundTop = h * CONFIG.GROUND_LEVEL_FRACTION;
    state.groundY = groundTop;
    const groundHeight = parseFloat(getComputedStyle(els.ground).height) || 46;
    els.ground.style.bottom = (groundTop - groundHeight) + "px";

    const playerRect = els.player.getBoundingClientRect();
    const playerHeight = playerRect.height || 72;
    setPlayerBottom(groundTop);
  }

  function setPlayerBottom(base){
    els.player.style.bottom = base + state.player.yOffset + "px";
  }

  function updateEnergyUI(){
    const ratio = clamp(state.energy / CONFIG.MAX_ENERGY, 0, 1);
    els.energyFill.style.transform = `scaleX(${ratio})`;
    els.energyText.textContent = `${Math.round(state.energy)} / ${CONFIG.MAX_ENERGY}`;
    let color = "var(--energy-high)";
    if(ratio < 0.33) color = "var(--energy-low)";
    else if(ratio < 0.66) color = "var(--energy-mid)";
    els.energyFill.style.background = `linear-gradient(90deg, ${color}, #f97316, #fb7185)`;
  }

  function updateScoreUI(){
    els.scoreText.textContent = Math.round(state.score);
    els.coinsText.textContent = state.coinsRun;
    els.totalCoinsLabel.textContent = save.coins;
    els.bestScoreLabel.textContent = save.bestScore;
    els.shopCoinsLabel.textContent = save.coins;
  }

  function resetRun(applyConsumables = true){
    state.entities.collectibles.forEach(c => c.el.remove());
    state.entities.obstacles.forEach(o => o.el.remove());
    state.entities.holes.forEach(h => h.el.remove());
    state.entities.collectibles = [];
    state.entities.obstacles = [];
    state.entities.holes = [];

    state.player.vy = 0;
    state.player.yOffset = 0;
    state.player.ducking = false;
    state.player.slideHold = false;
    state.player.onGround = true;
    state.player.hitIframes = 0;
    state.player.hitSlow = 0;
    els.player.classList.remove("is-ducking","hit-iframe","is-boost","is-giant");

    state.timers.jellyTrail = randRange(CONFIG.JELLY_TRAIL_MIN_MS, CONFIG.JELLY_TRAIL_MAX_MS);
    state.timers.heart = randRange(CONFIG.HEART_MIN_MS, CONFIG.HEART_MAX_MS);
    state.timers.special = randRange(CONFIG.SPECIAL_MIN_MS, CONFIG.SPECIAL_MAX_MS);
    state.timers.magnet = 0;
    state.timers.boost = 0;
    state.timers.giant = 0;

    state.score = 0;
    state.coinsRun = 0;
    state.revivePenalty = false;
    state.freeReviveUsed = false;

    let startEnergy = CONFIG.START_ENERGY;

    if(applyConsumables){
      if(save.consumables.startEnergy > 0){
        startEnergy = 150;
        save.consumables.startEnergy -= 1;
      }
      if(save.consumables.startBoost > 0){
        state.timers.boost = CONFIG.BOOST_DURATION_MS;
        save.consumables.startBoost -= 1;
        els.player.classList.add("is-boost");
      }
      state.passive = save.passive.current;
    }else{
      state.passive = save.passive.current;
    }

    state.energy = startEnergy;
    updateEnergyUI();
    updateScoreUI();
    persistSave();
    setPlayerBottom(state.groundY);
  }

  function startCountdown(){
    state.running = false;
    state.paused = false;
    state.countdown = 3.0;
    els.countdownText.textContent = "3";
    els.countdownOverlay.classList.add("visible");
    els.infoOverlay.style.display = "none";
  }

  function startRun(){
    resetRun(true);
    recalcLayout();
    startCountdown();
  }

  function pauseGame(){
    if(!state.running) return;
    state.paused = true;
    $("#pauseScore").textContent = Math.round(state.score);
    $("#pauseCoins").textContent = state.coinsRun;
    els.pausePanel.classList.add("visible");
  }

  function resumeGame(){
    if(!state.paused) return;
    state.paused = false;
    els.pausePanel.classList.remove("visible");
  }

  function endRun(){
    state.running = false;
    state.paused = false;
    els.countdownOverlay.classList.remove("visible");
    els.infoOverlay.style.display = "flex";

    // ‡∏£‡∏ß‡∏°‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤ save
    save.coins += state.coinsRun;
    if(state.score > save.bestScore) save.bestScore = Math.round(state.score);
    persistSave();

    updateScoreUI();

    els.overScore.textContent = Math.round(state.score);
    els.overCoins.textContent = state.coinsRun;
    els.overBest.textContent = save.bestScore;
    els.gameOverPanel.classList.add("visible");
  }

  function addScore(amount){
    let mult = 1;
    if(state.revivePenalty) mult *= CONFIG.REVIVE_SCORE_MULTIPLIER;
    state.score += amount * mult;
  }

  function addCoins(amount){
    let mult = 1;
    if(state.passive === "doubleCoins") mult *= 2;
    if(state.revivePenalty) mult *= CONFIG.REVIVE_COIN_MULTIPLIER;
    const gain = Math.max(1, Math.round(amount * mult));
    state.coinsRun += gain;
  }

  function spawnCollectible(kind, x, bottom){
    const el = document.createElement("div");
    el.classList.add("collectible");
    el.classList.add(kind);
    el.style.left = x + "px";
    el.style.bottom = bottom + "px";
    els.entitiesLayer.appendChild(el);
    state.entities.collectibles.push({el, kind, x});
  }

  function spawnObstacle(type, x){
    const el = document.createElement("div");
    el.classList.add("obstacle", type);
    const rect = els.gameContainer.getBoundingClientRect();
    const baseY = state.groundY;
    if(type === "ground"){
      el.style.bottom = baseY + "px";
      el.style.height = "54px";
    }else{
      const h = rect.height;
      const maxTop = h - (baseY + 76);
      const bottom = baseY + randRange(56, 76);
      el.style.bottom = bottom + "px";
      el.style.height = "80px";
    }
    el.style.left = x + "px";
    els.entitiesLayer.appendChild(el);
    state.entities.obstacles.push({el, type, x});
  }

  function spawnHole(x){
    const el = document.createElement("div");
    el.classList.add("hole");
    el.style.bottom = (state.groundY - 10) + "px";
    el.style.left = x + "px";
    els.entitiesLayer.appendChild(el);
    state.entities.holes.push({el, x});
  }

  function spawnJellyTrail(){
    const rect = els.gameContainer.getBoundingClientRect();
    const w = rect.width;
    const baseX = w + 40;
    const step = w * 0.06; // ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏°‡πá‡∏î
    const levels = [10, 34, 62, 86, 72, 52, 32, 20];
    for(let i=0;i<levels.length;i++){
      const offset = levels[i];
      const bottom = state.groundY + offset;
      const x = baseX + i*step;
      spawnCollectible("jelly", x, bottom);
    }
  }

  function maybeSpawnHeart(){
    const rect = els.gameContainer.getBoundingClientRect();
    const w = rect.width;
    const baseX = w + 40;
    const bottom = state.groundY + randRange(40, 110);

    // small heart ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å, ‡πÅ‡∏ï‡πà‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏ó‡∏ô‡∏î‡πâ‡∏ß‡∏¢ medium (rare)
    const roll = Math.random();
    if(roll < 0.65){
      spawnCollectible("heart-small", baseX, bottom);
    }else if(roll < 0.80){
      spawnCollectible("heart-large", baseX, bottom + 12);
    }else{
      // ‡∏´‡∏±‡∏ß‡πÉ‡∏à medium: rare ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö boost / giant (‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° special ‡∏î‡πâ‡∏ß‡∏¢)
      spawnCollectible("heart-medium", baseX, bottom + 6);
    }
  }

  function maybeSpawnSpecial(){
    const rect = els.gameContainer.getBoundingClientRect();
    const w = rect.width;
    const baseX = w + 40;
    const bottom = state.groundY + randRange(68, 124);

    const r = Math.random();
    if(r < 1/3){
      spawnCollectible("heart-medium", baseX, bottom);
    }else if(r < 2/3){
      spawnCollectible("boost", baseX, bottom);
    }else{
      spawnCollectible("giant", baseX, bottom);
    }
  }

  function maybeSpawnObstacleSet(){
    const rect = els.gameContainer.getBoundingClientRect();
    const w = rect.width;
    const baseX = w + 60;

    const pattern = Math.random();
    if(pattern < 0.4){
      // ‡∏û‡∏∑‡πâ‡∏ô‡πÅ‡∏ö‡∏ö block ‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß + ‡∏´‡∏•‡∏∏‡∏°
      spawnObstacle("ground", baseX);
      spawnHole(baseX + w*0.18);
    }else if(pattern < 0.8){
      // ceiling + ground
      spawnObstacle("ground", baseX);
      spawnObstacle("ceiling", baseX + w*0.16);
    }else{
      // ‡∏ä‡∏∏‡∏î‡πÄ‡∏•‡πá‡∏Å ‡πÜ
      spawnObstacle("ground", baseX);
      spawnObstacle("ground", baseX + w*0.13);
    }
  }

  function handleCollect(idx){
    const c = state.entities.collectibles[idx];
    if(!c) return;
    const kind = c.kind;
    c.el.remove();
    state.entities.collectibles.splice(idx,1);

    switch(kind){
      case "jelly":
        addScore(12);
        addCoins(1);
        break;
      case "heart-small":
        state.energy = Math.min(CONFIG.MAX_ENERGY, state.energy + CONFIG.HEART_SMALL_GAIN);
        break;
      case "heart-medium":
        state.energy = Math.min(CONFIG.MAX_ENERGY, state.energy + CONFIG.HEART_MEDIUM_GAIN);
        break;
      case "heart-large":
        state.energy = Math.min(CONFIG.MAX_ENERGY, state.energy + CONFIG.HEART_LARGE_GAIN);
        state.baseSpeed *= 1.04;
        break;
      case "magnet":
        state.timers.magnet = CONFIG.MAGNET_DURATION_MS;
        break;
      case "boost":
        state.timers.boost = CONFIG.BOOST_DURATION_MS;
        els.player.classList.add("is-boost");
        break;
      case "giant":
        state.timers.giant = CONFIG.GIANT_DURATION_MS;
        els.player.classList.add("is-giant");
        break;
    }
    updateEnergyUI();
  }

  function applyDamage(isPit=false){
    if(state.player.hitIframes > 0) return;
    if(state.timers.giant > 0) return;
    if(isPit && state.passive === "antiPit"){
      // ‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏´‡∏•‡∏∏‡∏°
      return;
    }

    state.energy -= CONFIG.HIT_LOSS * (state.passive === "lessEnergy" ? 0.85 : 1);
    if(state.energy < 0) state.energy = 0;
    state.player.hitIframes = CONFIG.HIT_IFRAMES_MS;
    state.player.hitSlow = CONFIG.HIT_SLOW_MS;
    els.player.classList.add("hit-iframe");
    updateEnergyUI();

    if(state.energy <= 0){
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ passive freeRevive ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ
      if(state.passive === "freeRevive" && !state.freeReviveUsed){
        state.freeReviveUsed = true;
        state.energy = CONFIG.MAX_ENERGY * 0.6;
        state.player.hitIframes = CONFIG.HIT_IFRAMES_MS;
        els.player.classList.add("hit-iframe");
        updateEnergyUI();
      }else{
        endRun();
      }
    }
  }

  function handleGameTap(e, type){
    if(!state.running || state.paused) return;
    if(state.countdown > 0) return;

    if(type === "jump"){
      if(state.player.onGround){
        state.player.vy = CONFIG.JUMP_VELOCITY;
        state.player.onGround = false;
      }
    }else if(type === "duck-down"){
      state.player.ducking = true;
      state.player.slideHold = true;
      els.player.classList.add("is-ducking");
    }else if(type === "duck-up"){
      state.player.slideHold = false;
      state.player.ducking = false;
      els.player.classList.remove("is-ducking");
    }
  }

  function setupInput(){
    window.addEventListener("keydown", e => {
      if(e.repeat) return;
      if(e.code === "Space" || e.code === "ArrowUp"){
        handleGameTap(e,"jump");
      }else if(e.code === "ArrowDown"){
        handleGameTap(e,"duck-down");
      }else if(e.code === "KeyP"){
        if(state.paused) resumeGame(); else pauseGame();
      }
    });

    window.addEventListener("keyup", e => {
      if(e.code === "ArrowDown"){
        handleGameTap(e,"duck-up");
      }
    });

    els.btnJump.addEventListener("pointerdown", e => {
      e.stopPropagation();
      handleGameTap(e,"jump");
    });

    els.btnDuck.addEventListener("pointerdown", e => {
      e.stopPropagation();
      handleGameTap(e,"duck-down");
    });
    els.btnDuck.addEventListener("pointerup", e => {
      e.stopPropagation();
      handleGameTap(e,"duck-up");
    });
    els.btnDuck.addEventListener("pointercancel", e => {
      e.stopPropagation();
      handleGameTap(e,"duck-up");
    });

    // ‡πÅ‡∏ï‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ã‡∏µ‡∏Å‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤
    els.gameContainer.addEventListener("pointerdown", e => {
      const target = e.target;
      if(target.closest("[data-ui-block='true']")) return;
      if(target.closest(".modal")) return;
      if(target.closest(".touch-btn")) return;

      const rect = els.gameContainer.getBoundingClientRect();
      const uiRect = $("#inGameTopBar").getBoundingClientRect();
      if(e.clientY <= uiRect.bottom + 4) return;

      const midX = rect.left + rect.width/2;
      if(e.clientX < midX){
        handleGameTap(e,"jump");
      }else{
        state.player.ducking = true;
        state.player.slideHold = true;
        els.player.classList.add("is-ducking");
        state.duckPointerId = e.pointerId;
      }
    });

    els.gameContainer.addEventListener("pointerup", e => {
      if(state.duckPointerId !== null && e.pointerId === state.duckPointerId){
        state.duckPointerId = null;
        state.player.slideHold = false;
        state.player.ducking = false;
        els.player.classList.remove("is-ducking");
      }
    });
    els.gameContainer.addEventListener("pointercancel", e => {
      if(state.duckPointerId !== null && e.pointerId === state.duckPointerId){
        state.duckPointerId = null;
        state.player.slideHold = false;
        state.player.ducking = false;
        els.player.classList.remove("is-ducking");
      }
    });

    // UI buttons
    els.btnStartRun.addEventListener("click", () => {
      els.gameOverPanel.classList.remove("visible");
      startRun();
    });

    els.btnPause.addEventListener("click", () => pauseGame());
    $("#btnPauseResume").addEventListener("click", () => resumeGame());
    $("#btnPauseQuit").addEventListener("click", () => {
      els.pausePanel.classList.remove("visible");
      endRun();
    });

    $("#btnOverToLobby").addEventListener("click", () => {
      els.gameOverPanel.classList.remove("visible");
    });
    $("#btnOverRetry").addEventListener("click", () => {
      els.gameOverPanel.classList.remove("visible");
      startRun();
    });

    els.btnRestartTop.addEventListener("click", () => {
      startRun();
    });

    els.btnShop.addEventListener("click", () => openShop());
    els.btnGuide.addEventListener("click", () => {
      els.guideModalRoot.style.display = "flex";
    });

    document.querySelectorAll(".modal-close").forEach(btn => {
      btn.addEventListener("click", () => {
        const type = btn.getAttribute("data-close");
        if(type === "shop") els.shopModalRoot.style.display = "none";
        else if(type === "guide") els.guideModalRoot.style.display = "none";
      });
    });

    els.shopModalRoot.addEventListener("click", e => {
      if(e.target === els.shopModalRoot){
        els.shopModalRoot.style.display = "none";
      }
    });
    els.guideModalRoot.addEventListener("click", e => {
      if(e.target === els.guideModalRoot){
        els.guideModalRoot.style.display = "none";
      }
    });

    // fullscreen toggling
    els.btnFullscreen.addEventListener("click", () => {
      const elem = document.documentElement;
      if(!document.fullscreenElement){
        if(elem.requestFullscreen) elem.requestFullscreen();
      }else{
        document.exitFullscreen();
      }
    });

    els.btnMute.addEventListener("click", () => {
      save.settings.muted = !save.settings.muted;
      persistSave();
      els.btnMute.classList.toggle("muted", save.settings.muted);
    });
  }

  function buildShop(){
    const consumables = [
      {
        id: "startEnergy",
        name: "Start Energy +50",
        desc: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏î‡πâ‡∏ß‡∏¢ Energy 150 (‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏° 1 ‡∏ä‡∏¥‡πâ‡∏ô)",
        price: 60
      },
      {
        id: "startBoost",
        name: "Start Boost",
        desc: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏° Boost ~5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ",
        price: 70
      }
    ];

    els.shopConsumables.innerHTML = "";
    consumables.forEach(item => {
      const card = document.createElement("div");
      card.className = "shop-card";
      card.innerHTML = `
        <div class="shop-title">${item.name}</div>
        <div class="shop-desc">${item.desc}</div>
        <div class="shop-footer">
          <span class="badge">‡∏£‡∏≤‡∏Ñ‡∏≤: ${item.price} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</span>
          <button class="shop-btn" data-id="${item.id}">‡∏ã‡∏∑‡πâ‡∏≠</button>
        </div>
      `;
      els.shopConsumables.appendChild(card);
    });

    const passives = [
      {
        id: "passiveBox",
        name: "Passive Box",
        desc: "‡∏™‡∏∏‡πà‡∏° Passive Skill 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç x2 / ‡πÉ‡∏ä‡πâ Energy ‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á / ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏ü‡∏£‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á / ‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏´‡∏•‡∏∏‡∏°)",
        price: save.passive.rerollPrice
      }
    ];
    els.shopPassives.innerHTML = "";
    passives.forEach(item => {
      const card = document.createElement("div");
      card.className = "shop-card";
      card.innerHTML = `
        <div class="shop-title">${item.name}</div>
        <div class="shop-desc">${item.desc}</div>
        <div class="shop-footer">
          <span class="badge highlight">‡∏£‡∏≤‡∏Ñ‡∏≤: ${item.price} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</span>
          <button class="shop-btn" data-id="${item.id}">‡∏™‡∏∏‡πà‡∏°</button>
        </div>
      `;
      els.shopPassives.appendChild(card);
    });

    els.shopConsumables.querySelectorAll(".shop-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-id");
        const item = consumables.find(i => i.id === id);
        if(!item) return;
        if(save.coins < item.price) return;
        save.coins -= item.price;
        save.consumables[id] += 1;
        persistSave();
        updateScoreUI();
      });
    });

    els.shopPassives.querySelectorAll(".shop-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const item = passives[0];
        if(save.coins < item.price) return;
        save.coins -= item.price;

        const options = ["doubleCoins","lessEnergy","freeRevive","antiPit"];
        const roll = options[randInt(0, options.length-1)];
        const prev = save.passive.current;
        save.passive.current = roll;
        if(prev && prev === roll){
          save.passive.rerollPrice = Math.max(20, Math.round(save.passive.rerollPrice * 0.85));
          save.passive.rerollDiscountCount += 1;
        }else{
          save.passive.rerollPrice = 120;
          save.passive.rerollDiscountCount = 0;
        }
        persistSave();
        buildShop();
        updateScoreUI();
        alert("Passive ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: " + roll);
      });
    });
  }

  function openShop(){
    buildShop();
    els.shopModalRoot.style.display = "flex";
  }

  function update(dt){
    if(state.paused){
      state.lastTs += dt;
      requestAnimationFrame(loop);
      return;
    }

    if(state.countdown > 0){
      state.countdown -= dt / 1000;
      const t = Math.ceil(state.countdown);
      els.countdownText.textContent = t > 0 ? t : "GO!";
      if(state.countdown <= 0){
        state.countdown = 0;
        els.countdownOverlay.classList.remove("visible");
        state.running = true;
        state.baseSpeed = els.gameContainer.getBoundingClientRect().width / 3.2 / 1000;
        state.speed = state.baseSpeed;
      }
    }

    if(!state.running){
      requestAnimationFrame(loop);
      return;
    }

    // Buff timers
    if(state.timers.boost > 0){
      state.timers.boost -= dt;
      state.speed = state.baseSpeed * 1.55;
      if(state.timers.boost <= 0){
        state.timers.boost = 0;
        els.player.classList.remove("is-boost");
        state.speed = state.baseSpeed;
      }
    }else{
      state.speed = state.baseSpeed;
    }

    if(state.timers.giant > 0){
      state.timers.giant -= dt;
      if(state.timers.giant <= 0){
        state.timers.giant = 0;
        els.player.classList.remove("is-giant");
      }
    }

    if(state.timers.magnet > 0){
      state.timers.magnet -= dt;
      if(state.timers.magnet < 0) state.timers.magnet = 0;
    }

    // hit iframes
    if(state.player.hitIframes > 0){
      state.player.hitIframes -= dt;
      if(state.player.hitIframes <= 0){
        state.player.hitIframes = 0;
        els.player.classList.remove("hit-iframe");
      }
    }
    if(state.player.hitSlow > 0){
      state.player.hitSlow -= dt;
    }

    // energy drain
    const energyDrainBase = CONFIG.RUN_DRAIN_PER_SEC * (state.passive === "lessEnergy" ? 0.85 : 1);
    state.energy -= energyDrainBase * (dt/1000);
    if(state.energy <= 0){
      state.energy = 0;
      updateEnergyUI();
      endRun();
      requestAnimationFrame(loop);
      return;
    }
    updateEnergyUI();

    const rect = els.gameContainer.getBoundingClientRect();
    const w = rect.width;

    // spawn timers
    state.timers.jellyTrail -= dt;
    state.timers.heart -= dt;
    state.timers.special -= dt;

    if(state.timers.jellyTrail <= 0){
      spawnJellyTrail();
      state.timers.jellyTrail = randRange(CONFIG.JELLY_TRAIL_MIN_MS, CONFIG.JELLY_TRAIL_MAX_MS);
    }
    if(state.timers.heart <= 0){
      maybeSpawnHeart();
      state.timers.heart = randRange(CONFIG.HEART_MIN_MS, CONFIG.HEART_MAX_MS);
    }
    if(state.timers.special <= 0){
      maybeSpawnSpecial();
      state.timers.special = randRange(CONFIG.SPECIAL_MIN_MS, CONFIG.SPECIAL_MAX_MS);
    }

    // obstacles
    if(Math.random() < dt / 2200){
      maybeSpawnObstacleSet();
    }

    // move entities
    const moveDist = state.speed * dt * (state.player.hitSlow > 0 ? 0.65 : 1);
    const playerRect = els.player.getBoundingClientRect();

    // collectibles
    for(let i=state.entities.collectibles.length-1; i>=0; i--){
      const c = state.entities.collectibles[i];
      c.x -= moveDist;
      c.el.style.left = c.x + "px";

      if(c.x < -120){
        c.el.remove();
        state.entities.collectibles.splice(i,1);
        continue;
      }

      const r = c.el.getBoundingClientRect();
      if(!(r.right < playerRect.left+8 || r.left > playerRect.right-8 || r.bottom < playerRect.top+8 || r.top > playerRect.bottom-8)){
        handleCollect(i);
      }
    }

    // obstacles
    for(let i=state.entities.obstacles.length-1;i>=0;i--){
      const o = state.entities.obstacles[i];
      o.x -= moveDist;
      o.el.style.left = o.x + "px";
      if(o.x < -160){
        o.el.remove();
        state.entities.obstacles.splice(i,1);
        continue;
      }
      const r = o.el.getBoundingClientRect();
      if(!(r.right < playerRect.left+6 || r.left > playerRect.right-6 || r.bottom < playerRect.top+10 || r.top > playerRect.bottom-10)){
        applyDamage(false);
      }
    }

    // holes
    for(let i=state.entities.holes.length-1;i>=0;i--){
      const h = state.entities.holes[i];
      h.x -= moveDist;
      h.el.style.left = h.x + "px";
      if(h.x < -200){
        h.el.remove();
        state.entities.holes.splice(i,1);
        continue;
      }
      const r = h.el.getBoundingClientRect();
      const px = playerRect.left + playerRect.width*0.35;
      if(px > r.left+10 && px < r.right-10 && state.player.onGround){
        applyDamage(true);
      }
    }

    // player vertical
    state.player.vy -= CONFIG.GRAVITY * (dt/1000);
    state.player.yOffset += state.player.vy * (dt/1000);
    if(state.player.yOffset <= 0){
      state.player.yOffset = 0;
      state.player.vy = 0;
      state.player.onGround = true;
    }else{
      state.player.onGround = false;
    }
    setPlayerBottom(state.groundY);

    // score ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
    addScore(moveDist * 18);
    updateScoreUI();

    requestAnimationFrame(loop);
  }

  function loop(ts){
    const dt = Math.min(64, ts - state.lastTs);
    state.lastTs = ts;
    update(dt);
  }

  function init(){
    loadSave();
    els.btnMute.classList.toggle("muted", save.settings.muted);
    updateScoreUI();
    recalcLayout();
    setupInput();
    buildShop();
    requestAnimationFrame(loop);
    window.addEventListener("resize", () => {
      recalcLayout();
    });
  }

  init();
})();
</script>
</body>
</html>
